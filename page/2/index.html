<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="chengshuomin"><title>学习笔记</title><meta name="description" content="chengshuomin blog"><meta name="keywords" content="Blog,博客,chengshuomin"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon1.svg"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.1.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">首页</a></li><li> <a href="/archives">归档</a></li><li> <a href="/tags">标签</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)" style="display:none;"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/logo.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/title.svg" style="width:200px;" alt="favicon"><h3 title=""><a href="/">学习笔记</a></h3><div class="description"><p>chengshuomin blog</p></div></div><ul class="social-links"></ul></div></div><div class="footer"><div class="p"><span> 全站 CC-BY-SA-3.0</span><i class="fa fa-star"></i><span> chengshuomin</span></div><div class="by_farbox"><span>Powered by</span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo</a><span> &</span><span>Anatolo</span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/107-nextTick/">7. nextTick</a></h3></div><div class="post-content"><div class="card"><p><h2 id="1-nextTick-与-nextTick"><a href="#1-nextTick-与-nextTick" class="headerlink" title="1. nextTick 与 $nextTick"></a>1. nextTick 与 $nextTick</h2><h3 id="全局-API-Vue-nextTick"><a href="#全局-API-Vue-nextTick" class="headerlink" title="全局 API Vue.nextTick()"></a>全局 API <code>Vue.nextTick()</code></h3><h3 id="Vue-nextTick-callback-context"><a href="#Vue-nextTick-callback-context" class="headerlink" title="[Vue.nextTick( callback, context] )"></a>[Vue.nextTick( <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#Vue-nextTick">callback, context] )</a></h3><p><strong>在下次 DOM 更新循环结束之后执行延迟回调。</strong></p>
<p><strong>在修改数据之后立即使用这个方法，获取更新后的 DOM。</strong></p>
<p>2.1.0 起新增：<strong>如果没有提供回调且在支持 Promise 的环境中，则返回一个 Promise。</strong>请注意 Vue 不自带 Promise 的 polyfill，所以如果你的目标浏览器不原生支持 Promise (IE：你们都看我干嘛)，你得自己提供 polyfill。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改数据</span></span><br><span class="line">vm.<span class="property">msg</span> = <span class="string">&#x27;Hello&#x27;</span></span><br><span class="line"><span class="comment">// DOM 还没有更新</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">nextTick</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// DOM 更新了</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 作为一个 Promise 使用 (2.1.0 起新增，详见接下来的提示)</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">nextTick</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// DOM 更新了</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="实例方法-x2F-实例生命周期-vm-nextTick"><a href="#实例方法-x2F-实例生命周期-vm-nextTick" class="headerlink" title="实例方法&#x2F;实例生命周期 vm.$nextTick()"></a>实例方法&#x2F;实例生命周期 <code>vm.$nextTick()</code></h3><h3 id="vm-nextTick-callback"><a href="#vm-nextTick-callback" class="headerlink" title="[vm.$nextTick( callback] )"></a>[vm.$nextTick( <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#vm-nextTick">callback] )</a></h3><p><strong>将回调延迟到下次 DOM 更新循环之后执行。</strong></p>
<p><strong>在修改数据之后立即使用它，然后等待 DOM 更新。</strong></p>
<p><strong>它跟全局方法</strong> <strong>Vue.nextTick</strong> <strong>一样，不同的是回调的</strong> <strong>this</strong> <strong>自动绑定到调用它的实例上。</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="attr">example</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 修改数据</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">message</span> = <span class="string">&#x27;changed&#x27;</span></span><br><span class="line">      <span class="comment">// DOM 还没有更新</span></span><br><span class="line">      <span class="variable language_">this</span>.$nextTick(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// DOM 现在更新了</span></span><br><span class="line">        <span class="comment">// `this` 绑定到当前实例</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">doSomethingElse</span>()</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="2-源码分析"><a href="#2-源码分析" class="headerlink" title="2. 源码分析"></a>2. 源码分析</h2><h3 id="2-1-初始化"><a href="#2-1-初始化" class="headerlink" title="2.1 初始化"></a>2.1 初始化</h3><p>都是调用的 src&#x2F;core&#x2F;util&#x2F;next-tick.js 的 nextTick 方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; nextTick &#125; <span class="keyword">from</span> <span class="string">&#x27;../util/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/core/global-api/index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initGlobalAPI</span> (<span class="title class_">Vue</span>: <span class="title class_">GlobalAPI</span>) &#123;</span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property">nextTick</span> = nextTick</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/core/instance/render.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$nextTick</span> = <span class="keyword">function</span> (<span class="params">fn: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">nextTick</span>(fn, <span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-调用"><a href="#2-2-调用" class="headerlink" title="2.2 调用"></a>2.2 调用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/scheduler.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">queueWatcher</span> (<span class="attr">watcher</span>: <span class="title class_">Watcher</span>) &#123;</span><br><span class="line">      <span class="title function_">nextTick</span>(flushSchedulerQueue)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-nextTick"><a href="#2-3-nextTick" class="headerlink" title="2.3 nextTick()"></a>2.3 <code>nextTick()</code></h3><ul>
<li>将 回调函数 存到 callbacks 队列</li>
<li>如果有正在执行的，就等待上一个执行结束后，下一次更新执行</li>
<li>事件循环通过微任务或宏任务，再依次执行 callbacks 中的回调函数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/util/next-tick.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局唯一，异步操作队列</span></span><br><span class="line"><span class="keyword">const</span> callbacks = []</span><br><span class="line"><span class="comment">// 标识同一个时间只能执行一次</span></span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">nextTick</span> (cb?: <span class="title class_">Function</span>, ctx?: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> _resolve</span><br><span class="line">  <span class="comment">// 将入参的 回调函数cb 存到 callbacks队列中</span></span><br><span class="line">  callbacks.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 保留 cb 的 this 仍是 ctx</span></span><br><span class="line">        cb.<span class="title function_">call</span>(ctx)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="title function_">handleError</span>(e, ctx, <span class="string">&#x27;nextTick&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_resolve) &#123;</span><br><span class="line">      <span class="title function_">_resolve</span>(ctx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 若没有正在执行的任务</span></span><br><span class="line">  <span class="keyword">if</span> (!pending) &#123;</span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// 将待执行操作加到微/宏任务队列（各个系统方式不同 ，简单理解为 setTimeout（利用 Event Loop））</span></span><br><span class="line">    <span class="title function_">timerFunc</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="comment">// 如果没有提供回调且在支持 Promise 的环境中，则返回一个 Promise</span></span><br><span class="line">  <span class="keyword">if</span> (!cb &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      _resolve = resolve</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-timerFunc"><a href="#2-4-timerFunc" class="headerlink" title="2.4 timerFunc"></a>2.4 <code>timerFunc</code></h3><p>挂起任务的方法，将待执行操作加到微&#x2F;宏任务队列（微任务优先于宏任务）</p>
<p>优先级为： Promise &gt; MutationObserver &gt; setImmediate &gt; setTimeout</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/util/next-tick.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 挂起方法，将待执行操作加到微/宏任务队列（各个系统方式不同 ，使用不同的方式）</span></span><br><span class="line"><span class="comment">// 优先级为： Promise &gt; MutationObserver &gt; setImmediate &gt; setTimeout</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> isUsingMicroTask = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> timerFunc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(<span class="title class_">Promise</span>)) &#123;</span><br><span class="line">  <span class="comment">// 支持 Promise 的，使用 Promise 方式挂起，回调函数放在 then() 中 -- 微任务</span></span><br><span class="line">  <span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    p.<span class="title function_">then</span>(flushCallbacks)</span><br><span class="line">    <span class="keyword">if</span> (isIOS) <span class="built_in">setTimeout</span>(noop)</span><br><span class="line">  &#125;</span><br><span class="line">  isUsingMicroTask = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isIE &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">MutationObserver</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; (</span><br><span class="line">  <span class="title function_">isNative</span>(<span class="title class_">MutationObserver</span>) ||</span><br><span class="line">  <span class="comment">// PhantomJS and iOS 7.x</span></span><br><span class="line">  <span class="title class_">MutationObserver</span>.<span class="title function_">toString</span>() === <span class="string">&#x27;[object MutationObserverConstructor]&#x27;</span></span><br><span class="line">)) &#123;</span><br><span class="line">  <span class="comment">// 不支持 Promise ,但非IE 且支持 MutationObserver 的，使用 MutationObserver  -- 微任务</span></span><br><span class="line">  ...</span><br><span class="line">  isUsingMicroTask = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(setImmediate)) &#123;</span><br><span class="line">  <span class="comment">// 不支持 Promise 和 MutationObserver ，</span></span><br><span class="line">  <span class="comment">// 但支持 setImmediate，用 setImmediate 挂起 -- 宏任务</span></span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setImmediate</span>(flushCallbacks)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 以上都不支持的，使用 setTimeout 挂起 -- 宏任务</span></span><br><span class="line">  <span class="comment">// Fallback to setTimeout.</span></span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(flushCallbacks, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-5-flushCallbacks"><a href="#2-5-flushCallbacks" class="headerlink" title="2.5 flushCallbacks()"></a>2.5 <code>flushCallbacks()</code></h3><ul>
<li>执行回调函数，将标志位置为 false</li>
<li>遍历 callbacks 回调队列，挨个执行</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/util/next-tick.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历 callbacks 队列中的回调函数，挨个执行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushCallbacks</span> () &#123;</span><br><span class="line">  pending = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> copies = callbacks.<span class="title function_">slice</span>(<span class="number">0</span>)</span><br><span class="line">  callbacks.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// 挨个执行</span></span><br><span class="line">    copies[i]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-07-18</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约968个字, 3分钟13秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/">6. 模版渲染</a></h3></div><div class="post-content"><div class="card"><p><h1 id="入口-vm-mount-方法："><a href="#入口-vm-mount-方法：" class="headerlink" title="入口 vm.$mount 方法："></a>入口 <code>vm.$mount</code> 方法：</h1><p>在 <code>vm.$mount(vm.$options.el)</code>中，</p>
<h1 id="1-扩展-mount-方法（platforms-web-entry-runtime-with-compiler）"><a href="#1-扩展-mount-方法（platforms-web-entry-runtime-with-compiler）" class="headerlink" title="1. 扩展 $mount 方法（platforms/web/entry-runtime-with-compiler）"></a>1. 扩展 $mount 方法（<code>platforms/web/entry-runtime-with-compiler</code>）</h1><p><strong>先调用 扩展的 $mount 方法（</strong><code>**src/platforms/web/entry-runtime-with-compiler.js**</code><strong>）, 生成 render。</strong></p>
<ul>
<li><p>id 不能挂载到 body 或 documentElement 页面文档上</p>
</li>
<li><p>若 this.$options 上没有 render 方法</p>
</li>
<li><ul>
<li>取 $options 的 template 或 el 获取元素，生成 html 字符串（此 html 字符串即 下文 parseHTML 方法的入参 html）</li>
<li>调用 compileToFunctions ，获取 render 方法</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/platforms/web/entry-runtime-with-compiler.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mount = <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  <span class="comment">// 获取元素或查询元素 （query 方法分析见下方）</span></span><br><span class="line">  <span class="comment">//  el 是元素选择器</span></span><br><span class="line">  el = el &amp;&amp; <span class="title function_">query</span>(el)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="comment">// vue 不允许将 id 直接挂到 body 或 页面文档</span></span><br><span class="line">  <span class="keyword">if</span> (el === <span class="variable language_">document</span>.<span class="property">body</span> || el === <span class="variable language_">document</span>.<span class="property">documentElement</span>) &#123;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.`</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 此处的 $options 如下图1</span></span><br><span class="line">  <span class="keyword">const</span> options = <span class="variable language_">this</span>.<span class="property">$options</span></span><br><span class="line">  <span class="comment">// resolve template/el and convert to render function</span></span><br><span class="line">  <span class="keyword">if</span> (!options.<span class="property">render</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> template = options.<span class="property">template</span></span><br><span class="line">    <span class="comment">// 若参数中有 template</span></span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> template === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 若有 # ，则可能是id 选择器的标志，用 idToTemplate 转换获取 node 节点</span></span><br><span class="line">        <span class="keyword">if</span> (template.<span class="title function_">charAt</span>(<span class="number">0</span>) === <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">          template = <span class="title function_">idToTemplate</span>(template)</span><br><span class="line">          <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">          <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !template) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">`Template element not found or is empty: <span class="subst">$&#123;options.template&#125;</span>`</span>,</span><br><span class="line">              <span class="variable language_">this</span></span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (template.<span class="property">nodeType</span>) &#123;</span><br><span class="line">        <span class="comment">// 若 template 是node 类型节点，则取其 内部html 节点</span></span><br><span class="line">        template = template.<span class="property">innerHTML</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(<span class="string">&#x27;invalid template option:&#x27;</span> + template, <span class="variable language_">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el) &#123;</span><br><span class="line">      <span class="comment">// 若el 有值，则取 el 本身元素（此处也表明 优先取 template 属性值）</span></span><br><span class="line">      template = <span class="title function_">getOuterHTML</span>(el)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">        <span class="title function_">mark</span>(<span class="string">&#x27;compile&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 1.模板编译，将 template 解析为 ast tree</span></span><br><span class="line"><span class="comment">        * 2.将 ast tree 转换成 render 语法字符串</span></span><br><span class="line"><span class="comment">        * 3.生成 render 方法</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line">      <span class="keyword">const</span> &#123; render, staticRenderFns &#125; = <span class="title function_">compileToFunctions</span>(template, &#123;</span><br><span class="line">        <span class="attr">outputSourceRange</span>: process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">        shouldDecodeNewlines,</span><br><span class="line">        shouldDecodeNewlinesForHref,</span><br><span class="line">        <span class="attr">delimiters</span>: options.<span class="property">delimiters</span>,</span><br><span class="line">        <span class="attr">comments</span>: options.<span class="property">comments</span></span><br><span class="line">      &#125;, <span class="variable language_">this</span>)</span><br><span class="line">      <span class="comment">// 这里的 render 就是生成虚拟 DOM 的方法</span></span><br><span class="line">      options.<span class="property">render</span> = render</span><br><span class="line">      options.<span class="property">staticRenderFns</span> = staticRenderFns</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">        <span class="title function_">mark</span>(<span class="string">&#x27;compile end&#x27;</span>)</span><br><span class="line">        <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;<span class="variable language_">this</span>._name&#125;</span> compile`</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;compile end&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 此处转换后的 $options 如下图2</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">$options</span>)</span><br><span class="line">  <span class="comment">// 由于是扩展方法，则 return 回 $mount 方法，使其继续调用原始方法</span></span><br><span class="line">  <span class="keyword">return</span> mount.<span class="title function_">call</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1656583813165-0d3bf22c-7b9d-4187-8ae8-6fe052976217.png" alt="img"></p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1656583751696-a1a3581c-3204-4245-8f82-433ef3404b5e.png" alt="img"></p>
<h4 id="【辅助】query-el-方法："><a href="#【辅助】query-el-方法：" class="headerlink" title="【辅助】query(el) 方法："></a>【辅助】<code>query(el)</code> 方法：</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Query an element selector if it&#x27;s not an element already.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">query</span> (<span class="attr">el</span>: string | <span class="title class_">Element</span>): <span class="title class_">Element</span> &#123;</span><br><span class="line">  <span class="comment">// el 的格式只有 string 和 Element</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> el === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// string 时，相当于 el 的值是元素的 id ，通过 document.querySelector() 方法获取dom元素 ，并返回</span></span><br><span class="line">    <span class="keyword">const</span> selected = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(el)</span><br><span class="line">    <span class="keyword">if</span> (!selected) &#123;</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;Cannot find element: &#x27;</span> + el</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> selected</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 若是 Element 类型，直接返回 元素</span></span><br><span class="line">    <span class="keyword">return</span> el</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-1-compileToFunctions"><a href="#1-1-compileToFunctions" class="headerlink" title="1.1 compileToFunctions()"></a>1.1 <code>compileToFunctions()</code></h2><ul>
<li>找 compileToFunctions() 的定义在 <code>src\platforms\web\compiler\index.js</code>，由 createCompiler 创建</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\platforms\web\compiler\index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createCompiler &#125; <span class="keyword">from</span> <span class="string">&#x27;compiler/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; compile, compileToFunctions &#125; = <span class="title function_">createCompiler</span>(baseOptions)</span><br><span class="line"><span class="keyword">export</span> &#123; compile, compileToFunctions &#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-createCompiler"><a href="#1-2-createCompiler" class="headerlink" title="1.2 createCompiler"></a>1.2 <code>createCompiler</code></h2><ul>
<li>再找 createCompiler 的定义在 <code>src\compiler\index.js</code>，引出创建方法 <code>createCompilerCreator</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模板编译，将模板代码转化为 AST；</span></span><br><span class="line"><span class="comment"> * 优化 AST，方便后续虚拟 DOM 更新；</span></span><br><span class="line"><span class="comment"> * 生成代码，将 AST 转化为可执行的代码；</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createCompiler = <span class="title function_">createCompilerCreator</span>(<span class="keyword">function</span> <span class="title function_">baseCompile</span> (</span><br><span class="line">  <span class="attr">template</span>: string,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">CompiledResult</span> &#123;</span><br><span class="line">  <span class="comment">// baseCompile 的调用在：</span></span><br><span class="line">  <span class="comment">// src\compiler\create-compiler.js 中的 const compiled = baseCompile(template.trim(), finalOptions)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 解析 template 模板，转换为 ast</span></span><br><span class="line">  <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options)</span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">optimize</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">// 优化 ast，标记静态节点</span></span><br><span class="line">    <span class="title function_">optimize</span>(ast, options)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将 ast 转化为可执行代码</span></span><br><span class="line">  <span class="keyword">const</span> code = <span class="title function_">generate</span>(ast, options)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="1-3-createCompilerCreator"><a href="#1-3-createCompilerCreator" class="headerlink" title="1.3 createCompilerCreator"></a>1.3 <code>createCompilerCreator</code></h2><ul>
<li><p>再找<code>createCompilerCreator</code>创建在 <code>src\compiler\create-compiler.js</code>，由此引出：</p>
</li>
<li><ul>
<li><code>createCompileToFunctionFn(compile)</code> </li>
<li><code>compile()</code> 的定义在 <code>createCompiler</code>方法内的子函数</li>
</ul>
</li>
</ul>
<h3 id="1-3-1-createCompilerCreator-和-compile"><a href="#1-3-1-createCompilerCreator-和-compile" class="headerlink" title="1.3.1 createCompilerCreator 和 compile()"></a>1.3.1 <code>createCompilerCreator</code> 和 <code>compile()</code></h3><ul>
<li><ul>
<li><ul>
<li>在 <code>compile()</code>的实现中，引出 <code>baseCompile(template.trim(), finalOptions)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\create-compiler.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createCompilerCreator</span> (<span class="attr">baseCompile</span>: <span class="title class_">Function</span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">createCompiler</span> (<span class="attr">baseOptions</span>: <span class="title class_">CompilerOptions</span>) &#123;</span><br><span class="line">    <span class="comment">// compile 是在 createCompiler 函数体内定义个一个子函数</span></span><br><span class="line">    <span class="comment">// 应用 eg： src\compiler\to-function.js 中，const compiled = compile(template, options)</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">compile</span> (</span><br><span class="line">      <span class="attr">template</span>: string,</span><br><span class="line">      options?: <span class="title class_">CompilerOptions</span></span><br><span class="line">    ): <span class="title class_">CompiledResult</span> &#123;</span><br><span class="line">         <span class="comment">// 深拷贝参数 baseOptions</span></span><br><span class="line">        <span class="keyword">const</span> finalOptions = <span class="title class_">Object</span>.<span class="title function_">create</span>(baseOptions)</span><br><span class="line">        <span class="comment">// modules, directives, warn 的合并</span></span><br><span class="line">        ... </span><br><span class="line">        <span class="comment">// baseCompile 方法是 src\compiler\index.js 中 创建</span></span><br><span class="line">        <span class="keyword">const</span> compiled = <span class="title function_">baseCompile</span>(template.<span class="title function_">trim</span>(), finalOptions)</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> compiled</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        compile,</span><br><span class="line">        <span class="attr">compileToFunctions</span>: <span class="title function_">createCompileToFunctionFn</span>(compile)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<h4 id="1-3-1-1-baseCompile-template-trim-finalOptions"><a href="#1-3-1-1-baseCompile-template-trim-finalOptions" class="headerlink" title="1.3.1.1 baseCompile(template.trim(), finalOptions)"></a>1.3.1.1 <code>baseCompile(template.trim(), finalOptions)</code></h4><p>此方法的创建在 1.1.2 内。</p>
<p>调用此方法后，由此引出 ：</p>
<ul>
<li><code>const ast = parse(template.trim(), options)</code>，具体分析见下文 【 <em><strong>3. 生成AST</strong></em> 】</li>
<li><code>optimize(ast, options)</code> &#x2F;&#x2F; todo</li>
<li><code>constcode = generate(ast, options)</code> &#x2F;&#x2F; todo</li>
</ul>
<h3 id="1-3-2-createCompileToFunctionFn-compile"><a href="#1-3-2-createCompileToFunctionFn-compile" class="headerlink" title="1.3.2 createCompileToFunctionFn(compile)"></a>1.3.2 <code>createCompileToFunctionFn(compile)</code></h3><ul>
<li><ul>
<li>再找 <code>createCompileToFunctionFn(compile)</code> 创建在 <code>src\compiler\to-function.js</code></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\to-function.js</span></span><br><span class="line"></span><br><span class="line">type <span class="title class_">CompiledFunctionResult</span> = &#123;</span><br><span class="line">  <span class="attr">render</span>: <span class="title class_">Function</span>;</span><br><span class="line">  <span class="attr">staticRenderFns</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Function</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建 编译函数 render, staticRenderFns</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">创建</span>&#125; compile </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span>  <span class="variable">CompiledFunctionResult</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createCompileToFunctionFn</span> (<span class="attr">compile</span>: <span class="title class_">Function</span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="comment">// 创建编译缓存</span></span><br><span class="line">  <span class="keyword">const</span> cache = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">compileToFunctions</span> (</span><br><span class="line">    <span class="attr">template</span>: string,</span><br><span class="line">    options?: <span class="title class_">CompilerOptions</span>,</span><br><span class="line">    vm?: <span class="title class_">Component</span></span><br><span class="line">  ): <span class="title class_">CompiledFunctionResult</span> &#123;</span><br><span class="line">    options = <span class="title function_">extend</span>(&#123;&#125;, options)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// check cache</span></span><br><span class="line">    <span class="comment">// 检查缓存，有缓存直接用</span></span><br><span class="line">    <span class="keyword">const</span> key = options.<span class="property">delimiters</span></span><br><span class="line">      ? <span class="title class_">String</span>(options.<span class="property">delimiters</span>) + template</span><br><span class="line">      : template</span><br><span class="line">    <span class="keyword">if</span> (cache[key]) &#123;</span><br><span class="line">      <span class="keyword">return</span> cache[key]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// compile</span></span><br><span class="line">    <span class="comment">// compile 函数 是在 src\compiler\create-compiler.js 下，createCompilerCreator 中 return 的 createCompiler 的函数体中定义 </span></span><br><span class="line">    <span class="keyword">const</span> compiled = <span class="title function_">compile</span>(template, options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check compilation errors/tips</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// turn code into functions</span></span><br><span class="line">    <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> fnGenErrors = []</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * createFunction 核心 new Function(code)</span></span><br><span class="line"><span class="comment">     * 将 字符串 创建为 函数 </span></span><br><span class="line"><span class="comment">     * */</span> </span><br><span class="line">    <span class="comment">// render 创建好了</span></span><br><span class="line">    res.<span class="property">render</span> = <span class="title function_">createFunction</span>(compiled.<span class="property">render</span>, fnGenErrors)</span><br><span class="line">    res.<span class="property">staticRenderFns</span> = compiled.<span class="property">staticRenderFns</span>.<span class="title function_">map</span>(<span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">createFunction</span>(code, fnGenErrors)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check function generation errors.</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建好的 res 放在缓存</span></span><br><span class="line">    <span class="keyword">return</span> (cache[key] = res)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-原始-mount-方法（-platforms-web-runtime-index-）"><a href="#2-原始-mount-方法（-platforms-web-runtime-index-）" class="headerlink" title="2. 原始 $mount 方法（**platforms/web/runtime/index**）"></a>2. <strong>原始 $mount 方法（</strong><code>**platforms/web/runtime/index**</code><strong>）</strong></h1><p><strong>再调用 原始的 $mount 方法（</strong><code>**src/platforms/web/runtime/index.js**</code><strong>）, 获得元素，返回 mountComponent 方法</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/platforms/web/runtime/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; mountComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;core/instance/lifecycle&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// public mount method</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  <span class="comment">// 初始化挂载组件</span></span><br><span class="line">  el = el &amp;&amp; inBrowser ? <span class="title function_">query</span>(el) : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">mountComponent</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="mountComponent-this-el-hydrating-方法："><a href="#mountComponent-this-el-hydrating-方法：" class="headerlink" title="mountComponent(this, el, hydrating) 方法："></a><code>mountComponent(this, el, hydrating)</code> 方法：</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\lifecycle.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">mountComponent</span> (</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span><br><span class="line">  <span class="attr">el</span>: ?<span class="title class_">Element</span>,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): <span class="title class_">Component</span> &#123;</span><br><span class="line">  vm.<span class="property">$el</span> = el</span><br><span class="line">  <span class="comment">// 若没有获取解析的 render 函数，抛出警告</span></span><br><span class="line">  <span class="comment">// render 是解析模板生成的，</span></span><br><span class="line">  <span class="comment">// 在 /entry-runtime-with-Compiler.js 中 $mounted() , const &#123; render, staticRenderFns &#125; = compileToFunctions(template,&#123;&#125;) 生成的</span></span><br><span class="line">  <span class="keyword">if</span> (!vm.<span class="property">$options</span>.<span class="property">render</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeMount&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> updateComponent</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">    <span class="comment">// 支持performance的开发环境，添加关于 performance 的分析时间线</span></span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> name = vm.<span class="property">_name</span></span><br><span class="line">      <span class="keyword">const</span> id = vm.<span class="property">_uid</span></span><br><span class="line">      <span class="keyword">const</span> startTag = <span class="string">`vue-perf-start:<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">      <span class="keyword">const</span> endTag = <span class="string">`vue-perf-end:<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">      <span class="title function_">mark</span>(startTag)</span><br><span class="line">      <span class="keyword">const</span> vnode = vm.<span class="title function_">_render</span>()</span><br><span class="line">      <span class="title function_">mark</span>(endTag)</span><br><span class="line">      <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;name&#125;</span> render`</span>, startTag, endTag)</span><br><span class="line"></span><br><span class="line">      <span class="title function_">mark</span>(startTag)</span><br><span class="line">      vm.<span class="title function_">_update</span>(vnode, hydrating) <span class="comment">// 核心逻辑 同else的，vm._update(vm._render(), hydrating)</span></span><br><span class="line">      <span class="title function_">mark</span>(endTag)</span><br><span class="line">      <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;name&#125;</span> patch`</span>, startTag, endTag)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 生产环境环境 </span></span><br><span class="line">    <span class="comment">// vm._render 用于生成虚拟 DOM</span></span><br><span class="line">    <span class="comment">// _update 内部调用 patch 方法 将虚拟 DOM 与 真实的 DOM 同步 ( diff )</span></span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we set this to vm._watcher inside the watcher&#x27;s constructor</span></span><br><span class="line">  <span class="comment">// since the watcher&#x27;s initial patch may call $forceUpdate (e.g. inside child</span></span><br><span class="line">  <span class="comment">// component&#x27;s mounted hook), which relies on vm._watcher being already defined</span></span><br><span class="line">  <span class="comment">// 【new Watcher 初始化】监听当前组件状态，当有数据变化时，更新组件</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, updateComponent, noop, &#123;</span><br><span class="line">    before () &#123;</span><br><span class="line">      <span class="keyword">if</span> (vm.<span class="property">_isMounted</span> &amp;&amp; !vm.<span class="property">_isDestroyed</span>) &#123;</span><br><span class="line">        <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeUpdate&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>)</span><br><span class="line">  hydrating = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// manually mounted instance, call mounted on self</span></span><br><span class="line">  <span class="comment">// mounted is called for render-created child components in its inserted hook</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$vnode</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">    vm.<span class="property">_isMounted</span> = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;mounted&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-1-vm-render"><a href="#2-1-vm-render" class="headerlink" title="2.1 vm._render()"></a>2.1 <code>vm._render()</code></h2><p>vm._render <strong>用于生成虚拟 dom</strong>，执行 dom-diff，更新真实 dom</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\render.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initRender</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">    <span class="comment">// bind the createElement fn to this instance</span></span><br><span class="line">  <span class="comment">// so that we get proper render context inside it.</span></span><br><span class="line">  <span class="comment">// args order: tag, data, children, normalizationType, alwaysNormalize</span></span><br><span class="line">  <span class="comment">// internal version is used by render functions compiled from templates</span></span><br><span class="line">  vm.<span class="property">_c</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">false</span>)              <span class="comment">// 系统创建元素的 方法</span></span><br><span class="line">  <span class="comment">// normalization is always applied for the public version, used in</span></span><br><span class="line">  <span class="comment">// user-written render functions.</span></span><br><span class="line">  vm.<span class="property">$createElement</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">true</span>)   <span class="comment">// 用户提供了 render 属性时创建元素的方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_render</span> = <span class="keyword">function</span> (<span class="params"></span>): <span class="title class_">VNode</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> &#123; render, _parentVnode &#125; = vm.<span class="property">$options</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 执行 render 方法中的 createElement 参数就是 vm.$createElement，</span></span><br><span class="line">    <span class="comment">// vm.$createElement 方法是定义在 initRender 方法上</span></span><br><span class="line">    vnode = render.<span class="title function_">call</span>(vm.<span class="property">_renderProxy</span>, vm.<span class="property">$createElement</span>)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// createEmptyVNode 的核心  const node = new VNode()</span></span><br><span class="line">    vnode = <span class="title function_">createEmptyVNode</span>()</span><br><span class="line">    <span class="comment">// set parent</span></span><br><span class="line">    vnode.<span class="property">parent</span> = _parentVnode</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>initRender</code>,</p>
<p>这里 vm._c 和 vm.$createElement 的区别为：</p>
<p>vm._c 是被模板编译成的 render 函数使用；</p>
<p>vm.$createElement 是用户手写 render 方法使用的；</p>
<p>两个方法支持的参数相同，并且内部都调用了 createElement 方法</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657800175284-07e129c1-8412-46ed-a8eb-70fbe5d575b6.png" alt="img"></p>
<h3 id="2-1-1-VNode"><a href="#2-1-1-VNode" class="headerlink" title="2.1.1 VNode"></a>2.1.1 <code>VNode</code></h3><p>虚拟Dom 的类是 <code>VNode</code>，主要属性是：tag, data, children, text, elm, ns, context, key, parent, raw</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="attr">tag</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">data</span>: <span class="title class_">VNodeData</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">children</span>: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;;</span><br><span class="line">  <span class="attr">text</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">elm</span>: <span class="title class_">Node</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">ns</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">context</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// rendered in this component&#x27;s scope</span></span><br><span class="line">  <span class="attr">key</span>: string | number | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">componentOptions</span>: <span class="title class_">VNodeComponentOptions</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">componentInstance</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// component instance</span></span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">VNode</span> | <span class="keyword">void</span>; <span class="comment">// component placeholder node</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// strictly internal</span></span><br><span class="line">  <span class="attr">raw</span>: boolean; <span class="comment">// contains raw HTML? (server only)</span></span><br><span class="line">  <span class="attr">isStatic</span>: boolean; <span class="comment">// hoisted static node</span></span><br><span class="line">  <span class="attr">isRootInsert</span>: boolean; <span class="comment">// necessary for enter transition check</span></span><br><span class="line">  <span class="attr">isComment</span>: boolean; <span class="comment">// empty comment placeholder?</span></span><br><span class="line">  <span class="attr">isCloned</span>: boolean; <span class="comment">// is a cloned node?</span></span><br><span class="line">  <span class="attr">isOnce</span>: boolean; <span class="comment">// is a v-once node?</span></span><br><span class="line">  <span class="attr">asyncFactory</span>: <span class="title class_">Function</span> | <span class="keyword">void</span>; <span class="comment">// async component factory function</span></span><br><span class="line">  <span class="attr">asyncMeta</span>: <span class="title class_">Object</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">isAsyncPlaceholder</span>: boolean;</span><br><span class="line">  <span class="attr">ssrContext</span>: <span class="title class_">Object</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">fnContext</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// real context vm for functional nodes</span></span><br><span class="line">  <span class="attr">fnOptions</span>: ?<span class="title class_">ComponentOptions</span>; <span class="comment">// for SSR caching</span></span><br><span class="line">  <span class="attr">devtoolsMeta</span>: ?<span class="title class_">Object</span>; <span class="comment">// used to store functional render context for devtools</span></span><br><span class="line">  <span class="attr">fnScopeId</span>: ?string; <span class="comment">// functional scope id support</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (</span><br><span class="line">    tag?: string,</span><br><span class="line">    data?: <span class="title class_">VNodeData</span>,</span><br><span class="line">    children?: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;,</span><br><span class="line">    text?: string,</span><br><span class="line">    elm?: <span class="title class_">Node</span>,</span><br><span class="line">    context?: <span class="title class_">Component</span>,</span><br><span class="line">    componentOptions?: <span class="title class_">VNodeComponentOptions</span>,</span><br><span class="line">    asyncFactory?: <span class="title class_">Function</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tag</span> = tag</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = data</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">children</span> = children</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">text</span> = text</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">elm</span> = elm</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ns</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span> = context</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnContext</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnOptions</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnScopeId</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = data &amp;&amp; data.<span class="property">key</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentOptions</span> = componentOptions</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentInstance</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">raw</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStatic</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRootInsert</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isComment</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isCloned</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isOnce</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncFactory</span> = asyncFactory</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncMeta</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isAsyncPlaceholder</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// DEPRECATED: alias for componentInstance for backwards compat.</span></span><br><span class="line">  <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">  get child (): <span class="title class_">Component</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">componentInstance</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-vm-update"><a href="#2-2-vm-update" class="headerlink" title="2.2 vm._update()"></a>2.2 <code>vm._update()</code></h2><p>把 VNode 渲染成真实的 DOM。</p>
<p>被调用：</p>
<ul>
<li>mountComponent ，在初次渲染时</li>
<li>在 update 时</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\lifecycle.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">lifecycleMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_update</span> = <span class="keyword">function</span> (<span class="params">vnode: VNode, hydrating?: boolean</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">// 初次渲染</span></span><br><span class="line">    <span class="comment">// vm.__patch__ 方法：进行 dom diff 比较，然后更新 dom</span></span><br><span class="line">    <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">      <span class="comment">// initial render</span></span><br><span class="line">      vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(vm.<span class="property">$el</span>, vnode, hydrating, <span class="literal">false</span> <span class="comment">/* removeOnly */</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// updates</span></span><br><span class="line">      <span class="comment">// 更新</span></span><br><span class="line">      vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(prevVnode, vnode)</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-1-Vue-prototype-patch"><a href="#2-2-1-Vue-prototype-patch" class="headerlink" title="2.2.1 Vue.**prototype**.**__patch__**"></a>2.2.1 <code>Vue.**prototype**.**__patch__**</code></h3><p><code>__patch__</code>项目中有两种实现，区分于平台：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/platforms/web/runtime/index.js</span></span><br><span class="line"><span class="comment">// install platform patch function</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__patch__</span> = inBrowser ? patch : noop</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/platforms/weex/runtime/index.js</span></span><br><span class="line"><span class="comment">// install platform patch function</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__patch__</span> = patch</span><br></pre></td></tr></table></figure>

<h2 id="2-3-new-Watcher"><a href="#2-3-new-Watcher" class="headerlink" title="2.3 new Watcher"></a>2.3 <code>new Watcher</code></h2><p>关于 Watcher 见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/onzg44">05- Observer</a></p>
<h1 id="3-生成-AST"><a href="#3-生成-AST" class="headerlink" title="3. 生成 AST"></a>3. 生成 AST</h1><p>如下创建入口，引出 <code>parse</code>方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options)</span><br></pre></td></tr></table></figure>

<p>例： 如下模板 template：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;editor&quot;</span>&gt;</span><br><span class="line">  &lt;!-- 注释 --&gt;</span><br><span class="line">  &lt;试试\&lt;</span><br><span class="line">  &lt;p&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>li的值<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">:value</span>=<span class="string">&quot;input + new Date()&quot;</span> @<span class="attr">input</span>=<span class="string">&quot;update&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-html</span>=<span class="string">&quot;compiledMarkdown&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>生成的 AST 结构如下：</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657793256463-9f07c6aa-a310-4f26-b11a-046ff5be636c.png" alt="img"></p>
<h2 id="3-1-parse"><a href="#3-1-parse" class="headerlink" title="3.1 parse"></a>3.1 <code>parse</code></h2><p>分析源码，由 <code>parse</code> 引出 <code>parseHTML</code> ，</p>
<p>此处 template ：</p>
<p><strong>注意：在转字符串时：</strong></p>
<ul>
<li><strong>会 将类似</strong> <code>**&lt;**</code> <strong>直接转为</strong> <code>**&lt;**</code></li>
<li><strong>会将</strong><code>**&lt;p&gt;**</code> <strong>这样的自动补全为</strong> <code>**&lt;p&gt;&lt;/p&gt;**</code></li>
</ul>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657785219591-105ece0c-a99c-4215-b3e3-785f767b19ad.png" alt="img"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  src\compiler\parser\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert HTML string to AST.</span></span><br><span class="line"><span class="comment"> * 将 html 字符串 转换为 AST</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parse</span> (</span><br><span class="line">  <span class="attr">template</span>: string,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">ASTElement</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">const</span> stack = []</span><br><span class="line">  <span class="keyword">let</span> root</span><br><span class="line">  ...</span><br><span class="line">    <span class="title function_">parseHTML</span>(template, &#123;</span><br><span class="line">    warn,</span><br><span class="line">    <span class="attr">expectHTML</span>: options.<span class="property">expectHTML</span>,</span><br><span class="line">    <span class="attr">isUnaryTag</span>: options.<span class="property">isUnaryTag</span>,</span><br><span class="line">    <span class="attr">canBeLeftOpenTag</span>: options.<span class="property">canBeLeftOpenTag</span>,</span><br><span class="line">    <span class="attr">shouldDecodeNewlines</span>: options.<span class="property">shouldDecodeNewlines</span>,</span><br><span class="line">    <span class="attr">shouldDecodeNewlinesForHref</span>: options.<span class="property">shouldDecodeNewlinesForHref</span>,</span><br><span class="line">    <span class="attr">shouldKeepComment</span>: options.<span class="property">comments</span>,</span><br><span class="line">    <span class="attr">outputSourceRange</span>: options.<span class="property">outputSourceRange</span>,</span><br><span class="line">    start (tag, attrs, unary, start, end) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    end (tag, start, end) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    chars (<span class="attr">text</span>: string, <span class="attr">start</span>: number, <span class="attr">end</span>: number) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line">    comment (<span class="attr">text</span>: string, start, end) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-1-start"><a href="#3-1-1-start" class="headerlink" title="3.1.1 start"></a>3.1.1 <code>start</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">start (tag, attrs, unary, start, end) &#123;</span><br><span class="line">      <span class="comment">// start tag 开头标签回调后执行</span></span><br><span class="line">      <span class="comment">// check namespace.</span></span><br><span class="line">      <span class="comment">// inherit parent ns if there is one</span></span><br><span class="line">      <span class="keyword">const</span> ns = (currentParent &amp;&amp; currentParent.<span class="property">ns</span>) || <span class="title function_">platformGetTagNamespace</span>(tag)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// handle IE svg bug</span></span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (isIE &amp;&amp; ns === <span class="string">&#x27;svg&#x27;</span>) &#123;</span><br><span class="line">        attrs = <span class="title function_">guardIESVGBug</span>(attrs)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建 AST 节点</span></span><br><span class="line">      <span class="keyword">let</span> <span class="attr">element</span>: <span class="title class_">ASTElement</span> = <span class="title function_">createASTElement</span>(tag, attrs, currentParent)</span><br><span class="line">      <span class="keyword">if</span> (ns) &#123;</span><br><span class="line">        element.<span class="property">ns</span> = ns</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="comment">// apply pre-transforms</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; preTransforms.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        element = preTransforms[i](element, options) || element</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!inVPre) &#123;</span><br><span class="line">        <span class="title function_">processPre</span>(element)</span><br><span class="line">        <span class="keyword">if</span> (element.<span class="property">pre</span>) &#123;</span><br><span class="line">          inVPre = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">platformIsPreTag</span>(element.<span class="property">tag</span>)) &#123;</span><br><span class="line">        inPre = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (inVPre) &#123;</span><br><span class="line">        <span class="title function_">processRawAttrs</span>(element)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!element.<span class="property">processed</span>) &#123;</span><br><span class="line">        <span class="comment">// structural directives</span></span><br><span class="line">        <span class="comment">// 处理指令: v-for v-if v-once</span></span><br><span class="line">        <span class="title function_">processFor</span>(element)</span><br><span class="line">        <span class="title function_">processIf</span>(element)</span><br><span class="line">        <span class="title function_">processOnce</span>(element)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">        root = element</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">          <span class="title function_">checkRootConstraints</span>(root)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 闭合标签将 ast element 存入stack</span></span><br><span class="line">      <span class="keyword">if</span> (!unary) &#123;</span><br><span class="line">        currentParent = element</span><br><span class="line">        stack.<span class="title function_">push</span>(element)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 非闭合标签关闭元素</span></span><br><span class="line">        <span class="title function_">closeElement</span>(element)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<h4 id="3-1-1-1-createASTElement-AST-节点-结构"><a href="#3-1-1-1-createASTElement-AST-节点-结构" class="headerlink" title="3.1.1.1 createASTElement AST 节点 结构"></a>3.1.1.1 <code>createASTElement</code> AST 节点 结构</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\parser\index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createASTElement</span> (</span><br><span class="line">  <span class="attr">tag</span>: string,</span><br><span class="line">  <span class="attr">attrs</span>: <span class="title class_">Array</span>&lt;<span class="title class_">ASTAttr</span>&gt;,</span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">ASTElement</span> | <span class="keyword">void</span></span><br><span class="line">): <span class="title class_">ASTElement</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="number">1</span>, <span class="comment">// 节点类型</span></span><br><span class="line">    tag, <span class="comment">// 节点名称</span></span><br><span class="line">    <span class="attr">attrsList</span>: attrs, <span class="comment">// 属性列表</span></span><br><span class="line">    <span class="attr">attrsMap</span>: <span class="title function_">makeAttrsMap</span>(attrs), <span class="comment">// 属性 Map</span></span><br><span class="line">    <span class="attr">rawAttrsMap</span>: &#123;&#125;, <span class="comment">// </span></span><br><span class="line">    parent, <span class="comment">// 父节点</span></span><br><span class="line">    <span class="attr">children</span>: []  <span class="comment">// 子节点</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>【辅助】 <code>makeAttrsMap()</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回转换 attrs 后的map，key 是 attr[i].name, value 是 attrs[i].value</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeAttrsMap</span> (<span class="attr">attrs</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Object</span>&gt;): <span class="title class_">Object</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> map = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = attrs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">      map[attrs[i].<span class="property">name</span>] &amp;&amp; !isIE &amp;&amp; !isEdge</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(<span class="string">&#x27;duplicate attribute: &#x27;</span> + attrs[i].<span class="property">name</span>, attrs[i])</span><br><span class="line">    &#125;</span><br><span class="line">    map[attrs[i].<span class="property">name</span>] = attrs[i].<span class="property">value</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-2-end"><a href="#3-1-2-end" class="headerlink" title="3.1.2 end"></a>3.1.2 <code>end</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">end (tag, start, end) &#123;</span><br><span class="line">      <span class="comment">// end tag 结尾标签回调后执行</span></span><br><span class="line">      <span class="keyword">const</span> element = stack[stack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">      <span class="comment">// pop stack</span></span><br><span class="line">      <span class="comment">// 出栈，重置当前的父节点</span></span><br><span class="line">      stack.<span class="property">length</span> -= <span class="number">1</span></span><br><span class="line">      currentParent = stack[stack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">        element.<span class="property">end</span> = end</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">closeElement</span>(element)</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="3-1-3-chars"><a href="#3-1-3-chars" class="headerlink" title="3.1.3 chars"></a>3.1.3 <code>chars</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">chars (<span class="attr">text</span>: string, <span class="attr">start</span>: number, <span class="attr">end</span>: number) &#123;</span><br><span class="line">     <span class="comment">// 文本 回调后执行</span></span><br><span class="line">     <span class="comment">// 文本节点外如果没有父节点则不处理报错</span></span><br><span class="line">     <span class="keyword">if</span> (!currentParent) &#123;</span><br><span class="line">       <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (text === template) &#123;</span><br><span class="line">           <span class="title function_">warnOnce</span>(</span><br><span class="line">             <span class="string">&#x27;Component template requires a root element, rather than just text.&#x27;</span>,</span><br><span class="line">             &#123; start &#125;</span><br><span class="line">           )</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((text = text.<span class="title function_">trim</span>())) &#123;</span><br><span class="line">           <span class="title function_">warnOnce</span>(</span><br><span class="line">             <span class="string">`text &quot;<span class="subst">$&#123;text&#125;</span>&quot; outside root element will be ignored.`</span>,</span><br><span class="line">             &#123; start &#125;</span><br><span class="line">           )</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// IE textarea placeholder bug</span></span><br><span class="line">     <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">     <span class="keyword">if</span> (isIE &amp;&amp;</span><br><span class="line">       currentParent.<span class="property">tag</span> === <span class="string">&#x27;textarea&#x27;</span> &amp;&amp;</span><br><span class="line">       currentParent.<span class="property">attrsMap</span>.<span class="property">placeholder</span> === text</span><br><span class="line">     ) &#123;</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">const</span> children = currentParent.<span class="property">children</span></span><br><span class="line">     <span class="keyword">if</span> (inPre || text.<span class="title function_">trim</span>()) &#123;</span><br><span class="line">       text = <span class="title function_">isTextTag</span>(currentParent) ? text : <span class="title function_">decodeHTMLCached</span>(text)</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!children.<span class="property">length</span>) &#123;</span><br><span class="line">       <span class="comment">// remove the whitespace-only node right after an opening tag</span></span><br><span class="line">       text = <span class="string">&#x27;&#x27;</span></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (whitespaceOption) &#123;</span><br><span class="line">       <span class="keyword">if</span> (whitespaceOption === <span class="string">&#x27;condense&#x27;</span>) &#123;</span><br><span class="line">         <span class="comment">// in condense mode, remove the whitespace node if it contains</span></span><br><span class="line">         <span class="comment">// line break, otherwise condense to a single space</span></span><br><span class="line">         text = lineBreakRE.<span class="title function_">test</span>(text) ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; &#x27;</span></span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         text = <span class="string">&#x27; &#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       text = preserveWhitespace ? <span class="string">&#x27; &#x27;</span> : <span class="string">&#x27;&#x27;</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (text) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!inPre &amp;&amp; whitespaceOption === <span class="string">&#x27;condense&#x27;</span>) &#123;</span><br><span class="line">         <span class="comment">// condense consecutive whitespaces into single space</span></span><br><span class="line">         text = text.<span class="title function_">replace</span>(whitespaceRE, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">let</span> res</span><br><span class="line">       <span class="keyword">let</span> <span class="attr">child</span>: ?<span class="title class_">ASTNode</span></span><br><span class="line">       <span class="keyword">if</span> (!inVPre &amp;&amp; text !== <span class="string">&#x27; &#x27;</span> &amp;&amp; (res = <span class="title function_">parseText</span>(text, delimiters))) &#123;</span><br><span class="line">         <span class="comment">// 表达式</span></span><br><span class="line">         child = &#123;</span><br><span class="line">           <span class="attr">type</span>: <span class="number">2</span>,</span><br><span class="line">           <span class="attr">expression</span>: res.<span class="property">expression</span>,</span><br><span class="line">           <span class="attr">tokens</span>: res.<span class="property">tokens</span>,</span><br><span class="line">           text</span><br><span class="line">         &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (text !== <span class="string">&#x27; &#x27;</span> || !children.<span class="property">length</span> || children[children.<span class="property">length</span> - <span class="number">1</span>].<span class="property">text</span> !== <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">         <span class="comment">// 静态文本</span></span><br><span class="line">         child = &#123;</span><br><span class="line">           <span class="attr">type</span>: <span class="number">3</span>,</span><br><span class="line">           text</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (child) &#123;</span><br><span class="line">         <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">           child.<span class="property">start</span> = start</span><br><span class="line">           child.<span class="property">end</span> = end</span><br><span class="line">         &#125;</span><br><span class="line">         children.<span class="title function_">push</span>(child)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="3-1-4-comment"><a href="#3-1-4-comment" class="headerlink" title="3.1.4 comment"></a>3.1.4 <code>comment</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">comment (<span class="attr">text</span>: string, start, end) &#123;</span><br><span class="line">      <span class="comment">// 注释代码 回调后执行</span></span><br><span class="line">      <span class="comment">// adding anything as a sibling to the root node is forbidden</span></span><br><span class="line">      <span class="comment">// comments should still be allowed, but ignored</span></span><br><span class="line">      <span class="keyword">if</span> (currentParent) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">child</span>: <span class="title class_">ASTText</span> = &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="number">3</span>,</span><br><span class="line">          text,</span><br><span class="line">          <span class="attr">isComment</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">          child.<span class="property">start</span> = start</span><br><span class="line">          child.<span class="property">end</span> = end</span><br><span class="line">        &#125;</span><br><span class="line">        currentParent.<span class="property">children</span>.<span class="title function_">push</span>(child)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-parseHTML"><a href="#3-2-parseHTML" class="headerlink" title="3.2 parseHTML()"></a>3.2 <code>parseHTML()</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src\compiler\parser\html-parser.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据 options ，对 html字符串 遍历，生成核心参数 match, attrs,</span></span><br><span class="line"><span class="comment"> * 再通过如 options.start(tagName, attrs, unary, match.start, match.end) 回调 parse 中的start, end, chars, comment 方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; html </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; options </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">  <span class="keyword">const</span> stack = [] <span class="comment">// 存 非单标签</span></span><br><span class="line">  <span class="keyword">const</span> expectHTML = options.<span class="property">expectHTML</span></span><br><span class="line">  <span class="keyword">const</span> isUnaryTag = options.<span class="property">isUnaryTag</span> || no</span><br><span class="line">  <span class="keyword">const</span> canBeLeftOpenTag = options.<span class="property">canBeLeftOpenTag</span> || no</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> last, lastTag</span><br><span class="line">  <span class="comment">// 通过 advance 方法递减 html 字符串，直至html为空表示将html全部遍历，结束循环</span></span><br><span class="line">  <span class="keyword">while</span> (html) &#123;</span><br><span class="line">    last = html</span><br><span class="line">    <span class="comment">// Make sure we&#x27;re not in a plaintext content element like script/style</span></span><br><span class="line">    <span class="keyword">if</span> (!lastTag || !<span class="title function_">isPlainTextElement</span>(lastTag)) &#123;</span><br><span class="line">      <span class="keyword">let</span> textEnd = html.<span class="title function_">indexOf</span>(<span class="string">&#x27;&lt;&#x27;</span>)</span><br><span class="line">      <span class="comment">// 以 &lt; 开头</span></span><br><span class="line">      <span class="keyword">if</span> (textEnd === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Comment:</span></span><br><span class="line">        <span class="comment">// 匹配 &lt;!-- 开头  (/^&lt;!\--/ )</span></span><br><span class="line">        <span class="keyword">if</span> (comment.<span class="title function_">test</span>(html)) &#123;</span><br><span class="line">          <span class="keyword">const</span> commentEnd = html.<span class="title function_">indexOf</span>(<span class="string">&#x27;--&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 匹配到注释 &lt;!--  --&gt;</span></span><br><span class="line">          <span class="keyword">if</span> (commentEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (options.<span class="property">shouldKeepComment</span>) &#123;</span><br><span class="line">              <span class="comment">// options.comment 回调</span></span><br><span class="line">              options.<span class="title function_">comment</span>(html.<span class="title function_">substring</span>(<span class="number">4</span>, commentEnd), index, index + commentEnd + <span class="number">3</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 截取 注释结束位+3 后 html 片段 ，相当于 参数html 删掉 已匹配的 注释 字符串</span></span><br><span class="line">            <span class="title function_">advance</span>(commentEnd + <span class="number">3</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// http://en.wikipedia.org/wiki/Conditional_comment#Downlevel-revealed_conditional_comment</span></span><br><span class="line">        <span class="comment">// 匹配 条件注释 ![ 开头   /^&lt;!\[/</span></span><br><span class="line">        <span class="keyword">if</span> (conditionalComment.<span class="title function_">test</span>(html)) &#123;</span><br><span class="line">          <span class="keyword">const</span> conditionalEnd = html.<span class="title function_">indexOf</span>(<span class="string">&#x27;]&gt;&#x27;</span>)</span><br><span class="line">          <span class="comment">// 匹配到条件注释 &lt;![]&gt; , 如 ![if !IE]</span></span><br><span class="line">          <span class="keyword">if</span> (conditionalEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="title function_">advance</span>(conditionalEnd + <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Doctype:</span></span><br><span class="line">        <span class="comment">// 匹配到 &lt;!DOCTYPE &gt; 删掉</span></span><br><span class="line">        <span class="keyword">const</span> doctypeMatch = html.<span class="title function_">match</span>(doctype)</span><br><span class="line">        <span class="keyword">if</span> (doctypeMatch) &#123;</span><br><span class="line">          <span class="title function_">advance</span>(doctypeMatch[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// End tag:</span></span><br><span class="line">        <span class="comment">// 匹配 &lt;/ **&gt; 结束标签</span></span><br><span class="line">        <span class="keyword">const</span> endTagMatch = html.<span class="title function_">match</span>(endTag)</span><br><span class="line">        <span class="keyword">if</span> (endTagMatch) &#123;</span><br><span class="line">          <span class="keyword">const</span> curIndex = index</span><br><span class="line">          <span class="title function_">advance</span>(endTagMatch[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">          <span class="title function_">parseEndTag</span>(endTagMatch[<span class="number">1</span>], curIndex, index)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start tag:</span></span><br><span class="line">        <span class="comment">// 匹配 &lt;**&gt; 开始标签</span></span><br><span class="line">        <span class="keyword">const</span> startTagMatch = <span class="title function_">parseStartTag</span>()</span><br><span class="line">        <span class="keyword">if</span> (startTagMatch) &#123;</span><br><span class="line">          <span class="title function_">handleStartTag</span>(startTagMatch)</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">shouldIgnoreFirstNewline</span>(startTagMatch.<span class="property">tagName</span>, html)) &#123;</span><br><span class="line">            <span class="title function_">advance</span>(<span class="number">1</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> text, rest, next</span><br><span class="line">      <span class="comment">// 参数html 中有 &lt;</span></span><br><span class="line">      <span class="keyword">if</span> (textEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        rest = html.<span class="title function_">slice</span>(textEnd)</span><br><span class="line">        <span class="comment">// 根据这些判断条件知，这个 if 部分的 &lt; 是文本 &lt;</span></span><br><span class="line">        <span class="comment">// 循环 &lt; 后的字符串</span></span><br><span class="line">        <span class="keyword">while</span> (</span><br><span class="line">          !endTag.<span class="title function_">test</span>(rest) &amp;&amp;</span><br><span class="line">          !startTagOpen.<span class="title function_">test</span>(rest) &amp;&amp;</span><br><span class="line">          !comment.<span class="title function_">test</span>(rest) &amp;&amp;</span><br><span class="line">          !conditionalComment.<span class="title function_">test</span>(rest)</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="comment">// &lt; in plain text, be forgiving and treat it as text</span></span><br><span class="line">          next = rest.<span class="title function_">indexOf</span>(<span class="string">&#x27;&lt;&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">if</span> (next &lt; <span class="number">0</span>) <span class="keyword">break</span></span><br><span class="line">          textEnd += next</span><br><span class="line">          rest = html.<span class="title function_">slice</span>(textEnd)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据实践，页面中直接写的&lt;,变成字符串html后，会被转换为 &amp;lt; 并不会进上方的 while 循环</span></span><br><span class="line">        <span class="comment">// text 获取的是普通文本</span></span><br><span class="line">        text = html.<span class="title function_">substring</span>(<span class="number">0</span>, textEnd)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 参数html 中没有 &lt;</span></span><br><span class="line">      <span class="keyword">if</span> (textEnd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        text = html</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (text) &#123;</span><br><span class="line">        <span class="title function_">advance</span>(text.<span class="property">length</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果存在 text 文本，则处理 普通文本 的回调</span></span><br><span class="line">      <span class="comment">// 调用 options.chars 回调</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">chars</span> &amp;&amp; text) &#123;</span><br><span class="line">        options.<span class="title function_">chars</span>(text, index - text.<span class="property">length</span>, index)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 处理结束标签</span></span><br><span class="line">      <span class="keyword">let</span> endTagLength = <span class="number">0</span></span><br><span class="line">      <span class="keyword">const</span> stackedTag = lastTag.<span class="title function_">toLowerCase</span>()</span><br><span class="line">      <span class="keyword">const</span> reStackedTag = reCache[stackedTag] || (reCache[stackedTag] = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&#x27;([\\s\\S]*?)(&lt;/&#x27;</span> + stackedTag + <span class="string">&#x27;[^&gt;]*&gt;)&#x27;</span>, <span class="string">&#x27;i&#x27;</span>))</span><br><span class="line">      <span class="keyword">const</span> rest = html.<span class="title function_">replace</span>(reStackedTag, <span class="keyword">function</span> (<span class="params">all, text, endTag</span>) &#123;</span><br><span class="line">        endTagLength = endTag.<span class="property">length</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">isPlainTextElement</span>(stackedTag) &amp;&amp; stackedTag !== <span class="string">&#x27;noscript&#x27;</span>) &#123;</span><br><span class="line">          text = text</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&lt;!\--([\s\S]*?)--&gt;/g</span>, <span class="string">&#x27;$1&#x27;</span>) <span class="comment">// #7298</span></span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&lt;!\[CDATA\[([\s\S]*?)]]&gt;/g</span>, <span class="string">&#x27;$1&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">shouldIgnoreFirstNewline</span>(stackedTag, text)) &#123;</span><br><span class="line">          text = text.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">chars</span>) &#123;</span><br><span class="line">          options.<span class="title function_">chars</span>(text)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line">      index += html.<span class="property">length</span> - rest.<span class="property">length</span></span><br><span class="line">      html = rest</span><br><span class="line">      <span class="title function_">parseEndTag</span>(stackedTag, index - endTagLength, index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (html === last) &#123;</span><br><span class="line">      options.<span class="property">chars</span> &amp;&amp; options.<span class="title function_">chars</span>(html)</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !stack.<span class="property">length</span> &amp;&amp; options.<span class="property">warn</span>) &#123;</span><br><span class="line">        options.<span class="title function_">warn</span>(<span class="string">`Mal-formatted tag at end of template: &quot;<span class="subst">$&#123;html&#125;</span>&quot;`</span>, &#123; <span class="attr">start</span>: index + html.<span class="property">length</span> &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clean up any remaining tags</span></span><br><span class="line">  <span class="title function_">parseEndTag</span>()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-1-advance"><a href="#3-2-1-advance" class="headerlink" title="3.2.1 advance"></a>3.2.1 <code>advance</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 截取 index + n 后的 html （即删除掉 n 前的字符串）</span></span><br><span class="line"><span class="comment">   * 处理后的标签从html中删除，index 位置相应后移n</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"></span>&#125; <span class="variable">n</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">advance</span> (n) &#123;</span><br><span class="line">    index += n</span><br><span class="line">    html = html.<span class="title function_">substring</span>(n)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-parseStartTag"><a href="#3-2-2-parseStartTag" class="headerlink" title="3.2.2  parseStartTag"></a>3.2.2  <code>parseStartTag</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理 开始标签 ，将 html 转换为 对象match 格式</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">parseStartTag</span> () &#123;</span><br><span class="line">    <span class="keyword">const</span> start = html.<span class="title function_">match</span>(startTagOpen)</span><br><span class="line">    <span class="keyword">if</span> (start) &#123;</span><br><span class="line">      <span class="keyword">const</span> match = &#123;</span><br><span class="line">        <span class="attr">tagName</span>: start[<span class="number">1</span>],</span><br><span class="line">        <span class="attr">attrs</span>: [],</span><br><span class="line">        <span class="attr">start</span>: index</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">advance</span>(start[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">      <span class="keyword">let</span> end, attr</span><br><span class="line">      <span class="comment">// 把 标签内 属性赋值给match</span></span><br><span class="line">      <span class="keyword">while</span> (!(end = html.<span class="title function_">match</span>(startTagClose)) &amp;&amp; (attr = html.<span class="title function_">match</span>(dynamicArgAttribute) || html.<span class="title function_">match</span>(attribute))) &#123;</span><br><span class="line">        attr.<span class="property">start</span> = index</span><br><span class="line">        <span class="title function_">advance</span>(attr[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">        attr.<span class="property">end</span> = index</span><br><span class="line">        match.<span class="property">attrs</span>.<span class="title function_">push</span>(attr)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果有 结束 的标签</span></span><br><span class="line">      <span class="keyword">if</span> (end) &#123;</span><br><span class="line">        match.<span class="property">unarySlash</span> = end[<span class="number">1</span>]</span><br><span class="line">        <span class="comment">// 清掉此句 ，随遍历，随清除</span></span><br><span class="line">        <span class="title function_">advance</span>(end[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">        match.<span class="property">end</span> = index</span><br><span class="line">        <span class="keyword">return</span> match</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例：遍历到 <code>&lt;textarea :value=&quot;input + newDate()&quot; @input=&quot;update&quot;&gt;</code>，<code>parseStartTag()</code> 得到的 match如下图：</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657791625682-d817e676-e28a-4c56-99a1-e8e894bc8180.png" alt="img"></p>
<h3 id="3-2-3-handleStartTag"><a href="#3-2-3-handleStartTag" class="headerlink" title="3.2.3 handleStartTag"></a>3.2.3 <code>handleStartTag</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理 参数match，得到新格式 attrs，</span></span><br><span class="line"><span class="comment">   * 未闭合标签入栈，</span></span><br><span class="line"><span class="comment">   * 回调 start</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; match </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">handleStartTag</span> (match) &#123;</span><br><span class="line">    <span class="keyword">const</span> tagName = match.<span class="property">tagName</span></span><br><span class="line">    <span class="keyword">const</span> unarySlash = match.<span class="property">unarySlash</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (expectHTML) &#123;</span><br><span class="line">      <span class="keyword">if</span> (lastTag === <span class="string">&#x27;p&#x27;</span> &amp;&amp; <span class="title function_">isNonPhrasingTag</span>(tagName)) &#123;</span><br><span class="line">        <span class="title function_">parseEndTag</span>(lastTag)</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">/*       export const canBeLeftOpenTag = makeMap(</span></span><br><span class="line"><span class="comment">        &#x27;colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr,source&#x27;</span></span><br><span class="line"><span class="comment">      ) */</span></span><br><span class="line">      <span class="comment">// 针对可以省略 结果标签 的，自动当作已有结尾标签进行处理</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">canBeLeftOpenTag</span>(tagName) &amp;&amp; lastTag === tagName) &#123;</span><br><span class="line">        <span class="title function_">parseEndTag</span>(tagName)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> unary = <span class="title function_">isUnaryTag</span>(tagName) || !!unarySlash</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历处理 attrs 按照新格式</span></span><br><span class="line">    <span class="keyword">const</span> l = match.<span class="property">attrs</span>.<span class="property">length</span></span><br><span class="line">    <span class="keyword">const</span> attrs = <span class="keyword">new</span> <span class="title class_">Array</span>(l)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> args = match.<span class="property">attrs</span>[i]</span><br><span class="line">      <span class="comment">// 这里的 3、4、5 分别对应三种不同复制属性的方式</span></span><br><span class="line">      <span class="comment">// 3: attr=&quot;xxx&quot; 双引号</span></span><br><span class="line">      <span class="comment">// 4: attr=&#x27;xxx&#x27; 单引号</span></span><br><span class="line">      <span class="comment">// 5: attr=xxx   省略引号</span></span><br><span class="line">      <span class="keyword">const</span> value = args[<span class="number">3</span>] || args[<span class="number">4</span>] || args[<span class="number">5</span>] || <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="keyword">const</span> shouldDecodeNewlines = tagName === <span class="string">&#x27;a&#x27;</span> &amp;&amp; args[<span class="number">1</span>] === <span class="string">&#x27;href&#x27;</span></span><br><span class="line">        ? options.<span class="property">shouldDecodeNewlinesForHref</span></span><br><span class="line">        : options.<span class="property">shouldDecodeNewlines</span></span><br><span class="line">      attrs[i] = &#123;</span><br><span class="line">        <span class="attr">name</span>: args[<span class="number">1</span>],</span><br><span class="line">        <span class="attr">value</span>: <span class="title function_">decodeAttr</span>(value, shouldDecodeNewlines)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">        attrs[i].<span class="property">start</span> = args.<span class="property">start</span> + args[<span class="number">0</span>].<span class="title function_">match</span>(<span class="regexp">/^\s*/</span>).<span class="property">length</span></span><br><span class="line">        attrs[i].<span class="property">end</span> = args.<span class="property">end</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!unary) &#123;</span><br><span class="line">      <span class="comment">// 非单标签，入栈</span></span><br><span class="line">      stack.<span class="title function_">push</span>(&#123; <span class="attr">tag</span>: tagName, <span class="attr">lowerCasedTag</span>: tagName.<span class="title function_">toLowerCase</span>(), <span class="attr">attrs</span>: attrs, <span class="attr">start</span>: match.<span class="property">start</span>, <span class="attr">end</span>: match.<span class="property">end</span> &#125;)</span><br><span class="line">      lastTag = tagName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">start</span>) &#123;</span><br><span class="line">      <span class="comment">// 回调 start</span></span><br><span class="line">      options.<span class="title function_">start</span>(tagName, attrs, unary, match.<span class="property">start</span>, match.<span class="property">end</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例：遍历到 <code>&lt;textarea :value=&quot;input + newDate()&quot; @input=&quot;update&quot;&gt;</code>，<code>handleStartTag()</code> 得到的 <code>attrs</code>如下图：</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657791747470-3a4ab7c5-48a7-4584-abc5-3f1545ce6a2f.png" alt="img"></p>
<h3 id="3-2-4-parseEndTag"><a href="#3-2-4-parseEndTag" class="headerlink" title="3.2.4 parseEndTag"></a>3.2.4 <code>parseEndTag</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理结束标签：</span></span><br><span class="line"><span class="comment">   * 先找未闭合标签的位置pos，回调 end，并在栈中删除已关闭标签</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; tagName </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; start </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; end </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">parseEndTag</span> (tagName, start, end) &#123;</span><br><span class="line">    <span class="keyword">let</span> pos, lowerCasedTagName</span><br><span class="line">    <span class="keyword">if</span> (start == <span class="literal">null</span>) start = index</span><br><span class="line">    <span class="keyword">if</span> (end == <span class="literal">null</span>) end = index</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the closest opened tag of the same type</span></span><br><span class="line">    <span class="keyword">if</span> (tagName) &#123;</span><br><span class="line">      lowerCasedTagName = tagName.<span class="title function_">toLowerCase</span>()</span><br><span class="line">      <span class="comment">// 寻找相同类型的未闭合标签的位置 pos</span></span><br><span class="line">      <span class="keyword">for</span> (pos = stack.<span class="property">length</span> - <span class="number">1</span>; pos &gt;= <span class="number">0</span>; pos--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stack[pos].<span class="property">lowerCasedTag</span> === lowerCasedTagName) &#123;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// If no tag name is provided, clean shop</span></span><br><span class="line">      pos = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Close all the open elements, up the stack</span></span><br><span class="line">      <span class="comment">// 有 pos 位置，如果能和 未闭合stack 栈中匹配（即 stack.length - 1 == pos），则回调 end</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = stack.<span class="property">length</span> - <span class="number">1</span>; i &gt;= pos; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">          (i &gt; pos || !tagName) &amp;&amp;</span><br><span class="line">          options.<span class="property">warn</span></span><br><span class="line">        ) &#123;</span><br><span class="line">          options.<span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`tag &lt;<span class="subst">$&#123;stack[i].tag&#125;</span>&gt; has no matching end tag.`</span>,</span><br><span class="line">            &#123; <span class="attr">start</span>: stack[i].<span class="property">start</span>, <span class="attr">end</span>: stack[i].<span class="property">end</span> &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">end</span>) &#123;</span><br><span class="line">          options.<span class="title function_">end</span>(stack[i].<span class="property">tag</span>, start, end)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Remove the open elements from the stack</span></span><br><span class="line">      <span class="comment">// 并在栈中删除已关闭标签</span></span><br><span class="line">      stack.<span class="property">length</span> = pos</span><br><span class="line">      lastTag = pos &amp;&amp; stack[pos - <span class="number">1</span>].<span class="property">tag</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lowerCasedTagName === <span class="string">&#x27;br&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">start</span>) &#123;</span><br><span class="line">        options.<span class="title function_">start</span>(tagName, [], <span class="literal">true</span>, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lowerCasedTagName === <span class="string">&#x27;p&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">start</span>) &#123;</span><br><span class="line">        options.<span class="title function_">start</span>(tagName, [], <span class="literal">false</span>, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">end</span>) &#123;</span><br><span class="line">        options.<span class="title function_">end</span>(tagName, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-optimize"><a href="#4-optimize" class="headerlink" title="4. optimize()"></a>4. <code>optimize()</code></h1><p>同 3 中模板，</p>
<p>如下创建入口，引出 <code>optimize</code>方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">optimize</span>(ast, options)</span><br></pre></td></tr></table></figure>

<p>得到 ast 结构如下图：</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657792178113-75f71a19-6e80-4005-a2b6-ae44cbe3057e.png" alt="img"></p>
<p>对比上一步的ast，多了一个 static，staticRoot。</p>
<p>具体原因，之后再继续琢磨。</p>
<h1 id="5-generate"><a href="#5-generate" class="headerlink" title="5. generate()"></a>5. <code>generate()</code></h1><p>同 3 中模板，</p>
<p>如下创建入口，引出 <code>generate</code>方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="title function_">generate</span>(ast, options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>得到 code 如下图：</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657798847942-c8230cb1-d174-49b3-9dd1-0a76bf3d767a.png" alt="img"></p>
<h2 id="render-创建了！"><a href="#render-创建了！" class="headerlink" title="render 创建了！"></a>render 创建了！</h2><h2 id="render-的结构："><a href="#render-的结构：" class="headerlink" title="render 的结构："></a><code>render</code> 的结构：</h2><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657798935121-e07f3e38-a733-49b2-bf8f-f01a761124e5.png" alt="img"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">`with(this)&#123;</span></span><br><span class="line"><span class="string">    return_c(&#x27;div&#x27;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        attrs: &#123;</span></span><br><span class="line"><span class="string">            &quot;id&quot;: &quot;editor&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    [</span></span><br><span class="line"><span class="string">        _v(&quot;\\n      &lt;试试\\\\&lt;\\n      &quot;),</span></span><br><span class="line"><span class="string">        _c(&#x27;textarea&#x27;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            domProps: &#123;</span></span><br><span class="line"><span class="string">                &quot;value&quot;: input+newDate()</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            on: &#123;</span></span><br><span class="line"><span class="string">                &quot;input&quot;: update</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;),</span></span><br><span class="line"><span class="string">        _v(&quot; &quot;),</span></span><br><span class="line"><span class="string">        _c(&#x27;div&#x27;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            domProps: &#123;</span></span><br><span class="line"><span class="string">                &quot;innerHTML&quot;: _s(compiledMarkdown)</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;)</span></span><br><span class="line"><span class="string">    ])</span></span><br><span class="line"><span class="string">&#125;`</span></span><br></pre></td></tr></table></figure>

<p>这里的 _c 对应的是虚拟 DOM 中的 createElement 方法。</p>
<p>其他的下划线方法在 core&#x2F;instance&#x2F;render-helpers 中都有定义。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7064788398304657415">https://juejin.cn/post/7064788398304657415</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6863241580753616903">https://juejin.cn/post/6863241580753616903</a></p>
<p><strong>着重记下这位大佬推荐的</strong> <a href="https://link.juejin.cn/?target=https://jex.im/regulex/"><strong>正则可视化工具</strong></a> <strong>(๑•̀ㅂ•́)و✧</strong></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-06-28</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约5066个字, 16分钟53秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/105-observer-Dep-Watcher/">5. observer/Dep/Watcher</a></h3></div><div class="post-content"><div class="card"><p><h1 id="1-Observer"><a href="#1-Observer" class="headerlink" title="1. Observer"></a>1. Observer</h1><p><strong>【前情回顾】</strong></p>
<p><code>observe()</code> 方法路径：<code>src\core\observer\index.js</code><br><img src="/105-observer-Dep-Watcher/1657836607196-542a783f-2ae7-40e0-a62c-d53b407943ab.png" alt="img"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\index.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Vue</span> (options) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_init</span>(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src\core\instance\init.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options?: <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">    <span class="title function_">initState</span>(vm)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initState</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">data</span>) &#123;</span><br><span class="line">    <span class="title function_">initData</span>(vm)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">observe</span>(vm.<span class="property">_data</span> = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initData</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> data = vm.<span class="property">$options</span>.<span class="property">data</span></span><br><span class="line">  <span class="title function_">observe</span>(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-1-observe"><a href="#1-1-observe" class="headerlink" title="1.1 observe()"></a>1.1 <code>observe()</code></h2><p>对 vm.$options.data 进行响应式处理的入口方法。</p>
<p><strong>核心</strong>就是对符合响应式条件的 value 创建 new Observer 实例。</p>
<p><strong>流程：</strong></p>
<ul>
<li>若 value （vm.options.$data）不是对象或是 Vnode 的实例，则不处理直接 return</li>
<li>若 value 包含属性<code>__ob__</code>，且<code>value.__ob__</code>是 Observer 的实例 (<code>__ob__</code>是 Vue 中响应式对象的 标记 )，则返回已存在的响应式对象</li>
<li>若没有包含<code>__ob__</code>,  则调用 <code>new Observer(value)</code>，创建 响应式对象 实例</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\index.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Attempt to create an observer instance for a value,</span></span><br><span class="line"><span class="comment"> * returns the new observer if successfully observed,</span></span><br><span class="line"><span class="comment"> * or the existing observer if the value already has one.</span></span><br><span class="line"><span class="comment"> * 为 vm.$options.data 创建一个 observer 实例</span></span><br><span class="line"><span class="comment"> * 如果是可响应式的，则返回一个新实例；若已经存在则返回已有实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">observe</span> (<span class="attr">value</span>: any, <span class="attr">asRootData</span>: ?boolean): <span class="title class_">Observer</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// 如果不是对象，或者是 VNode，则不进行响应处理</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(value) || value <span class="keyword">instanceof</span> <span class="title class_">VNode</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">ob</span>: <span class="title class_">Observer</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="comment">// 若本身就是响应式对象则直接返回该实例 value.__ob__</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">hasOwn</span>(value, <span class="string">&#x27;__ob__&#x27;</span>) &amp;&amp; value.<span class="property">__ob__</span> <span class="keyword">instanceof</span> <span class="title class_">Observer</span>) &#123;</span><br><span class="line">    ob = value.<span class="property">__ob__</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    shouldObserve &amp;&amp;</span><br><span class="line">    !<span class="title function_">isServerRendering</span>() &amp;&amp;</span><br><span class="line">    (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value) || <span class="title function_">isPlainObject</span>(value)) &amp;&amp;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">isExtensible</span>(value) &amp;&amp;</span><br><span class="line">    !value.<span class="property">_isVue</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 符合 可响应处理的标志 &amp;&amp; 不是SSR &amp; (数组 || 对象) &amp; 对象可扩展 &amp; 不是 Vue 实例本身，则进行响应式处理</span></span><br><span class="line">    ob = <span class="keyword">new</span> <span class="title class_">Observer</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 每个组件只能有一个根元素，若多个则标记，后续判断时有警告</span></span><br><span class="line">  <span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.<span class="property">vmCount</span>++</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-1-1-new-Observer-value"><a href="#1-1-1-new-Observer-value" class="headerlink" title="1.1.1 new Observer(value)"></a>1.1.1 <code>new Observer(value)</code></h2><p>创建响应式实例，</p>
<p><strong>流程：</strong></p>
<ul>
<li>初始化 value，dep，__ob__，vmCount</li>
<li>若 value 是数组，先对数组原型方法进行响应式处理，再遍历递归至对象，再响应式处理</li>
<li>若 value 是对象，则直接 调用 defineReactive() 进行响应式处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">  <span class="attr">value</span>: any;</span><br><span class="line">  <span class="attr">dep</span>: <span class="title class_">Dep</span>;</span><br><span class="line">  <span class="attr">vmCount</span>: number; <span class="comment">// number of vms that have this object as root $data</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (<span class="attr">value</span>: any) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = value <span class="comment">// 相当于 this.value = vm.options.$data</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dep</span> = <span class="keyword">new</span> <span class="title class_">Dep</span>() <span class="comment">// Dep 创建了</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vmCount</span> = <span class="number">0</span> <span class="comment">// 为0，说明是根实例只有一个，符合规范</span></span><br><span class="line">    <span class="title function_">def</span>(value, <span class="string">&#x27;__ob__&#x27;</span>, <span class="variable language_">this</span>) <span class="comment">// 相当于 value.__ob__ = this，循环引用: 对象.__ob__ </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数组的响应式处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">      <span class="comment">// 判断浏览器是否支持 __prop__</span></span><br><span class="line">      <span class="comment">// 对数组 原型方法 进行响应式处理！</span></span><br><span class="line">      <span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">        <span class="comment">// 相当于 value.__proto__ = arrayMethods</span></span><br><span class="line">        <span class="title function_">protoAugment</span>(value, arrayMethods)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">copyAugment</span>(value, arrayMethods, arrayKeys)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 遍历递归数组的元素，对数组每一项进行递归响应式处理</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">observeArray</span>(value)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 遍历对象的属性, 进行响应式处理</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">walk</span>(value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Walk through all properties and convert them into</span></span><br><span class="line"><span class="comment">   * getter/setters. This method should only be called when</span></span><br><span class="line"><span class="comment">   * value type is Object.</span></span><br><span class="line"><span class="comment">   * 遍历对象，循环进行响应式 defineReactive 处理</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  walk (<span class="attr">obj</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="title function_">defineReactive</span>(obj, keys[i]) <span class="comment">// 响应式处理来了</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Observe a list of Array items.</span></span><br><span class="line"><span class="comment">   * 遍历递归数组，调用响应式方法</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  observeArray (<span class="attr">items</span>: <span class="title class_">Array</span>&lt;any&gt;) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = items.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="title function_">observe</span>(items[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="【辅助】def"><a href="#【辅助】def" class="headerlink" title="【辅助】def"></a>【辅助】<code>def</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\util\lang.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define a property.</span></span><br><span class="line"><span class="comment"> * 相当于 obj.key = val</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">def</span> (<span class="attr">obj</span>: <span class="title class_">Object</span>, <span class="attr">key</span>: string, <span class="attr">val</span>: any, enumerable?: boolean) &#123;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">    <span class="attr">value</span>: val,</span><br><span class="line">    <span class="attr">enumerable</span>: !!enumerable,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="【辅助】arrayMethods"><a href="#【辅助】arrayMethods" class="headerlink" title="【辅助】arrayMethods"></a>【辅助】<code>arrayMethods</code></h4><p>arrayProto： Array 基础类型的原型</p>
<p>arrayMethods： arrayMethods 继承 arrayProto ，arrayMethods 的原型就是 arrayProto 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arrayProto = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> arrayMethods = <span class="title class_">Object</span>.<span class="title function_">create</span>(arrayProto)</span><br></pre></td></tr></table></figure>

<p>运行出来是：</p>
<p><img src="/105-observer-Dep-Watcher/1657270159866-e5c77424-fd69-49cb-93f7-e0edf5b76b0a.png" alt="img"></p>
<h4 id="关于-Object-create-："><a href="#关于-Object-create-：" class="headerlink" title="关于 Object.create()："></a>关于 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create">Object.create()</a><strong>：</strong></h4><p><strong>Object.create()</strong> 方法用于创建一个新对象，使用现有的对象来作为新创建对象的原型（prototype）。</p>
<p>试一个简单的例子，</p>
<p><code>var ob = Object.create(arr)</code> <strong>就是将 arr 的值作为 新对象 ob 的原型</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>]</span><br><span class="line"><span class="keyword">var</span> ob = <span class="title class_">Object</span>.<span class="title function_">create</span>(arr)</span><br></pre></td></tr></table></figure>

<p><img src="/105-observer-Dep-Watcher/1657580592186-b6cda673-e8fe-46fe-9419-714b9715f934.png" alt="img"></p>
<p>若 arr 重新赋值， ob 并不会跟着改变，说明此处是深拷贝，不是指向的引用值：</p>
<p><img src="/105-observer-Dep-Watcher/1657580729546-8f1c7819-9d15-4026-8df7-0923e3311b7a.png" alt="img"></p>
<h4 id="【对Array原型方法进行响应式处理】"><a href="#【对Array原型方法进行响应式处理】" class="headerlink" title="【对Array原型方法进行响应式处理】"></a>【对<code>Array</code>原型方法进行响应式处理】</h4><p><code>Array</code>基本类型有pop, push, shift, unshift 等方法，对其进行响应式处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 constructor 构造函数中处理</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断浏览器是否支持 __prop__</span></span><br><span class="line"><span class="comment">// 对数组 原型方法 进行响应式处理！！</span></span><br><span class="line"><span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">  <span class="comment">// 相当于 value.__proto__ = arrayMethods</span></span><br><span class="line">  <span class="title function_">protoAugment</span>(value, arrayMethods)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="title function_">copyAugment</span>(value, arrayMethods, arrayKeys)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用的工具方法实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// helpers</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Augment a target Object or Array by intercepting</span></span><br><span class="line"><span class="comment"> * the prototype chain using __proto__</span></span><br><span class="line"><span class="comment"> * 数组的原型链修改, 从而使得数组变成响应式的 ( pop, push, shift, unshift, ... ) ！</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">protoAugment</span> (target, <span class="attr">src</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="comment">/* eslint-disable no-proto */</span></span><br><span class="line">  target.<span class="property">__proto__</span> = src</span><br><span class="line">  <span class="comment">/* eslint-enable no-proto */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Augment a target Object or Array by defining</span></span><br><span class="line"><span class="comment"> * hidden properties.</span></span><br><span class="line"><span class="comment"> * 如果浏览器不支持就将这些方法直接混入到当前数组中, 属性访问元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* istanbul ignore next */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copyAugment</span> (<span class="attr">target</span>: <span class="title class_">Object</span>, <span class="attr">src</span>: <span class="title class_">Object</span>, <span class="attr">keys</span>: <span class="title class_">Array</span>&lt;string&gt;) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = keys.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="title function_">def</span>(target, key, src[key])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-1-1-defineReactive-响应式的实现"><a href="#1-1-1-1-defineReactive-响应式的实现" class="headerlink" title="1.1.1.1 defineReactive() 响应式的实现"></a>1.1.1.1 <code>defineReactive()</code> 响应式的实现</h3><p>调用处的 walk 方法中，是循环遍历 obj，然后将 obj 和 obj 中每一个 key 作为入参：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">defineReactive</span>(obj, keys[i])</span><br></pre></td></tr></table></figure>

<p><strong>流程</strong>：</p>
<ul>
<li>通過 Object.getOwnPropertyDesccriptor 获取 obj.key 的属性描述</li>
<li>通过 Object.defineProperty 劫持 obj.key 属性，改写 get、set 方法</li>
<li>当模板填充 data 的属性值时，触发 get 方法，调用 dep.depend() ，收集依赖（收集 Watcher）</li>
<li>当 data 的属性值修改时，触发 set 方法，调用 dep.notify() ，派发更新 （通知所有依赖的 Watcher）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define a reactive property on an Object.</span></span><br><span class="line"><span class="comment"> * 为对象定义一个 可响应式 的属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">defineReactive</span> (</span><br><span class="line">  <span class="attr">obj</span>: <span class="title class_">Object</span>,</span><br><span class="line">  <span class="attr">key</span>: string,</span><br><span class="line">  <span class="attr">val</span>: any,</span><br><span class="line">  customSetter?: ?<span class="title class_">Function</span>,</span><br><span class="line">  shallow?: boolean</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// 创建 new Dep</span></span><br><span class="line">  <span class="comment">// Dep见 3 分析</span></span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>()</span><br><span class="line">  <span class="comment">// 获取对象的属性描述 ( &#123; enumerable: true, writable: true, ... &#125; )</span></span><br><span class="line">  <span class="keyword">const</span> property = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(obj, key)</span><br><span class="line">  <span class="keyword">if</span> (property &amp;&amp; property.<span class="property">configurable</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cater for pre-defined getter/setters</span></span><br><span class="line">  <span class="keyword">const</span> getter = property &amp;&amp; property.<span class="property">get</span></span><br><span class="line">  <span class="keyword">const</span> setter = property &amp;&amp; property.<span class="property">set</span></span><br><span class="line">  <span class="comment">// 若 get 方法未定义，则 val 没有值，就手动给 val 赋值</span></span><br><span class="line">  <span class="keyword">if</span> ((!getter || setter) &amp;&amp; <span class="variable language_">arguments</span>.<span class="property">length</span> === <span class="number">2</span>) &#123;</span><br><span class="line">    val = obj[key]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归子，val 是属性值，递归循环看是否还有子对象|数组</span></span><br><span class="line">  <span class="keyword">let</span> childOb = !shallow &amp;&amp; <span class="title function_">observe</span>(val)</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// get 方法收集依赖</span></span><br><span class="line">    <span class="comment">// 读取 某个属性，就触发 get 方法</span></span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span> <span class="title function_">reactiveGetter</span> () &#123;</span><br><span class="line">      <span class="comment">// 如果已经定义 get 方法可以被继承下来, 不会丢失</span></span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.<span class="title function_">call</span>(obj) : val</span><br><span class="line">      <span class="comment">// 如果有 target 标识，则进行依赖收集</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        <span class="comment">// 收集依赖 （页面 template 中用到 data 中某个 key 时，就触发 get 方法，在 dep 收集对应的 Watcher）     </span></span><br><span class="line">        <span class="comment">// 方法内分析见4.2</span></span><br><span class="line">        dep.<span class="title function_">depend</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 收集子属性</span></span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          childOb.<span class="property">dep</span>.<span class="title function_">depend</span>()</span><br><span class="line">          <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">            <span class="title function_">dependArray</span>(value)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// set 通知依赖</span></span><br><span class="line">    <span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">reactiveSetter</span> (newVal) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.<span class="title function_">call</span>(obj) : val</span><br><span class="line">      <span class="comment">/* eslint-disable no-self-compare */</span></span><br><span class="line">      <span class="comment">// 如果数据没有发生变化 就不会进行派发更新</span></span><br><span class="line">      <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* eslint-enable no-self-compare */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; customSetter) &#123;</span><br><span class="line">        <span class="title function_">customSetter</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// #7981: for accessor properties without setter</span></span><br><span class="line">      <span class="keyword">if</span> (getter &amp;&amp; !setter) <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">        <span class="comment">// 保证了如果已经定义的 set 方法可以被继承下来, 不会丢失</span></span><br><span class="line">        setter.<span class="title function_">call</span>(obj, newVal)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 对新值进行响应式化处理</span></span><br><span class="line">      childOb = !shallow &amp;&amp; <span class="title function_">observe</span>(newVal)</span><br><span class="line">      <span class="comment">// 派发更新 </span></span><br><span class="line">      <span class="comment">// 修改数据，通知页面重新渲染</span></span><br><span class="line">      <span class="comment">// 方法内分析见4.3</span></span><br><span class="line">      dep.<span class="title function_">notify</span>() </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="【辅助】Object-getOwnPropertyDescriptor-obj-prop"><a href="#【辅助】Object-getOwnPropertyDescriptor-obj-prop" class="headerlink" title="【辅助】Object.getOwnPropertyDescriptor(obj, prop)"></a>【辅助】<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor">Object.getOwnPropertyDescriptor(obj, prop)</a></h4><p><strong>Object.getOwnPropertyDescriptor()</strong> 方法返回指定对象上一个自有属性对应的属性描述符。（自有属性指的是直接赋予该对象的属性，不需要从原型链上进行查找的属性）</p>
<p><strong>eg:</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> object1 = &#123;</span><br><span class="line">  <span class="attr">property1</span>: <span class="number">42</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> descriptor1 = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(object1, <span class="string">&#x27;property1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(descriptor1);</span><br><span class="line"><span class="comment">// 结果：</span></span><br><span class="line"><span class="comment">// &gt; Object &#123; value: 42, writable: true, enumerable: true, configurable: true &#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="2-Dep"><a href="#2-Dep" class="headerlink" title="2. Dep"></a>2. <code>Dep</code></h1><h2 id="2-1-new-Dep"><a href="#2-1-new-Dep" class="headerlink" title="2.1 new Dep()"></a>2.1 <code>new Dep()</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span><br><span class="line">  <span class="comment">// target 是 当前 Watcher</span></span><br><span class="line">  <span class="keyword">static</span> <span class="attr">target</span>: ?<span class="title class_">Watcher</span>;</span><br><span class="line">  <span class="attr">id</span>: number;</span><br><span class="line">  <span class="comment">// subs 是所有 Watcher 集合，通过 addSub() 添加</span></span><br><span class="line">  <span class="attr">subs</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Watcher</span>&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = uid++</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subs</span> = []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-depend"><a href="#2-2-depend" class="headerlink" title="2.2 depend()"></a>2.2 <code>depend()</code></h2><p>收集依赖，通知 Watcher （通过调用 Watcher.addDep）收集依赖</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 收集依赖，通知 Watcher 收集</span></span><br><span class="line">depend () &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">    <span class="title class_">Dep</span>.<span class="property">target</span>.<span class="title function_">addDep</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-addSub"><a href="#2-3-addSub" class="headerlink" title="2.3 addSub()"></a>2.3 <code>addSub()</code></h2><p>实际 Dep 收集 Watcher 的方法，将Watcher 存到 subs 数组中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 收集 Watcher，通过 dep.depend() ==&gt; Dep.target.addDep() ==&gt; dep.addSub()</span></span><br><span class="line">addSub (<span class="attr">sub</span>: <span class="title class_">Watcher</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">push</span>(sub)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-4-notify"><a href="#2-4-notify" class="headerlink" title="2.4 notify()"></a>2.4 <code>notify()</code></h2><p>遍历通知 dep.subs 绑定的 Watcher ，更新视图</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 每一个属性 都会包含一个 dep 实例</span></span><br><span class="line"><span class="comment"> * 这个 dep 实例会记录下 参与计算或渲染的 watcher</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 发送通知</span></span><br><span class="line">notify () &#123;</span><br><span class="line">  <span class="comment">// stabilize the subscriber list first</span></span><br><span class="line">  <span class="keyword">const</span> subs = <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">slice</span>()</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !config.<span class="property">async</span>) &#123;</span><br><span class="line">    <span class="comment">// subs aren&#x27;t sorted in scheduler if not running async</span></span><br><span class="line">    <span class="comment">// we need to sort them now to make sure they fire in correct</span></span><br><span class="line">    <span class="comment">// order</span></span><br><span class="line">    subs.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">id</span> - b.<span class="property">id</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = subs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="comment">// 调用对应的 Watcher，更新视图</span></span><br><span class="line">    subs[i].<span class="title function_">update</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-5-pushTarget-，popTarget"><a href="#2-5-pushTarget-，popTarget" class="headerlink" title="2.5 pushTarget()，popTarget()"></a>2.5 <code>pushTarget()</code>，<code>popTarget()</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在 watcher 调用 get 方法的时候, 调用 pushTarget(this)，将 Wather 赋值给 Dep.target</span></span><br><span class="line"><span class="comment"> * 在 watcher 的 get 方法结束的时候, 调用 popTarget()，将 Wather 重置为上一个 target</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// The current target watcher being evaluated.</span></span><br><span class="line"><span class="comment">// This is globally unique because only one watcher</span></span><br><span class="line"><span class="comment">// can be evaluated at a time.</span></span><br><span class="line"><span class="comment">// 全局的容器存储渲染 Watcher</span></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property">target</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> targetStack = []</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将当前操作的 watcher 存储到 全局 watcher 中, 参数 target 就是当前 watcher</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">pushTarget</span> (<span class="attr">target</span>: ?<span class="title class_">Watcher</span>) &#123;</span><br><span class="line">  targetStack.<span class="title function_">push</span>(target)</span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = target</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将 当前 watcher 删掉，重置为上一个</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">popTarget</span> () &#123;</span><br><span class="line">  targetStack.<span class="title function_">pop</span>()</span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = targetStack[targetStack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-Watcher"><a href="#3-Watcher" class="headerlink" title="3. Watcher"></a>3. <code>Watcher</code></h1><p><img src="/105-observer-Dep-Watcher/1658238003604-4cf934a7-91d4-477d-bcd9-f3c55dafe7bc.png" alt="img"></p>
<p><strong>【前情】</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initState</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="comment">// 初始化 options.watch 监听</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">watch</span> &amp;&amp; opts.<span class="property">watch</span> !== nativeWatch) &#123;</span><br><span class="line">    <span class="title function_">initWatch</span>(vm, opts.<span class="property">watch</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-1-Wather初始化"><a href="#3-1-Wather初始化" class="headerlink" title="3.1 Wather初始化"></a>3.1 <code>Wather</code>初始化</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">**initWatch(vm, opts.watch)**</span><br></pre></td></tr></table></figure>

<ul>
<li>遍历 $options.watch，值为数组的继续遍历，</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历 $options.watch, 调用 createWatcher 创建</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; watch </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initWatch</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">watch</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="comment">// 遍历 $options.watch</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> watch) &#123;</span><br><span class="line">    <span class="keyword">const</span> handler = watch[key]</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(handler)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; handler.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">createWatcher</span>(vm, key, handler[i])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">createWatcher</span>(vm, key, handler)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-1-createWatcher-vm-key-handler"><a href="#3-1-1-createWatcher-vm-key-handler" class="headerlink" title="3.1.1 createWatcher(vm, key, handler)"></a>3.1.1 <code>createWatcher(vm, key, handler)</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展 $watch </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; expOrFn </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; handler </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; options </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createWatcher</span> (</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span><br><span class="line">  <span class="attr">expOrFn</span>: string | <span class="title class_">Function</span>,</span><br><span class="line">  <span class="attr">handler</span>: any,</span><br><span class="line">  options?: <span class="title class_">Object</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// 如果是对象，参数移位</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(handler)) &#123;</span><br><span class="line">    options = handler</span><br><span class="line">    handler = handler.<span class="property">handler</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果是字符串，取 vm[handler] 作为方法</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> handler === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    handler = vm[handler]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm.$watch(expOrFn, handler, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-1-1-vm-watch-expOrFn-handler-options"><a href="#3-1-1-1-vm-watch-expOrFn-handler-options" class="headerlink" title="3.1.1.1 vm.$watch(expOrFn, handler, options)"></a>3.1.1.1 <code>vm.$watch(expOrFn, handler, options)</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$watch</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">    expOrFn: string | <span class="built_in">Function</span>,</span></span><br><span class="line"><span class="params">    cb: any,</span></span><br><span class="line"><span class="params">    options?: <span class="built_in">Object</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="comment">// 如果传入的 handler 是对象，则再扩展解析</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(cb)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">createWatcher</span>(vm, expOrFn, cb, options)</span><br><span class="line">    &#125;</span><br><span class="line">    options = options || &#123;&#125;</span><br><span class="line">    options.<span class="property">user</span> = <span class="literal">true</span></span><br><span class="line">     <span class="comment">// 创建 Watcher 实例 !!!</span></span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, expOrFn, cb, options)</span><br><span class="line">    <span class="comment">// 如果 立即执行标志位为 true，则直接执行 handler（cb）函数</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">immediate</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> info = <span class="string">`callback for immediate watcher &quot;<span class="subst">$&#123;watcher.expression&#125;</span>&quot;`</span></span><br><span class="line">      <span class="title function_">pushTarget</span>()</span><br><span class="line">      <span class="title function_">invokeWithErrorHandling</span>(cb, vm, [watcher.<span class="property">value</span>], vm, info)</span><br><span class="line">      <span class="title function_">popTarget</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回取消监听函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unwatchFn</span> () &#123;</span><br><span class="line">      watcher.<span class="title function_">teardown</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-new-Watcher"><a href="#3-2-new-Watcher" class="headerlink" title="3.2 new Watcher()"></a>3.2 <code>new Watcher()</code></h2><h3 id="3-2-1-construcor"><a href="#3-2-1-construcor" class="headerlink" title="3.2.1 construcor"></a>3.2.1 <code>construcor</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\watcher.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A watcher parses an expression, collects dependencies,</span></span><br><span class="line"><span class="comment"> * and fires callback when the expression value changes.</span></span><br><span class="line"><span class="comment"> * This is used for both the $watch() api and directives.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 在 Vue 中使用了 二次提交的概念</span></span><br><span class="line"><span class="comment">// 每次在数据 渲染 或 计算的时候 就会访问响应式的数据, 就会进行依赖收集</span></span><br><span class="line"><span class="comment">// 将关联的 Watcher 与 dep 相关联,</span></span><br><span class="line"><span class="comment">// 在数据发生变化时, 根据 dep 找到关联的 Watcher, 遍历调用 update</span></span><br><span class="line"><span class="comment">// 执行完成后会清空 Watcher</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Watcher</span> &#123;</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span>;</span><br><span class="line">  <span class="attr">expression</span>: string; <span class="comment">// 关联表达式 或 渲染方法体</span></span><br><span class="line">  <span class="attr">cb</span>: <span class="title class_">Function</span>; <span class="comment">// 在定义 Vue 构造函数时，Vue.prototype.$watch</span></span><br><span class="line">  <span class="attr">id</span>: number;</span><br><span class="line">  <span class="attr">deep</span>: boolean; <span class="comment">// 为 true 时，监听对象内部值的变化</span></span><br><span class="line">  <span class="attr">user</span>: boolean;</span><br><span class="line">  <span class="attr">lazy</span>: boolean;  <span class="comment">// 计算属性标记，为 true 时 Watcher 不立即执行</span></span><br><span class="line">  <span class="attr">sync</span>: boolean;</span><br><span class="line">  <span class="attr">dirty</span>: boolean; <span class="comment">// 计算属性时，为 true 时，需重新计算</span></span><br><span class="line">  <span class="attr">active</span>: boolean;</span><br><span class="line">  <span class="attr">deps</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Dep</span>&gt;;</span><br><span class="line">  <span class="attr">newDeps</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Dep</span>&gt;;</span><br><span class="line">  <span class="attr">depIds</span>: <span class="title class_">SimpleSet</span>;</span><br><span class="line">  <span class="attr">newDepIds</span>: <span class="title class_">SimpleSet</span>;</span><br><span class="line">  <span class="attr">before</span>: ?<span class="title class_">Function</span>; <span class="comment">// Watcher 触发之前, 类似于 生命周期</span></span><br><span class="line">  <span class="attr">getter</span>: <span class="title class_">Function</span>; <span class="comment">// 就是 渲染函数 ( 模板或组件的渲染 ) 或 计算函数 ( watch )</span></span><br><span class="line">  <span class="attr">value</span>: any; </span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (</span><br><span class="line">    <span class="attr">vm</span>: <span class="title class_">Component</span>,</span><br><span class="line">    <span class="attr">expOrFn</span>: string | <span class="title class_">Function</span>,</span><br><span class="line">    <span class="attr">cb</span>: <span class="title class_">Function</span>,</span><br><span class="line">    options?: ?<span class="title class_">Object</span>,</span><br><span class="line">    isRenderWatcher?: boolean</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vm</span> = vm</span><br><span class="line">    <span class="keyword">if</span> (isRenderWatcher) &#123;</span><br><span class="line">      vm.<span class="property">_watcher</span> = <span class="variable language_">this</span></span><br><span class="line">    &#125;</span><br><span class="line">    vm.<span class="property">_watchers</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="comment">// options</span></span><br><span class="line">    <span class="keyword">if</span> (options) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">deep</span> = !!options.<span class="property">deep</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">user</span> = !!options.<span class="property">user</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">lazy</span> = !!options.<span class="property">lazy</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">sync</span> = !!options.<span class="property">sync</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">before</span> = options.<span class="property">before</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">deep</span> = <span class="variable language_">this</span>.<span class="property">user</span> = <span class="variable language_">this</span>.<span class="property">lazy</span> = <span class="variable language_">this</span>.<span class="property">sync</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cb</span> = cb</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = ++uid <span class="comment">// uid for batching</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="variable language_">this</span>.<span class="property">lazy</span> <span class="comment">// for lazy watchers</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">deps</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDeps</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">depIds</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDepIds</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">expression</span> = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span></span><br><span class="line">      ? expOrFn.<span class="title function_">toString</span>()</span><br><span class="line">      : <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">// parse expression for getter</span></span><br><span class="line">    <span class="comment">// expOrFn 如果是函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 在 mountComponent 中，</span></span><br><span class="line">    <span class="comment">// updateComponent = () =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//   vm._update(vm._render(), hydrating)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// new Watcher(vm, updateComponent);</span></span><br><span class="line">    <span class="comment">// 所以，这里的 expOrFn 是： </span></span><br><span class="line">    <span class="comment">/* ƒ () &#123;</span></span><br><span class="line"><span class="comment">      vm._update(vm._render(), hydrating);</span></span><br><span class="line"><span class="comment">    &#125; */</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">getter</span> = expOrFn</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">getter</span> = <span class="title function_">parsePath</span>(expOrFn)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">getter</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">getter</span> = noop</span><br><span class="line">        process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Failed watching path: &quot;<span class="subst">$&#123;expOrFn&#125;</span>&quot; `</span> +</span><br><span class="line">          <span class="string">&#x27;Watcher only accepts simple dot-delimited paths. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;For full control, use a function instead.&#x27;</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 不是计算属性，则 调用 get() 初始化取值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="property">lazy</span></span><br><span class="line">      ? <span class="literal">undefined</span></span><br><span class="line">      : <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-get"><a href="#3-2-2-get" class="headerlink" title="3.2.2 get()"></a>3.2.2 <code>get()</code></h3><ul>
<li><p>先 pushTarget(this) ，将当前 Watcher 赋值给 Dep.target</p>
</li>
<li><p>执行 <strong>this.getter</strong> 的方法</p>
</li>
<li><ul>
<li>若 new Watcher() 的 在初始化 mountComponent 时，getter 是 <code>f() &#123;vm._update(vm._render(), hydrating); &#125;</code></li>
<li>若 在 计算属性时，getter 是 $options.computed 遍历的某一项的自定义函数</li>
</ul>
</li>
<li><p>popTarget() 和 cleanupDeps() 清除 Dep.tartget ，清除依赖收集</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Evaluate the getter, and re-collect dependencies.</span></span><br><span class="line"><span class="comment"> * 计算的getter，重新收集依赖</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">get () &#123;</span><br><span class="line">  <span class="comment">// 将 当前 Watcher 赋值给 Dep.target</span></span><br><span class="line">  <span class="title function_">pushTarget</span>(<span class="variable language_">this</span>)</span><br><span class="line">  <span class="keyword">let</span> value</span><br><span class="line">  <span class="keyword">const</span> vm = <span class="variable language_">this</span>.<span class="property">vm</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 this.getter 是函数，则是</span></span><br><span class="line">   <span class="comment">/*  ƒ () &#123;</span></span><br><span class="line"><span class="comment">      vm._update(vm._render(), hydrating);</span></span><br><span class="line"><span class="comment">    &#125; */</span></span><br><span class="line">    <span class="comment">// this.getter 就是 expOrFn，也就是 vm._render</span></span><br><span class="line">    <span class="comment">// vm._render 用来生成虚拟 dom、执行 dom-diff、更新真实 dom</span></span><br><span class="line">    value = <span class="variable language_">this</span>.<span class="property">getter</span>.<span class="title function_">call</span>(vm, vm)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">user</span>) &#123;</span><br><span class="line">      <span class="title function_">handleError</span>(e, vm, <span class="string">`getter for watcher &quot;<span class="subst">$&#123;<span class="variable language_">this</span>.expression&#125;</span>&quot;`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> e</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// &quot;touch&quot; every property so they are all tracked as</span></span><br><span class="line">    <span class="comment">// dependencies for deep watching</span></span><br><span class="line">    <span class="comment">// 若 要监听对象内部值，则递归</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">deep</span>) &#123;</span><br><span class="line">      <span class="title function_">traverse</span>(value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">popTarget</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">cleanupDeps</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-3-run"><a href="#3-2-3-run" class="headerlink" title="3.2.3 run()"></a>3.2.3 <code>run()</code></h3><ul>
<li>调用 get()，相当于执行  watcher.getter 的函数</li>
<li>执行 watcher.cb 函数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Scheduler job interface.</span></span><br><span class="line"><span class="comment"> * Will be called by the scheduler.</span></span><br><span class="line"><span class="comment"> * 调用 get()，执行 watcher.cb 函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">run () &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">    <span class="comment">// 和初始化一样，直接调用 get(), 更新视图</span></span><br><span class="line">    <span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      value !== <span class="variable language_">this</span>.<span class="property">value</span> ||</span><br><span class="line">      <span class="comment">// Deep watchers and watchers on Object/Arrays should fire even</span></span><br><span class="line">      <span class="comment">// when the value is the same, because the value may</span></span><br><span class="line">      <span class="comment">// have mutated.</span></span><br><span class="line">      <span class="title function_">isObject</span>(value) ||</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">deep</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// set new value</span></span><br><span class="line">      <span class="keyword">const</span> oldValue = <span class="variable language_">this</span>.<span class="property">value</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">value</span> = value</span><br><span class="line">      <span class="comment">// 执行 watcher 的 cb 回调函数</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">user</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果是 user watchers，调用 invokeWithErrorHandling 执行 cb</span></span><br><span class="line">        <span class="keyword">const</span> info = <span class="string">`callback for watcher &quot;<span class="subst">$&#123;<span class="variable language_">this</span>.expression&#125;</span>&quot;`</span></span><br><span class="line">        <span class="title function_">invokeWithErrorHandling</span>(<span class="variable language_">this</span>.<span class="property">cb</span>, <span class="variable language_">this</span>.<span class="property">vm</span>, [value, oldValue], <span class="variable language_">this</span>.<span class="property">vm</span>, info)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cb</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>.<span class="property">vm</span>, value, oldValue)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-4-update"><a href="#3-2-4-update" class="headerlink" title="3.2.4 update()"></a>3.2.4 <code>update()</code></h3><p>更新 Watcher 方法：</p>
<ul>
<li>若是计算属性，则将 dirty 置为 true</li>
<li>若 sync 为 true，直接调用 run()</li>
<li>否则，调用 queueWatcher，开启异步队列（异步队列相关，见 3.3 scheduler ）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Subscriber interface.</span></span><br><span class="line"><span class="comment"> * Will be called when a dependency changes.</span></span><br><span class="line"><span class="comment"> * 订阅者接口，在依赖项改变时被调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">update () &#123;</span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">lazy</span>) &#123;</span><br><span class="line">    <span class="comment">// 若是计算属性，更新后需将缓存标记置为true表示需要更新</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">sync</span>) &#123;</span><br><span class="line">    <span class="comment">// 若为同步，直接 run</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">run</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 否则，放到 观察值队列</span></span><br><span class="line">    <span class="comment">// 开启异步队列，批量更新 Watcher</span></span><br><span class="line">    <span class="title function_">queueWatcher</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-5-addDep-dep"><a href="#3-2-5-addDep-dep" class="headerlink" title="3.2.5 addDep(dep)"></a>3.2.5 <code>addDep(dep)</code></h3><ul>
<li>将 dep 添加到 watcher.newDeps 中</li>
<li>调用 dep.addSub(this)，再将 watcher 添加到 Dep 中</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add a dependency to this directive.</span></span><br><span class="line"><span class="comment"> * Watcher 关联 dep ， 并通知 dep 关联对应的 Watcher</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">addDep (<span class="attr">dep</span>: <span class="title class_">Dep</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = dep.<span class="property">id</span></span><br><span class="line">    <span class="comment">// 当前 dep 不在 新newDepIds 队列，就添加dep 及 id</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">add</span>(id)</span><br><span class="line">      <span class="comment">// 将 dep 关联到 Watcher 中的 newDeps</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDeps</span>.<span class="title function_">push</span>(dep)</span><br><span class="line">      <span class="comment">// 当前 新id 不在 旧depIds 队列，同时将  Watcher 添加到 Dep 队列</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">depIds</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">      <span class="comment">// 将 当前 Watcher 添加到 Dep.subs 中</span></span><br><span class="line">      dep.<span class="title function_">addSub</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-6-cleanupDeps"><a href="#3-2-6-cleanupDeps" class="headerlink" title="3.2.6 cleanupDeps()"></a>3.2.6 <code>cleanupDeps()</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Clean up for dependency collection.</span></span><br><span class="line"><span class="comment"> * 清除依赖收集 ，清除当前watcher对应的 dep.subs 和 watcher.newDeps 中的对应关系</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">cleanupDeps () &#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">deps</span>.<span class="property">length</span></span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> dep = <span class="variable language_">this</span>.<span class="property">deps</span>[i]</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">has</span>(dep.<span class="property">id</span>)) &#123;</span><br><span class="line">      dep.<span class="title function_">removeSub</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> tmp = <span class="variable language_">this</span>.<span class="property">depIds</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">depIds</span> = <span class="variable language_">this</span>.<span class="property">newDepIds</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDepIds</span> = tmp</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">clear</span>()</span><br><span class="line">  tmp = <span class="variable language_">this</span>.<span class="property">deps</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">deps</span> = <span class="variable language_">this</span>.<span class="property">newDeps</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDeps</span> = tmp</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDeps</span>.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-7-evaluate"><a href="#3-2-7-evaluate" class="headerlink" title="3.2.7 evaluate()"></a>3.2.7 <code>evaluate()</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Evaluate the value of the watcher.</span></span><br><span class="line"><span class="comment"> * This only gets called for lazy watchers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算 watcher 的值，仅用于 计算属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">evaluate () &#123;</span><br><span class="line">  <span class="comment">// 调用get() 方法重新计算</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-7-depend"><a href="#3-2-7-depend" class="headerlink" title="3.2.7 depend()"></a>3.2.7 <code>depend()</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Depend on all deps collected by this watcher.</span></span><br><span class="line"><span class="comment"> * 依赖收集；遍历 watcher 中存的 deps，挨个调 Dep.depend()，将watcher 与 dep 相互绑定</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">depend () &#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">deps</span>.<span class="property">length</span></span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">deps</span>[i].<span class="title function_">depend</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-8-teardown"><a href="#3-2-8-teardown" class="headerlink" title="3.2.8 teardown()"></a>3.2.8 <code>teardown()</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Remove self from all dependencies&#x27; subscriber list.</span></span><br><span class="line"><span class="comment">   * teardown 与 depend 相对</span></span><br><span class="line"><span class="comment">   * 将当前 watcher 与 dep 的相互绑定关系移除</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  teardown () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">      <span class="comment">// remove self from vm&#x27;s watcher list</span></span><br><span class="line">      <span class="comment">// this is a somewhat expensive operation so we skip it</span></span><br><span class="line">      <span class="comment">// if the vm is being destroyed.</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">vm</span>.<span class="property">_isBeingDestroyed</span>) &#123;</span><br><span class="line">        <span class="title function_">remove</span>(<span class="variable language_">this</span>.<span class="property">vm</span>.<span class="property">_watchers</span>, <span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">deps</span>.<span class="property">length</span></span><br><span class="line">      <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">deps</span>[i].<span class="title function_">removeSub</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-scheduler"><a href="#3-3-scheduler" class="headerlink" title="3.3 scheduler"></a>3.3 <code>scheduler</code></h2><h3 id="3-3-1-scheduler-相关的全局变量"><a href="#3-3-1-scheduler-相关的全局变量" class="headerlink" title="3.3.1 scheduler 相关的全局变量"></a>3.3.1 scheduler 相关的全局变量</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\scheduler.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">MAX_UPDATE_COUNT</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// watcher 异步队列</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">queue</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Watcher</span>&gt; = []</span><br><span class="line"><span class="keyword">const</span> <span class="attr">activatedChildren</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Component</span>&gt; = []</span><br><span class="line"><span class="keyword">let</span> <span class="attr">has</span>: &#123; [<span class="attr">key</span>: number]: ?<span class="literal">true</span> &#125; = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">circular</span>: &#123; [<span class="attr">key</span>: number]: number &#125; = &#123;&#125;</span><br><span class="line"><span class="comment">// waiting:false 未开启异步队列（是在调用异步回调方法时开启的）</span></span><br><span class="line"><span class="keyword">let</span> waiting = <span class="literal">false</span></span><br><span class="line"><span class="comment">// flushing: false 未开启冲洗队列（冲洗是在异步回调方法执行完成后回调时执行 flushSchedulerQueue 开启的）</span></span><br><span class="line"><span class="keyword">let</span> flushing = <span class="literal">false</span></span><br><span class="line"><span class="keyword">let</span> index = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>waiting 与 flushing 区别：</strong></p>
<ul>
<li><strong>waiting  是为了判断当前是否调用异步队列 nextTick ，防止重复调用</strong></li>
<li><strong>flushing 是为了判断当前是否正在进行冲洗操作（冲洗操作是在异步队列 nextTick 执行后回调的方法）</strong></li>
</ul>
<h3 id="3-3-2-queueWatcher"><a href="#3-3-2-queueWatcher" class="headerlink" title="3.3.2 queueWatcher()"></a>3.3.2 <code>queueWatcher()</code></h3><p>在 Watcher 的 update() 方法中调用。</p>
<ul>
<li><p>先 判断队列中是否 新watcher 的id，若有则不重复添加到队列；若无，进行后面操作</p>
</li>
<li><p>再判断 flushing，</p>
</li>
<li><ul>
<li>若当前没有冲洗操作，则将 wather 直接push 到 queue 队列</li>
<li>若正在进行冲洗操作，则遍历 queue 队列，给当前的watcher 根据 id 找到合适的位置插入</li>
</ul>
</li>
<li><p>判断 waiting，</p>
</li>
<li><ul>
<li>若 当前没有已调用 异步队列 nextTick，则修改标记 waiting 置为 true，将冲洗操作传给异步队列 nextTick(flushSchedulerQueue)</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">queueWatcher</span> (<span class="attr">watcher</span>: <span class="title class_">Watcher</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = watcher.<span class="property">id</span></span><br><span class="line">  <span class="comment">// 若 watcher 的 id 在全局变量 has 中已存在，则忽略</span></span><br><span class="line">  <span class="comment">// 避免重复更新，提升效率</span></span><br><span class="line">  <span class="keyword">if</span> (has[id] == <span class="literal">null</span>) &#123;</span><br><span class="line">    has[id] = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (!flushing) &#123;</span><br><span class="line">      <span class="comment">// 当前没有冲洗操作，将 watcher 插入到队列</span></span><br><span class="line">      queue.<span class="title function_">push</span>(watcher)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// if already flushing, splice the watcher based on its id</span></span><br><span class="line">      <span class="comment">// if already past its id, it will be run next immediately.</span></span><br><span class="line">      <span class="comment">// 冲洗操作时，将新的watcher 遍历按 id 顺序插入到正确的位置</span></span><br><span class="line">      <span class="comment">// 遍历队列，从队尾开始开始，按照 id 的大小（队列是从小到大的顺序）将 Watcher 插入到队列</span></span><br><span class="line">      <span class="comment">// 如果没有遍历到，即当前 id 比队列中的id 都大，没有执行过 i--，相当于插入到队尾</span></span><br><span class="line">      <span class="comment">// index 代表队列中当前正在执行的 Watcher 的位置，初始为 0</span></span><br><span class="line">      <span class="keyword">let</span> i = queue.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">      <span class="keyword">while</span> (i &gt; index &amp;&amp; queue[i].<span class="property">id</span> &gt; watcher.<span class="property">id</span>) &#123;</span><br><span class="line">        i--</span><br><span class="line">      &#125;</span><br><span class="line">      queue.<span class="title function_">splice</span>(i + <span class="number">1</span>, <span class="number">0</span>, watcher)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// queue the flush</span></span><br><span class="line">    <span class="comment">// 正在调用异步队列标记，表示调用队列执行之前不允许重复调用</span></span><br><span class="line">    <span class="keyword">if</span> (!waiting) &#123;</span><br><span class="line">      waiting = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 开发环境若配置同步 则立即执行</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !config.<span class="property">async</span>) &#123;</span><br><span class="line">        <span class="title function_">flushSchedulerQueue</span>()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将待执行的调度任务加入异步队列</span></span><br><span class="line">      <span class="title function_">nextTick</span>(flushSchedulerQueue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-3-flushSchedulerQueue"><a href="#3-3-3-flushSchedulerQueue" class="headerlink" title="3.3.3 flushSchedulerQueue()"></a>3.3.3 <code>flushSchedulerQueue()</code></h3><p><strong>传给异步队列 nextTick 的回调方法，在异步队列执行后回调时执行此方法</strong></p>
<ul>
<li>给 watcher 队列用 id 排序</li>
<li>遍历 watcher 队列，调用 watcher.run() ；更新 active，update 状态</li>
<li>重置状态标记</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Flush both queues and run the watchers.</span></span><br><span class="line"><span class="comment"> * 传给异步队列 nextTick 的回调方法，在异步队列执行后回调时执行此方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushSchedulerQueue</span> () &#123;</span><br><span class="line">  currentFlushTimestamp = <span class="title function_">getNow</span>()</span><br><span class="line">  <span class="comment">// 开始冲洗，此方法是在执行异步队列执行后的回调方法</span></span><br><span class="line">  flushing = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">let</span> watcher, id</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 给队列用 id 由小到大排序</span></span><br><span class="line">  queue.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">id</span> - b.<span class="property">id</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// do not cache length because more watchers might be pushed</span></span><br><span class="line">  <span class="comment">// as we run existing watchers</span></span><br><span class="line">  <span class="comment">// 执行 watcher.run()；更新 active，update 状态</span></span><br><span class="line">  <span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; queue.<span class="property">length</span>; index++) &#123;</span><br><span class="line">    watcher = queue[index]</span><br><span class="line">    ...</span><br><span class="line">    watcher.<span class="title function_">run</span>()</span><br><span class="line">     ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="title function_">resetSchedulerState</span>()</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-4-resetSchedulerState"><a href="#3-3-4-resetSchedulerState" class="headerlink" title="3.3.4 resetSchedulerState()"></a>3.3.4 <code>resetSchedulerState()</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reset the scheduler&#x27;s state.</span></span><br><span class="line"><span class="comment"> * 重置任务调度所有状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resetSchedulerState</span> () &#123;</span><br><span class="line">  index = queue.<span class="property">length</span> = activatedChildren.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">  has = &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    circular = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  waiting = flushing = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-computed-计算属性"><a href="#4-computed-计算属性" class="headerlink" title="4. computed 计算属性"></a>4. <code>computed</code> 计算属性</h1><p><img src="/105-observer-Dep-Watcher/1658334142764-691315cf-a639-4dc2-adea-cb6be819dd06.png" alt="img"></p>
<h3 id="initComputed-vm-opts-computed"><a href="#initComputed-vm-opts-computed" class="headerlink" title="initComputed(vm,opts.computed)"></a><code>initComputed(vm,opts.computed)</code></h3><ul>
<li>创建 计算属性内部的 watcher， vm._computedWatchers</li>
<li>为 计算属性 响应式处理</li>
</ul>
<p><strong>【lazy】</strong>计算属性标记：为true ，则为 计算属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算属性的标记 lazy: true</span></span><br><span class="line"><span class="keyword">const</span> computedWatcherOptions = &#123; <span class="attr">lazy</span>: <span class="literal">true</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initComputed</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">computed</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="comment">// 创建 存储计算属性 的 watcher：_computedWatchers</span></span><br><span class="line">  <span class="keyword">const</span> watchers = vm.<span class="property">_computedWatchers</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// computed properties are just getters during SSR</span></span><br><span class="line">  <span class="keyword">const</span> isSSR = <span class="title function_">isServerRendering</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> computed) &#123;</span><br><span class="line">    <span class="comment">// 获取用户自定义的 computed</span></span><br><span class="line">    <span class="keyword">const</span> userDef = computed[key]</span><br><span class="line">    <span class="comment">// 兼容 computed 后直接写 方法  or 对象中写 get() 的方式</span></span><br><span class="line">    <span class="keyword">const</span> getter = <span class="keyword">typeof</span> userDef === <span class="string">&#x27;function&#x27;</span> ? userDef : userDef.<span class="property">get</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; getter == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`Getter is missing for computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot;.`</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在服务端SSR时，不创建计算属性对应 watcher</span></span><br><span class="line">    <span class="keyword">if</span> (!isSSR) &#123;</span><br><span class="line">      <span class="comment">// create internal watcher for the computed property.</span></span><br><span class="line">      <span class="comment">// 为 计算属性 创建内部 watcher</span></span><br><span class="line">      watchers[key] = <span class="keyword">new</span> <span class="title class_">Watcher</span>(</span><br><span class="line">        vm,</span><br><span class="line">        getter || noop,</span><br><span class="line">        noop,</span><br><span class="line">        computedWatcherOptions</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// component-defined computed properties are already defined on the</span></span><br><span class="line">    <span class="comment">// component prototype. We only need to define computed properties defined</span></span><br><span class="line">    <span class="comment">// at instantiation here.</span></span><br><span class="line">    <span class="comment">// 如果计算属性 key 不在vue实例中，就创建响应式的 vm[key] ，其值为 userDef</span></span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      <span class="title function_">defineComputed</span>(vm, key, userDef)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 各种重名报错</span></span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> vm.<span class="property">$data</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">`The computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already defined in data.`</span>, vm)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">props</span> &amp;&amp; key <span class="keyword">in</span> vm.<span class="property">$options</span>.<span class="property">props</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">`The computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already defined as a prop.`</span>, vm)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">methods</span> &amp;&amp; key <span class="keyword">in</span> vm.<span class="property">$options</span>.<span class="property">methods</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">`The computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already defined as a method.`</span>, vm)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="为什么-SSR-不用创建-computed？"><a href="#为什么-SSR-不用创建-computed？" class="headerlink" title="为什么 SSR 不用创建 computed？"></a>为什么 SSR 不用创建 computed？</h4><p>由于watcher实现vue的响应式，而如果是服务器环境下，数据和模板从后端获取即可而不需要在前端收集依赖，不需要缓存机制，因此在服务器并不需要这一点</p>
<h2 id="4-1-defineComputed-vm-key-userDef"><a href="#4-1-defineComputed-vm-key-userDef" class="headerlink" title="4.1 defineComputed(vm, key, userDef)"></a>4.1 <code>defineComputed(vm, key, userDef)</code></h2><ul>
<li>非 SSR 使用缓存，及 computed 的值是否是函数，设置get，set方法，进行响应式处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应式基础配置</span></span><br><span class="line"><span class="keyword">const</span> sharedPropertyDefinition = &#123;</span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">get</span>: noop,</span><br><span class="line">  <span class="attr">set</span>: noop</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * computed 进行响应式处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; target </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; key </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; userDef </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">defineComputed</span> (</span><br><span class="line">  <span class="attr">target</span>: any,</span><br><span class="line">  <span class="attr">key</span>: string,</span><br><span class="line">  <span class="attr">userDef</span>: <span class="title class_">Object</span> | <span class="title class_">Function</span></span><br><span class="line">) &#123;</span><br><span class="line">   <span class="comment">// 缓存标记，非 SSR 的进行缓存</span></span><br><span class="line">  <span class="keyword">const</span> shouldCache = !<span class="title function_">isServerRendering</span>()</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> userDef === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// userDef 若为函数，若有缓存用 createComputedGetter 转换，若无则用 createGetterInvoker 转换，获取 get</span></span><br><span class="line">    sharedPropertyDefinition.<span class="property">get</span> = shouldCache</span><br><span class="line">      ? <span class="title function_">createComputedGetter</span>(key)</span><br><span class="line">      : <span class="title function_">createGetterInvoker</span>(userDef)</span><br><span class="line">    sharedPropertyDefinition.<span class="property">set</span> = noop</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// userDef 若不是函数，则 取 userDef.get 的值</span></span><br><span class="line">    <span class="comment">// 若userDef.get为空则赋值 空函数</span></span><br><span class="line">    <span class="comment">// 若不为空，同上 if</span></span><br><span class="line">    sharedPropertyDefinition.<span class="property">get</span> = userDef.<span class="property">get</span></span><br><span class="line">      ? shouldCache &amp;&amp; userDef.<span class="property">cache</span> !== <span class="literal">false</span></span><br><span class="line">        ? <span class="title function_">createComputedGetter</span>(key)</span><br><span class="line">        : <span class="title function_">createGetterInvoker</span>(userDef.<span class="property">get</span>)</span><br><span class="line">      : noop</span><br><span class="line">    sharedPropertyDefinition.<span class="property">set</span> = userDef.<span class="property">set</span> || noop</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// computed 属性的 get，set 配置后，响应式 绑定 到 target[key]</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(target, key, sharedPropertyDefinition)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-1-createComputedGetter-key"><a href="#4-1-1-createComputedGetter-key" class="headerlink" title="4.1.1 createComputedGetter(key)"></a>4.1.1 <code>createComputedGetter(key)</code></h3><ul>
<li>获取计算属性的watcher，_computedWatchers</li>
<li>若 watcher.dirty 为true，则调用 evaluate() 进行计算获取值；若为false，继续使用watcher.value 的缓存值</li>
<li>若 Dep.target 存在，则进行依赖收集</li>
</ul>
<p><strong>【dirty】</strong>：缓存标记；true：需要重新计算；false：使用缓存</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回计算属性的结果值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createComputedGetter</span> (key) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">computedGetter</span> () &#123;</span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="variable language_">this</span>.<span class="property">_computedWatchers</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">_computedWatchers</span>[key]</span><br><span class="line">    <span class="keyword">if</span> (watcher) &#123;</span><br><span class="line">      <span class="comment">// dirty：缓存标记；true：需要重新计算；false：使用缓存</span></span><br><span class="line">      <span class="keyword">if</span> (watcher.<span class="property">dirty</span>) &#123;</span><br><span class="line">        watcher.evaluate()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 依赖收集</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        watcher.<span class="title function_">depend</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> watcher.<span class="property">value</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-1-1-1-watcher-evaluate"><a href="#4-1-1-1-watcher-evaluate" class="headerlink" title="4.1.1.1  watcher.evaluate()"></a>4.1.1.1 <code> watcher.evaluate()</code></h4><ul>
<li>调用 watcher.get() 方法计算，并将 dirty 置为 false</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Evaluate the value of the watcher.</span></span><br><span class="line"><span class="comment"> * This only gets called for lazy watchers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算 watcher 的值，仅用于 计算属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">evaluate () &#123;</span><br><span class="line">  <span class="comment">// 调用get() 方法重新计算</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-2-createGetterInvoker-userDef"><a href="#4-1-2-createGetterInvoker-userDef" class="headerlink" title="4.1.2 createGetterInvoker(userDef)"></a>4.1.2 <code>createGetterInvoker(userDef)</code></h3><ul>
<li>SSR 下，直接返回 计算属性函数，不进行缓存处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回 直接执行 fn 的函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createGetterInvoker</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">computedGetter</span> () &#123;</span><br><span class="line">    <span class="keyword">return</span> fn.<span class="title function_">call</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-响应式原理"><a href="#5-响应式原理" class="headerlink" title="5. 响应式原理"></a>5. 响应式原理</h2><p>这位<a target="_blank" rel="noopener" href="https://juejin.cn/post/6857669921166491662">大神孟思行</a>已经整理的非常好，直接拿来用好了</p>
<ol>
<li><strong>从 new Vue 开始，首先通过 get、set 监听 Data 中的数据变化，同时创建 Dep 用来搜集使用该 Data 的 Watcher。</strong></li>
<li><strong>编译模板，创建 Watcher，并将 Dep.target 标识为当前 Watcher。</strong></li>
<li><strong>编译模板时，如果使用到了 Data 中的数据，就会触发 Data 的 get 方法，然后调用 Dep.addSub 将 Watcher 搜集起来。</strong></li>
<li><strong>数据更新时，会触发 Data 的 set 方法，然后调用 Dep.notify 通知所有使用到该 Data 的 Watcher 去更新 DOM。</strong></li>
</ol>
<p><img src="/105-observer-Dep-Watcher/1657613113860-71683bd4-1f5b-4bc9-a715-6dc168f790ea.png" alt="img"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903858850758670">https://juejin.cn/post/6844903858850758670</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6857669921166491662">https://juejin.cn/post/6857669921166491662</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-06-02</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约5998个字, 19分钟59秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/103-%E5%85%A8%E5%B1%80API%E6%BA%90%E7%A0%81/">3. 全局API源码</a></h3></div><div class="post-content"><div class="card"><p><p><strong>【前情回顾】</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 vue 实例</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;./instance/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; initGlobalAPI &#125; <span class="keyword">from</span> <span class="string">&#x27;./global-api/index&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 初始化 Vue 全局 API</span></span><br><span class="line"><span class="title function_">initGlobalAPI</span>(<span class="title class_">Vue</span>)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span></span><br></pre></td></tr></table></figure>



<p><strong>此文件主要是注册 Vue API 方法，因此比对着</strong> <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><strong>官方API</strong> </a> <strong>读，会容易许多。</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/global-api/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initGlobalAPI</span> (<span class="title class_">Vue</span>: <span class="title class_">GlobalAPI</span>) &#123;</span><br><span class="line">  <span class="comment">// ===== 1 =====</span></span><br><span class="line">  <span class="comment">// config</span></span><br><span class="line">  <span class="comment">// 劫持 config 属性，根据warn提示，此处是为了保护  Vue.config， 不被同名替换</span></span><br><span class="line">  <span class="keyword">const</span> configDef = &#123;&#125;</span><br><span class="line">  configDef.<span class="property">get</span> = <span class="function">() =&gt;</span> config</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    configDef.<span class="property">set</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;Do not replace the Vue.config object, set individual fields instead.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>, <span class="string">&#x27;config&#x27;</span>, configDef)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 2 =====</span></span><br><span class="line">  <span class="comment">// exposed util methods.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> these are not considered part of the public API - avoid relying on</span></span><br><span class="line">  <span class="comment">// them unless you are aware of the risk.</span></span><br><span class="line">  <span class="comment">// 提示：这些不被认为是公共API的一部分，避免依赖它们，除非你清楚风险。</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">util</span> = &#123;</span><br><span class="line">    warn,</span><br><span class="line">    extend,</span><br><span class="line">    mergeOptions,</span><br><span class="line">    defineReactive</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 3 =====</span></span><br><span class="line">  <span class="comment">// 挂载 Vue.set, Vue.delete, Vue.nextTick 方法</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">set</span> = set</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">delete</span> = del</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">nextTick</span> = nextTick</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 挂载 Vue.observable(object) 方法 ， 2.6.0 新增方法</span></span><br><span class="line">  <span class="comment">// 2.6 explicit observable API</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">observable</span> = &lt;T&gt;(<span class="attr">obj</span>: T): <span class="function"><span class="params">T</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">observe</span>(obj)</span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 4 =====</span></span><br><span class="line">  <span class="comment">/* export const ASSET_TYPES = [</span></span><br><span class="line"><span class="comment">    &#x27;component&#x27;,</span></span><br><span class="line"><span class="comment">    &#x27;directive&#x27;,</span></span><br><span class="line"><span class="comment">    &#x27;filter&#x27;</span></span><br><span class="line"><span class="comment">  ] */</span></span><br><span class="line">  <span class="comment">// 初始化 Vue.options, Vue.options.directive, Vue.options.component, Vue.options.filter 方法</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">options</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="variable constant_">ASSET_TYPES</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property">options</span>[type + <span class="string">&#x27;s&#x27;</span>] = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 5 =====</span></span><br><span class="line">  <span class="comment">// this is used to identify the &quot;base&quot; constructor to extend all plain-object</span></span><br><span class="line">  <span class="comment">// components with in Weex&#x27;s multi-instance scenarios.</span></span><br><span class="line">  <span class="comment">// 将 Vue 构造函数挂载到 _base 属性，多用于 weex 多应用场景</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">options</span>.<span class="property">_base</span> = <span class="title class_">Vue</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 6 =====</span></span><br><span class="line">  <span class="comment">// 挂载 keepAlive</span></span><br><span class="line">  <span class="title function_">extend</span>(<span class="title class_">Vue</span>.<span class="property">options</span>.<span class="property">components</span>, builtInComponents)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 7 =====</span></span><br><span class="line">  <span class="comment">// 挂载 Vue.use, Vue.mixin, Vue.extend 方法</span></span><br><span class="line">  <span class="title function_">initUse</span>(<span class="title class_">Vue</span>)</span><br><span class="line">  <span class="title function_">initMixin</span>(<span class="title class_">Vue</span>)</span><br><span class="line">  <span class="title function_">initExtend</span>(<span class="title class_">Vue</span>)</span><br><span class="line">  <span class="comment">// ===== 8 =====</span></span><br><span class="line">  <span class="comment">// 注册定义 Vue.directive, Vue.component, Vue.filter </span></span><br><span class="line">  <span class="title function_">initAssetRegisters</span>(<span class="title class_">Vue</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-Vue-config-全局配置"><a href="#1-Vue-config-全局配置" class="headerlink" title="1. Vue.config  全局配置"></a>1. <code>Vue.config</code>  <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE">全局配置</a></h2><ul>
<li>silent: 取消 Vue 所有的日志与警告。</li>
<li>optionMergeStrategies: 自定义合并策略的选项。(父实例和子实例参数合并时）</li>
<li>devtools：配置是否允许 <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-devtools">vue-devtools</a> 检查代码。开发版本默认为 true，生产版本默认为 false。生产版本设为 true 可以启用检查。</li>
<li>errorHandler： 这个处理函数被调用时，可获取错误信息和 Vue 实例。</li>
<li>warnHandler： 为 Vue 的运行时警告赋予一个自定义处理函数。注意这只会在开发者环境下生效，在生产环境下它会被忽略。</li>
<li>ignoredElements： 须使 Vue 忽略在 Vue 之外的自定义元素 (e.g. 使用了 Web Components APIs)。否则，它会假设你忘记注册全局组件或者拼错了组件名称，从而抛出一个关于 Unknown custom element 的警告。</li>
<li>keyCodes： 给 v-on 自定义键位别名。</li>
<li>performance： 设置为 true 以在浏览器开发工具的性能&#x2F;时间线面板中启用对组件初始化、编译、渲染和打补丁的性能追踪。只适用于开发模式和支持 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/mark">performance.mark</a> API 的浏览器上。</li>
<li>productionTip： 如果设置为 false 以阻止 vue 在启动时生成生产提示。</li>
</ul>
<h2 id="2-Vue-util"><a href="#2-Vue-util" class="headerlink" title="2. Vue.util"></a>2. <code>Vue.util</code></h2><p>一些常用的内部 API 的挂载</p>
<h2 id="3-Vue-set-Vue-delete-Vue-nextTick-Vue-observable"><a href="#3-Vue-set-Vue-delete-Vue-nextTick-Vue-observable" class="headerlink" title="3. Vue.set, Vue.delete,Vue.nextTick, Vue.observable"></a>3. <code>Vue.set, Vue.delete,Vue.nextTick, Vue.observable</code></h2><h3 id="3-1-Vue-set-target-propertyName-x2F-index-value"><a href="#3-1-Vue-set-target-propertyName-x2F-index-value" class="headerlink" title="3.1 Vue.set( target, propertyName&#x2F;index, value )"></a>3.1 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#Vue-set">Vue.set( target, propertyName&#x2F;index, value )</a></h3><p>向响应式对象中添加一个 property，并确保这个新 property 同样是响应式的，且触发视图更新。它必须用于向响应式对象上添加新 property，因为 Vue 无法探测普通的新增 property </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span> (<span class="attr">target</span>: <span class="title class_">Array</span>&lt;any&gt; | <span class="title class_">Object</span>, <span class="attr">key</span>: any, <span class="attr">val</span>: any): any &#123;</span><br><span class="line">  <span class="comment">// 确保target是响应式对象中</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">    (<span class="title function_">isUndef</span>(target) || <span class="title function_">isPrimitive</span>(target))</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">`Cannot set reactive property on undefined, null, or primitive value: <span class="subst">$&#123;(target: any)&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 若target是数组，属性key在target中，则直接赋新值返回</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(target) &amp;&amp; <span class="title function_">isValidArrayIndex</span>(key)) &#123;</span><br><span class="line">    target.<span class="property">length</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(target.<span class="property">length</span>, key)</span><br><span class="line">    target.<span class="title function_">splice</span>(key, <span class="number">1</span>, val)</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 属性key在target中，且不是在prototype上，说明此属性已存在，则直接赋新值返回</span></span><br><span class="line">  <span class="keyword">if</span> (key <span class="keyword">in</span> target &amp;&amp; !(key <span class="keyword">in</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>)) &#123;</span><br><span class="line">    target[key] = val</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> ob = (<span class="attr">target</span>: any).<span class="property">__ob__</span></span><br><span class="line">  <span class="comment">// 是Vue组件，且 vmCount 在有 asRootData 时增加，vmCount 不等于 0 时说明在root下</span></span><br><span class="line">  <span class="comment">// 说明应避免直接在 Vue 根root $data 下添加响应式属性</span></span><br><span class="line">  <span class="keyword">if</span> (target.<span class="property">_isVue</span> || (ob &amp;&amp; ob.<span class="property">vmCount</span>)) &#123;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">&#x27;Avoid adding reactive properties to a Vue instance or its root $data &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;at runtime - declare it upfront in the data option.&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// target 没有 __ob__ 说明是一个非响应式对象，直接添加普通属性</span></span><br><span class="line">  <span class="keyword">if</span> (!ob) &#123;</span><br><span class="line">    target[key] = val</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 设置响应式</span></span><br><span class="line">  <span class="title function_">defineReactive</span>(ob.<span class="property">value</span>, key, val)</span><br><span class="line">  <span class="comment">// 并在更新 dep </span></span><br><span class="line">  ob.<span class="property">dep</span>.<span class="title function_">notify</span>()</span><br><span class="line">  <span class="keyword">return</span> val</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-Vue-delete-target-propertyName-x2F-index"><a href="#3-2-Vue-delete-target-propertyName-x2F-index" class="headerlink" title="3.2  Vue.delete( target, propertyName&#x2F;index )"></a>3.2  <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#Vue-delete">Vue.delete( target, propertyName&#x2F;index )</a></h3><p>删除对象的 property。如果对象是响应式的，确保删除能触发更新视图。这个方法主要用于避开 Vue 不能检测到 property 被删除的限制，但是你应该很少会使用它。</p>
<p><strong>在 2.2.0+ 中同样支持在数组上工作。</strong></p>
<p>目标对象不能是一个 Vue 实例或 Vue 实例的根数据对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">del</span> (<span class="attr">target</span>: <span class="title class_">Array</span>&lt;any&gt; | <span class="title class_">Object</span>, <span class="attr">key</span>: any) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">    (<span class="title function_">isUndef</span>(target) || <span class="title function_">isPrimitive</span>(target))</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">`Cannot delete reactive property on undefined, null, or primitive value: <span class="subst">$&#123;(target: any)&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(target) &amp;&amp; <span class="title function_">isValidArrayIndex</span>(key)) &#123;</span><br><span class="line">    target.<span class="title function_">splice</span>(key, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> ob = (<span class="attr">target</span>: any).<span class="property">__ob__</span></span><br><span class="line">  <span class="comment">// 目标对象不能是一个 Vue 实例或 Vue 实例的根数据对象。</span></span><br><span class="line">  <span class="keyword">if</span> (target.<span class="property">_isVue</span> || (ob &amp;&amp; ob.<span class="property">vmCount</span>)) &#123;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">&#x27;Avoid deleting properties on a Vue instance or its root $data &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;- just set it to null.&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 不存在则不删</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">hasOwn</span>(target, key)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">delete</span> target[key]</span><br><span class="line">  <span class="comment">// 如果是非响应式对象，则不用同步修改 dep</span></span><br><span class="line">  <span class="keyword">if</span> (!ob) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  ob.<span class="property">dep</span>.<span class="title function_">notify</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Vue-nextTick-callback-context"><a href="#3-3-Vue-nextTick-callback-context" class="headerlink" title="3.3 [Vue.nextTick( callback, context] )"></a>3.3 [Vue.nextTick( <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#Vue-nextTick">callback, context] )</a></h3><p>在下次 DOM 更新循环结束之后执行延迟回调。</p>
<p>在修改数据之后立即使用这个方法，获取更新后的 DOM。</p>
<p>整个流程：</p>
<ul>
<li>将调用 nextTick 的参数都放在数组 callbacks 中存下，同时将 pending 标志位改为 true，并开启一个宏&#x2F;微任务挂起。</li>
<li>当挂起的 callbacks 正在执行，又有新的 nextTick 调用，将新任务存到 callbacks 队列中</li>
<li>当执行任务 flushCallbacks ，重置 callbacks，pending，遍遍历 callbacks ，执行回调函数</li>
</ul>
<p>具体可见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/ddlwni">07- nextTick</a></p>
<h3 id="3-4-Vue-observable-object"><a href="#3-4-Vue-observable-object" class="headerlink" title="3.4 Vue.observable( object )"></a>3.4 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#Vue-observable">Vue.observable( object )</a></h3><p>让一个对象可响应。Vue 内部会用它来处理 data 函数返回的对象。</p>
<p>内部调用 <code>observe(obj)</code>实现</p>
<p>返回的对象可以直接用于<a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/render-function.html">渲染函数</a>和<a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/computed.html">计算属性</a>内，并且会在发生变更时触发相应的更新。</p>
<p><strong>也可以作为最小化的跨组件状态存储器</strong>，eg如下：</p>
<p><img src="/103-%E5%85%A8%E5%B1%80API%E6%BA%90%E7%A0%81/1657187193593-fadcd89b-9d54-4386-b625-2984eb84f7bc-20220818214451930.png" alt="img"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * In some cases we may want to disable observation inside a component&#x27;s</span></span><br><span class="line"><span class="comment"> * update computation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 是否启用观察的标记位</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> <span class="attr">shouldObserve</span>: boolean = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">toggleObserving</span> (<span class="attr">value</span>: boolean) &#123;</span><br><span class="line">  shouldObserve = value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Attempt to create an observer instance for a value,</span></span><br><span class="line"><span class="comment"> * returns the new observer if successfully observed,</span></span><br><span class="line"><span class="comment"> * or the existing observer if the value already has one.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">observe</span> (<span class="attr">value</span>: any, <span class="attr">asRootData</span>: ?boolean): <span class="title class_">Observer</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// 如果不是对象，或者是 VNode，则不进行响应处理</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(value) || value <span class="keyword">instanceof</span> <span class="title class_">VNode</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">ob</span>: <span class="title class_">Observer</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="comment">// 若本身就是响应式对象则 ob = value.__ob__</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">hasOwn</span>(value, <span class="string">&#x27;__ob__&#x27;</span>) &amp;&amp; value.<span class="property">__ob__</span> <span class="keyword">instanceof</span> <span class="title class_">Observer</span>) &#123;</span><br><span class="line">    ob = value.<span class="property">__ob__</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    shouldObserve &amp;&amp;</span><br><span class="line">    !<span class="title function_">isServerRendering</span>() &amp;&amp;</span><br><span class="line">    (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value) || <span class="title function_">isPlainObject</span>(value)) &amp;&amp;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">isExtensible</span>(value) &amp;&amp;</span><br><span class="line">    !value.<span class="property">_isVue</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 可响应处理的标志 &amp;&amp; 不是SSR &amp; (数组 || 对象) &amp; 对象可扩展 &amp; 不是 Vue 实例本身</span></span><br><span class="line">    ob = <span class="keyword">new</span> <span class="title class_">Observer</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.<span class="property">vmCount</span>++</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Object-isExtensible"><a href="#Object-isExtensible" class="headerlink" title="**Object.isExtensible()**"></a><code>**Object.isExtensible()**</code></h4><p><strong>Object.isExtensible()</strong> 方法判断一个对象是否是可扩展的（是否可以在它上面添加新的属性）</p>
<h4 id="isVue"><a href="#isVue" class="headerlink" title="_isVue"></a><code>_isVue</code></h4><p>_isVue 为 ture 时，是初始化<code>_init()</code>时赋值，表示 Vue 本身的标志</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\init.js</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// a flag to avoid this being observed</span></span><br><span class="line">    vm.<span class="property">_isVue</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="4-初始化对象"><a href="#4-初始化对象" class="headerlink" title="4.  初始化对象"></a>4.  初始化对象</h2><p>初始化 Vue.options, Vue.options.directive, Vue.options.component, Vue.options.filter 方法</p>
<p>具体细节见 8</p>
<h2 id="5-Vue-options-base-Vue"><a href="#5-Vue-options-base-Vue" class="headerlink" title="5.  Vue.options._base = Vue"></a>5. <code> Vue.options._base = Vue</code></h2><p>Vue 挂载 _base </p>
<h2 id="6-extend-Vue-options-components-builtInComponents"><a href="#6-extend-Vue-options-components-builtInComponents" class="headerlink" title="6.extend(Vue.options.components, builtInComponents)"></a>6.<code>extend(Vue.options.components, builtInComponents)</code></h2><p>拆解此方法后知，此方法是初始化构建 KeepAlive 组件，将 KeepAlive 组件挂载到 Vue.option.components 。</p>
<p><a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#keep-alive">https://cn.vuejs.org/v2/api/#keep-alive</a></p>
<h3 id="6-1-extend"><a href="#6-1-extend" class="headerlink" title="6.1 extend()"></a>6.1 <code>extend()</code></h3><p>引用自： <code>import &#123; initExtend &#125; from&#39;./extend&#39;</code></p>
<p>由此引用，找到实际定义的文件： <code>src\shared\util.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mix properties into target object.</span></span><br><span class="line"><span class="comment"> * 将 _from 的属性混入到 to 中，并返回新的原对象to</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">extend</span> (<span class="attr">to</span>: <span class="title class_">Object</span>, <span class="attr">_from</span>: ?<span class="title class_">Object</span>): <span class="title class_">Object</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> _from) &#123;</span><br><span class="line">    to[key] = _from[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> to</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-builtInComponents"><a href="#6-2-builtInComponents" class="headerlink" title="6.2 builtInComponents"></a>6.2 <code>builtInComponents</code></h3><p>引用于 <code>import builtInComponents from &#39;../components/index&#39;&#39; </code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\components\index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">KeepAlive</span> <span class="keyword">from</span> <span class="string">&#x27;./keep-alive&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title class_">KeepAlive</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>keep-alive 组件源码分析可参考：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903837770203144#heading-3">https://juejin.cn/post/6844903837770203144#heading-3</a></p>
<p>Vue渲染的整个过程：</p>
<p><img src="/103-%E5%85%A8%E5%B1%80API%E6%BA%90%E7%A0%81/1657162564361-7eb27457-0e4e-4777-a552-6e660ab55775-20220818214452020.webp" alt="img"></p>
<p>Vue的渲染是从图中的render阶段开始的，但keep-alive的渲染是在patch阶段，这是构建组件树（虚拟DOM树），并将VNode转换成真正DOM节点的过程。</p>
<h2 id="7-Vue-use-Vue-mixin-Vue-extend"><a href="#7-Vue-use-Vue-mixin-Vue-extend" class="headerlink" title="7. Vue.use, Vue.mixin, Vue.extend"></a>7. Vue.use, Vue.mixin, Vue.extend</h2><h3 id="7-1-Vue-use-plugin"><a href="#7-1-Vue-use-plugin" class="headerlink" title="7.1 Vue.use( plugin )"></a>7.1 <code>Vue.use( plugin )</code></h3><p>安装 Vue.js 插件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\global-api\use.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initUse</span> (<span class="title class_">Vue</span>: <span class="title class_">GlobalAPI</span>) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">use</span> = <span class="keyword">function</span> (<span class="params">plugin: <span class="built_in">Function</span> | <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> installedPlugins = (<span class="variable language_">this</span>.<span class="property">_installedPlugins</span> || (<span class="variable language_">this</span>.<span class="property">_installedPlugins</span> = []))</span><br><span class="line">    <span class="comment">// 若插件存在则直接返回，不重复添加</span></span><br><span class="line">    <span class="comment">// 当 install 方法被同一个插件多次调用，插件将只会被安装一次</span></span><br><span class="line">    <span class="keyword">if</span> (installedPlugins.<span class="title function_">indexOf</span>(plugin) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// additional parameters</span></span><br><span class="line">    <span class="comment">// install 方法调用时，会将 Vue 作为参数传入</span></span><br><span class="line">    <span class="keyword">const</span> args = <span class="title function_">toArray</span>(<span class="variable language_">arguments</span>, <span class="number">1</span>)</span><br><span class="line">    args.<span class="title function_">unshift</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="comment">// 如果插件是一个对象，必须提供 install 方法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin.<span class="property">install</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      plugin.<span class="property">install</span>.<span class="title function_">apply</span>(plugin, args)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果插件是一个函数，它会被作为 install 方法</span></span><br><span class="line">      plugin.<span class="title function_">apply</span>(<span class="literal">null</span>, args)</span><br><span class="line">    &#125;</span><br><span class="line">    installedPlugins.<span class="title function_">push</span>(plugin)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-2-Vue-mixin-mixin"><a href="#7-2-Vue-mixin-mixin" class="headerlink" title="7.2  Vue.mixin( mixin )"></a>7.2  <code>Vue.mixin( mixin )</code></h3><p> 全局注册一个混入，影响注册之后所有创建的每个 Vue 实例。插件作者可以使用混入，向组件注入自定义的行为。<strong>不推荐在应用代码中使用</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\global-api\mixin.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">GlobalAPI</span>) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">mixin</span> = <span class="keyword">function</span> (<span class="params">mixin: <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 合并参数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = <span class="title function_">mergeOptions</span>(<span class="variable language_">this</span>.<span class="property">options</span>, mixin)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-3-Vue-extend-options"><a href="#7-3-Vue-extend-options" class="headerlink" title="7.3  Vue.extend( options )"></a>7.3  <code>Vue.extend( options )</code></h3><p>使用基础 Vue 构造器，创建一个“子类”。</p>
<p>参数是一个包含组件选项的对象。</p>
<p>data 选项是特例，需要注意 - 在 Vue.extend() 中它必须是函数</p>
<p>应用示例：</p>
<p><img src="/103-%E5%85%A8%E5%B1%80API%E6%BA%90%E7%A0%81/1657181869595-61191ab2-1d6a-4c60-98ff-00df4af64a2c-20220818214451943.png" alt="img"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\global-api\extend.js</span></span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">extend</span> = <span class="keyword">function</span> (<span class="params">extendOptions: <span class="built_in">Object</span></span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">    extendOptions = extendOptions || &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Super</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SuperId</span> = <span class="title class_">Super</span>.<span class="property">cid</span></span><br><span class="line">    <span class="keyword">const</span> cachedCtors = extendOptions.<span class="property">_Ctor</span> || (extendOptions.<span class="property">_Ctor</span> = &#123;&#125;)</span><br><span class="line">    <span class="comment">// cid 是每个组件的唯一标志，若已创建则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (cachedCtors[<span class="title class_">SuperId</span>]) &#123;</span><br><span class="line">      <span class="keyword">return</span> cachedCtors[<span class="title class_">SuperId</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> name = extendOptions.<span class="property">name</span> || <span class="title class_">Super</span>.<span class="property">options</span>.<span class="property">name</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; name) &#123;</span><br><span class="line">      <span class="title function_">validateComponentName</span>(name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sub 就是使用 一个包含组件选项的对象 的参数，初始化创建一个 Vue 组件</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Sub</span> = <span class="keyword">function</span> <span class="title function_">VueComponent</span> (options) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_init</span>(options)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 继承父的prototype</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property"><span class="keyword">prototype</span></span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="title class_">Super</span>.<span class="property"><span class="keyword">prototype</span></span>)</span><br><span class="line">    <span class="comment">// 指向自己的 constructor </span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">constructor</span> = <span class="title class_">Sub</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">cid</span> = cid++</span><br><span class="line">    <span class="comment">// 合并父的参数</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">options</span> = <span class="title function_">mergeOptions</span>(</span><br><span class="line">      <span class="title class_">Super</span>.<span class="property">options</span>,</span><br><span class="line">      extendOptions</span><br><span class="line">    )</span><br><span class="line">    <span class="title class_">Sub</span>[<span class="string">&#x27;super&#x27;</span>] = <span class="title class_">Super</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// For props and computed properties, we define the proxy getters on</span></span><br><span class="line">    <span class="comment">// the Vue instances at extension time, on the extended prototype. This</span></span><br><span class="line">    <span class="comment">// avoids Object.defineProperty calls for each instance created.</span></span><br><span class="line">    <span class="comment">// 对于 props 和 computed 属性，定义proxy 的 getters 时扩展到Vue 实例的prototype 上，这样可以避免创建每个实例都调用 Object.defineProperty</span></span><br><span class="line">    <span class="comment">// 此句扩展的体现在 initProps(Sub) 的实现上， proxy(Comp.prototype, `_props`, key) ，用的是Comp.prototype</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Sub</span>.<span class="property">options</span>.<span class="property">props</span>) &#123;</span><br><span class="line">      <span class="title function_">initProps</span>(<span class="title class_">Sub</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Sub</span>.<span class="property">options</span>.<span class="property">computed</span>) &#123;</span><br><span class="line">      <span class="title function_">initComputed</span>(<span class="title class_">Sub</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow further extension/mixin/plugin usage</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">extend</span> = <span class="title class_">Super</span>.<span class="property">extend</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">mixin</span> = <span class="title class_">Super</span>.<span class="property">mixin</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">use</span> = <span class="title class_">Super</span>.<span class="property">use</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// create asset registers, so extended classes</span></span><br><span class="line">    <span class="comment">// can have their private assets too.</span></span><br><span class="line">    <span class="variable constant_">ASSET_TYPES</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">type</span>) &#123;</span><br><span class="line">      <span class="title class_">Sub</span>[type] = <span class="title class_">Super</span>[type]</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// enable recursive self-lookup</span></span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">      <span class="title class_">Sub</span>.<span class="property">options</span>.<span class="property">components</span>[name] = <span class="title class_">Sub</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// keep a reference to the super options at extension time.</span></span><br><span class="line">    <span class="comment">// later at instantiation we can check if Super&#x27;s options have</span></span><br><span class="line">    <span class="comment">// been updated.</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">superOptions</span> = <span class="title class_">Super</span>.<span class="property">options</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">extendOptions</span> = extendOptions</span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">sealedOptions</span> = <span class="title function_">extend</span>(&#123;&#125;, <span class="title class_">Sub</span>.<span class="property">options</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cache constructor</span></span><br><span class="line">    cachedCtors[<span class="title class_">SuperId</span>] = <span class="title class_">Sub</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Sub</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="8-initAssetRegisters-Vue"><a href="#8-initAssetRegisters-Vue" class="headerlink" title="8. initAssetRegisters(Vue)"></a>8. <code>initAssetRegisters(Vue)</code></h2><p>在第 4 部分，初始化 Vue.use, Vue.mixin, Vue.extend 对象；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\global-api\assets.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initAssetRegisters</span> (<span class="title class_">Vue</span>: <span class="title class_">GlobalAPI</span>) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Create asset registration methods.</span></span><br><span class="line"><span class="comment">   * 注册方法</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="variable constant_">ASSET_TYPES</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Vue</span>[type] = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">      id: string,</span></span><br><span class="line"><span class="params">      definition: <span class="built_in">Function</span> | <span class="built_in">Object</span></span></span><br><span class="line"><span class="params">    </span>): <span class="title class_">Function</span> | <span class="title class_">Object</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">      <span class="comment">// 无 definition 参数，直接返回已注册的 过滤器/指令/组件</span></span><br><span class="line">      <span class="keyword">if</span> (!definition) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">options</span>[type + <span class="string">&#x27;s&#x27;</span>][id]</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; type === <span class="string">&#x27;component&#x27;</span>) &#123;</span><br><span class="line">          <span class="comment">// 注册组件，检查组件名是否规范</span></span><br><span class="line">          <span class="title function_">validateComponentName</span>(id)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">&#x27;component&#x27;</span> &amp;&amp; <span class="title function_">isPlainObject</span>(definition)) &#123;</span><br><span class="line">          <span class="comment">// 未设置 组件的name，则用id 当作name</span></span><br><span class="line">          definition.<span class="property">name</span> = definition.<span class="property">name</span> || id</span><br><span class="line">          <span class="comment">// 若是组件，definition 为对象，则添加到 _base 中</span></span><br><span class="line">          <span class="comment">// 注册组件，传入一个选项对象 (自动调用 Vue.extend) —— 针对官方 api 此句的处理</span></span><br><span class="line">          definition = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">_base</span>.<span class="title function_">extend</span>(definition)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 注册 (指令函数)</span></span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">&#x27;directive&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> definition === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">          <span class="comment">// 这里将会被 `bind` 和 `update` 调用 —— 针对此的处理</span></span><br><span class="line">          definition = &#123; <span class="attr">bind</span>: definition, <span class="attr">update</span>: definition &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">options</span>[type + <span class="string">&#x27;s&#x27;</span>][id] = definition</span><br><span class="line">        <span class="comment">// 返回处理后的值</span></span><br><span class="line">        <span class="keyword">return</span> definition</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-1-Vue-directive-id-definition"><a href="#8-1-Vue-directive-id-definition" class="headerlink" title="8.1 Vue.directive( id, [definition] )"></a>8.1 <code>Vue.directive( id, [definition] )</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">directive</span>(<span class="string">&#x27;my-directive&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">bind</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="attr">inserted</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="attr">update</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="attr">componentUpdated</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="attr">unbind</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册 (指令函数)</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">directive</span>(<span class="string">&#x27;my-directive&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 这里将会被 `bind` 和 `update` 调用</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// getter，返回已注册的指令</span></span><br><span class="line"><span class="keyword">var</span> myDirective = <span class="title class_">Vue</span>.<span class="title function_">directive</span>(<span class="string">&#x27;my-directive&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="8-2-Vue-filter-id-definition"><a href="#8-2-Vue-filter-id-definition" class="headerlink" title="8.2 Vue.filter( id, [definition] )"></a>8.2 <code>Vue.filter( id, [definition] )</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">filter</span>(<span class="string">&#x27;my-filter&#x27;</span>, <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="comment">// 返回处理后的值</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// getter，返回已注册的过滤器</span></span><br><span class="line"><span class="keyword">var</span> myFilter = <span class="title class_">Vue</span>.<span class="title function_">filter</span>(<span class="string">&#x27;my-filter&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="8-3-Vue-component-id-definition"><a href="#8-3-Vue-component-id-definition" class="headerlink" title="8.3 Vue.component( id, [definition] )"></a>8.3 <code>Vue.component( id, [definition] )</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册组件，传入一个扩展过的构造器</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;my-component&#x27;</span>, <span class="title class_">Vue</span>.<span class="title function_">extend</span>(&#123; <span class="comment">/* ... */</span> &#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册组件，传入一个选项对象 (自动调用 Vue.extend)</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;my-component&#x27;</span>, &#123; <span class="comment">/* ... */</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取注册的组件 (始终返回构造器)</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MyComponent</span> = <span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;my-component&#x27;</span>)</span><br></pre></td></tr></table></figure>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-04-28</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约3278个字, 10分钟55秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/104-initProxy/">4. initProxy</a></h3></div><div class="post-content"><div class="card"><p><p><strong>【前情回顾】</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  src\core\instance\init.js</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options?: <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 开发环境时，调用initProxy方法</span></span><br><span class="line">      <span class="comment">// 如果不是开发环境，则vue实例的_renderProxy属性指向vue实例本身。</span></span><br><span class="line">      <span class="title function_">initProxy</span>(vm)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vm.<span class="property">_renderProxy</span> = vm</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-initProxy"><a href="#1-initProxy" class="headerlink" title="1. initProxy"></a>1. <code>initProxy</code></h2><ul>
<li>最核心的代码就是 <code>vm._renderProxy = new Proxy(vm, handlers)</code>，通过 Proxy 进行 handlers 拦截检测处理 ，将结果赋值给 <code>vm._renderProxy</code>。</li>
<li>其中，handlers 中主要检测 vm 的属性拦截校验。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">let</span> initProxy</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 根据 makeMap 的实现，将这个字符串转换为类似对象 &#123;Infinity: true, undefined: true, ...&#125;</span></span><br><span class="line">  <span class="keyword">const</span> allowedGlobals = <span class="title function_">makeMap</span>(</span><br><span class="line">    <span class="string">&#x27;Infinity,undefined,NaN,isFinite,isNaN,&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;parseFloat,parseInt,decodeURI,decodeURIComponent,encodeURI,encodeURIComponent,&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;Math,Number,Date,Array,Object,Boolean,String,RegExp,Map,Set,JSON,Intl,BigInt,&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;require&#x27;</span> <span class="comment">// for Webpack/Browserify</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 属性或方法未定义，报警告</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">warnNonPresent</span> = (<span class="params">target, key</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`Property or method &quot;<span class="subst">$&#123;key&#125;</span>&quot; is not defined on the instance but `</span> +</span><br><span class="line">      <span class="string">&#x27;referenced during render. Make sure that this property is reactive, &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;either in the data option, or for class-based components, by &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;initializing the property. &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;See: https://vuejs.org/v2/guide/reactivity.html#Declaring-Reactive-Properties.&#x27;</span>,</span><br><span class="line">      target</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 属性 key 以 $ 或者 _ 开头，报警告（避免与内置属性方法冲突）</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">warnReservedPrefix</span> = (<span class="params">target, key</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`Property &quot;<span class="subst">$&#123;key&#125;</span>&quot; must be accessed with &quot;$data.<span class="subst">$&#123;key&#125;</span>&quot; because `</span> +</span><br><span class="line">      <span class="string">&#x27;properties starting with &quot;$&quot; or &quot;_&quot; are not proxied in the Vue instance to &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;prevent conflicts with Vue internals. &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;See: https://vuejs.org/v2/api/#data&#x27;</span>,</span><br><span class="line">      target</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    // 检测是不是支持原生方法 </span></span><br><span class="line"><span class="comment">    export function isNative (Ctor: any): boolean &#123;</span></span><br><span class="line"><span class="comment">    return typeof Ctor === &#x27;function&#x27; &amp;&amp; /native code/.test(Ctor.toString())</span></span><br><span class="line"><span class="comment">  &#125; */</span></span><br><span class="line">  <span class="comment">// 判断是否支持 Proxy</span></span><br><span class="line">  <span class="keyword">const</span> hasProxy =</span><br><span class="line">    <span class="keyword">typeof</span> <span class="title class_">Proxy</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(<span class="title class_">Proxy</span>)</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">const</span> hasHandler = &#123;...&#125;</span><br><span class="line">    <span class="keyword">const</span> getHandler = &#123;...&#125;                 </span><br><span class="line">    </span><br><span class="line">    initProxy = <span class="keyword">function</span> <span class="title function_">initProxy</span> (vm) &#123;</span><br><span class="line">      <span class="comment">// 判断当前环境是否支持 Proxy，支持就用 Proxy 代理后赋值 vm._renderProxy </span></span><br><span class="line">      <span class="keyword">if</span> (hasProxy) &#123;</span><br><span class="line">        <span class="comment">// determine which proxy handler to use</span></span><br><span class="line">        <span class="keyword">const</span> options = vm.<span class="property">$options</span></span><br><span class="line">        <span class="keyword">const</span> handlers = options.<span class="property">render</span> &amp;&amp; options.<span class="property">render</span>.<span class="property">_withStripped</span></span><br><span class="line">          ? getHandler</span><br><span class="line">          : hasHandler</span><br><span class="line">        vm.<span class="property">_renderProxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(vm, handlers)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vm.<span class="property">_renderProxy</span> = vm</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123; initProxy &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调试时，只看到调 <code>hasHandler</code>，不知什么时候调 <code>getHandler</code>，查资料如下：</li>
</ul>
<p>handers函数会根据 options.render._withStripped的不同执行不同的代理函数，<strong>当使用类似webpack这样的打包工具时，通常会使用vue-loader插件进行模板的编译，这个时候options.render是存在的，并且_withStripped的属性也会设置为true</strong>，所以此时代理的选项是hasHandler,在其他场景下，代理的选项是getHandler。getHandler,hasHandler的逻辑相似</p>
<ul>
<li>关于 <code>_renderProxy</code></li>
</ul>
<p>源码中vm._renderProxy的使用出现在Vue实例的_render方法中，Vue.prototype._render是将渲染函数转换成Virtual DOM的方法，这部分是关于实例的挂载和模板引擎的解析，笔者并不会在这一章节中深入分析，我们只需要先有一个认知，Vue内部在js和真实DOM节点中设立了一个中间层，这个中间层就是Virtual DOM，<strong>遵循js -&gt; virtual -&gt; 真实dom</strong>的转换过程,而<strong>Vue.prototype._render是前半段的转换</strong>，当我们调用render函数时，代理的vm._renderProxy对象便会访问到。</p>
<h3 id="1-1-hasHandler"><a href="#1-1-hasHandler" class="headerlink" title="1.1  hasHandler"></a>1.1 <code> hasHandler</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hasHandler = &#123;</span><br><span class="line">  <span class="comment">// target 是目标代理的对象； key 是需要检查是否存在的属性</span></span><br><span class="line">  <span class="comment">// 此方法拦截检测模板中的属性，检测是否合法</span></span><br><span class="line">  has (target, key) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;key&#x27;</span>, key) <span class="comment">// 辅助理解，打印 key</span></span><br><span class="line">    <span class="comment">// 此处的target就是 Vue 实例</span></span><br><span class="line">    <span class="comment">// key 是否在 target 中的标记</span></span><br><span class="line">    <span class="keyword">const</span> has = key <span class="keyword">in</span> target</span><br><span class="line">    <span class="comment">// (key 在上文全局 Globals 字符串中 || key 以`_`开头且 key 不属于 target 的 $data 的属性) 则为 true</span></span><br><span class="line">    <span class="keyword">const</span> isAllowed = <span class="title function_">allowedGlobals</span>(key) ||</span><br><span class="line">      (<span class="keyword">typeof</span> key === <span class="string">&#x27;string&#x27;</span> &amp;&amp; key.<span class="title function_">charAt</span>(<span class="number">0</span>) === <span class="string">&#x27;_&#x27;</span> &amp;&amp; !(key <span class="keyword">in</span> target.<span class="property">$data</span>))</span><br><span class="line">    <span class="keyword">if</span> (!has &amp;&amp; !isAllowed) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> target.<span class="property">$data</span>) <span class="title function_">warnReservedPrefix</span>(target, key)</span><br><span class="line">      <span class="keyword">else</span> <span class="title function_">warnNonPresent</span>(target, key)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> has || !isAllowed</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>此方法是为了拦截模板中的属性进行校验，</strong></p>
<p><strong>eg: 如下这段示例代码，打印出</strong> hasHandler 中 的 <strong>has 的 key 值：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;editor&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">:value</span>=<span class="string">&quot;input + new Date()&quot;</span> @<span class="attr">input</span>=<span class="string">&quot;update&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-html</span>=<span class="string">&quot;compiledMarkdown&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">el</span>: <span class="string">&#x27;#editor&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">data</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">input</span>: <span class="string">&#x27;# hello&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">computed</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">compiledMarkdown</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">return</span> <span class="title function_">marked</span>(<span class="variable language_">this</span>.<span class="property">input</span>, &#123; <span class="attr">sanitize</span>: <span class="literal">true</span> &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">update</span>: _.<span class="title function_">debounce</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">input</span> = e.<span class="property">target</span>.<span class="property">value</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;, <span class="number">300</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/104-initProxy/1657261394103-7e82e6a1-0505-4343-b9ec-8b5b0b6996eb.png" alt="img"></p>
<p>原示例中 <code>&lt;textarea :value=&quot;input&quot;</code> 没有 new Date()，则打印的 key 值也没有 Date。</p>
<p>这个理解辅助理解 <code> allowedGlobals(key)</code>的意义，说明如果模板中使用原生一些对象，是不会被拦截的。</p>
<h4 id="【辅助】makeMap"><a href="#【辅助】makeMap" class="headerlink" title="【辅助】makeMap"></a>【辅助】<code>makeMap</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\shared\util.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Make a map and return a function for checking if a key</span></span><br><span class="line"><span class="comment"> * is in that map.</span></span><br><span class="line"><span class="comment"> * 调用eg：makeMap(&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;)(&#x27;a&#x27;) // 返回true</span></span><br><span class="line"><span class="comment"> * 1.第一组参数 (str,expectsLowerCase) ，将字符串格式化为对象</span></span><br><span class="line"><span class="comment"> * &quot;a,b,c&quot; ==&gt; &#123;a: true, b: true, c: true&#125;</span></span><br><span class="line"><span class="comment"> * 2. 第二组参数 return 的 val，校验val是否存在str中，若存在返回 true，不存在返回undefined</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">makeMap</span> (</span><br><span class="line">  <span class="attr">str</span>: string,</span><br><span class="line">  expectsLowerCase?: boolean</span><br><span class="line">): <span class="function">(<span class="params">key: string</span>) =&gt;</span> <span class="literal">true</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> map = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// 将类似格式的字符串 &quot;a,b,c&quot; 拆成数组 [a,b,c] </span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">list</span>: <span class="title class_">Array</span>&lt;string&gt; = str.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// 将类似格式的数组[a,b,c] 转换为 &#123;a: true, b: true, c: true&#125;</span></span><br><span class="line">    map[list[i]] = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 统一大小写处理，返回 val 是否在 map 中，存在返回 true，不存在返回undefined</span></span><br><span class="line">  <span class="keyword">return</span> expectsLowerCase</span><br><span class="line">    ? <span class="function"><span class="params">val</span> =&gt;</span> map[val.<span class="title function_">toLowerCase</span>()]</span><br><span class="line">    : <span class="function"><span class="params">val</span> =&gt;</span> map[val]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Proxy-对象"><a href="#2-Proxy-对象" class="headerlink" title="2. Proxy 对象"></a>2. Proxy 对象</h2><h3 id="2-1-概念"><a href="#2-1-概念" class="headerlink" title="2.1 概念"></a>2.1 概念</h3><p><strong>Proxy</strong> 对象用于创建一个对象的代理，从而实现基本操作的拦截和自定义（如属性查找、赋值、枚举、函数调用等）。</p>
<p>ES6 原生提供 Proxy 构造函数，用来生成 Proxy 实例。</p>
<p>Proxy 用于修改某些操作的默认行为，等同于在语言层面做出修改，所以属于一种“元编程”（meta programming），即对编程语言进行编程。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// target: 所要拦截的目标对象</span></span><br><span class="line"><span class="comment">// handler: 处理器对象，用于设置拦截行为</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Proxy</span>(target, handler)</span><br></pre></td></tr></table></figure>



<h3 id="2-2-术语"><a href="#2-2-术语" class="headerlink" title="2.2 术语"></a>2.2 术语</h3><ul>
<li>target</li>
</ul>
<p>要使用 Proxy 包装的目标对象（可以是任何类型的对象，包括原生数组，函数，甚至另一个代理）</p>
<ul>
<li>handler</li>
</ul>
<p>处理器对象（包含trap）</p>
<ul>
<li><em>traps</em></li>
</ul>
<p>捕捉器， 提供属性访问的方法</p>
<h3 id="2-3-拦截器-handler"><a href="#2-3-拦截器-handler" class="headerlink" title="2.3 拦截器 handler"></a>2.3 拦截器 handler</h3><p>下面是 Proxy 支持的拦截操作一览，一共 13 种。</p>
<ul>
<li>**get(target, propKey, receiver)**：拦截对象属性的读取，比如proxy.foo和proxy[‘foo’]。</li>
<li>**set(target, propKey, value, receiver)**：拦截对象属性的设置，比如proxy.foo &#x3D; v或proxy[‘foo’] &#x3D; v，返回一个布尔值。</li>
<li>**has(target, propKey)**：拦截propKey in proxy的操作，返回一个布尔值。</li>
<li>**deleteProperty(target, propKey)**：拦截delete proxy[propKey]的操作，返回一个布尔值。</li>
<li>**ownKeys(target)**：拦截Object.getOwnPropertyNames(proxy)、Object.getOwnPropertySymbols(proxy)、Object.keys(proxy)、for…in循环，返回一个数组。该方法返回目标对象所有自身的属性的属性名，而Object.keys()的返回结果仅包括目标对象自身的可遍历属性。</li>
<li>**getOwnPropertyDescriptor(target, propKey)**：拦截Object.getOwnPropertyDescriptor(proxy, propKey)，返回属性的描述对象。</li>
<li>**defineProperty(target, propKey, propDesc)**：拦截Object.defineProperty(proxy, propKey, propDesc）、Object.defineProperties(proxy, propDescs)，返回一个布尔值。</li>
<li>**preventExtensions(target)**：拦截Object.preventExtensions(proxy)，返回一个布尔值。</li>
<li>**getPrototypeOf(target)**：拦截Object.getPrototypeOf(proxy)，返回一个对象。</li>
<li>**isExtensible(target)**：拦截Object.isExtensible(proxy)，返回一个布尔值。</li>
<li>**setPrototypeOf(target, proto)**：拦截Object.setPrototypeOf(proxy, proto)，返回一个布尔值。如果目标对象是函数，那么还有两种额外操作可以拦截。</li>
<li>**apply(target, object, args)**：拦截 Proxy 实例作为函数调用的操作，比如proxy(…args)、proxy.call(object, …args)、proxy.apply(…)。</li>
<li>**construct(target, args)**：拦截 Proxy 实例作为构造函数调用的操作，比如new proxy(…args)。</li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1821611">https://cloud.tencent.com/developer/article/1821611</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903812285595662">https://juejin.cn/post/6844903812285595662</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy</a></p>
<p><a target="_blank" rel="noopener" href="https://es6.ruanyifeng.com/#docs/proxy">https://es6.ruanyifeng.com/#docs/proxy</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-04-08</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约1997个字, 6分钟39秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/102-Vue%E5%AE%9E%E4%BE%8B%E5%88%9D%E5%A7%8B%E5%8C%96/">2. Vue实例初始化</a></h3></div><div class="post-content"><div class="card"><p><p><img src="/102-Vue%E5%AE%9E%E4%BE%8B%E5%88%9D%E5%A7%8B%E5%8C%96/1658330043075-39864445-8c75-4cbf-aec6-106aeaafd5a5.png" alt="img"></p>
<p><strong>【前情回顾】</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;./instance/index&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span></span><br></pre></td></tr></table></figure>

<h1 id="src-core-instance-index-js"><a href="#src-core-instance-index-js" class="headerlink" title="src/core/instance/index.js"></a><code>src/core/instance/index.js</code></h1><ul>
<li>创建 new Vue(options) 时调用的方法，内部 调用 _init  方法</li>
<li>挂载 初始化 相关方法 </li>
<li>挂载 状态处理 相关方法</li>
<li>挂载 事件 相关方法</li>
<li>挂载 生命周期 方法</li>
<li>挂载 渲染 相关方法</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; initMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./init&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; stateMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./state&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; renderMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./render&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; eventsMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./events&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; lifecycleMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./lifecycle&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; warn &#125; <span class="keyword">from</span> <span class="string">&#x27;../util/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 组件创建 new Vue() 时调用的方法</span></span><br><span class="line"><span class="comment">// options是new Vue() 时传的配置项参数，如data、methods等</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Vue</span> (options) &#123;</span><br><span class="line">  <span class="comment">// 当 直接使用 Vue(...) 时会报错，要求用 new Vue(...)</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">    !(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">Vue</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">&#x27;Vue is a constructor and should be called with the `new` keyword&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_init</span>(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">initMixin</span>(<span class="title class_">Vue</span>)        <span class="comment">// 挂载 初始化 方法 ( 含 this._init )</span></span><br><span class="line"><span class="title function_">stateMixin</span>(<span class="title class_">Vue</span>)       <span class="comment">// 挂载 状态处理 方法</span></span><br><span class="line"><span class="title function_">eventsMixin</span>(<span class="title class_">Vue</span>)      <span class="comment">// 挂载 事件 相关方法</span></span><br><span class="line"><span class="title function_">lifecycleMixin</span>(<span class="title class_">Vue</span>)   <span class="comment">// 挂载 生命周期 方法</span></span><br><span class="line"><span class="title function_">renderMixin</span>(<span class="title class_">Vue</span>)      <span class="comment">// 挂载 渲染 相关方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span></span><br></pre></td></tr></table></figure>

<h2 id="1-initMixin-Vue"><a href="#1-initMixin-Vue" class="headerlink" title="1. initMixin(Vue)"></a>1. <code>initMixin(Vue)</code></h2><ul>
<li>定义 Vue.prototype._init ，代码分析如下 6</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/init.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options?: <span class="built_in">Object</span></span>) &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-stateMixin-Vue"><a href="#2-stateMixin-Vue" class="headerlink" title="2. stateMixin(Vue)"></a>2. <code>stateMixin(Vue)</code></h2><ul>
<li>给 Vue 挂载属性 <code>$data</code> <code>$props</code> <code>$set</code> <code>$delete</code> <code>$watch</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/state.js</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Watcher</span> <span class="keyword">from</span> <span class="string">&#x27;../observer/watcher&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Dep</span>, &#123; pushTarget, popTarget &#125; <span class="keyword">from</span> <span class="string">&#x27;../observer/dep&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  set,</span><br><span class="line">  del,</span><br><span class="line">  observe,</span><br><span class="line">  defineReactive,</span><br><span class="line">  toggleObserving</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;../observer/index&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">stateMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$data&#x27;</span>, dataDef)</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$props&#x27;</span>, propsDef)</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$set</span> = set</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$delete</span> = del</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$watch</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">    expOrFn: string | <span class="built_in">Function</span>,</span></span><br><span class="line"><span class="params">    cb: any,</span></span><br><span class="line"><span class="params">    options?: <span class="built_in">Object</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, expOrFn, cb, options)</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unwatchFn</span> () &#123;</span><br><span class="line">      watcher.<span class="title function_">teardown</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-eventsMixin-Vue"><a href="#3-eventsMixin-Vue" class="headerlink" title="3. *eventsMixin*(*Vue*)"></a>3. <code>*eventsMixin*(*Vue*)</code></h2><ul>
<li>给 Vue 挂载属性 <code>$on``$once``$off</code> <code>$emit</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/events.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">eventsMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$on</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$once</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$off</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$emit</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-lifecycleMixin-Vue"><a href="#4-lifecycleMixin-Vue" class="headerlink" title="4. *lifecycleMixin*(*Vue*)"></a><em>4.</em> <code>*lifecycleMixin*(*Vue*)</code></h2><ul>
<li>给 Vue 挂载属性 <code>$_update``$forceUpdate``$destroy</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/lifecycle.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">eventsMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_update</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$forceUpdate</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$destroy</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-renderMixin-Vue"><a href="#5-renderMixin-Vue" class="headerlink" title="5. *renderMixin*(*Vue*)"></a><em>5.</em> <code>*renderMixin*(*Vue*)</code></h2><ul>
<li>给 Vue 挂载属性 <code>$nextTick``_render</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/render.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">eventsMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$nextTick</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_render</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$destroy</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-this-init"><a href="#6-this-init" class="headerlink" title="6. this._init()"></a>6. <code>this._init()</code></h2><ul>
<li><p>初始化 Vue 实例 vm 的属性 <code>_uid</code> ,<code>_isVue</code>, <code>$option</code>, <code>_renderProxy</code>,<code>_name</code> 等 ；</p>
</li>
<li><p>beforeCreate 前，</p>
</li>
<li><ul>
<li>合并参数及组件；</li>
<li>开发环境且支持 Proxy 对象的，使用 initProxy 拦截检测实例 vm</li>
<li>初始化生命周期的状态变量，如 $parent, $child, _watcher, _isMounted 等</li>
<li>初始化事件变量 $_events</li>
<li>初始化渲染相关变量，如 $slot, _c, $createElement, $attrs, $listeners 等</li>
</ul>
</li>
<li><p>beforeCreate 后，created 前， </p>
</li>
<li><ul>
<li>初始化注入元素</li>
<li>初始化状态， props, methods, data, computed, watch</li>
<li>初始化提供注入的数据或方法</li>
</ul>
</li>
<li><p>created后，vm.$mount 挂载 el 元素</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/init.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options?: <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">    <span class="comment">// Vue 实例</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="comment">// a uid</span></span><br><span class="line">    <span class="comment">// 在 Vue 的源码中每一个类型的实例 都会有一个 唯一标识</span></span><br><span class="line">    vm.<span class="property">_uid</span> = uid++</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> startTag, endTag</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">      startTag = <span class="string">`vue-perf-start:<span class="subst">$&#123;vm._uid&#125;</span>`</span></span><br><span class="line">      endTag = <span class="string">`vue-perf-end:<span class="subst">$&#123;vm._uid&#125;</span>`</span></span><br><span class="line">      <span class="title function_">mark</span>(startTag)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// a flag to avoid this being observed</span></span><br><span class="line">    <span class="comment">// Vue 根实例的标记，用于避免 被响应式处理的标记</span></span><br><span class="line">    vm.<span class="property">_isVue</span> = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// merge options 合并参数</span></span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; options.<span class="property">_isComponent</span>) &#123;</span><br><span class="line">      <span class="comment">// 组件的合并</span></span><br><span class="line">      <span class="comment">// optimize internal component instantiation</span></span><br><span class="line">      <span class="comment">// since dynamic options merging is pretty slow, and none of the</span></span><br><span class="line">      <span class="comment">// internal component options needs special treatment.</span></span><br><span class="line">      <span class="title function_">initInternalComponent</span>(vm, options)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 简单实例的合并，将自定义属性和默认属性合并</span></span><br><span class="line">      vm.<span class="property">$options</span> = <span class="title function_">mergeOptions</span>(</span><br><span class="line">        <span class="title function_">resolveConstructorOptions</span>(vm.<span class="property">constructor</span>),</span><br><span class="line">        options || &#123;&#125;,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="comment">// 开发环境时，调用 initProxy 方法</span></span><br><span class="line">    <span class="comment">// 如果不是开发环境，则将 vue实例的 _renderProxy 属性指向 vue实例本身</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">initProxy</span>(vm)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vm.<span class="property">_renderProxy</span> = vm</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// expose real self</span></span><br><span class="line">    <span class="comment">// 将实例指向 _self 属性</span></span><br><span class="line">    vm.<span class="property">_self</span> = vm</span><br><span class="line">    <span class="comment">// 初始化生命周期的状态变量</span></span><br><span class="line">    <span class="title function_">initLifecycle</span>(vm)</span><br><span class="line">    <span class="comment">// 初始化事件</span></span><br><span class="line">    <span class="title function_">initEvents</span>(vm)</span><br><span class="line">    <span class="comment">// 初始化创建元素的方法</span></span><br><span class="line">    <span class="title function_">initRender</span>(vm)</span><br><span class="line">    <span class="comment">// 标记生命周期 - beforeCreate</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeCreate&#x27;</span>)</span><br><span class="line">    <span class="comment">// 初始化注入元素</span></span><br><span class="line">    <span class="title function_">initInjections</span>(vm) <span class="comment">// resolve injections before data/props</span></span><br><span class="line">    <span class="comment">// 初始化状态（data，props）【重点】</span></span><br><span class="line">    <span class="title function_">initState</span>(vm)</span><br><span class="line">    <span class="comment">// 初始化注入对应的依赖</span></span><br><span class="line">    <span class="title function_">initProvide</span>(vm) <span class="comment">// resolve provide after data/props</span></span><br><span class="line">    <span class="comment">// 标记生命周期 - created</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;created&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="comment">// 给 performance 分析添加处理标记</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">      vm.<span class="property">_name</span> = <span class="title function_">formatComponentName</span>(vm, <span class="literal">false</span>)</span><br><span class="line">      <span class="title function_">mark</span>(endTag)</span><br><span class="line">      <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;vm._name&#125;</span> init`</span>, startTag, endTag)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">el</span>) &#123;</span><br><span class="line">      <span class="comment">// 组件挂载, 将组件挂载到 el 描述的元素上</span></span><br><span class="line">      <span class="comment">// 此处的 $mount 方法</span></span><br><span class="line">      <span class="comment">// 会先调用 扩展的 $mount 方法（src/platforms/web/entry-runtime-with-compiler.js）, 生成 render</span></span><br><span class="line">      <span class="comment">// 再调用 原始的 $mount 方法（src/platforms/web/runtime/index.js）, 获得元素, 再调用 mountComponent 方法</span></span><br><span class="line">      vm.$mount(vm.<span class="property">$options</span>.<span class="property">el</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-1-initProxy-vm"><a href="#6-1-initProxy-vm" class="headerlink" title="6.1 initProxy(vm)"></a>6.1 <code>initProxy(vm)</code></h3><p>详细分析见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/xf5gh3">04- initProxy</a></p>
<h3 id="6-2-initLifecycle-vm"><a href="#6-2-initLifecycle-vm" class="headerlink" title="6.2 initLifecycle(vm)"></a>6.2 <code>initLifecycle(vm)</code></h3><ul>
<li>初始化 生命周期 相关属性，如 $root, $refs, $children, _watcher, _isMounted, _destroyed</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\lifecycle.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 生命周期 相关属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initLifecycle</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> options = vm.<span class="property">$options</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// locate first non-abstract parent</span></span><br><span class="line">  <span class="keyword">let</span> parent = options.<span class="property">parent</span></span><br><span class="line">  <span class="keyword">if</span> (parent &amp;&amp; !options.<span class="property">abstract</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (parent.<span class="property">$options</span>.<span class="property">abstract</span> &amp;&amp; parent.<span class="property">$parent</span>) &#123;</span><br><span class="line">      parent = parent.<span class="property">$parent</span></span><br><span class="line">    &#125;</span><br><span class="line">    parent.<span class="property">$children</span>.<span class="title function_">push</span>(vm)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vm.<span class="property">$parent</span> = parent</span><br><span class="line">  vm.<span class="property">$root</span> = parent ? parent.<span class="property">$root</span> : vm</span><br><span class="line"></span><br><span class="line">  vm.<span class="property">$children</span> = []</span><br><span class="line">  vm.<span class="property">$refs</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  vm.<span class="property">_watcher</span> = <span class="literal">null</span></span><br><span class="line">  vm.<span class="property">_inactive</span> = <span class="literal">null</span></span><br><span class="line">  vm.<span class="property">_directInactive</span> = <span class="literal">false</span></span><br><span class="line">  vm.<span class="property">_isMounted</span> = <span class="literal">false</span></span><br><span class="line">  vm.<span class="property">_isDestroyed</span> = <span class="literal">false</span></span><br><span class="line">  vm.<span class="property">_isBeingDestroyed</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-initEvents-vm"><a href="#6-3-initEvents-vm" class="headerlink" title="6.3 initEvents(vm)"></a>6.3 <code>initEvents(vm)</code></h3><ul>
<li>新增_events属性并将其赋值为空对象，用来存储事件</li>
<li>获取父组件注册的事件赋给listeners，如果listeners不为空，则调用updateComponentListeners函数，将父组件向子组件注册的事件注册到子组件的实例中</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\events.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">target</span>: any</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">add</span> (event, fn) &#123;</span><br><span class="line">  target.$on(event, fn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">remove</span> (event, fn) &#123;</span><br><span class="line">  target.$off(event, fn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 属性 _events, _hasHookEvent，增加更新组件监听</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"></span>&#125; vm </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initEvents</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  vm.<span class="property">_events</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  vm.<span class="property">_hasHookEvent</span> = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// init parent attached events</span></span><br><span class="line">  <span class="keyword">const</span> listeners = vm.<span class="property">$options</span>.<span class="property">_parentListeners</span></span><br><span class="line">  <span class="keyword">if</span> (listeners) &#123;</span><br><span class="line">    <span class="comment">// 如果有 父组件监听，则 调用更新组件方法</span></span><br><span class="line">    <span class="title function_">updateComponentListeners</span>(vm, listeners)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">updateComponentListeners</span> (</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span><br><span class="line">  <span class="attr">listeners</span>: <span class="title class_">Object</span>,</span><br><span class="line">  <span class="attr">oldListeners</span>: ?<span class="title class_">Object</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">//  增加 绑定事件 方法</span></span><br><span class="line">  target = vm</span><br><span class="line">  <span class="title function_">updateListeners</span>(listeners, oldListeners || &#123;&#125;, add, remove, createOnceHandler, vm)</span><br><span class="line">  <span class="comment">// 增加 移除事件方法</span></span><br><span class="line">  target = <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-3-1-updateListeners"><a href="#6-3-1-updateListeners" class="headerlink" title="6.3.1 updateListeners()"></a>6.3.1 <code>updateListeners()</code></h4><ul>
<li>遍历 listeners  , 如果 listeners对象中存在某个key（即事件名）而oldListeners中不存在，则说明这个事件是需要新增的；</li>
<li>遍历 oldListeners  , 如果oldListeners对象中存在某个key（即事件名）而listeners中不存在，则说明这个事件是需要从事件系统中卸载。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对比listeners和oldListeners</span></span><br><span class="line"><span class="comment"> * 再通过 add 和remove 进行 注册事件 和 卸载事件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; on </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; oldOn </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; add </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; remove </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; createOnceHandler </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">updateListeners</span> (</span><br><span class="line">  <span class="attr">on</span>: <span class="title class_">Object</span>,</span><br><span class="line">  <span class="attr">oldOn</span>: <span class="title class_">Object</span>,</span><br><span class="line">  <span class="attr">add</span>: <span class="title class_">Function</span>,</span><br><span class="line">  <span class="attr">remove</span>: <span class="title class_">Function</span>,</span><br><span class="line">  <span class="attr">createOnceHandler</span>: <span class="title class_">Function</span>,</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">let</span> name, def, cur, old, event</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> on) &#123;</span><br><span class="line">    def = cur = on[name]</span><br><span class="line">    old = oldOn[name]</span><br><span class="line">    event = <span class="title function_">normalizeEvent</span>(name)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* export function isUndef (v: any): boolean %checks &#123;</span></span><br><span class="line"><span class="comment">      return v === undefined || v === null</span></span><br><span class="line"><span class="comment">    &#125; */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(cur)) &#123;</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`Invalid handler for event &quot;<span class="subst">$&#123;event.name&#125;</span>&quot;: got `</span> + <span class="title class_">String</span>(cur),</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isUndef</span>(old)) &#123;</span><br><span class="line">      <span class="comment">// cur 有值， old 没值 </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isUndef</span>(cur.<span class="property">fns</span>)) &#123;</span><br><span class="line">        cur = on[name] = <span class="title function_">createFnInvoker</span>(cur, vm)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isTrue</span>(event.<span class="property">once</span>)) &#123;</span><br><span class="line">        cur = on[name] = <span class="title function_">createOnceHandler</span>(event.<span class="property">name</span>, cur, event.<span class="property">capture</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 调用入参的 target.$on(event, fn) 方法 注册事件</span></span><br><span class="line">      <span class="title function_">add</span>(event.<span class="property">name</span>, cur, event.<span class="property">capture</span>, event.<span class="property">passive</span>, event.<span class="property">params</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur !== old) &#123;</span><br><span class="line">      <span class="comment">// cur 有值， old 有值，且两者不相等</span></span><br><span class="line">      old.<span class="property">fns</span> = cur</span><br><span class="line">      on[name] = old</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> oldOn) &#123;</span><br><span class="line">    <span class="comment">// 遍历旧Listener，如果有 name 属性没有值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(on[name])) &#123;</span><br><span class="line">      event = <span class="title function_">normalizeEvent</span>(name)</span><br><span class="line">      <span class="comment">// 调用入参的 target.$off(event, fn) 方法 移除事件 </span></span><br><span class="line">      <span class="title function_">remove</span>(event.<span class="property">name</span>, oldOn[name], event.<span class="property">capture</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-initRender-vm"><a href="#6-4-initRender-vm" class="headerlink" title="6.4 initRender(vm)"></a>6.4 <code>initRender(vm)</code></h3><ul>
<li>初始化 渲染相关属性，如 _node, _staticTrees, $slots, $scopedSlots, _c, $createElement 等 </li>
<li>将 $attrs 和 $listeners 变成响应式</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\render.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initRender</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="comment">// _vnode 是子节点树的根</span></span><br><span class="line">  vm.<span class="property">_vnode</span> = <span class="literal">null</span> <span class="comment">// the root of the child tree</span></span><br><span class="line">  vm.<span class="property">_staticTrees</span> = <span class="literal">null</span> <span class="comment">// v-once cached trees</span></span><br><span class="line">  <span class="keyword">const</span> options = vm.<span class="property">$options</span></span><br><span class="line">  <span class="keyword">const</span> parentVnode = vm.<span class="property">$vnode</span> = options.<span class="property">_parentVnode</span> <span class="comment">// the placeholder node in parent tree</span></span><br><span class="line">  <span class="keyword">const</span> renderContext = parentVnode &amp;&amp; parentVnode.<span class="property">context</span></span><br><span class="line">  vm.<span class="property">$slots</span> = <span class="title function_">resolveSlots</span>(options.<span class="property">_renderChildren</span>, renderContext)</span><br><span class="line">  vm.<span class="property">$scopedSlots</span> = emptyObject</span><br><span class="line">  <span class="comment">// bind the createElement fn to this instance</span></span><br><span class="line">  <span class="comment">// so that we get proper render context inside it.</span></span><br><span class="line">  <span class="comment">// args order: tag, data, children, normalizationType, alwaysNormalize</span></span><br><span class="line">  <span class="comment">// internal version is used by render functions compiled from templates</span></span><br><span class="line">  <span class="comment">// 系统创建元素的方法，参数分别为：tag, data, children, normalizationType, alwaysNormalize</span></span><br><span class="line">  vm.<span class="property">_c</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">false</span>)</span><br><span class="line">  <span class="comment">// normalization is always applied for the public version, used in</span></span><br><span class="line">  <span class="comment">// user-written render functions.</span></span><br><span class="line">  <span class="comment">// 用户写 render 属性时创建元素的方法</span></span><br><span class="line">  vm.<span class="property">$createElement</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// $attrs &amp; $listeners are exposed for easier HOC creation.</span></span><br><span class="line">  <span class="comment">// they need to be reactive so that HOCs using them are always updated</span></span><br><span class="line">  <span class="keyword">const</span> parentData = parentVnode &amp;&amp; parentVnode.<span class="property">data</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">  <span class="comment">// 将 $attrs 和 $listeners 变成响应式</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$attrs&#x27;</span>, parentData &amp;&amp; parentData.<span class="property">attrs</span> || emptyObject, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      !isUpdatingChildComponent &amp;&amp; <span class="title function_">warn</span>(<span class="string">`$attrs is readonly.`</span>, vm)</span><br><span class="line">    &#125;, <span class="literal">true</span>)</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$listeners&#x27;</span>, options.<span class="property">_parentListeners</span> || emptyObject, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      !isUpdatingChildComponent &amp;&amp; <span class="title function_">warn</span>(<span class="string">`$listeners is readonly.`</span>, vm)</span><br><span class="line">    &#125;, <span class="literal">true</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$attrs&#x27;</span>, parentData &amp;&amp; parentData.<span class="property">attrs</span> || emptyObject, <span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$listeners&#x27;</span>, options.<span class="property">_parentListeners</span> || emptyObject, <span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-5-callHook-vm-39-beforeCreate-39"><a href="#6-5-callHook-vm-39-beforeCreate-39" class="headerlink" title="6.5 callHook(vm, &#39;beforeCreate&#39;)"></a>6.5 <code>callHook(vm, &#39;beforeCreate&#39;)</code></h3><ul>
<li>执行 $options 中配置的钩子函数</li>
<li>若有 Hook Event（vm._hasHookEvent 为 true），生命周期函数执行后触发自定义hook事件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行 $options 中配置的钩子函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; hook </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">callHook</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">hook</span>: string) &#123;</span><br><span class="line">  <span class="comment">// #7573 disable dep collection when invoking lifecycle hooks</span></span><br><span class="line">  <span class="comment">// 当构造生命周期钩子时， 禁止 dep 依赖收集，故将 Dep.target 置空</span></span><br><span class="line">  <span class="title function_">pushTarget</span>()</span><br><span class="line">  <span class="comment">// 从参数中获取 钩子函数体， 如created, mounted</span></span><br><span class="line">  <span class="keyword">const</span> handlers = vm.<span class="property">$options</span>[hook]</span><br><span class="line">  <span class="keyword">const</span> info = <span class="string">`<span class="subst">$&#123;hook&#125;</span> hook`</span></span><br><span class="line">  <span class="keyword">if</span> (handlers) &#123;</span><br><span class="line">    <span class="comment">// 遍历钩子函数体，通过 apply 或 call 执行钩子函数体的内容</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, j = handlers.<span class="property">length</span>; i &lt; j; i++) &#123;</span><br><span class="line">      <span class="title function_">invokeWithErrorHandling</span>(handlers[i], vm, <span class="literal">null</span>, vm, info)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 若实例设置 Hook Event，如：&lt;comp @hook:mounted=&quot;method&quot; /&gt;，</span></span><br><span class="line">  <span class="comment">// 执行完生命周期函数之后，触发该事件的执行</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">_hasHookEvent</span>) &#123;</span><br><span class="line">    <span class="comment">// 相当于 vm.$emit(&#x27;hook:mounted&#x27;)</span></span><br><span class="line">    vm.$emit(<span class="string">&#x27;hook:&#x27;</span> + hook)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 关闭依赖收集</span></span><br><span class="line">  <span class="title function_">popTarget</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-5-1-invokeWithErrorHandling-handlers-i-vm-null-vm-info"><a href="#6-5-1-invokeWithErrorHandling-handlers-i-vm-null-vm-info" class="headerlink" title="6.5.1 invokeWithErrorHandling(handlers[i], vm, null, vm, info)"></a>6.5.1 <code>invokeWithErrorHandling(handlers[i], vm, null, vm, info)</code></h4><ul>
<li>将 handler 函数体，包在 try catch 中捕获异常</li>
<li>执行 handler 函数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\util\error.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行 handler 函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; handler </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; context </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; args </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; info </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">invokeWithErrorHandling</span> (</span><br><span class="line">  <span class="attr">handler</span>: <span class="title class_">Function</span>,</span><br><span class="line">  <span class="attr">context</span>: any,</span><br><span class="line">  <span class="attr">args</span>: <span class="literal">null</span> | any[],</span><br><span class="line">  <span class="attr">vm</span>: any,</span><br><span class="line">  <span class="attr">info</span>: string</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">let</span> res</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 若有参数 用 apply，若无则用 call，执行 handler 函数，</span></span><br><span class="line">    <span class="comment">// handler 方法体内若无return，则res 为 undefined（正常情况下为undefined）</span></span><br><span class="line">    res = args ? handler.<span class="title function_">apply</span>(context, args) : handler.<span class="title function_">call</span>(context)</span><br><span class="line">    <span class="keyword">if</span> (res &amp;&amp; !res.<span class="property">_isVue</span> &amp;&amp; <span class="title function_">isPromise</span>(res) &amp;&amp; !res.<span class="property">_handled</span>) &#123;</span><br><span class="line">      <span class="comment">// 当 返回有值 且 _isVue 不为true 且 是Promise 对象 且 _handled 为空即第一次执行的，报错</span></span><br><span class="line">      res.<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">handleError</span>(e, vm, info + <span class="string">` (Promise/async)`</span>))</span><br><span class="line">      <span class="comment">// issue #9511</span></span><br><span class="line">      <span class="comment">// avoid catch triggering multiple times when nested calls</span></span><br><span class="line">      res.<span class="property">_handled</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="title function_">handleError</span>(e, vm, info)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-6-initInjections-vm"><a href="#6-6-initInjections-vm" class="headerlink" title="6.6 	initInjections(vm)"></a>6.6 	<code>initInjections(vm)</code></h3><ul>
<li>通过 resolveInject 方法处理 获取 $option.inject 参数中数组中 键 对应的 provide 的  键值对参数</li>
<li>若有 inject ，将处理后的参数进行响应式处理 挂到 vm 实例上</li>
</ul>
<p>注意：解析 inject 在 初始化 data&#x2F;props 之前</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\inject.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 $options.inject 的值注入到 vm 上</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initInjections</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取 $options.inject 注入内容</span></span><br><span class="line">  <span class="comment">/* 如：</span></span><br><span class="line"><span class="comment">    // 父组件</span></span><br><span class="line"><span class="comment">    provide: &#123;</span></span><br><span class="line"><span class="comment">      father: &#x27;father params&#x27;</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    // 子组件</span></span><br><span class="line"><span class="comment">    inject: [&#x27;father&#x27;],</span></span><br><span class="line"><span class="comment">    result 结果为： &#123;father: &quot;father params&quot;&#125; */</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">resolveInject</span>(vm.<span class="property">$options</span>.<span class="property">inject</span>, vm)</span><br><span class="line">  <span class="keyword">if</span> (result) &#123;</span><br><span class="line">    <span class="comment">// 关闭依赖收集监听</span></span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="comment">// 将注入的值，在 vm 实例上直接响应式处理；使其可以直接用 vm.father 这种方式使用注入的值</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(result).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">defineReactive</span>(vm, key, result[key], <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`Avoid mutating an injected value directly since the changes will be `</span> +</span><br><span class="line">            <span class="string">`overwritten whenever the provided component re-renders. `</span> +</span><br><span class="line">            <span class="string">`injection being mutated: &quot;<span class="subst">$&#123;key&#125;</span>&quot;`</span>,</span><br><span class="line">            vm</span><br><span class="line">          )</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理后 vm.father = &quot;father params&quot;</span></span><br><span class="line">        <span class="title function_">defineReactive</span>(vm, key, result[key])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 打开依赖收集监听</span></span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-7-initState-vm"><a href="#6-7-initState-vm" class="headerlink" title="6.7 initState(vm)"></a>6.7 <code>initState(vm)</code></h3><ul>
<li>初始化 props, methods, data, computed, watch</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 props, methods, data, computed, watch</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initState</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  vm.<span class="property">_watchers</span> = []</span><br><span class="line">  <span class="keyword">const</span> opts = vm.<span class="property">$options</span></span><br><span class="line">  <span class="comment">// 初始化 options.props 成员</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">props</span>) <span class="title function_">initProps</span>(vm, opts.<span class="property">props</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 options.methods 方法成员</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">methods</span>) <span class="title function_">initMethods</span>(vm, opts.<span class="property">methods</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 options.data ( 响应式处理 )</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">data</span>) &#123;</span><br><span class="line">    <span class="title function_">initData</span>(vm)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">observe</span>(vm.<span class="property">_data</span> = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 options.computed 计算属性</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">computed</span>) <span class="title function_">initComputed</span>(vm, opts.<span class="property">computed</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 options.watch 监听</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">watch</span> &amp;&amp; opts.<span class="property">watch</span> !== nativeWatch) &#123;</span><br><span class="line">    <span class="title function_">initWatch</span>(vm, opts.<span class="property">watch</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-7-1-initProps-vm-opts-props"><a href="#6-7-1-initProps-vm-opts-props" class="headerlink" title="6.7.1 initProps(vm,opts.props)"></a>6.7.1 <code>initProps(vm,opts.props)</code></h4><ul>
<li>遍历 $options.props ，将 key 挂载在 vm._props 下，进行响应式处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 props</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; propsOptions </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initProps</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">propsOptions</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> propsData = vm.<span class="property">$options</span>.<span class="property">propsData</span> || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> props = vm.<span class="property">_props</span> = &#123;&#125;</span><br><span class="line">  <span class="comment">// cache prop keys so that future props updates can iterate using Array</span></span><br><span class="line">  <span class="comment">// instead of dynamic object key enumeration.</span></span><br><span class="line">  <span class="keyword">const</span> keys = vm.<span class="property">$options</span>.<span class="property">_propKeys</span> = []</span><br><span class="line">  <span class="keyword">const</span> isRoot = !vm.<span class="property">$parent</span></span><br><span class="line">  <span class="comment">// root instance props should be converted</span></span><br><span class="line">  <span class="comment">// 不在根下，关闭响应式处理</span></span><br><span class="line">  <span class="keyword">if</span> (!isRoot) &#123;</span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">false</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> propsOptions) &#123;</span><br><span class="line">    keys.<span class="title function_">push</span>(key)</span><br><span class="line">    <span class="keyword">const</span> value = <span class="title function_">validateProp</span>(key, propsOptions, propsData, vm)</span><br><span class="line">    ...</span><br><span class="line">      <span class="comment">// 将 key 挂载在 vm._props 下，进行响应式处理</span></span><br><span class="line">      <span class="title function_">defineReactive</span>(props, key, value)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// static props are already proxied on the component&#x27;s prototype</span></span><br><span class="line">    <span class="comment">// during Vue.extend(). We only need to proxy props defined at</span></span><br><span class="line">    <span class="comment">// instantiation here.</span></span><br><span class="line">    <span class="comment">// 如果 key 不在 vm 实例中，则 将 key 挂载到 vm._props 属性下</span></span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      <span class="title function_">proxy</span>(vm, <span class="string">`_props`</span>, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">toggleObserving</span>(<span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-7-2-initMethods-vm-opts-methods"><a href="#6-7-2-initMethods-vm-opts-methods" class="headerlink" title="6.7.2 initMethods(vm,opts.methods)"></a>6.7.2 <code>initMethods(vm,opts.methods)</code></h4><ul>
<li>遍历 $options.methods ，校验方法，若不是function类型、或与 props 重名、或方法名重名 均报错</li>
<li>若是方法，则 使用 bind 方法，将每个 methods 方法体的 this 指向 vm 实例</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 methods 所有方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; methods </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initMethods</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">methods</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> props = vm.<span class="property">$options</span>.<span class="property">props</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> methods) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 校验 方法不是 function</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> methods[key] !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; has type &quot;<span class="subst">$&#123;<span class="keyword">typeof</span> methods[key]&#125;</span>&quot; in the component definition. `</span> +</span><br><span class="line">          <span class="string">`Did you reference the function correctly?`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 校验 方法 与 props 重名</span></span><br><span class="line">      <span class="keyword">if</span> (props &amp;&amp; <span class="title function_">hasOwn</span>(props, key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; has already been defined as a prop.`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 校验 方法名重复</span></span><br><span class="line">      <span class="keyword">if</span> ((key <span class="keyword">in</span> vm) &amp;&amp; <span class="title function_">isReserved</span>(key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; conflicts with an existing Vue instance method. `</span> +</span><br><span class="line">          <span class="string">`Avoid defining component methods that start with _ or $.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 若  methods[key] 不是方法，则 值为空函数</span></span><br><span class="line">    <span class="comment">// 若 是方法，相当于 methods[key].bind(vm)，即将每个 methods 方法体的 this 指向 vm 实例</span></span><br><span class="line">    vm[key] = <span class="keyword">typeof</span> methods[key] !== <span class="string">&#x27;function&#x27;</span> ? noop : <span class="title function_">bind</span>(methods[key], vm)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="【辅助】bind"><a href="#【辅助】bind" class="headerlink" title="【辅助】bind"></a>【辅助】<code>bind</code></h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\shared\util.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持 bind 时， 即将 fn 内的 this 指向 ctx</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">nativeBind</span> (<span class="attr">fn</span>: <span class="title class_">Function</span>, <span class="attr">ctx</span>: <span class="title class_">Object</span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> fn.<span class="title function_">bind</span>(ctx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> bind = <span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">bind</span></span><br><span class="line">  ? nativeBind</span><br><span class="line">  : polyfillBind</span><br></pre></td></tr></table></figure>

<h4 id="6-7-3-initData-vm"><a href="#6-7-3-initData-vm" class="headerlink" title="6.7.3 initData(vm)"></a>6.7.3 <code>initData(vm)</code></h4><ul>
<li>method、props 重名校验</li>
<li>循环遍历，将 $options.data 的属性挂载到 vm._data；为方便访问，又将其直接挂载到 vm 下</li>
<li>调用 observe 响应式处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initData</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> data = vm.<span class="property">$options</span>.<span class="property">data</span></span><br><span class="line">  <span class="comment">// data 如果是对象格式，则直接赋值；若是函数，则通过getData 获取data 对象</span></span><br><span class="line">  <span class="comment">// 然后将 data 挂载到 vm._data 上</span></span><br><span class="line">  data = vm.<span class="property">_data</span> = <span class="keyword">typeof</span> data === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    ? <span class="title function_">getData</span>(data, vm)</span><br><span class="line">    : data || &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isPlainObject</span>(data)) &#123;</span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">&#x27;data functions should return an object:\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function&#x27;</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// proxy data on instance</span></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(data)</span><br><span class="line">  <span class="keyword">const</span> props = vm.<span class="property">$options</span>.<span class="property">props</span></span><br><span class="line">  <span class="keyword">const</span> methods = vm.<span class="property">$options</span>.<span class="property">methods</span></span><br><span class="line">  <span class="keyword">let</span> i = keys.<span class="property">length</span></span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="comment">// methods 与 $options.data 属性不能重名</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (methods &amp;&amp; <span class="title function_">hasOwn</span>(methods, key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; has already been defined as a data property.`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// props 与 $options.data 属性不能重名</span></span><br><span class="line">    <span class="keyword">if</span> (props &amp;&amp; <span class="title function_">hasOwn</span>(props, key)) &#123;</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`The data property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already declared as a prop. `</span> +</span><br><span class="line">        <span class="string">`Use prop default value instead.`</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title function_">isReserved</span>(key)) &#123;</span><br><span class="line">      <span class="comment">// 若不含保留字符 $ 和 _，循环将 $options.data 的所有属性 key 映射到 vue 实例上</span></span><br><span class="line">      <span class="comment">// 从而访问 data中的属性时，不用 Vue._data.**，直接用 Vue.** </span></span><br><span class="line">      <span class="title function_">proxy</span>(vm, <span class="string">`_data`</span>, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// observe data</span></span><br><span class="line">  <span class="comment">// data 响应式处理</span></span><br><span class="line">  <span class="title function_">observe</span>(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6-7-3-1-getData"><a href="#6-7-3-1-getData" class="headerlink" title="6.7.3.1 getData()"></a>6.7.3.1 <code>getData()</code></h5><ul>
<li>由于此时是 Vue 的初始化，还没有进行模板渲染，所以 <strong>不需要进行依赖收集，在 pushTarget 的时候传入 空</strong></li>
<li>就将全局的 Watcher 设置为 undefined，依赖收集的时候有一个判断是 Dep.target 存在的时候才收集</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getData</span> (<span class="attr">data</span>: <span class="title class_">Function</span>, <span class="attr">vm</span>: <span class="title class_">Component</span>): any &#123;</span><br><span class="line">  <span class="comment">// #7573 disable dep collection when invoking data getters</span></span><br><span class="line">  <span class="comment">// 此时是 Vue 的初始化，还没有进行模板渲染，所以 不需要进行依赖收集</span></span><br><span class="line">  <span class="title function_">pushTarget</span>()</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> data.<span class="title function_">call</span>(vm, vm)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="title function_">handleError</span>(e, vm, <span class="string">`data()`</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="title function_">popTarget</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6-7-3-2-proxy-将-options-data-的所有属性-key-映射到-vue-实例上"><a href="#6-7-3-2-proxy-将-options-data-的所有属性-key-映射到-vue-实例上" class="headerlink" title="6.7.3.2 proxy()  将$options.data 的所有属性 key 映射到 vue 实例上"></a>6.7.3.2 <code>proxy()</code>  将$options.data 的所有属性 key 映射到 vue 实例上</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 Object.defineProperty 数据劫持</span></span><br><span class="line"><span class="comment">// eg：proxy(vm, `_data`, key), 实现将 vm._data.key 可以直接用 vm.key 访问的功能</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">proxy</span> (<span class="attr">target</span>: <span class="title class_">Object</span>, <span class="attr">sourceKey</span>: string, <span class="attr">key</span>: string) &#123;</span><br><span class="line">  sharedPropertyDefinition.<span class="property">get</span> = <span class="keyword">function</span> <span class="title function_">proxyGetter</span> () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>[sourceKey][key]</span><br><span class="line">  &#125;</span><br><span class="line">  sharedPropertyDefinition.<span class="property">set</span> = <span class="keyword">function</span> <span class="title function_">proxySetter</span> (val) &#123;</span><br><span class="line">    <span class="variable language_">this</span>[sourceKey][key] = val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(target, key, sharedPropertyDefinition)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6-7-3-3-observe响应式处理"><a href="#6-7-3-3-observe响应式处理" class="headerlink" title="6.7.3.3  observe响应式处理"></a>6.7.3.3  <code>observe</code>响应式处理</h5><p>详见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/onzg44">05- observer</a></p>
<h4 id="6-7-4-initComputed-vm-opts-computed"><a href="#6-7-4-initComputed-vm-opts-computed" class="headerlink" title="6.7.4 initComputed(vm,opts.computed)"></a>6.7.4 <code>initComputed(vm,opts.computed)</code></h4><p>详见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/onzg44">05- observer</a> 的 6</p>
<h4 id="6-7-5-initWatch-vm-opts-watch"><a href="#6-7-5-initWatch-vm-opts-watch" class="headerlink" title="6.7.5 initWatch(vm,opts.watch)"></a>6.7.5 <code>initWatch(vm,opts.watch)</code></h4><p>详见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/onzg44">05- observer</a> 的 5.1</p>
<h3 id="6-8-initProvide-vm"><a href="#6-8-initProvide-vm" class="headerlink" title="6.8 initProvide(vm)"></a>6.8 <code>initProvide(vm)</code></h3><ul>
<li>初始化 provide 指定我们想要<strong>提供</strong>给后代组件的数据&#x2F;方法</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 provide</span></span><br><span class="line"><span class="comment"> * 获取 $options.provide，若是 function 则直接执行；若不是则返回 provide</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initProvide</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> provide = vm.<span class="property">$options</span>.<span class="property">provide</span></span><br><span class="line">  <span class="keyword">if</span> (provide) &#123;</span><br><span class="line">    vm.<span class="property">_provided</span> = <span class="keyword">typeof</span> provide === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">      ? provide.<span class="title function_">call</span>(vm)</span><br><span class="line">      : provide</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-9-vm-mount-vm-options-el"><a href="#6-9-vm-mount-vm-options-el" class="headerlink" title="6.9 vm.$mount(vm.$options.el)"></a>6.9 <code>vm.$mount(vm.$options.el)</code></h3><p>详细分析见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/ad1pdp">06- 模板渲染</a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6877754661362171912">https://juejin.cn/post/6877754661362171912</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6954923081462710309">https://juejin.cn/post/6954923081462710309</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7070087080965046280">https://juejin.cn/post/7070087080965046280</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-03-12</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约4049个字, 13分钟29秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/101-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E5%85%A5%E5%8F%A3/">1. 源码学习入口</a></h3></div><div class="post-content"><div class="card"><p><h2 id><a href="#" class="headerlink" title></a><img src="/101-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E5%85%A5%E5%8F%A3/1658329999134-ff717063-49d2-447d-8227-3c345506f6e4.png" alt="img"></h2><h2 id="1-入口文件package-json"><a href="#1-入口文件package-json" class="headerlink" title="1. 入口文件package.json"></a>1. 入口文件<code>package.json</code></h2><ul>
<li>根据运行命令，去找 <code>dev</code> 后配置，即找 <code>scripts/config.js</code> 文件的 <code>web-full-dev</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;dev&quot;: &quot;rollup -w -c scripts/config.js --environment TARGET:web-full-dev&quot;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-scripts-config-js"><a href="#2-scripts-config-js" class="headerlink" title="2. scripts/config.js"></a>2. <code>scripts/config.js</code></h2><ul>
<li>初始化配置 config，引入 entry-runtime-with-compiler.js</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">// scripts\config.js</span><br><span class="line">...</span><br><span class="line">const aliases = require(&#x27;./alias&#x27;) // 看 ./alias 文件</span><br><span class="line">const resolve = p =&gt; &#123;</span><br><span class="line">  const base = p.split(&#x27;/&#x27;)[0]</span><br><span class="line">  if (aliases[base]) &#123;</span><br><span class="line">    return path.resolve(aliases[base], p.slice(base.length + 1))</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return path.resolve(__dirname, &#x27;../&#x27;, p)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 配置定义</span><br><span class="line">const builds = &#123;</span><br><span class="line">  ... </span><br><span class="line">  // Runtime+compiler development build (Browser)</span><br><span class="line">  &#x27;web-full-dev&#x27;: &#123;</span><br><span class="line">    entry: resolve(&#x27;web/entry-runtime-with-compiler.js&#x27;), // 看 reslove ，由此找到对应文件真实路径</span><br><span class="line">    dest: resolve(&#x27;dist/vue.js&#x27;),</span><br><span class="line">    format: &#x27;umd&#x27;,</span><br><span class="line">    env: &#x27;development&#x27;,</span><br><span class="line">    alias: &#123; he: &#x27;./entity-decoder&#x27; &#125;,</span><br><span class="line">    banner</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 根据不同的环境，初始化参数 input, plugins, output, __VERSION__ 等</span><br><span class="line"> * @param &#123;*&#125; name 环境名</span><br><span class="line"> * @returns </span><br><span class="line"> */</span><br><span class="line">function genConfig (name) &#123;</span><br><span class="line">  const opts = builds[name] // 找 builds 中 name 配置</span><br><span class="line">  const config = &#123;</span><br><span class="line">     input: opts.entry,</span><br><span class="line">     external: opts.external,</span><br><span class="line">     plugins: [],</span><br><span class="line">     output: &#123;&#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  return config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始执行入口，找 TARGET 对应配置</span><br><span class="line">if (process.env.TARGET) &#123;</span><br><span class="line">  module.exports = genConfig(process.env.TARGET) // 看 genConfig</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  exports.getBuild = genConfig</span><br><span class="line">  exports.getAllBuilds = () =&gt; Object.keys(builds).map(genConfig)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="process-env-TARGET"><a href="#process-env-TARGET" class="headerlink" title="**process****.****env****.****TARGET**:"></a><code>**process****.****env****.****TARGET**</code><strong>:</strong></h3><p>这个 <code>process</code>  是nodejs 的 变量，</p>
<p>在  \node_modules@types\node\globals.d.ts 中：</p>
<p> <code>declare var process: NodeJS.Process;</code></p>
<h3 id="aliases："><a href="#aliases：" class="headerlink" title="aliases："></a><code>aliases</code>：</h3><p>根据上面的找<code>./alias</code> 文件，即：scripts&#x2F;alias.js，由此找到 <code>web/</code> 对应的文件全路径。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// </span><br><span class="line">...</span><br><span class="line">module.exports = &#123;</span><br><span class="line">  vue: resolve(&#x27;src/platforms/web/entry-runtime-with-compiler&#x27;),</span><br><span class="line">  compiler: resolve(&#x27;src/compiler&#x27;),</span><br><span class="line">  core: resolve(&#x27;src/core&#x27;),</span><br><span class="line">  shared: resolve(&#x27;src/shared&#x27;),</span><br><span class="line">  web: resolve(&#x27;src/platforms/web&#x27;),</span><br><span class="line">  weex: resolve(&#x27;src/platforms/weex&#x27;),</span><br><span class="line">  server: resolve(&#x27;src/server&#x27;),</span><br><span class="line">  sfc: resolve(&#x27;src/sfc&#x27;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由此找到 <code> entry: resolve(&#39;web/entry-runtime-with-compiler.js&#39;),</code></p>
<p>拼接后的入口文件路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/platforms/web/entry-runtime-with-compiler.js</span><br></pre></td></tr></table></figure>



<h2 id="3-platforms-web-entry-runtime-with-compiler-js"><a href="#3-platforms-web-entry-runtime-with-compiler-js" class="headerlink" title="3. platforms/web/entry-runtime-with-compiler.js"></a>3. <code>platforms/web/entry-runtime-with-compiler.js</code></h2><ul>
<li>导入  .&#x2F;runtime&#x2F;index，见 4.1；</li>
<li>扩展 Vue.prototype.$mount 方法；</li>
<li>导入  .&#x2F;compiler&#x2F;index 的 compileToFunctions 方法，挂载到 Vue.compile，见 4.2；</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">// 引入 /runtime/index 文件, 初始化 vue</span><br><span class="line">import Vue from &#x27;./runtime/index&#x27;</span><br><span class="line">...</span><br><span class="line">// 引入 /compiler/index 文件，初始化 compile 编译方法</span><br><span class="line">import &#123; compileToFunctions &#125; from &#x27;./compiler/index&#x27;</span><br><span class="line">...</span><br><span class="line">// 扩展 $mount 挂载方法</span><br><span class="line">const mount = Vue.prototype.$mount</span><br><span class="line">Vue.prototype.$mount = function (</span><br><span class="line">  el?: string | Element,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): Component &#123;</span><br><span class="line">    ...</span><br><span class="line">    return mount.call(this, el, hydrating)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">// 定义 compile 方法</span><br><span class="line">Vue.compile = compileToFunctions</span><br><span class="line"></span><br><span class="line">export default Vue</span><br></pre></td></tr></table></figure>



<h2 id="4-1-platforms-web-runtime-index-js"><a href="#4-1-platforms-web-runtime-index-js" class="headerlink" title="4.1 platforms/web/runtime/index.js"></a>4.1 <code>platforms/web/runtime/index.js</code></h2><ul>
<li>导入 <code>core/index</code> ，vue 核心代码</li>
<li>定义 $mount 挂载方法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 初始化 vue 核心代码</span><br><span class="line">import Vue from &#x27;core/index&#x27;</span><br><span class="line">...</span><br><span class="line">// 定义 $mount 挂载方法</span><br><span class="line">Vue.prototype.$mount = function (</span><br><span class="line">  el?: string | Element,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): Component &#123;</span><br><span class="line">  // 初始化挂载组件</span><br><span class="line">  el = el &amp;&amp; inBrowser ? query(el) : undefined</span><br><span class="line">  ...</span><br><span class="line">  return mountComponent(this, el, hydrating)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">export default Vue</span><br></pre></td></tr></table></figure>



<h3 id="4-1-2-core-index-js"><a href="#4-1-2-core-index-js" class="headerlink" title="4.1.2 core/index.js"></a>4.1.2 <code>core/index.js</code></h3><ul>
<li>导入 core&#x2F;instance&#x2F;index.js </li>
<li>初始化 全局 API 方法，initGlobalAPI(Vue)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 初始化 vue 实例</span><br><span class="line">import Vue from &#x27;./instance/index&#x27;</span><br><span class="line">import &#123; initGlobalAPI &#125; from &#x27;./global-api/index&#x27;</span><br><span class="line">...</span><br><span class="line">// 初始化 Vue 全局 API</span><br><span class="line">initGlobalAPI(Vue)</span><br><span class="line">...</span><br><span class="line">export default Vue</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-1-instance-index"><a href="#4-1-2-1-instance-index" class="headerlink" title="4.1.2.1 ./instance/index"></a>4.1.2.1 <code>./instance/index</code></h4><ul>
<li>详见：<a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/knb6de">02- ‘src&#x2F;core&#x2F;instance&#x2F;index.js’</a></li>
</ul>
<h4 id="4-1-2-2-initGlobalAPI-Vue"><a href="#4-1-2-2-initGlobalAPI-Vue" class="headerlink" title="4.1.2.2 initGlobalAPI(Vue)"></a>4.1.2.2 <code>initGlobalAPI(Vue)</code></h4><ul>
<li>详见：<a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/vhrfsg">03 - core&#x2F;global-api&#x2F;index.js</a></li>
</ul>
<h2 id="4-2-platforms-web-compile-index-js"><a href="#4-2-platforms-web-compile-index-js" class="headerlink" title="4.2 platforms/web/compile/index.js"></a>4.2 <code>platforms/web/compile/index.js</code></h2><ul>
<li>通过  createCompiler(baseOptions) 初始化 compile， compileToFunctions  方法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import &#123; baseOptions &#125; from &#x27;./options&#x27;</span><br><span class="line">import &#123; createCompiler &#125; from &#x27;compiler/index&#x27;</span><br><span class="line"></span><br><span class="line">const &#123; compile, compileToFunctions &#125; = createCompiler(baseOptions)</span><br><span class="line"></span><br><span class="line">export &#123; compile, compileToFunctions &#125;</span><br></pre></td></tr></table></figure>

<h2 id="附：-调试方法（基于-v2-6-14）"><a href="#附：-调试方法（基于-v2-6-14）" class="headerlink" title="附： 调试方法（基于 v2.6.14）"></a>附： 调试方法（基于 v2.6.14）</h2><ul>
<li><code>npm install</code></li>
<li>找到 examples 文件夹，打开任意一个，如 markdowm&#x2F;index.html，将引入的文件的vue文件由min修改为</li>
</ul>
<script src="../../dist/vue.js"></script>

<ul>
<li>直接浏览器打开 index.html 文件即可调试，如 file:&#x2F;&#x2F;&#x2F;E:&#x2F;workSpaces&#x2F;vue-2.6.14&#x2F;examples&#x2F;markdown&#x2F;index.html</li>
</ul>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-02-13</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约823个字, 2分钟44秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/03-%E5%86%85%E5%AD%98/">内存</a></h3></div><div class="post-content"><div class="card"><p><h1 id="1-内存模型"><a href="#1-内存模型" class="headerlink" title="1. 内存模型"></a>1. 内存模型</h1><p>内存空间分为 **栈(stack)、堆(heap)、池(一般也会归类为栈中)**。 </p>
<p>其中<strong>栈</strong>存放变量，<strong>堆</strong>存放复杂对象，<strong>池</strong>存放常量。</p>
<h3 id="1-1-栈内存"><a href="#1-1-栈内存" class="headerlink" title="1.1 栈内存"></a>1.1 栈内存</h3><p>栈是一种特殊的列表。</p>
<p>存取：<strong>先进后出</strong></p>
<p>存储基本数据类型： <strong><code>String</code>、<code>Number</code>、<code>boolean</code>、<code>null</code>、<code>undefined</code>、<code>Symbol</code></strong></p>
<p>基本数据类型保存在栈内存中，因为基本数据类型占用空间小、大小固定，通过按值来访问，属于被频繁使用的数据。</p>
<h3 id="1-2-堆内存"><a href="#1-2-堆内存" class="headerlink" title="1.2 堆内存"></a>1.2 堆内存</h3><p>堆是一种经过排序的树形数据结构，每个结点都有一个值。</p>
<p>堆的特点是根结点的值最小（或最大），且根结点的两个子树也是一个堆。 由于堆的这个特性，常用来实现优先队列。</p>
<p>存取：<strong>随意</strong></p>
<p>存储引用数据类型：<code>Object</code>、<code>Array</code>、<code>Function</code>等</p>
<p>引用数据类型存储在堆内存中，因为引用数据类型占据空间大、大小不固定。 如果存储在栈中，将会影响程序运行的性能； <strong>引用数据类型在栈中存储了指针</strong>，该指针指向堆中该实体的起始地址。 当解释器寻找引用值时，会首先检索其在栈中的地址，<strong>取得地址后从堆中获得值</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">123</span>; <span class="comment">// 变量 a 存在栈中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 变量 b 存在栈中，b的值是&#123;age: 18&#125;的引用地址；&#123;age: 18&#125;作为对象存在堆内存</span></span><br><span class="line"><span class="keyword">var</span> b = &#123; <span class="attr">age</span>: <span class="number">18</span> &#125;; </span><br></pre></td></tr></table></figure>

<h4 id="1-2-1-为什么可以改变-const-的值？"><a href="#1-2-1-为什么可以改变-const-的值？" class="headerlink" title="1.2.1 为什么可以改变 const 的值？"></a>1.2.1 为什么可以改变 const 的值？</h4><p>ES6语法中的 const 声明一个只读的常量。一旦声明，常量的值就不能改变。但是下面的代码可以改变 const 的值，这是为什么？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = &#123;&#125;;</span><br><span class="line">foo.<span class="property">prop</span> = <span class="number">123</span>;</span><br><span class="line">foo.<span class="property">prop</span> <span class="comment">// 123; // 可以修改const，不报错</span></span><br><span class="line">foo = &#123;&#125;; <span class="comment">// TypeError: &quot;foo&quot; is read-only</span></span><br></pre></td></tr></table></figure>

<p>因为const foo存的{}的地址，当foo直接改变地址时，就违反了改变的原则；而当{}中增加属性值时，foo的引用地址没改变，所以可以修改。</p>
<h3 id="1-3-简单类型和复杂类型的区别"><a href="#1-3-简单类型和复杂类型的区别" class="headerlink" title="1.3 简单类型和复杂类型的区别"></a>1.3 简单类型和复杂类型的区别</h3><ul>
<li><p>声明变量时不同的内存地址分配：</p>
</li>
<li><ul>
<li>简单类型的值存放在栈中，在栈中存放的是对应的值</li>
<li>引用类型对应的值存储在堆中，在栈中存放的是指向堆内存的地址</li>
</ul>
</li>
<li><p>不同的类型数据导致赋值变量时的不同：</p>
</li>
<li><ul>
<li>简单类型赋值，是生成相同的值，两个对象对应不同的地址</li>
<li>复杂类型赋值，是将保存对象的内存地址赋值给另一个变量。也就是两个变量指向堆内存中同一个对象</li>
</ul>
</li>
</ul>
<h2 id="2-内存的生命周期："><a href="#2-内存的生命周期：" class="headerlink" title="2. 内存的生命周期："></a>2. 内存的生命周期：</h2><p><img src="/03-%E5%86%85%E5%AD%98/1661853741029-c26d1a6a-79ca-4f67-a7a6-30c667a149af-20220901232511827.png" alt="img"></p>
<ol>
<li>分配需要的内存</li>
</ol>
<p>JavaScript 在定义变量或者创建一个变量的时候，就完成了内存分配。</p>
<ol>
<li>使用分配到的内存（读、写操作）</li>
<li>不需要时将其释放、归还</li>
</ol>
<p>“垃圾回收器”，它的主要工作是跟踪内存的分配和使用，以便当分配的内存不再使用时，自动释放它。</p>
<h2 id="3-垃圾回收机制（GC）"><a href="#3-垃圾回收机制（GC）" class="headerlink" title="3. 垃圾回收机制（GC）"></a>3. 垃圾回收机制（GC）</h2><p><strong>Java garbage collection (GC)</strong></p>
<h3 id="3-1-JavaScript-的自动垃圾收集机制"><a href="#3-1-JavaScript-的自动垃圾收集机制" class="headerlink" title="3.1 JavaScript 的自动垃圾收集机制"></a>3.1 JavaScript 的自动垃圾收集机制</h3><p>就是找出那些不再继续使用的值，然后释放其占用的内存。垃圾收集器会每隔固定的时间段就执行一次释放操作。 在JavaScript中，最常用的是通过标记清除的算法来找到哪些对象是不再继续使用的，因此 a &#x3D; null 其实仅仅只是做了一个释放引用的操作，让 a 原本对应的值失去引用，脱离执行环境，这个值会在下一次垃圾收集器执行操作时被找到并释放。而在适当的时候解除引用，是为页面获得更好性能的一个重要方式。</p>
<h4 id="3-1-1-如何判断一个变量已经死了？"><a href="#3-1-1-如何判断一个变量已经死了？" class="headerlink" title="3.1.1 如何判断一个变量已经死了？"></a>3.1.1 如何判断一个变量已经死了？</h4><p>一个对象在已经没有引用时。</p>
<p>全局变量：会到程序执行完毕，才会被回收；</p>
<p>局部变量：函数执行结束后，如果有外部引用，则不能被回收；没有便可以被回收；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a= &#123;<span class="attr">a</span>: <span class="number">123</span>&#125; <span class="comment">//  &#123;a: 123&#125; 有a引用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> b1 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> c =&#123;<span class="attr">a</span>:<span class="number">1</span>&#125;</span><br><span class="line">  <span class="keyword">return</span> b1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="title function_">b</span>();<span class="comment">//如果return b1,则b1会被回收；如果return c，c不会被回收；</span></span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-到底什么时候回收？"><a href="#3-1-2-到底什么时候回收？" class="headerlink" title="3.1.2 到底什么时候回收？"></a>3.1.2 到底什么时候回收？</h4><p>JavaScript 是自动回收机制，以下是可能会触发的情况：</p>
<ul>
<li>执行完一次主线程（或宏任务、微任务），就会回收一次</li>
<li>当内存不够时，一次执行中可能也会触发回收</li>
</ul>
<h4 id><a href="#" class="headerlink" title></a></h4><h3 id="3-2-引用计数算法"><a href="#3-2-引用计数算法" class="headerlink" title="3.2 引用计数算法"></a>3.2 引用计数算法</h3><p> 引用计数算法定义“内存不再使用”的标准很简单，就是看一个对象是否有指向它的引用。如果没有其他对象指向它了，说明该对象已经不再需了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个对象person，有两个指向属性age和name的引用</span></span><br><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">12</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;aaaa&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">person.<span class="property">name</span> = <span class="literal">null</span>; <span class="comment">// 虽然设置为null，但因为person对象还有指向name的引用，因此name不会回收</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p = person; </span><br><span class="line">person = <span class="number">1</span>;         <span class="comment">//原来的person对象被赋值为1，但因为有新引用p指向原person对象，因此它不会被回收</span></span><br><span class="line"></span><br><span class="line">p = <span class="literal">null</span>;           <span class="comment">//原person对象已经没有引用，很快会被回收</span></span><br></pre></td></tr></table></figure>

<h4 id="限制：循环引用会导致内存泄露"><a href="#限制：循环引用会导致内存泄露" class="headerlink" title="限制：循环引用会导致内存泄露"></a>限制：循环引用会导致内存泄露</h4><p>循环引用：两个对象相互引用，尽管它们不再使用，也不会进行回收，导致内存泄露。</p>
<p>该算法有个限制：无法处理循环引用的事例。在下面的例子1中，两个对象被创建，并互相引用，形成了一个循环。它们被调用之后会离开函数作用域，所以它们已经没有用了，可以被回收了。然而，引用计数算法考虑到它们互相都有至少一次引用，所以它们不会被回收。</p>
<ul>
<li>案例1：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> o = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> o2 = &#123;&#125;;</span><br><span class="line">  o.<span class="property">a</span> = o2; <span class="comment">// o 引用 o2</span></span><br><span class="line">  o2.<span class="property">a</span> = o; <span class="comment">// o2 引用 o</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;azerty&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li>案例2：</li>
</ul>
<p>如：创建一个DOM元素并绑定一个点击事件，变量div有事件处理函数的引用，同时事件处理函数也有div的引用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> div;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  div = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;myDivElement&quot;</span>);</span><br><span class="line">  div.<span class="property">circularReference</span> = div;</span><br><span class="line">  div.<span class="property">lotsOfData</span> = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">10000</span>).<span class="title function_">join</span>(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在上面的例子里，myDivElement 这个 DOM 元素里的 circularReference 属性引用了 myDivElement，造成了循环引用。如果该属性没有显示移除或者设为 null，引用计数式垃圾收集器将总是且至少有一个引用，并将一直保持在内存里的 DOM 元素，即使其从 DOM 树中删去了。如果这个 DOM 元素拥有大量的数据 (如上的 lotsOfData 属性)，而这个数据占用的内存将永远不会被释放。</p>
<h3 id="3-3-标记清除算法"><a href="#3-3-标记清除算法" class="headerlink" title="3.3 标记清除算法"></a>3.3 标记清除算法</h3><p>从 2012 年起，所有现代浏览器都使用了标记 - 清除垃圾回收算法。所有对 JavaScript 垃圾回收算法的改进都是基于标记 - 清除算法的改进，并没有改进标记 - 清除算法本身和它对“对象是否不再需要”的简化定义。</p>
<p>这个算法假定设置一个叫做根（root）的对象（在 Javascript 里，根是全局对象）。垃圾回收器将定期从根开始，找所有从根开始引用的对象，然后找这些对象引用的对象……从根开始，垃圾回收器将找到所有可以获得的对象和收集所有不能获得的对象。</p>
<p>简单说，将那些无法由根部触触发到的对象标记为不再使用，稍后进行回收。</p>
<p><strong>此算法避免内存泄露的方法：</strong></p>
<p><strong>明确切断需要回收的对象与根部的联系</strong></p>
<h4 id="限制：那些无法从根对象查询到的对象都将被清除"><a href="#限制：那些无法从根对象查询到的对象都将被清除" class="headerlink" title="限制：那些无法从根对象查询到的对象都将被清除"></a>限制：那些无法从根对象查询到的对象都将被清除</h4><p>尽管这是一个限制，但实践中我们很少会碰到类似的情况，所以开发者不太会去关心垃圾回收机制。</p>
<h3 id="3-4-V8引擎"><a href="#3-4-V8引擎" class="headerlink" title="3.4 V8引擎"></a>3.4 V8引擎</h3><h4 id="3-4-1-堆内存大小"><a href="#3-4-1-堆内存大小" class="headerlink" title="3.4.1 堆内存大小"></a>3.4.1 堆内存大小</h4><p>在V8引擎的堆内存的大小上限在64位系统中为 <strong>1464MB</strong>，在32位系统中则为 <strong>732MB</strong>（在node 环境有 C++ 加持下，会略扩容）</p>
<h4 id="3-4-2-堆内存对象的分代管理"><a href="#3-4-2-堆内存对象的分代管理" class="headerlink" title="3.4.2 堆内存对象的分代管理"></a>3.4.2 堆内存对象的分代管理</h4><p>V8引擎对堆内存中的 JavaScript 对象进行分代管理。</p>
<p><img src="/03-%E5%86%85%E5%AD%98/1662016839861-073ba972-8ecb-40e9-b3eb-8a8fd7e42379-20220901232511902.png" alt="img"></p>
<p>“垃圾变量”：不再使用的变量或没有被引用的对象。</p>
<h5 id="3-4-2-1-新生代："><a href="#3-4-2-1-新生代：" class="headerlink" title="3.4.2.1 新生代："></a>3.4.2.1 新生代：</h5><p>短时间存活的新变量会存在新生代中，新生代的内存量极小。在 64位系统下，约32M。</p>
<p><strong>新生代的回收算法:</strong></p>
<p>新生代空间一分为二，分为 from: 16M、to: 16M(一直空的) 区。</p>
<p><strong>核心：复制 - 清空</strong></p>
<p><strong>过程：</strong></p>
<p>删掉垃圾变量，把from存活的变量复制到to，把from清空，再把to和from的名字对调。</p>
<p><strong>优势：</strong></p>
<p>这样可以提升回收速度，时间复杂度低，牺牲空间换时间。不用像老生代那样整理磁盘。</p>
<h5 id="3-4-2-2-老生代："><a href="#3-4-2-2-老生代：" class="headerlink" title="3.4.2.2 老生代："></a>3.4.2.2 老生代：</h5><p>生存时间比较长的变量，会转存到老生代，老生代占据了几乎所有内存。在 64位系统下，约1.4G。</p>
<p><strong>老生代回收算法：</strong></p>
<ol>
<li><p>标记垃圾变量</p>
</li>
<li><p>清除垃圾变量</p>
</li>
<li><p>整理磁盘（）– </p>
</li>
<li><ol>
<li>为什么要整理磁盘？</li>
</ol>
</li>
</ol>
<p>如果清除的垃圾变量是多个不连续的变量，虽然空间够，但如果要存一个数组，而<strong>数组存储，必须是在连续的内存空间</strong>，多个不连续的空白空间不能存储数组。</p>
<ol>
<li><ol>
<li>如何整理磁盘？</li>
</ol>
</li>
</ol>
<p>把空出来的内存位置移动合并，留最后整个统一的空白块</p>
<h5 id="3-4-2-3-新生代什么时候转换到老生代？"><a href="#3-4-2-3-新生代什么时候转换到老生代？" class="headerlink" title="3.4.2.3  新生代什么时候转换到老生代？"></a>3.4.2.3  <strong>新生代什么时候转换到老生代？</strong></h5><ol>
<li>新生代发现本次复制（from-&gt; to复制）后，会占用超过25%的to空间</li>
<li>这个对象已经在新生代经历过一次回收</li>
</ol>
<p>就会将新生代变量放到老生代。</p>
<h3 id="3-4-3-为什么-JavaScript-要限制内存，设置-1-4G？"><a href="#3-4-3-为什么-JavaScript-要限制内存，设置-1-4G？" class="headerlink" title="3.4.3 为什么 JavaScript 要限制内存，设置 1.4G？"></a>3.4.3 为什么 JavaScript 要限制内存，设置 1.4G？</h3><ol>
<li>JavaScript 是脚本语言，而脚本语言的特性是一次执行的，没必要弄太大；</li>
</ol>
<p>而Java 这类是后端语言，是作为服务的，会一直开着运行，也就会不断增加内存。</p>
<ol>
<li><strong>核心原因：</strong>垃圾回收是阻塞式的（阻塞式是如果要进行垃圾回收，会中断代码执行，而 JavaScript 是单线程的）</li>
</ol>
<p>而进行一次 1.4G 的垃圾回收，大约需要1s。</p>
<p>如果垃圾太大，垃圾回收耗时久，用户直观看页面感知非常明显；但后端如果中断1s相对影响不大。</p>
<h2 id="4-检测内存"><a href="#4-检测内存" class="headerlink" title="4. 检测内存"></a>4. 检测内存</h2><h3 id="4-1-浏览器端"><a href="#4-1-浏览器端" class="headerlink" title="4.1 浏览器端"></a>4.1 浏览器端</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window.performance.memory</span><br></pre></td></tr></table></figure>

<p>在 DevTools 中，使用 Memory 工具。</p>
<h4 id="Shallow-Size："><a href="#Shallow-Size：" class="headerlink" title="Shallow Size："></a>Shallow Size：</h4><p>对象本身占用<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%86%85%E5%AD%98&spm=1001.2101.3001.7020">内存</a>的大小，不包含其引用的对象。</p>
<ul>
<li>常规对象（非数组）的 Shallow size 由其成员变量的数量和类型决定。</li>
<li>数组的shallow size由数组元素的类型及数组长度决定</li>
</ul>
<h4 id="Retained-Size："><a href="#Retained-Size：" class="headerlink" title="Retained Size："></a>Retained Size：</h4><p>对象的Retained Size &#x3D; 对象本身的Shallow Size + 对象能直接或间接访问到的对象的Shallow Size</p>
<h4 id="Heap-Size"><a href="#Heap-Size" class="headerlink" title="Heap Size:"></a>Heap Size:</h4><p>堆的大小，当资源增加，当前堆的空间不够时，系统会增加堆的大小，若超过上限（如64M，阈值视平台而定）则会被杀掉 。</p>
<h4 id="Allocated"><a href="#Allocated" class="headerlink" title="Allocated:"></a>Allocated:</h4><p>堆中已分配的大小，即 App 应用实际占用的内存大小，资源回收后，此项数据会变小。</p>
<h3 id="4-2-Node-端"><a href="#4-2-Node-端" class="headerlink" title="4.2 Node 端"></a>4.2 Node 端</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 已使用的内存</span></span><br><span class="line">process.<span class="title function_">memoryUsage</span>()</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Node端可以手动触发垃圾回收：global.gc （因为其源码是C++）</p>
</li>
<li><p>Node端可以设置内存：</p>
</li>
</ul>
<p>Node 新版是可以自动扩，如下将内存设置到最大：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行 test.js 文件，设置最大的老生代空间为1700M</span></span><br><span class="line">node --max-old-space-size=<span class="number">1700</span> test.<span class="property">js</span> <span class="comment">// 单位是MB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 test.js 文件，设置最大的新生代空间为1024M</span></span><br><span class="line">node --max_semi_space_size=<span class="number">1024</span> test.<span class="property">js</span> <span class="comment">// 单位是KB</span></span><br></pre></td></tr></table></figure>

<h2 id="5-优化内存"><a href="#5-优化内存" class="headerlink" title="5. 优化内存"></a>5. 优化内存</h2><ul>
<li>少定义全局变量；</li>
<li>如果一定要定义全局变量，可以用完后，手动释放掉，如 <code>a=undefined;a=null;</code> (原理：将引用类型赋值为基本类型，去引用)；</li>
<li>注意增长闭包情况；</li>
</ul>
<h3 id="5-1-增长闭包："><a href="#5-1-增长闭包：" class="headerlink" title="5.1 增长闭包："></a>5.1 增长闭包：</h3><p>普通闭包，对象数据量不大，对整个项目一般影响不大，但需注意增长闭包。</p>
<p>如下例子，是会无限增长的闭包：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="title function_">funciotn</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> arr = []</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">item</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(arr.<span class="property">length</span>&gt;<span class="number">0</span>)&#123; <span class="comment">//可通过限制条数，规避对内存的影响</span></span><br><span class="line">      arr.<span class="title function_">push</span>(item)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)&#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-WeakMap"><a href="#6-WeakMap" class="headerlink" title="6. WeakMap"></a>6. WeakMap</h2><p>ES6 推出了两种新的数据结构：<strong>WeakSet</strong> 和 <strong>WeakMap</strong>。它们对于值的引用都是不计入垃圾回收机制的，所以名字里面才会有一个”Weak”，表示这是<strong>弱引用</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> wm = <span class="keyword">new</span> <span class="title class_">WeakMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> element = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;example&#x27;</span>);</span><br><span class="line"></span><br><span class="line">wm.<span class="title function_">set</span>(element, <span class="string">&#x27;some information&#x27;</span>);</span><br><span class="line">wm.<span class="title function_">get</span>(element) <span class="comment">// &quot;some information&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面代码中，先新建一个 Weakmap 实例。然后，将一个 DOM 节点作为键名存入该实例，并将一些附加信息作为键值，一起存放在 WeakMap 里面。这时，WeakMap 里面对element的引用就是弱引用，不会被计入垃圾回收机制。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903615300108302">https://juejin.cn/post/6844903615300108302</a></p>
<p><a target="_blank" rel="noopener" href="https://www.imooc.com/article/13489">https://www.imooc.com/article/13489</a></p>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2017/04/memory-leak.html">http://www.ruanyifeng.com/blog/2017/04/memory-leak.html</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-01-08</span><i class="fa fa-tag"></i><a class="tag" href="/tags/JavaScript/" title="JavaScript">JavaScript </a><span class="leancloud_visitors"></span><span>大约3562个字, 11分钟52秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/06-%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95vs%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95vs%E5%8E%9F%E5%9E%8B%E6%96%B9%E6%B3%95/">静态方法vs实例方法vs原型方法</a></h3></div><div class="post-content"><div class="card"><p><h4 id="例子对比："><a href="#例子对比：" class="headerlink" title="例子对比："></a>例子对比：</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Person</span> = <span class="keyword">function</span>(<span class="params">name</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;初始化构造函数&#x27;</span>)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构造函数内的方法</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">getName</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;调用构造函数内的方法&#x27;</span>)</span><br><span class="line">    <span class="comment">// return name</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态方法</span></span><br><span class="line"><span class="title class_">Person</span>.<span class="property">staticFunc</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;调用静态方法&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 原型方法</span></span><br><span class="line"><span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">protoFunc</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;调用原型方法&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例对象</span></span><br><span class="line"><span class="keyword">let</span> p1 = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;Luna&#x27;</span>) <span class="comment">// 输出： 初始化构造函数</span></span><br><span class="line"></span><br><span class="line">p1.<span class="title function_">getName</span>()  <span class="comment">// 输出：  调用构造函数内的方法</span></span><br><span class="line">p1.<span class="title function_">protoFunc</span>() <span class="comment">// 输出： 调用原型方法</span></span><br><span class="line">p1.<span class="property">staticFunc</span> <span class="comment">// 输出： undefined</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Person</span>.<span class="property">getName</span> <span class="comment">// 输出： undefined </span></span><br><span class="line"><span class="title class_">Person</span>.<span class="property">protoFunc</span> <span class="comment">// 输出： undefined</span></span><br><span class="line"><span class="title class_">Person</span>.<span class="title function_">staticFunc</span>() <span class="comment">// 输出： 调用静态方法</span></span><br></pre></td></tr></table></figure>

<h3 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h3><p><strong>static</strong> 关键字定义了<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E5%92%8C%E5%AD%97%E6%AE%B5">静态方法或字段</a>，或<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes/Static_initialization_blocks">静态初始化块</a>（有关这种用法的更多信息，请参阅链接）。<strong>静态属性不能在类的实例上直接访问</strong>。相反，它们是<strong>在类本身上被访问</strong>的。</p>
<p>静态方法通常是实用函数，如创建或克隆对象的函数，而静态属性则适用于缓存、固定配置或其他不需要跨实例复制的数据。</p>
<p><strong>当你希望一个字段在每个类中只存在一次，而不是在你创建的每个类实例中都存在时，公有静态字段就很有用。</strong>这对缓存、固定配置或其他不需要在实例间复制的数据非常有用。</p>
<h3 id="构造函数："><a href="#构造函数：" class="headerlink" title="构造函数："></a>构造函数：</h3><p>构造函数的特点有两个。</p>
<ul>
<li>函数体内部使用了this关键字，代表了所要生成的对象实例。</li>
<li>生成对象实例的时候，必须使用new命令。</li>
</ul>
<h3 id="实例方法："><a href="#实例方法：" class="headerlink" title="实例方法："></a>实例方法：</h3><p>实例对象调用的构造函数内的方法。</p>
<h3 id="原型方法："><a href="#原型方法：" class="headerlink" title="原型方法："></a>原型方法：</h3><p>希望在已存在的对象、构造函数添加新的属性或方法，就在对象或构造函数的 prototype 属性上增加新属性和方法。</p>
<p><strong>实例之间共享prototype上的属性和方法。</strong></p>
<h4 id="共享而非复制"><a href="#共享而非复制" class="headerlink" title="共享而非复制"></a>共享而非复制</h4><p>通过将方法和属性定义在prototype上，所有的实例都会共享这些属性和方法，而不是在每个实例创建时复制一份。这意味着无论创建多少个实例，它们都使用同一个方法的引用，这有助于减少脚本的内存使用量。</p>
<h4 id="减少内存使用，优化性能"><a href="#减少内存使用，优化性能" class="headerlink" title="减少内存使用，优化性能"></a>减少内存使用，优化性能</h4><p>当实例需要访问构造函数原型上的属性或方法时，它们会通过原型链来进行查找。这种查找机制相比于在每个对象实例中存储自己的副本要高效得多，因为它避免了不必要的内存浪费，从而提高程序运行的性能。</p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><ol>
<li><strong>实例对象</strong>可以调用的方法：<strong>构造函数内的方法、原型方法；</strong></li>
<li><strong>构造函数</strong>可以调用的方法：<strong>静态方法；</strong></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://docs.pingcode.com/ask/168242.html">https://docs.pingcode.com/ask/168242.html</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Working_with_objects">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Working_with_objects</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-11-30</span><i class="fa fa-tag"></i><a class="tag" href="/tags/JavaScript/" title="JavaScript">JavaScript </a><span class="leancloud_visitors"></span><span>大约788个字, 2分钟37秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/301-hexo%E6%90%AD%E5%BB%BA/">hexo搭建</a></h3></div><div class="post-content"><div class="card"><p><h2 id="1-创建-hexo-项目"><a href="#1-创建-hexo-项目" class="headerlink" title="1. 创建 hexo 项目"></a>1. 创建 hexo 项目</h2><h3 id="1-1-安装-Hexo"><a href="#1-1-安装-Hexo" class="headerlink" title="1.1 安装 Hexo"></a>1.1 安装 Hexo</h3><p><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/#%E5%AE%89%E8%A3%85-Hexo">https://hexo.io/zh-cn/docs/#%E5%AE%89%E8%A3%85-Hexo</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 安装 hexo 手脚架</span><br><span class="line">$ npm install -g hexo-cli</span><br></pre></td></tr></table></figure>

<h3 id="1-2-建站（创建-hexo-项目）"><a href="#1-2-建站（创建-hexo-项目）" class="headerlink" title="1.2  建站（创建 hexo 项目）"></a>1.2  建站（创建 hexo 项目）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 创建项目 &lt;folder&gt;</span><br><span class="line">$ hexo init &lt;folder&gt;</span><br><span class="line">  </span><br><span class="line"># 安装项目依赖  </span><br><span class="line">$ cd &lt;folder&gt;</span><br><span class="line">$ npm install</span><br></pre></td></tr></table></figure>



<p>新建完成后，指定文件夹的目录如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">. </span><br><span class="line">├── _config.yml  // hexo 项目主要的配置文件 </span><br><span class="line">├── package.json </span><br><span class="line">├── scaffolds   // 存放新建blog的模板 </span><br><span class="line">├── source   // blog 文件源 </span><br><span class="line">|   ├── _drafts </span><br><span class="line">|   └── _posts // 最常用穿件的blog存放位置 </span><br><span class="line">└── themes  // blog 主题包</span><br></pre></td></tr></table></figure>

<p><img src="/301-hexo%E6%90%AD%E5%BB%BA/1651791606534-8e89bb3d-10d1-42ae-991a-3cb0309c962e-20220820211106224.png" alt="img"></p>
<h3 id="1-3-预览网站"><a href="#1-3-预览网站" class="headerlink" title="1.3 预览网站"></a>1.3 预览网站</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo server</span><br></pre></td></tr></table></figure>

<p><img src="/301-hexo%E6%90%AD%E5%BB%BA/1651791772412-82774cdc-c583-49ed-813e-bd89f252a8c3-20220820211106832.png" alt="img"></p>
<h2 id="目录-默认文件结构"><a href="#目录-默认文件结构" class="headerlink" title="目录(默认文件结构)"></a>目录(默认文件结构)</h2><table>
<thead>
<tr>
<th><strong>参数</strong></th>
<th><strong>描述</strong></th>
<th><strong>默认值</strong></th>
</tr>
</thead>
<tbody><tr>
<td>source_dir</td>
<td>资源文件夹，这个文件夹用来存放内容。</td>
<td>source</td>
</tr>
<tr>
<td>public_dir</td>
<td>公共文件夹，这个文件夹用于存放生成的站点文件。</td>
<td>public</td>
</tr>
<tr>
<td>tag_dir</td>
<td>标签文件夹</td>
<td>tags</td>
</tr>
<tr>
<td>archive_dir</td>
<td>归档文件夹</td>
<td>archives</td>
</tr>
<tr>
<td>category_dir</td>
<td>分类文件夹</td>
<td>categories</td>
</tr>
<tr>
<td>code_dir</td>
<td>Include code 文件夹，source_dir 下的子目录</td>
<td>downloads&#x2F;code</td>
</tr>
<tr>
<td>i18n_dir</td>
<td>国际化（i18n）文件夹</td>
<td>:lang</td>
</tr>
<tr>
<td>skip_render</td>
<td>跳过指定文件的渲染。匹配到的文件将会被不做改动地复制到 public 目录中。您可使用 <a target="_blank" rel="noopener" href="https://github.com/micromatch/micromatch#extended-globbing">glob 表达式</a>来匹配路径。</td>
<td></td>
</tr>
</tbody></table>
<h3 id="1-4-主题修改"><a href="#1-4-主题修改" class="headerlink" title="1.4 主题修改"></a>1.4 主题修改</h3><p>在 <a target="_blank" rel="noopener" href="https://hexo.io/themes/">https://hexo.io/themes/</a> 可以寻找喜欢的主题进行安装。</p>
<p>如：安装 anatole 主题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://gitee.com/Lhcfl/hexo-theme-anatolo.git themes/Anatolo</span><br></pre></td></tr></table></figure>

<p>安装依赖</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-renderer-pug --save</span><br><span class="line">npm install hexo-renderer-stylus --save</span><br></pre></td></tr></table></figure>

<p>安装成功后（在 theme 文件夹下新增一个皮肤包），修改 <code>_config.yml</code>  的配置 ：</p>
<h2 id="2-创建文章"><a href="#2-创建文章" class="headerlink" title="2. 创建文章"></a>2. 创建文章</h2><h3 id="2-1-创建文章"><a href="#2-1-创建文章" class="headerlink" title="2.1 创建文章"></a>2.1 创建文章</h3><p>默认创建 post 类型 <code>.md</code>文章（文件名默认为<code>.md</code>，文件名无需加 后缀）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ hexo <span class="keyword">new</span> [layout] &lt;title&gt;</span><br><span class="line"></span><br><span class="line"># 简便创建，默认layout 为 post</span><br><span class="line">$ hexo <span class="keyword">new</span> &lt;title&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-创建有图片等资源的文件"><a href="#2-2-创建有图片等资源的文件" class="headerlink" title="2.2 创建有图片等资源的文件"></a>2.2 创建有图片等资源的文件</h3><h4 id="2-2-1-修改-post-asset-folder"><a href="#2-2-1-修改-post-asset-folder" class="headerlink" title="2.2.1 修改  post_asset_folder"></a>2.2.1 修改  <code>post_asset_folder</code></h4><p>修改 <code>_config.yml</code>  中 <code>post_asset_folder</code>配置为 <code>true</code>，然后正常创建文章，便会在<code>A.md</code>文章同层多一个<code>A</code>同名文件夹。</p>
<p>图片路径就直接写即可，相当于 <strong>图片和文章在同一层级</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">post_asset_folder</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><img src="/301-hexo%E6%90%AD%E5%BB%BA/1651793328430-c8aeb32c-1354-495c-bbcf-b8732792058e-20220820211106320.jpeg" alt="img"></p>
<h4 id="2-2-2-安装插件-hexo-renderer-marked"><a href="#2-2-2-安装插件-hexo-renderer-marked" class="headerlink" title="2.2.2 安装插件 hexo-renderer-marked"></a>2.2.2 安装插件 <code>hexo-renderer-marked</code></h4><p>用于 Markdown 解析和渲染的插件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-renderer-marked</span><br></pre></td></tr></table></figure>



<p>修改 <code>_config.yml</code> 配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">post_asset_folder: true</span><br><span class="line">marked:</span><br><span class="line">  prependRoot: true</span><br><span class="line">  postAsset: true</span><br></pre></td></tr></table></figure>



<h3 id="2-3-创建按照年份分类的文章-（此方式暂不可行，会导致图片无法显示）"><a href="#2-3-创建按照年份分类的文章-（此方式暂不可行，会导致图片无法显示）" class="headerlink" title="2.3 创建按照年份分类的文章 （此方式暂不可行，会导致图片无法显示）"></a>2.3 创建按照年份分类的文章 （此方式暂不可行，会导致图片无法显示）</h3><h4 id="有解决方案的欢迎指点"><a href="#有解决方案的欢迎指点" class="headerlink" title="有解决方案的欢迎指点~"></a>有解决方案的欢迎指点~</h4><p>如果直接创建文章，则默认在 <code>source/_post</code> 文件夹下排排放，修改如下配置后，则可以按创建年份将文章分类到不同文件夹下。</p>
<p>修改 <code>_config.yml</code>  ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 保持不变</span><br><span class="line"><span class="attr">permalink</span>: :year/:month/:day/:title/</span><br><span class="line"></span><br><span class="line"># 修改 new_post_name</span><br><span class="line"><span class="attr">new_post_name</span>: :year/:title.<span class="property">md</span> </span><br></pre></td></tr></table></figure>

<h3 id><a href="#" class="headerlink" title></a><img src="/301-hexo%E6%90%AD%E5%BB%BA/1651793466575-2ec9fc1c-8456-4f1f-8295-80fafa9fc221-20220820211106393.png" alt="img"></h3><h3 id="2-4-首页显示部分文章"><a href="#2-4-首页显示部分文章" class="headerlink" title="2.4 首页显示部分文章"></a>2.4 首页显示部分文章</h3><p>在需要显示后加此句，截断首页显示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--more--&gt; </span><br></pre></td></tr></table></figure>



<h2 id="3-Github-Action-部署项目"><a href="#3-Github-Action-部署项目" class="headerlink" title="3. Github Action 部署项目"></a>3. Github Action 部署项目</h2><h3 id="3-1-github-新建仓库"><a href="#3-1-github-新建仓库" class="headerlink" title="3.1 github 新建仓库"></a>3.1 github 新建仓库</h3><ul>
<li>在github 上新建仓库，仓库名为 <code>&#123;userName&#125;.github.io</code>， userName就是github的用户名</li>
<li>创建成功后，复制仓库http的地址</li>
</ul>
<h3 id="3-2-部署"><a href="#3-2-部署" class="headerlink" title="3.2 部署"></a>3.2 部署</h3><ul>
<li>安装部署插件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 安装部署插件</span></span><br><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>

<ul>
<li>修改 <code>_config.yml</code>  配置</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy</span>:</span><br><span class="line">  <span class="attr">type</span>: git</span><br><span class="line">  <span class="attr">repo</span>: <span class="attr">https</span>:<span class="comment">//github.com/SummerOrange/SummerOrange.github.io</span></span><br><span class="line">  <span class="attr">branch</span>: master</span><br></pre></td></tr></table></figure>

<ul>
<li>部署命令</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br><span class="line"></span><br><span class="line"># 简写</span><br><span class="line">$ hexo d</span><br></pre></td></tr></table></figure>

<p>部署完成后，使用仓库名<code>https://summerorange.github.io/</code>即可访问blog。</p>
<h3 id="3-3-如果部署后未修改，可以在github的Actions中查看自动build-run-的情况。"><a href="#3-3-如果部署后未修改，可以在github的Actions中查看自动build-run-的情况。" class="headerlink" title="3.3 如果部署后未修改，可以在github的Actions中查看自动build , run 的情况。"></a>3.3 如果部署后未修改，可以在github的Actions中查看自动build , run 的情况。</h3><p><img src="/301-hexo%E6%90%AD%E5%BB%BA/1651854012322-e6c0a9e2-5036-4d65-b9e5-f717d5cd8ca2-20220820211106443.png" alt="img"></p>
<h3 id="3-4-部署报错"><a href="#3-4-部署报错" class="headerlink" title="3.4 部署报错"></a>3.4 部署报错</h3><p>若 <code>hexo d</code>后报类似错：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fatal</span>: unable to access <span class="string">&#x27;https://.../&#x27;</span>: <span class="title class_">Encountered</span> end <span class="keyword">of</span> file</span><br><span class="line"><span class="variable constant_">FATAL</span> &#123;</span><br><span class="line">  <span class="attr">err</span>: <span class="title class_">Error</span>: <span class="title class_">Spawn</span> failed</span><br><span class="line">      at <span class="title class_">ChildProcess</span>.&lt;anonymous&gt; (<span class="regexp">/.../</span>lib/spawn.<span class="property">js</span>:<span class="number">51</span>:<span class="number">21</span>)</span><br><span class="line">      at <span class="title class_">ChildProcess</span>.<span class="property">emit</span> (events.<span class="property">js</span>:<span class="number">376</span>:<span class="number">20</span>)</span><br><span class="line">      at <span class="title class_">Process</span>.<span class="property">ChildProcess</span>.<span class="property">_handle</span>.<span class="property">onexit</span> (internal/child_process.<span class="property">js</span>:<span class="number">277</span>:<span class="number">12</span>) &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="number">128</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>解决方案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 在项目的根目录下操作如下：</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf .deploy_git/</span><br><span class="line"></span><br><span class="line">git config --global core.autocrlf <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br></pre></td></tr></table></figure>

<h2 id="4-导入有图片的-md已有-blog-小技巧"><a href="#4-导入有图片的-md已有-blog-小技巧" class="headerlink" title="4. 导入有图片的.md已有 blog 小技巧"></a>4. 导入有图片的<code>.md</code>已有 blog 小技巧</h2><h3 id="借助-Typora"><a href="#借助-Typora" class="headerlink" title="借助 Typora"></a><strong>借助 Typora</strong></h3><p>如果已经在在线笔记类似工具中存有<code>.md</code>文章，如果有图片，一个个下载图改路径，是个苦力活。</p>
<p>可以借助 Typora，先在“偏好设置”中配置，图像 - 对网络位置的图片应用上述规则，配置如下：</p>
<p><img src="/301-hexo%E6%90%AD%E5%BB%BA/1652026396145-80fff01d-d2bf-442d-b579-feadc44bf230-20220820211106406.png" alt="img"></p>
<p>配置好后，通过hexo新建好空文档，在 Typora 中将文章直接ctrl + v ，然后将根目录下的图片资源移动到文章对应的文件夹下。</p>
<p>PS：因为hexo中，md 中写的图片路径直接就是图片名称，所以此处配置，不能写<code>./$&#123;filename&#125;</code></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-11-08</span><i class="fa fa-tag"></i><a class="tag" href="/tags/综合/" title="综合">综合 </a><span class="leancloud_visitors"></span><span>大约1148个字, 3分钟49秒读完</span></div></div></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/">上一页</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/page/3/">下一页</a></li></ul></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(无标题)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="想要查找什么..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>