<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="chengshuomin"><title>学习笔记</title><meta name="description" content="chengshuomin blog"><meta name="keywords" content="Blog,博客,chengshuomin"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon1.svg"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.1.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">首页</a></li><li> <a href="/archives">归档</a></li><li> <a href="/tags">标签</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)" style="display:none;"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/logo.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/title.svg" style="width:200px;" alt="favicon"><h3 title=""><a href="/">学习笔记</a></h3><div class="description"><p>chengshuomin blog</p></div></div><ul class="social-links"></ul></div></div><div class="footer"><div class="p"><span> 全站 CC-BY-SA-3.0</span><i class="fa fa-star"></i><span> chengshuomin</span></div><div class="by_farbox"><span>Powered by</span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo</a><span> &</span><span>Anatolo</span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/103-%E5%85%A8%E5%B1%80API%E6%BA%90%E7%A0%81/">全局API源码</a></h3></div><div class="post-content"><div class="card"><p><p><strong>【前情回顾】</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 vue 实例</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;./instance/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; initGlobalAPI &#125; <span class="keyword">from</span> <span class="string">&#x27;./global-api/index&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 初始化 Vue 全局 API</span></span><br><span class="line"><span class="title function_">initGlobalAPI</span>(<span class="title class_">Vue</span>)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span></span><br></pre></td></tr></table></figure>



<p><strong>此文件主要是注册 Vue API 方法，因此比对着</strong> <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><strong>官方API</strong> </a> <strong>读，会容易许多。</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/global-api/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initGlobalAPI</span> (<span class="title class_">Vue</span>: <span class="title class_">GlobalAPI</span>) &#123;</span><br><span class="line">  <span class="comment">// ===== 1 =====</span></span><br><span class="line">  <span class="comment">// config</span></span><br><span class="line">  <span class="comment">// 劫持 config 属性，根据warn提示，此处是为了保护  Vue.config， 不被同名替换</span></span><br><span class="line">  <span class="keyword">const</span> configDef = &#123;&#125;</span><br><span class="line">  configDef.<span class="property">get</span> = <span class="function">() =&gt;</span> config</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    configDef.<span class="property">set</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;Do not replace the Vue.config object, set individual fields instead.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>, <span class="string">&#x27;config&#x27;</span>, configDef)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 2 =====</span></span><br><span class="line">  <span class="comment">// exposed util methods.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> these are not considered part of the public API - avoid relying on</span></span><br><span class="line">  <span class="comment">// them unless you are aware of the risk.</span></span><br><span class="line">  <span class="comment">// 提示：这些不被认为是公共API的一部分，避免依赖它们，除非你清楚风险。</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">util</span> = &#123;</span><br><span class="line">    warn,</span><br><span class="line">    extend,</span><br><span class="line">    mergeOptions,</span><br><span class="line">    defineReactive</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 3 =====</span></span><br><span class="line">  <span class="comment">// 挂载 Vue.set, Vue.delete, Vue.nextTick 方法</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">set</span> = set</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">delete</span> = del</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">nextTick</span> = nextTick</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 挂载 Vue.observable(object) 方法 ， 2.6.0 新增方法</span></span><br><span class="line">  <span class="comment">// 2.6 explicit observable API</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">observable</span> = &lt;T&gt;(<span class="attr">obj</span>: T): <span class="function"><span class="params">T</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">observe</span>(obj)</span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 4 =====</span></span><br><span class="line">  <span class="comment">/* export const ASSET_TYPES = [</span></span><br><span class="line"><span class="comment">    &#x27;component&#x27;,</span></span><br><span class="line"><span class="comment">    &#x27;directive&#x27;,</span></span><br><span class="line"><span class="comment">    &#x27;filter&#x27;</span></span><br><span class="line"><span class="comment">  ] */</span></span><br><span class="line">  <span class="comment">// 初始化 Vue.options, Vue.options.directive, Vue.options.component, Vue.options.filter 方法</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">options</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="variable constant_">ASSET_TYPES</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property">options</span>[type + <span class="string">&#x27;s&#x27;</span>] = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 5 =====</span></span><br><span class="line">  <span class="comment">// this is used to identify the &quot;base&quot; constructor to extend all plain-object</span></span><br><span class="line">  <span class="comment">// components with in Weex&#x27;s multi-instance scenarios.</span></span><br><span class="line">  <span class="comment">// 将 Vue 构造函数挂载到 _base 属性，多用于 weex 多应用场景</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">options</span>.<span class="property">_base</span> = <span class="title class_">Vue</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 6 =====</span></span><br><span class="line">  <span class="comment">// 挂载 keepAlive</span></span><br><span class="line">  <span class="title function_">extend</span>(<span class="title class_">Vue</span>.<span class="property">options</span>.<span class="property">components</span>, builtInComponents)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 7 =====</span></span><br><span class="line">  <span class="comment">// 挂载 Vue.use, Vue.mixin, Vue.extend 方法</span></span><br><span class="line">  <span class="title function_">initUse</span>(<span class="title class_">Vue</span>)</span><br><span class="line">  <span class="title function_">initMixin</span>(<span class="title class_">Vue</span>)</span><br><span class="line">  <span class="title function_">initExtend</span>(<span class="title class_">Vue</span>)</span><br><span class="line">  <span class="comment">// ===== 8 =====</span></span><br><span class="line">  <span class="comment">// 注册定义 Vue.directive, Vue.component, Vue.filter </span></span><br><span class="line">  <span class="title function_">initAssetRegisters</span>(<span class="title class_">Vue</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-Vue-config-全局配置"><a href="#1-Vue-config-全局配置" class="headerlink" title="1. Vue.config  全局配置"></a>1. <code>Vue.config</code>  <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE">全局配置</a></h2><ul>
<li>silent: 取消 Vue 所有的日志与警告。</li>
<li>optionMergeStrategies: 自定义合并策略的选项。(父实例和子实例参数合并时）</li>
<li>devtools：配置是否允许 <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-devtools">vue-devtools</a> 检查代码。开发版本默认为 true，生产版本默认为 false。生产版本设为 true 可以启用检查。</li>
<li>errorHandler： 这个处理函数被调用时，可获取错误信息和 Vue 实例。</li>
<li>warnHandler： 为 Vue 的运行时警告赋予一个自定义处理函数。注意这只会在开发者环境下生效，在生产环境下它会被忽略。</li>
<li>ignoredElements： 须使 Vue 忽略在 Vue 之外的自定义元素 (e.g. 使用了 Web Components APIs)。否则，它会假设你忘记注册全局组件或者拼错了组件名称，从而抛出一个关于 Unknown custom element 的警告。</li>
<li>keyCodes： 给 v-on 自定义键位别名。</li>
<li>performance： 设置为 true 以在浏览器开发工具的性能&#x2F;时间线面板中启用对组件初始化、编译、渲染和打补丁的性能追踪。只适用于开发模式和支持 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/mark">performance.mark</a> API 的浏览器上。</li>
<li>productionTip： 如果设置为 false 以阻止 vue 在启动时生成生产提示。</li>
</ul>
<h2 id="2-Vue-util"><a href="#2-Vue-util" class="headerlink" title="2. Vue.util"></a>2. <code>Vue.util</code></h2><p>一些常用的内部 API 的挂载</p>
<h2 id="3-Vue-set-Vue-delete-Vue-nextTick-Vue-observable"><a href="#3-Vue-set-Vue-delete-Vue-nextTick-Vue-observable" class="headerlink" title="3. Vue.set, Vue.delete,Vue.nextTick, Vue.observable"></a>3. <code>Vue.set, Vue.delete,Vue.nextTick, Vue.observable</code></h2><h3 id="3-1-Vue-set-target-propertyName-x2F-index-value"><a href="#3-1-Vue-set-target-propertyName-x2F-index-value" class="headerlink" title="3.1 Vue.set( target, propertyName&#x2F;index, value )"></a>3.1 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#Vue-set">Vue.set( target, propertyName&#x2F;index, value )</a></h3><p>向响应式对象中添加一个 property，并确保这个新 property 同样是响应式的，且触发视图更新。它必须用于向响应式对象上添加新 property，因为 Vue 无法探测普通的新增 property </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span> (<span class="attr">target</span>: <span class="title class_">Array</span>&lt;any&gt; | <span class="title class_">Object</span>, <span class="attr">key</span>: any, <span class="attr">val</span>: any): any &#123;</span><br><span class="line">  <span class="comment">// 确保target是响应式对象中</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">    (<span class="title function_">isUndef</span>(target) || <span class="title function_">isPrimitive</span>(target))</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">`Cannot set reactive property on undefined, null, or primitive value: <span class="subst">$&#123;(target: any)&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 若target是数组，属性key在target中，则直接赋新值返回</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(target) &amp;&amp; <span class="title function_">isValidArrayIndex</span>(key)) &#123;</span><br><span class="line">    target.<span class="property">length</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(target.<span class="property">length</span>, key)</span><br><span class="line">    target.<span class="title function_">splice</span>(key, <span class="number">1</span>, val)</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 属性key在target中，且不是在prototype上，说明此属性已存在，则直接赋新值返回</span></span><br><span class="line">  <span class="keyword">if</span> (key <span class="keyword">in</span> target &amp;&amp; !(key <span class="keyword">in</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>)) &#123;</span><br><span class="line">    target[key] = val</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> ob = (<span class="attr">target</span>: any).<span class="property">__ob__</span></span><br><span class="line">  <span class="comment">// 是Vue组件，且 vmCount 在有 asRootData 时增加，vmCount 不等于 0 时说明在root下</span></span><br><span class="line">  <span class="comment">// 说明应避免直接在 Vue 根root $data 下添加响应式属性</span></span><br><span class="line">  <span class="keyword">if</span> (target.<span class="property">_isVue</span> || (ob &amp;&amp; ob.<span class="property">vmCount</span>)) &#123;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">&#x27;Avoid adding reactive properties to a Vue instance or its root $data &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;at runtime - declare it upfront in the data option.&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// target 没有 __ob__ 说明是一个非响应式对象，直接添加普通属性</span></span><br><span class="line">  <span class="keyword">if</span> (!ob) &#123;</span><br><span class="line">    target[key] = val</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 设置响应式</span></span><br><span class="line">  <span class="title function_">defineReactive</span>(ob.<span class="property">value</span>, key, val)</span><br><span class="line">  <span class="comment">// 并在更新 dep </span></span><br><span class="line">  ob.<span class="property">dep</span>.<span class="title function_">notify</span>()</span><br><span class="line">  <span class="keyword">return</span> val</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-Vue-delete-target-propertyName-x2F-index"><a href="#3-2-Vue-delete-target-propertyName-x2F-index" class="headerlink" title="3.2  Vue.delete( target, propertyName&#x2F;index )"></a>3.2  <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#Vue-delete">Vue.delete( target, propertyName&#x2F;index )</a></h3><p>删除对象的 property。如果对象是响应式的，确保删除能触发更新视图。这个方法主要用于避开 Vue 不能检测到 property 被删除的限制，但是你应该很少会使用它。</p>
<p><strong>在 2.2.0+ 中同样支持在数组上工作。</strong></p>
<p>目标对象不能是一个 Vue 实例或 Vue 实例的根数据对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">del</span> (<span class="attr">target</span>: <span class="title class_">Array</span>&lt;any&gt; | <span class="title class_">Object</span>, <span class="attr">key</span>: any) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">    (<span class="title function_">isUndef</span>(target) || <span class="title function_">isPrimitive</span>(target))</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">`Cannot delete reactive property on undefined, null, or primitive value: <span class="subst">$&#123;(target: any)&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(target) &amp;&amp; <span class="title function_">isValidArrayIndex</span>(key)) &#123;</span><br><span class="line">    target.<span class="title function_">splice</span>(key, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> ob = (<span class="attr">target</span>: any).<span class="property">__ob__</span></span><br><span class="line">  <span class="comment">// 目标对象不能是一个 Vue 实例或 Vue 实例的根数据对象。</span></span><br><span class="line">  <span class="keyword">if</span> (target.<span class="property">_isVue</span> || (ob &amp;&amp; ob.<span class="property">vmCount</span>)) &#123;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">&#x27;Avoid deleting properties on a Vue instance or its root $data &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;- just set it to null.&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 不存在则不删</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">hasOwn</span>(target, key)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">delete</span> target[key]</span><br><span class="line">  <span class="comment">// 如果是非响应式对象，则不用同步修改 dep</span></span><br><span class="line">  <span class="keyword">if</span> (!ob) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  ob.<span class="property">dep</span>.<span class="title function_">notify</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Vue-nextTick-callback-context"><a href="#3-3-Vue-nextTick-callback-context" class="headerlink" title="3.3 [Vue.nextTick( callback, context] )"></a>3.3 [Vue.nextTick( <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#Vue-nextTick">callback, context] )</a></h3><p>在下次 DOM 更新循环结束之后执行延迟回调。</p>
<p>在修改数据之后立即使用这个方法，获取更新后的 DOM。</p>
<p>整个流程：</p>
<ul>
<li>将调用 nextTick 的参数都放在数组 callbacks 中存下，同时将 pending 标志位改为 true，并开启一个宏&#x2F;微任务挂起。</li>
<li>当挂起的 callbacks 正在执行，又有新的 nextTick 调用，将新任务存到 callbacks 队列中</li>
<li>当执行任务 flushCallbacks ，重置 callbacks，pending，遍遍历 callbacks ，执行回调函数</li>
</ul>
<p>具体可见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/ddlwni">07- nextTick</a></p>
<h3 id="3-4-Vue-observable-object"><a href="#3-4-Vue-observable-object" class="headerlink" title="3.4 Vue.observable( object )"></a>3.4 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#Vue-observable">Vue.observable( object )</a></h3><p>让一个对象可响应。Vue 内部会用它来处理 data 函数返回的对象。</p>
<p>内部调用 <code>observe(obj)</code>实现</p>
<p>返回的对象可以直接用于<a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/render-function.html">渲染函数</a>和<a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/computed.html">计算属性</a>内，并且会在发生变更时触发相应的更新。</p>
<p><strong>也可以作为最小化的跨组件状态存储器</strong>，eg如下：</p>
<p><img src="/103-%E5%85%A8%E5%B1%80API%E6%BA%90%E7%A0%81/1657187193593-fadcd89b-9d54-4386-b625-2984eb84f7bc-20220818214451930.png" alt="img"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * In some cases we may want to disable observation inside a component&#x27;s</span></span><br><span class="line"><span class="comment"> * update computation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 是否启用观察的标记位</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> <span class="attr">shouldObserve</span>: boolean = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">toggleObserving</span> (<span class="attr">value</span>: boolean) &#123;</span><br><span class="line">  shouldObserve = value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Attempt to create an observer instance for a value,</span></span><br><span class="line"><span class="comment"> * returns the new observer if successfully observed,</span></span><br><span class="line"><span class="comment"> * or the existing observer if the value already has one.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">observe</span> (<span class="attr">value</span>: any, <span class="attr">asRootData</span>: ?boolean): <span class="title class_">Observer</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// 如果不是对象，或者是 VNode，则不进行响应处理</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(value) || value <span class="keyword">instanceof</span> <span class="title class_">VNode</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">ob</span>: <span class="title class_">Observer</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="comment">// 若本身就是响应式对象则 ob = value.__ob__</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">hasOwn</span>(value, <span class="string">&#x27;__ob__&#x27;</span>) &amp;&amp; value.<span class="property">__ob__</span> <span class="keyword">instanceof</span> <span class="title class_">Observer</span>) &#123;</span><br><span class="line">    ob = value.<span class="property">__ob__</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    shouldObserve &amp;&amp;</span><br><span class="line">    !<span class="title function_">isServerRendering</span>() &amp;&amp;</span><br><span class="line">    (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value) || <span class="title function_">isPlainObject</span>(value)) &amp;&amp;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">isExtensible</span>(value) &amp;&amp;</span><br><span class="line">    !value.<span class="property">_isVue</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 可响应处理的标志 &amp;&amp; 不是SSR &amp; (数组 || 对象) &amp; 对象可扩展 &amp; 不是 Vue 实例本身</span></span><br><span class="line">    ob = <span class="keyword">new</span> <span class="title class_">Observer</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.<span class="property">vmCount</span>++</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Object-isExtensible"><a href="#Object-isExtensible" class="headerlink" title="**Object.isExtensible()**"></a><code>**Object.isExtensible()**</code></h4><p><strong>Object.isExtensible()</strong> 方法判断一个对象是否是可扩展的（是否可以在它上面添加新的属性）</p>
<h4 id="isVue"><a href="#isVue" class="headerlink" title="_isVue"></a><code>_isVue</code></h4><p>_isVue 为 ture 时，是初始化<code>_init()</code>时赋值，表示 Vue 本身的标志</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\init.js</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// a flag to avoid this being observed</span></span><br><span class="line">    vm.<span class="property">_isVue</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="4-初始化对象"><a href="#4-初始化对象" class="headerlink" title="4.  初始化对象"></a>4.  初始化对象</h2><p>初始化 Vue.options, Vue.options.directive, Vue.options.component, Vue.options.filter 方法</p>
<p>具体细节见 8</p>
<h2 id="5-Vue-options-base-Vue"><a href="#5-Vue-options-base-Vue" class="headerlink" title="5.  Vue.options._base = Vue"></a>5. <code> Vue.options._base = Vue</code></h2><p>Vue 挂载 _base </p>
<h2 id="6-extend-Vue-options-components-builtInComponents"><a href="#6-extend-Vue-options-components-builtInComponents" class="headerlink" title="6.extend(Vue.options.components, builtInComponents)"></a>6.<code>extend(Vue.options.components, builtInComponents)</code></h2><p>拆解此方法后知，此方法是初始化构建 KeepAlive 组件，将 KeepAlive 组件挂载到 Vue.option.components 。</p>
<p><a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#keep-alive">https://cn.vuejs.org/v2/api/#keep-alive</a></p>
<h3 id="6-1-extend"><a href="#6-1-extend" class="headerlink" title="6.1 extend()"></a>6.1 <code>extend()</code></h3><p>引用自： <code>import &#123; initExtend &#125; from&#39;./extend&#39;</code></p>
<p>由此引用，找到实际定义的文件： <code>src\shared\util.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mix properties into target object.</span></span><br><span class="line"><span class="comment"> * 将 _from 的属性混入到 to 中，并返回新的原对象to</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">extend</span> (<span class="attr">to</span>: <span class="title class_">Object</span>, <span class="attr">_from</span>: ?<span class="title class_">Object</span>): <span class="title class_">Object</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> _from) &#123;</span><br><span class="line">    to[key] = _from[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> to</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-builtInComponents"><a href="#6-2-builtInComponents" class="headerlink" title="6.2 builtInComponents"></a>6.2 <code>builtInComponents</code></h3><p>引用于 <code>import builtInComponents from &#39;../components/index&#39;&#39; </code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\components\index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">KeepAlive</span> <span class="keyword">from</span> <span class="string">&#x27;./keep-alive&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title class_">KeepAlive</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>keep-alive 组件源码分析可参考：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903837770203144#heading-3">https://juejin.cn/post/6844903837770203144#heading-3</a></p>
<p>Vue渲染的整个过程：</p>
<p><img src="/103-%E5%85%A8%E5%B1%80API%E6%BA%90%E7%A0%81/1657162564361-7eb27457-0e4e-4777-a552-6e660ab55775-20220818214452020.webp" alt="img"></p>
<p>Vue的渲染是从图中的render阶段开始的，但keep-alive的渲染是在patch阶段，这是构建组件树（虚拟DOM树），并将VNode转换成真正DOM节点的过程。</p>
<h2 id="7-Vue-use-Vue-mixin-Vue-extend"><a href="#7-Vue-use-Vue-mixin-Vue-extend" class="headerlink" title="7. Vue.use, Vue.mixin, Vue.extend"></a>7. Vue.use, Vue.mixin, Vue.extend</h2><h3 id="7-1-Vue-use-plugin"><a href="#7-1-Vue-use-plugin" class="headerlink" title="7.1 Vue.use( plugin )"></a>7.1 <code>Vue.use( plugin )</code></h3><p>安装 Vue.js 插件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\global-api\use.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initUse</span> (<span class="title class_">Vue</span>: <span class="title class_">GlobalAPI</span>) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">use</span> = <span class="keyword">function</span> (<span class="params">plugin: <span class="built_in">Function</span> | <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> installedPlugins = (<span class="variable language_">this</span>.<span class="property">_installedPlugins</span> || (<span class="variable language_">this</span>.<span class="property">_installedPlugins</span> = []))</span><br><span class="line">    <span class="comment">// 若插件存在则直接返回，不重复添加</span></span><br><span class="line">    <span class="comment">// 当 install 方法被同一个插件多次调用，插件将只会被安装一次</span></span><br><span class="line">    <span class="keyword">if</span> (installedPlugins.<span class="title function_">indexOf</span>(plugin) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// additional parameters</span></span><br><span class="line">    <span class="comment">// install 方法调用时，会将 Vue 作为参数传入</span></span><br><span class="line">    <span class="keyword">const</span> args = <span class="title function_">toArray</span>(<span class="variable language_">arguments</span>, <span class="number">1</span>)</span><br><span class="line">    args.<span class="title function_">unshift</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="comment">// 如果插件是一个对象，必须提供 install 方法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin.<span class="property">install</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      plugin.<span class="property">install</span>.<span class="title function_">apply</span>(plugin, args)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果插件是一个函数，它会被作为 install 方法</span></span><br><span class="line">      plugin.<span class="title function_">apply</span>(<span class="literal">null</span>, args)</span><br><span class="line">    &#125;</span><br><span class="line">    installedPlugins.<span class="title function_">push</span>(plugin)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-2-Vue-mixin-mixin"><a href="#7-2-Vue-mixin-mixin" class="headerlink" title="7.2  Vue.mixin( mixin )"></a>7.2  <code>Vue.mixin( mixin )</code></h3><p> 全局注册一个混入，影响注册之后所有创建的每个 Vue 实例。插件作者可以使用混入，向组件注入自定义的行为。<strong>不推荐在应用代码中使用</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\global-api\mixin.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">GlobalAPI</span>) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">mixin</span> = <span class="keyword">function</span> (<span class="params">mixin: <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 合并参数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = <span class="title function_">mergeOptions</span>(<span class="variable language_">this</span>.<span class="property">options</span>, mixin)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-3-Vue-extend-options"><a href="#7-3-Vue-extend-options" class="headerlink" title="7.3  Vue.extend( options )"></a>7.3  <code>Vue.extend( options )</code></h3><p>使用基础 Vue 构造器，创建一个“子类”。</p>
<p>参数是一个包含组件选项的对象。</p>
<p>data 选项是特例，需要注意 - 在 Vue.extend() 中它必须是函数</p>
<p>应用示例：</p>
<p><img src="/103-%E5%85%A8%E5%B1%80API%E6%BA%90%E7%A0%81/1657181869595-61191ab2-1d6a-4c60-98ff-00df4af64a2c-20220818214451943.png" alt="img"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\global-api\extend.js</span></span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">extend</span> = <span class="keyword">function</span> (<span class="params">extendOptions: <span class="built_in">Object</span></span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">    extendOptions = extendOptions || &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Super</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SuperId</span> = <span class="title class_">Super</span>.<span class="property">cid</span></span><br><span class="line">    <span class="keyword">const</span> cachedCtors = extendOptions.<span class="property">_Ctor</span> || (extendOptions.<span class="property">_Ctor</span> = &#123;&#125;)</span><br><span class="line">    <span class="comment">// cid 是每个组件的唯一标志，若已创建则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (cachedCtors[<span class="title class_">SuperId</span>]) &#123;</span><br><span class="line">      <span class="keyword">return</span> cachedCtors[<span class="title class_">SuperId</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> name = extendOptions.<span class="property">name</span> || <span class="title class_">Super</span>.<span class="property">options</span>.<span class="property">name</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; name) &#123;</span><br><span class="line">      <span class="title function_">validateComponentName</span>(name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sub 就是使用 一个包含组件选项的对象 的参数，初始化创建一个 Vue 组件</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Sub</span> = <span class="keyword">function</span> <span class="title function_">VueComponent</span> (options) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_init</span>(options)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 继承父的prototype</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property"><span class="keyword">prototype</span></span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="title class_">Super</span>.<span class="property"><span class="keyword">prototype</span></span>)</span><br><span class="line">    <span class="comment">// 指向自己的 constructor </span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">constructor</span> = <span class="title class_">Sub</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">cid</span> = cid++</span><br><span class="line">    <span class="comment">// 合并父的参数</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">options</span> = <span class="title function_">mergeOptions</span>(</span><br><span class="line">      <span class="title class_">Super</span>.<span class="property">options</span>,</span><br><span class="line">      extendOptions</span><br><span class="line">    )</span><br><span class="line">    <span class="title class_">Sub</span>[<span class="string">&#x27;super&#x27;</span>] = <span class="title class_">Super</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// For props and computed properties, we define the proxy getters on</span></span><br><span class="line">    <span class="comment">// the Vue instances at extension time, on the extended prototype. This</span></span><br><span class="line">    <span class="comment">// avoids Object.defineProperty calls for each instance created.</span></span><br><span class="line">    <span class="comment">// 对于 props 和 computed 属性，定义proxy 的 getters 时扩展到Vue 实例的prototype 上，这样可以避免创建每个实例都调用 Object.defineProperty</span></span><br><span class="line">    <span class="comment">// 此句扩展的体现在 initProps(Sub) 的实现上， proxy(Comp.prototype, `_props`, key) ，用的是Comp.prototype</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Sub</span>.<span class="property">options</span>.<span class="property">props</span>) &#123;</span><br><span class="line">      <span class="title function_">initProps</span>(<span class="title class_">Sub</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Sub</span>.<span class="property">options</span>.<span class="property">computed</span>) &#123;</span><br><span class="line">      <span class="title function_">initComputed</span>(<span class="title class_">Sub</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow further extension/mixin/plugin usage</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">extend</span> = <span class="title class_">Super</span>.<span class="property">extend</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">mixin</span> = <span class="title class_">Super</span>.<span class="property">mixin</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">use</span> = <span class="title class_">Super</span>.<span class="property">use</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// create asset registers, so extended classes</span></span><br><span class="line">    <span class="comment">// can have their private assets too.</span></span><br><span class="line">    <span class="variable constant_">ASSET_TYPES</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">type</span>) &#123;</span><br><span class="line">      <span class="title class_">Sub</span>[type] = <span class="title class_">Super</span>[type]</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// enable recursive self-lookup</span></span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">      <span class="title class_">Sub</span>.<span class="property">options</span>.<span class="property">components</span>[name] = <span class="title class_">Sub</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// keep a reference to the super options at extension time.</span></span><br><span class="line">    <span class="comment">// later at instantiation we can check if Super&#x27;s options have</span></span><br><span class="line">    <span class="comment">// been updated.</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">superOptions</span> = <span class="title class_">Super</span>.<span class="property">options</span></span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">extendOptions</span> = extendOptions</span><br><span class="line">    <span class="title class_">Sub</span>.<span class="property">sealedOptions</span> = <span class="title function_">extend</span>(&#123;&#125;, <span class="title class_">Sub</span>.<span class="property">options</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cache constructor</span></span><br><span class="line">    cachedCtors[<span class="title class_">SuperId</span>] = <span class="title class_">Sub</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Sub</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="8-initAssetRegisters-Vue"><a href="#8-initAssetRegisters-Vue" class="headerlink" title="8. initAssetRegisters(Vue)"></a>8. <code>initAssetRegisters(Vue)</code></h2><p>在第 4 部分，初始化 Vue.use, Vue.mixin, Vue.extend 对象；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\global-api\assets.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initAssetRegisters</span> (<span class="title class_">Vue</span>: <span class="title class_">GlobalAPI</span>) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Create asset registration methods.</span></span><br><span class="line"><span class="comment">   * 注册方法</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="variable constant_">ASSET_TYPES</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Vue</span>[type] = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">      id: string,</span></span><br><span class="line"><span class="params">      definition: <span class="built_in">Function</span> | <span class="built_in">Object</span></span></span><br><span class="line"><span class="params">    </span>): <span class="title class_">Function</span> | <span class="title class_">Object</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">      <span class="comment">// 无 definition 参数，直接返回已注册的 过滤器/指令/组件</span></span><br><span class="line">      <span class="keyword">if</span> (!definition) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">options</span>[type + <span class="string">&#x27;s&#x27;</span>][id]</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; type === <span class="string">&#x27;component&#x27;</span>) &#123;</span><br><span class="line">          <span class="comment">// 注册组件，检查组件名是否规范</span></span><br><span class="line">          <span class="title function_">validateComponentName</span>(id)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">&#x27;component&#x27;</span> &amp;&amp; <span class="title function_">isPlainObject</span>(definition)) &#123;</span><br><span class="line">          <span class="comment">// 未设置 组件的name，则用id 当作name</span></span><br><span class="line">          definition.<span class="property">name</span> = definition.<span class="property">name</span> || id</span><br><span class="line">          <span class="comment">// 若是组件，definition 为对象，则添加到 _base 中</span></span><br><span class="line">          <span class="comment">// 注册组件，传入一个选项对象 (自动调用 Vue.extend) —— 针对官方 api 此句的处理</span></span><br><span class="line">          definition = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">_base</span>.<span class="title function_">extend</span>(definition)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 注册 (指令函数)</span></span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">&#x27;directive&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> definition === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">          <span class="comment">// 这里将会被 `bind` 和 `update` 调用 —— 针对此的处理</span></span><br><span class="line">          definition = &#123; <span class="attr">bind</span>: definition, <span class="attr">update</span>: definition &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">options</span>[type + <span class="string">&#x27;s&#x27;</span>][id] = definition</span><br><span class="line">        <span class="comment">// 返回处理后的值</span></span><br><span class="line">        <span class="keyword">return</span> definition</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-1-Vue-directive-id-definition"><a href="#8-1-Vue-directive-id-definition" class="headerlink" title="8.1 Vue.directive( id, [definition] )"></a>8.1 <code>Vue.directive( id, [definition] )</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">directive</span>(<span class="string">&#x27;my-directive&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">bind</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="attr">inserted</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="attr">update</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="attr">componentUpdated</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="attr">unbind</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册 (指令函数)</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">directive</span>(<span class="string">&#x27;my-directive&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 这里将会被 `bind` 和 `update` 调用</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// getter，返回已注册的指令</span></span><br><span class="line"><span class="keyword">var</span> myDirective = <span class="title class_">Vue</span>.<span class="title function_">directive</span>(<span class="string">&#x27;my-directive&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="8-2-Vue-filter-id-definition"><a href="#8-2-Vue-filter-id-definition" class="headerlink" title="8.2 Vue.filter( id, [definition] )"></a>8.2 <code>Vue.filter( id, [definition] )</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">filter</span>(<span class="string">&#x27;my-filter&#x27;</span>, <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="comment">// 返回处理后的值</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// getter，返回已注册的过滤器</span></span><br><span class="line"><span class="keyword">var</span> myFilter = <span class="title class_">Vue</span>.<span class="title function_">filter</span>(<span class="string">&#x27;my-filter&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="8-3-Vue-component-id-definition"><a href="#8-3-Vue-component-id-definition" class="headerlink" title="8.3 Vue.component( id, [definition] )"></a>8.3 <code>Vue.component( id, [definition] )</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册组件，传入一个扩展过的构造器</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;my-component&#x27;</span>, <span class="title class_">Vue</span>.<span class="title function_">extend</span>(&#123; <span class="comment">/* ... */</span> &#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册组件，传入一个选项对象 (自动调用 Vue.extend)</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;my-component&#x27;</span>, &#123; <span class="comment">/* ... */</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取注册的组件 (始终返回构造器)</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MyComponent</span> = <span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;my-component&#x27;</span>)</span><br></pre></td></tr></table></figure>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-04-28</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约3278个字, 10分钟55秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/104-initProxy/">initProxy</a></h3></div><div class="post-content"><div class="card"><p><p><strong>【前情回顾】</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  src\core\instance\init.js</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options?: <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 开发环境时，调用initProxy方法</span></span><br><span class="line">      <span class="comment">// 如果不是开发环境，则vue实例的_renderProxy属性指向vue实例本身。</span></span><br><span class="line">      <span class="title function_">initProxy</span>(vm)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vm.<span class="property">_renderProxy</span> = vm</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-initProxy"><a href="#1-initProxy" class="headerlink" title="1. initProxy"></a>1. <code>initProxy</code></h2><ul>
<li>最核心的代码就是 <code>vm._renderProxy = new Proxy(vm, handlers)</code>，通过 Proxy 进行 handlers 拦截检测处理 ，将结果赋值给 <code>vm._renderProxy</code>。</li>
<li>其中，handlers 中主要检测 vm 的属性拦截校验。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">let</span> initProxy</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 根据 makeMap 的实现，将这个字符串转换为类似对象 &#123;Infinity: true, undefined: true, ...&#125;</span></span><br><span class="line">  <span class="keyword">const</span> allowedGlobals = <span class="title function_">makeMap</span>(</span><br><span class="line">    <span class="string">&#x27;Infinity,undefined,NaN,isFinite,isNaN,&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;parseFloat,parseInt,decodeURI,decodeURIComponent,encodeURI,encodeURIComponent,&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;Math,Number,Date,Array,Object,Boolean,String,RegExp,Map,Set,JSON,Intl,BigInt,&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;require&#x27;</span> <span class="comment">// for Webpack/Browserify</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 属性或方法未定义，报警告</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">warnNonPresent</span> = (<span class="params">target, key</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`Property or method &quot;<span class="subst">$&#123;key&#125;</span>&quot; is not defined on the instance but `</span> +</span><br><span class="line">      <span class="string">&#x27;referenced during render. Make sure that this property is reactive, &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;either in the data option, or for class-based components, by &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;initializing the property. &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;See: https://vuejs.org/v2/guide/reactivity.html#Declaring-Reactive-Properties.&#x27;</span>,</span><br><span class="line">      target</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 属性 key 以 $ 或者 _ 开头，报警告（避免与内置属性方法冲突）</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">warnReservedPrefix</span> = (<span class="params">target, key</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`Property &quot;<span class="subst">$&#123;key&#125;</span>&quot; must be accessed with &quot;$data.<span class="subst">$&#123;key&#125;</span>&quot; because `</span> +</span><br><span class="line">      <span class="string">&#x27;properties starting with &quot;$&quot; or &quot;_&quot; are not proxied in the Vue instance to &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;prevent conflicts with Vue internals. &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;See: https://vuejs.org/v2/api/#data&#x27;</span>,</span><br><span class="line">      target</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    // 检测是不是支持原生方法 </span></span><br><span class="line"><span class="comment">    export function isNative (Ctor: any): boolean &#123;</span></span><br><span class="line"><span class="comment">    return typeof Ctor === &#x27;function&#x27; &amp;&amp; /native code/.test(Ctor.toString())</span></span><br><span class="line"><span class="comment">  &#125; */</span></span><br><span class="line">  <span class="comment">// 判断是否支持 Proxy</span></span><br><span class="line">  <span class="keyword">const</span> hasProxy =</span><br><span class="line">    <span class="keyword">typeof</span> <span class="title class_">Proxy</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(<span class="title class_">Proxy</span>)</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">const</span> hasHandler = &#123;...&#125;</span><br><span class="line">    <span class="keyword">const</span> getHandler = &#123;...&#125;                 </span><br><span class="line">    </span><br><span class="line">    initProxy = <span class="keyword">function</span> <span class="title function_">initProxy</span> (vm) &#123;</span><br><span class="line">      <span class="comment">// 判断当前环境是否支持 Proxy，支持就用 Proxy 代理后赋值 vm._renderProxy </span></span><br><span class="line">      <span class="keyword">if</span> (hasProxy) &#123;</span><br><span class="line">        <span class="comment">// determine which proxy handler to use</span></span><br><span class="line">        <span class="keyword">const</span> options = vm.<span class="property">$options</span></span><br><span class="line">        <span class="keyword">const</span> handlers = options.<span class="property">render</span> &amp;&amp; options.<span class="property">render</span>.<span class="property">_withStripped</span></span><br><span class="line">          ? getHandler</span><br><span class="line">          : hasHandler</span><br><span class="line">        vm.<span class="property">_renderProxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(vm, handlers)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vm.<span class="property">_renderProxy</span> = vm</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123; initProxy &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调试时，只看到调 <code>hasHandler</code>，不知什么时候调 <code>getHandler</code>，查资料如下：</li>
</ul>
<p>handers函数会根据 options.render._withStripped的不同执行不同的代理函数，<strong>当使用类似webpack这样的打包工具时，通常会使用vue-loader插件进行模板的编译，这个时候options.render是存在的，并且_withStripped的属性也会设置为true</strong>，所以此时代理的选项是hasHandler,在其他场景下，代理的选项是getHandler。getHandler,hasHandler的逻辑相似</p>
<ul>
<li>关于 <code>_renderProxy</code></li>
</ul>
<p>源码中vm._renderProxy的使用出现在Vue实例的_render方法中，Vue.prototype._render是将渲染函数转换成Virtual DOM的方法，这部分是关于实例的挂载和模板引擎的解析，笔者并不会在这一章节中深入分析，我们只需要先有一个认知，Vue内部在js和真实DOM节点中设立了一个中间层，这个中间层就是Virtual DOM，<strong>遵循js -&gt; virtual -&gt; 真实dom</strong>的转换过程,而<strong>Vue.prototype._render是前半段的转换</strong>，当我们调用render函数时，代理的vm._renderProxy对象便会访问到。</p>
<h3 id="1-1-hasHandler"><a href="#1-1-hasHandler" class="headerlink" title="1.1  hasHandler"></a>1.1 <code> hasHandler</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hasHandler = &#123;</span><br><span class="line">  <span class="comment">// target 是目标代理的对象； key 是需要检查是否存在的属性</span></span><br><span class="line">  <span class="comment">// 此方法拦截检测模板中的属性，检测是否合法</span></span><br><span class="line">  has (target, key) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;key&#x27;</span>, key) <span class="comment">// 辅助理解，打印 key</span></span><br><span class="line">    <span class="comment">// 此处的target就是 Vue 实例</span></span><br><span class="line">    <span class="comment">// key 是否在 target 中的标记</span></span><br><span class="line">    <span class="keyword">const</span> has = key <span class="keyword">in</span> target</span><br><span class="line">    <span class="comment">// (key 在上文全局 Globals 字符串中 || key 以`_`开头且 key 不属于 target 的 $data 的属性) 则为 true</span></span><br><span class="line">    <span class="keyword">const</span> isAllowed = <span class="title function_">allowedGlobals</span>(key) ||</span><br><span class="line">      (<span class="keyword">typeof</span> key === <span class="string">&#x27;string&#x27;</span> &amp;&amp; key.<span class="title function_">charAt</span>(<span class="number">0</span>) === <span class="string">&#x27;_&#x27;</span> &amp;&amp; !(key <span class="keyword">in</span> target.<span class="property">$data</span>))</span><br><span class="line">    <span class="keyword">if</span> (!has &amp;&amp; !isAllowed) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> target.<span class="property">$data</span>) <span class="title function_">warnReservedPrefix</span>(target, key)</span><br><span class="line">      <span class="keyword">else</span> <span class="title function_">warnNonPresent</span>(target, key)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> has || !isAllowed</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>此方法是为了拦截模板中的属性进行校验，</strong></p>
<p><strong>eg: 如下这段示例代码，打印出</strong> hasHandler 中 的 <strong>has 的 key 值：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;editor&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">:value</span>=<span class="string">&quot;input + new Date()&quot;</span> @<span class="attr">input</span>=<span class="string">&quot;update&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-html</span>=<span class="string">&quot;compiledMarkdown&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">el</span>: <span class="string">&#x27;#editor&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">data</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">input</span>: <span class="string">&#x27;# hello&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">computed</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">compiledMarkdown</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">return</span> <span class="title function_">marked</span>(<span class="variable language_">this</span>.<span class="property">input</span>, &#123; <span class="attr">sanitize</span>: <span class="literal">true</span> &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">update</span>: _.<span class="title function_">debounce</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">input</span> = e.<span class="property">target</span>.<span class="property">value</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;, <span class="number">300</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/104-initProxy/1657261394103-7e82e6a1-0505-4343-b9ec-8b5b0b6996eb.png" alt="img"></p>
<p>原示例中 <code>&lt;textarea :value=&quot;input&quot;</code> 没有 new Date()，则打印的 key 值也没有 Date。</p>
<p>这个理解辅助理解 <code> allowedGlobals(key)</code>的意义，说明如果模板中使用原生一些对象，是不会被拦截的。</p>
<h4 id="【辅助】makeMap"><a href="#【辅助】makeMap" class="headerlink" title="【辅助】makeMap"></a>【辅助】<code>makeMap</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\shared\util.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Make a map and return a function for checking if a key</span></span><br><span class="line"><span class="comment"> * is in that map.</span></span><br><span class="line"><span class="comment"> * 调用eg：makeMap(&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;)(&#x27;a&#x27;) // 返回true</span></span><br><span class="line"><span class="comment"> * 1.第一组参数 (str,expectsLowerCase) ，将字符串格式化为对象</span></span><br><span class="line"><span class="comment"> * &quot;a,b,c&quot; ==&gt; &#123;a: true, b: true, c: true&#125;</span></span><br><span class="line"><span class="comment"> * 2. 第二组参数 return 的 val，校验val是否存在str中，若存在返回 true，不存在返回undefined</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">makeMap</span> (</span><br><span class="line">  <span class="attr">str</span>: string,</span><br><span class="line">  expectsLowerCase?: boolean</span><br><span class="line">): <span class="function">(<span class="params">key: string</span>) =&gt;</span> <span class="literal">true</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> map = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// 将类似格式的字符串 &quot;a,b,c&quot; 拆成数组 [a,b,c] </span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">list</span>: <span class="title class_">Array</span>&lt;string&gt; = str.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// 将类似格式的数组[a,b,c] 转换为 &#123;a: true, b: true, c: true&#125;</span></span><br><span class="line">    map[list[i]] = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 统一大小写处理，返回 val 是否在 map 中，存在返回 true，不存在返回undefined</span></span><br><span class="line">  <span class="keyword">return</span> expectsLowerCase</span><br><span class="line">    ? <span class="function"><span class="params">val</span> =&gt;</span> map[val.<span class="title function_">toLowerCase</span>()]</span><br><span class="line">    : <span class="function"><span class="params">val</span> =&gt;</span> map[val]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Proxy-对象"><a href="#2-Proxy-对象" class="headerlink" title="2. Proxy 对象"></a>2. Proxy 对象</h2><h3 id="2-1-概念"><a href="#2-1-概念" class="headerlink" title="2.1 概念"></a>2.1 概念</h3><p><strong>Proxy</strong> 对象用于创建一个对象的代理，从而实现基本操作的拦截和自定义（如属性查找、赋值、枚举、函数调用等）。</p>
<p>ES6 原生提供 Proxy 构造函数，用来生成 Proxy 实例。</p>
<p>Proxy 用于修改某些操作的默认行为，等同于在语言层面做出修改，所以属于一种“元编程”（meta programming），即对编程语言进行编程。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// target: 所要拦截的目标对象</span></span><br><span class="line"><span class="comment">// handler: 处理器对象，用于设置拦截行为</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Proxy</span>(target, handler)</span><br></pre></td></tr></table></figure>



<h3 id="2-2-术语"><a href="#2-2-术语" class="headerlink" title="2.2 术语"></a>2.2 术语</h3><ul>
<li>target</li>
</ul>
<p>要使用 Proxy 包装的目标对象（可以是任何类型的对象，包括原生数组，函数，甚至另一个代理）</p>
<ul>
<li>handler</li>
</ul>
<p>处理器对象（包含trap）</p>
<ul>
<li><em>traps</em></li>
</ul>
<p>捕捉器， 提供属性访问的方法</p>
<h3 id="2-3-拦截器-handler"><a href="#2-3-拦截器-handler" class="headerlink" title="2.3 拦截器 handler"></a>2.3 拦截器 handler</h3><p>下面是 Proxy 支持的拦截操作一览，一共 13 种。</p>
<ul>
<li>**get(target, propKey, receiver)**：拦截对象属性的读取，比如proxy.foo和proxy[‘foo’]。</li>
<li>**set(target, propKey, value, receiver)**：拦截对象属性的设置，比如proxy.foo &#x3D; v或proxy[‘foo’] &#x3D; v，返回一个布尔值。</li>
<li>**has(target, propKey)**：拦截propKey in proxy的操作，返回一个布尔值。</li>
<li>**deleteProperty(target, propKey)**：拦截delete proxy[propKey]的操作，返回一个布尔值。</li>
<li>**ownKeys(target)**：拦截Object.getOwnPropertyNames(proxy)、Object.getOwnPropertySymbols(proxy)、Object.keys(proxy)、for…in循环，返回一个数组。该方法返回目标对象所有自身的属性的属性名，而Object.keys()的返回结果仅包括目标对象自身的可遍历属性。</li>
<li>**getOwnPropertyDescriptor(target, propKey)**：拦截Object.getOwnPropertyDescriptor(proxy, propKey)，返回属性的描述对象。</li>
<li>**defineProperty(target, propKey, propDesc)**：拦截Object.defineProperty(proxy, propKey, propDesc）、Object.defineProperties(proxy, propDescs)，返回一个布尔值。</li>
<li>**preventExtensions(target)**：拦截Object.preventExtensions(proxy)，返回一个布尔值。</li>
<li>**getPrototypeOf(target)**：拦截Object.getPrototypeOf(proxy)，返回一个对象。</li>
<li>**isExtensible(target)**：拦截Object.isExtensible(proxy)，返回一个布尔值。</li>
<li>**setPrototypeOf(target, proto)**：拦截Object.setPrototypeOf(proxy, proto)，返回一个布尔值。如果目标对象是函数，那么还有两种额外操作可以拦截。</li>
<li>**apply(target, object, args)**：拦截 Proxy 实例作为函数调用的操作，比如proxy(…args)、proxy.call(object, …args)、proxy.apply(…)。</li>
<li>**construct(target, args)**：拦截 Proxy 实例作为构造函数调用的操作，比如new proxy(…args)。</li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1821611">https://cloud.tencent.com/developer/article/1821611</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903812285595662">https://juejin.cn/post/6844903812285595662</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy</a></p>
<p><a target="_blank" rel="noopener" href="https://es6.ruanyifeng.com/#docs/proxy">https://es6.ruanyifeng.com/#docs/proxy</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-04-08</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约1997个字, 6分钟39秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/102-Vue%E5%AE%9E%E4%BE%8B%E5%88%9D%E5%A7%8B%E5%8C%96/">Vue实例初始化</a></h3></div><div class="post-content"><div class="card"><p><p><img src="/102-Vue%E5%AE%9E%E4%BE%8B%E5%88%9D%E5%A7%8B%E5%8C%96/1658330043075-39864445-8c75-4cbf-aec6-106aeaafd5a5.png" alt="img"></p>
<p><strong>【前情回顾】</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;./instance/index&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span></span><br></pre></td></tr></table></figure>

<h1 id="src-core-instance-index-js"><a href="#src-core-instance-index-js" class="headerlink" title="src/core/instance/index.js"></a><code>src/core/instance/index.js</code></h1><ul>
<li>创建 new Vue(options) 时调用的方法，内部 调用 _init  方法</li>
<li>挂载 初始化 相关方法 </li>
<li>挂载 状态处理 相关方法</li>
<li>挂载 事件 相关方法</li>
<li>挂载 生命周期 方法</li>
<li>挂载 渲染 相关方法</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; initMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./init&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; stateMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./state&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; renderMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./render&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; eventsMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./events&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; lifecycleMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./lifecycle&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; warn &#125; <span class="keyword">from</span> <span class="string">&#x27;../util/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 组件创建 new Vue() 时调用的方法</span></span><br><span class="line"><span class="comment">// options是new Vue() 时传的配置项参数，如data、methods等</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Vue</span> (options) &#123;</span><br><span class="line">  <span class="comment">// 当 直接使用 Vue(...) 时会报错，要求用 new Vue(...)</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">    !(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">Vue</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">&#x27;Vue is a constructor and should be called with the `new` keyword&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_init</span>(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">initMixin</span>(<span class="title class_">Vue</span>)        <span class="comment">// 挂载 初始化 方法 ( 含 this._init )</span></span><br><span class="line"><span class="title function_">stateMixin</span>(<span class="title class_">Vue</span>)       <span class="comment">// 挂载 状态处理 方法</span></span><br><span class="line"><span class="title function_">eventsMixin</span>(<span class="title class_">Vue</span>)      <span class="comment">// 挂载 事件 相关方法</span></span><br><span class="line"><span class="title function_">lifecycleMixin</span>(<span class="title class_">Vue</span>)   <span class="comment">// 挂载 生命周期 方法</span></span><br><span class="line"><span class="title function_">renderMixin</span>(<span class="title class_">Vue</span>)      <span class="comment">// 挂载 渲染 相关方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span></span><br></pre></td></tr></table></figure>

<h2 id="1-initMixin-Vue"><a href="#1-initMixin-Vue" class="headerlink" title="1. initMixin(Vue)"></a>1. <code>initMixin(Vue)</code></h2><ul>
<li>定义 Vue.prototype._init ，代码分析如下 6</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/init.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options?: <span class="built_in">Object</span></span>) &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-stateMixin-Vue"><a href="#2-stateMixin-Vue" class="headerlink" title="2. stateMixin(Vue)"></a>2. <code>stateMixin(Vue)</code></h2><ul>
<li>给 Vue 挂载属性 <code>$data</code> <code>$props</code> <code>$set</code> <code>$delete</code> <code>$watch</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/state.js</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Watcher</span> <span class="keyword">from</span> <span class="string">&#x27;../observer/watcher&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Dep</span>, &#123; pushTarget, popTarget &#125; <span class="keyword">from</span> <span class="string">&#x27;../observer/dep&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  set,</span><br><span class="line">  del,</span><br><span class="line">  observe,</span><br><span class="line">  defineReactive,</span><br><span class="line">  toggleObserving</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;../observer/index&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">stateMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$data&#x27;</span>, dataDef)</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$props&#x27;</span>, propsDef)</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$set</span> = set</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$delete</span> = del</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$watch</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">    expOrFn: string | <span class="built_in">Function</span>,</span></span><br><span class="line"><span class="params">    cb: any,</span></span><br><span class="line"><span class="params">    options?: <span class="built_in">Object</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, expOrFn, cb, options)</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unwatchFn</span> () &#123;</span><br><span class="line">      watcher.<span class="title function_">teardown</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-eventsMixin-Vue"><a href="#3-eventsMixin-Vue" class="headerlink" title="3. *eventsMixin*(*Vue*)"></a>3. <code>*eventsMixin*(*Vue*)</code></h2><ul>
<li>给 Vue 挂载属性 <code>$on``$once``$off</code> <code>$emit</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/events.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">eventsMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$on</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$once</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$off</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$emit</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-lifecycleMixin-Vue"><a href="#4-lifecycleMixin-Vue" class="headerlink" title="4. *lifecycleMixin*(*Vue*)"></a><em>4.</em> <code>*lifecycleMixin*(*Vue*)</code></h2><ul>
<li>给 Vue 挂载属性 <code>$_update``$forceUpdate``$destroy</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/lifecycle.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">eventsMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_update</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$forceUpdate</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$destroy</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-renderMixin-Vue"><a href="#5-renderMixin-Vue" class="headerlink" title="5. *renderMixin*(*Vue*)"></a><em>5.</em> <code>*renderMixin*(*Vue*)</code></h2><ul>
<li>给 Vue 挂载属性 <code>$nextTick``_render</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/render.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">eventsMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$nextTick</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_render</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$destroy</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-this-init"><a href="#6-this-init" class="headerlink" title="6. this._init()"></a>6. <code>this._init()</code></h2><ul>
<li><p>初始化 Vue 实例 vm 的属性 <code>_uid</code> ,<code>_isVue</code>, <code>$option</code>, <code>_renderProxy</code>,<code>_name</code> 等 ；</p>
</li>
<li><p>beforeCreate 前，</p>
</li>
<li><ul>
<li>合并参数及组件；</li>
<li>开发环境且支持 Proxy 对象的，使用 initProxy 拦截检测实例 vm</li>
<li>初始化生命周期的状态变量，如 $parent, $child, _watcher, _isMounted 等</li>
<li>初始化事件变量 $_events</li>
<li>初始化渲染相关变量，如 $slot, _c, $createElement, $attrs, $listeners 等</li>
</ul>
</li>
<li><p>beforeCreate 后，created 前， </p>
</li>
<li><ul>
<li>初始化注入元素</li>
<li>初始化状态， props, methods, data, computed, watch</li>
<li>初始化提供注入的数据或方法</li>
</ul>
</li>
<li><p>created后，vm.$mount 挂载 el 元素</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/init.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options?: <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">    <span class="comment">// Vue 实例</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="comment">// a uid</span></span><br><span class="line">    <span class="comment">// 在 Vue 的源码中每一个类型的实例 都会有一个 唯一标识</span></span><br><span class="line">    vm.<span class="property">_uid</span> = uid++</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> startTag, endTag</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">      startTag = <span class="string">`vue-perf-start:<span class="subst">$&#123;vm._uid&#125;</span>`</span></span><br><span class="line">      endTag = <span class="string">`vue-perf-end:<span class="subst">$&#123;vm._uid&#125;</span>`</span></span><br><span class="line">      <span class="title function_">mark</span>(startTag)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// a flag to avoid this being observed</span></span><br><span class="line">    <span class="comment">// Vue 根实例的标记，用于避免 被响应式处理的标记</span></span><br><span class="line">    vm.<span class="property">_isVue</span> = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// merge options 合并参数</span></span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; options.<span class="property">_isComponent</span>) &#123;</span><br><span class="line">      <span class="comment">// 组件的合并</span></span><br><span class="line">      <span class="comment">// optimize internal component instantiation</span></span><br><span class="line">      <span class="comment">// since dynamic options merging is pretty slow, and none of the</span></span><br><span class="line">      <span class="comment">// internal component options needs special treatment.</span></span><br><span class="line">      <span class="title function_">initInternalComponent</span>(vm, options)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 简单实例的合并，将自定义属性和默认属性合并</span></span><br><span class="line">      vm.<span class="property">$options</span> = <span class="title function_">mergeOptions</span>(</span><br><span class="line">        <span class="title function_">resolveConstructorOptions</span>(vm.<span class="property">constructor</span>),</span><br><span class="line">        options || &#123;&#125;,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="comment">// 开发环境时，调用 initProxy 方法</span></span><br><span class="line">    <span class="comment">// 如果不是开发环境，则将 vue实例的 _renderProxy 属性指向 vue实例本身</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">initProxy</span>(vm)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vm.<span class="property">_renderProxy</span> = vm</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// expose real self</span></span><br><span class="line">    <span class="comment">// 将实例指向 _self 属性</span></span><br><span class="line">    vm.<span class="property">_self</span> = vm</span><br><span class="line">    <span class="comment">// 初始化生命周期的状态变量</span></span><br><span class="line">    <span class="title function_">initLifecycle</span>(vm)</span><br><span class="line">    <span class="comment">// 初始化事件</span></span><br><span class="line">    <span class="title function_">initEvents</span>(vm)</span><br><span class="line">    <span class="comment">// 初始化创建元素的方法</span></span><br><span class="line">    <span class="title function_">initRender</span>(vm)</span><br><span class="line">    <span class="comment">// 标记生命周期 - beforeCreate</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeCreate&#x27;</span>)</span><br><span class="line">    <span class="comment">// 初始化注入元素</span></span><br><span class="line">    <span class="title function_">initInjections</span>(vm) <span class="comment">// resolve injections before data/props</span></span><br><span class="line">    <span class="comment">// 初始化状态（data，props）【重点】</span></span><br><span class="line">    <span class="title function_">initState</span>(vm)</span><br><span class="line">    <span class="comment">// 初始化注入对应的依赖</span></span><br><span class="line">    <span class="title function_">initProvide</span>(vm) <span class="comment">// resolve provide after data/props</span></span><br><span class="line">    <span class="comment">// 标记生命周期 - created</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;created&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="comment">// 给 performance 分析添加处理标记</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">      vm.<span class="property">_name</span> = <span class="title function_">formatComponentName</span>(vm, <span class="literal">false</span>)</span><br><span class="line">      <span class="title function_">mark</span>(endTag)</span><br><span class="line">      <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;vm._name&#125;</span> init`</span>, startTag, endTag)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">el</span>) &#123;</span><br><span class="line">      <span class="comment">// 组件挂载, 将组件挂载到 el 描述的元素上</span></span><br><span class="line">      <span class="comment">// 此处的 $mount 方法</span></span><br><span class="line">      <span class="comment">// 会先调用 扩展的 $mount 方法（src/platforms/web/entry-runtime-with-compiler.js）, 生成 render</span></span><br><span class="line">      <span class="comment">// 再调用 原始的 $mount 方法（src/platforms/web/runtime/index.js）, 获得元素, 再调用 mountComponent 方法</span></span><br><span class="line">      vm.$mount(vm.<span class="property">$options</span>.<span class="property">el</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-1-initProxy-vm"><a href="#6-1-initProxy-vm" class="headerlink" title="6.1 initProxy(vm)"></a>6.1 <code>initProxy(vm)</code></h3><p>详细分析见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/xf5gh3">04- initProxy</a></p>
<h3 id="6-2-initLifecycle-vm"><a href="#6-2-initLifecycle-vm" class="headerlink" title="6.2 initLifecycle(vm)"></a>6.2 <code>initLifecycle(vm)</code></h3><ul>
<li>初始化 生命周期 相关属性，如 $root, $refs, $children, _watcher, _isMounted, _destroyed</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\lifecycle.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 生命周期 相关属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initLifecycle</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> options = vm.<span class="property">$options</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// locate first non-abstract parent</span></span><br><span class="line">  <span class="keyword">let</span> parent = options.<span class="property">parent</span></span><br><span class="line">  <span class="keyword">if</span> (parent &amp;&amp; !options.<span class="property">abstract</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (parent.<span class="property">$options</span>.<span class="property">abstract</span> &amp;&amp; parent.<span class="property">$parent</span>) &#123;</span><br><span class="line">      parent = parent.<span class="property">$parent</span></span><br><span class="line">    &#125;</span><br><span class="line">    parent.<span class="property">$children</span>.<span class="title function_">push</span>(vm)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vm.<span class="property">$parent</span> = parent</span><br><span class="line">  vm.<span class="property">$root</span> = parent ? parent.<span class="property">$root</span> : vm</span><br><span class="line"></span><br><span class="line">  vm.<span class="property">$children</span> = []</span><br><span class="line">  vm.<span class="property">$refs</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  vm.<span class="property">_watcher</span> = <span class="literal">null</span></span><br><span class="line">  vm.<span class="property">_inactive</span> = <span class="literal">null</span></span><br><span class="line">  vm.<span class="property">_directInactive</span> = <span class="literal">false</span></span><br><span class="line">  vm.<span class="property">_isMounted</span> = <span class="literal">false</span></span><br><span class="line">  vm.<span class="property">_isDestroyed</span> = <span class="literal">false</span></span><br><span class="line">  vm.<span class="property">_isBeingDestroyed</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-initEvents-vm"><a href="#6-3-initEvents-vm" class="headerlink" title="6.3 initEvents(vm)"></a>6.3 <code>initEvents(vm)</code></h3><ul>
<li>新增_events属性并将其赋值为空对象，用来存储事件</li>
<li>获取父组件注册的事件赋给listeners，如果listeners不为空，则调用updateComponentListeners函数，将父组件向子组件注册的事件注册到子组件的实例中</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\events.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">target</span>: any</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">add</span> (event, fn) &#123;</span><br><span class="line">  target.$on(event, fn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">remove</span> (event, fn) &#123;</span><br><span class="line">  target.$off(event, fn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 属性 _events, _hasHookEvent，增加更新组件监听</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"></span>&#125; vm </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initEvents</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  vm.<span class="property">_events</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  vm.<span class="property">_hasHookEvent</span> = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// init parent attached events</span></span><br><span class="line">  <span class="keyword">const</span> listeners = vm.<span class="property">$options</span>.<span class="property">_parentListeners</span></span><br><span class="line">  <span class="keyword">if</span> (listeners) &#123;</span><br><span class="line">    <span class="comment">// 如果有 父组件监听，则 调用更新组件方法</span></span><br><span class="line">    <span class="title function_">updateComponentListeners</span>(vm, listeners)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">updateComponentListeners</span> (</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span><br><span class="line">  <span class="attr">listeners</span>: <span class="title class_">Object</span>,</span><br><span class="line">  <span class="attr">oldListeners</span>: ?<span class="title class_">Object</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">//  增加 绑定事件 方法</span></span><br><span class="line">  target = vm</span><br><span class="line">  <span class="title function_">updateListeners</span>(listeners, oldListeners || &#123;&#125;, add, remove, createOnceHandler, vm)</span><br><span class="line">  <span class="comment">// 增加 移除事件方法</span></span><br><span class="line">  target = <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-3-1-updateListeners"><a href="#6-3-1-updateListeners" class="headerlink" title="6.3.1 updateListeners()"></a>6.3.1 <code>updateListeners()</code></h4><ul>
<li>遍历 listeners  , 如果 listeners对象中存在某个key（即事件名）而oldListeners中不存在，则说明这个事件是需要新增的；</li>
<li>遍历 oldListeners  , 如果oldListeners对象中存在某个key（即事件名）而listeners中不存在，则说明这个事件是需要从事件系统中卸载。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对比listeners和oldListeners</span></span><br><span class="line"><span class="comment"> * 再通过 add 和remove 进行 注册事件 和 卸载事件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; on </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; oldOn </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; add </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; remove </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; createOnceHandler </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">updateListeners</span> (</span><br><span class="line">  <span class="attr">on</span>: <span class="title class_">Object</span>,</span><br><span class="line">  <span class="attr">oldOn</span>: <span class="title class_">Object</span>,</span><br><span class="line">  <span class="attr">add</span>: <span class="title class_">Function</span>,</span><br><span class="line">  <span class="attr">remove</span>: <span class="title class_">Function</span>,</span><br><span class="line">  <span class="attr">createOnceHandler</span>: <span class="title class_">Function</span>,</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">let</span> name, def, cur, old, event</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> on) &#123;</span><br><span class="line">    def = cur = on[name]</span><br><span class="line">    old = oldOn[name]</span><br><span class="line">    event = <span class="title function_">normalizeEvent</span>(name)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* export function isUndef (v: any): boolean %checks &#123;</span></span><br><span class="line"><span class="comment">      return v === undefined || v === null</span></span><br><span class="line"><span class="comment">    &#125; */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(cur)) &#123;</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`Invalid handler for event &quot;<span class="subst">$&#123;event.name&#125;</span>&quot;: got `</span> + <span class="title class_">String</span>(cur),</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isUndef</span>(old)) &#123;</span><br><span class="line">      <span class="comment">// cur 有值， old 没值 </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isUndef</span>(cur.<span class="property">fns</span>)) &#123;</span><br><span class="line">        cur = on[name] = <span class="title function_">createFnInvoker</span>(cur, vm)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isTrue</span>(event.<span class="property">once</span>)) &#123;</span><br><span class="line">        cur = on[name] = <span class="title function_">createOnceHandler</span>(event.<span class="property">name</span>, cur, event.<span class="property">capture</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 调用入参的 target.$on(event, fn) 方法 注册事件</span></span><br><span class="line">      <span class="title function_">add</span>(event.<span class="property">name</span>, cur, event.<span class="property">capture</span>, event.<span class="property">passive</span>, event.<span class="property">params</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur !== old) &#123;</span><br><span class="line">      <span class="comment">// cur 有值， old 有值，且两者不相等</span></span><br><span class="line">      old.<span class="property">fns</span> = cur</span><br><span class="line">      on[name] = old</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> oldOn) &#123;</span><br><span class="line">    <span class="comment">// 遍历旧Listener，如果有 name 属性没有值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(on[name])) &#123;</span><br><span class="line">      event = <span class="title function_">normalizeEvent</span>(name)</span><br><span class="line">      <span class="comment">// 调用入参的 target.$off(event, fn) 方法 移除事件 </span></span><br><span class="line">      <span class="title function_">remove</span>(event.<span class="property">name</span>, oldOn[name], event.<span class="property">capture</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-initRender-vm"><a href="#6-4-initRender-vm" class="headerlink" title="6.4 initRender(vm)"></a>6.4 <code>initRender(vm)</code></h3><ul>
<li>初始化 渲染相关属性，如 _node, _staticTrees, $slots, $scopedSlots, _c, $createElement 等 </li>
<li>将 $attrs 和 $listeners 变成响应式</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\render.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initRender</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="comment">// _vnode 是子节点树的根</span></span><br><span class="line">  vm.<span class="property">_vnode</span> = <span class="literal">null</span> <span class="comment">// the root of the child tree</span></span><br><span class="line">  vm.<span class="property">_staticTrees</span> = <span class="literal">null</span> <span class="comment">// v-once cached trees</span></span><br><span class="line">  <span class="keyword">const</span> options = vm.<span class="property">$options</span></span><br><span class="line">  <span class="keyword">const</span> parentVnode = vm.<span class="property">$vnode</span> = options.<span class="property">_parentVnode</span> <span class="comment">// the placeholder node in parent tree</span></span><br><span class="line">  <span class="keyword">const</span> renderContext = parentVnode &amp;&amp; parentVnode.<span class="property">context</span></span><br><span class="line">  vm.<span class="property">$slots</span> = <span class="title function_">resolveSlots</span>(options.<span class="property">_renderChildren</span>, renderContext)</span><br><span class="line">  vm.<span class="property">$scopedSlots</span> = emptyObject</span><br><span class="line">  <span class="comment">// bind the createElement fn to this instance</span></span><br><span class="line">  <span class="comment">// so that we get proper render context inside it.</span></span><br><span class="line">  <span class="comment">// args order: tag, data, children, normalizationType, alwaysNormalize</span></span><br><span class="line">  <span class="comment">// internal version is used by render functions compiled from templates</span></span><br><span class="line">  <span class="comment">// 系统创建元素的方法，参数分别为：tag, data, children, normalizationType, alwaysNormalize</span></span><br><span class="line">  vm.<span class="property">_c</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">false</span>)</span><br><span class="line">  <span class="comment">// normalization is always applied for the public version, used in</span></span><br><span class="line">  <span class="comment">// user-written render functions.</span></span><br><span class="line">  <span class="comment">// 用户写 render 属性时创建元素的方法</span></span><br><span class="line">  vm.<span class="property">$createElement</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// $attrs &amp; $listeners are exposed for easier HOC creation.</span></span><br><span class="line">  <span class="comment">// they need to be reactive so that HOCs using them are always updated</span></span><br><span class="line">  <span class="keyword">const</span> parentData = parentVnode &amp;&amp; parentVnode.<span class="property">data</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">  <span class="comment">// 将 $attrs 和 $listeners 变成响应式</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$attrs&#x27;</span>, parentData &amp;&amp; parentData.<span class="property">attrs</span> || emptyObject, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      !isUpdatingChildComponent &amp;&amp; <span class="title function_">warn</span>(<span class="string">`$attrs is readonly.`</span>, vm)</span><br><span class="line">    &#125;, <span class="literal">true</span>)</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$listeners&#x27;</span>, options.<span class="property">_parentListeners</span> || emptyObject, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      !isUpdatingChildComponent &amp;&amp; <span class="title function_">warn</span>(<span class="string">`$listeners is readonly.`</span>, vm)</span><br><span class="line">    &#125;, <span class="literal">true</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$attrs&#x27;</span>, parentData &amp;&amp; parentData.<span class="property">attrs</span> || emptyObject, <span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$listeners&#x27;</span>, options.<span class="property">_parentListeners</span> || emptyObject, <span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-5-callHook-vm-39-beforeCreate-39"><a href="#6-5-callHook-vm-39-beforeCreate-39" class="headerlink" title="6.5 callHook(vm, &#39;beforeCreate&#39;)"></a>6.5 <code>callHook(vm, &#39;beforeCreate&#39;)</code></h3><ul>
<li>执行 $options 中配置的钩子函数</li>
<li>若有 Hook Event（vm._hasHookEvent 为 true），生命周期函数执行后触发自定义hook事件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行 $options 中配置的钩子函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; hook </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">callHook</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">hook</span>: string) &#123;</span><br><span class="line">  <span class="comment">// #7573 disable dep collection when invoking lifecycle hooks</span></span><br><span class="line">  <span class="comment">// 当构造生命周期钩子时， 禁止 dep 依赖收集，故将 Dep.target 置空</span></span><br><span class="line">  <span class="title function_">pushTarget</span>()</span><br><span class="line">  <span class="comment">// 从参数中获取 钩子函数体， 如created, mounted</span></span><br><span class="line">  <span class="keyword">const</span> handlers = vm.<span class="property">$options</span>[hook]</span><br><span class="line">  <span class="keyword">const</span> info = <span class="string">`<span class="subst">$&#123;hook&#125;</span> hook`</span></span><br><span class="line">  <span class="keyword">if</span> (handlers) &#123;</span><br><span class="line">    <span class="comment">// 遍历钩子函数体，通过 apply 或 call 执行钩子函数体的内容</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, j = handlers.<span class="property">length</span>; i &lt; j; i++) &#123;</span><br><span class="line">      <span class="title function_">invokeWithErrorHandling</span>(handlers[i], vm, <span class="literal">null</span>, vm, info)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 若实例设置 Hook Event，如：&lt;comp @hook:mounted=&quot;method&quot; /&gt;，</span></span><br><span class="line">  <span class="comment">// 执行完生命周期函数之后，触发该事件的执行</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">_hasHookEvent</span>) &#123;</span><br><span class="line">    <span class="comment">// 相当于 vm.$emit(&#x27;hook:mounted&#x27;)</span></span><br><span class="line">    vm.$emit(<span class="string">&#x27;hook:&#x27;</span> + hook)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 关闭依赖收集</span></span><br><span class="line">  <span class="title function_">popTarget</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-5-1-invokeWithErrorHandling-handlers-i-vm-null-vm-info"><a href="#6-5-1-invokeWithErrorHandling-handlers-i-vm-null-vm-info" class="headerlink" title="6.5.1 invokeWithErrorHandling(handlers[i], vm, null, vm, info)"></a>6.5.1 <code>invokeWithErrorHandling(handlers[i], vm, null, vm, info)</code></h4><ul>
<li>将 handler 函数体，包在 try catch 中捕获异常</li>
<li>执行 handler 函数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\util\error.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行 handler 函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; handler </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; context </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; args </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; info </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">invokeWithErrorHandling</span> (</span><br><span class="line">  <span class="attr">handler</span>: <span class="title class_">Function</span>,</span><br><span class="line">  <span class="attr">context</span>: any,</span><br><span class="line">  <span class="attr">args</span>: <span class="literal">null</span> | any[],</span><br><span class="line">  <span class="attr">vm</span>: any,</span><br><span class="line">  <span class="attr">info</span>: string</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">let</span> res</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 若有参数 用 apply，若无则用 call，执行 handler 函数，</span></span><br><span class="line">    <span class="comment">// handler 方法体内若无return，则res 为 undefined（正常情况下为undefined）</span></span><br><span class="line">    res = args ? handler.<span class="title function_">apply</span>(context, args) : handler.<span class="title function_">call</span>(context)</span><br><span class="line">    <span class="keyword">if</span> (res &amp;&amp; !res.<span class="property">_isVue</span> &amp;&amp; <span class="title function_">isPromise</span>(res) &amp;&amp; !res.<span class="property">_handled</span>) &#123;</span><br><span class="line">      <span class="comment">// 当 返回有值 且 _isVue 不为true 且 是Promise 对象 且 _handled 为空即第一次执行的，报错</span></span><br><span class="line">      res.<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">handleError</span>(e, vm, info + <span class="string">` (Promise/async)`</span>))</span><br><span class="line">      <span class="comment">// issue #9511</span></span><br><span class="line">      <span class="comment">// avoid catch triggering multiple times when nested calls</span></span><br><span class="line">      res.<span class="property">_handled</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="title function_">handleError</span>(e, vm, info)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-6-initInjections-vm"><a href="#6-6-initInjections-vm" class="headerlink" title="6.6 	initInjections(vm)"></a>6.6 	<code>initInjections(vm)</code></h3><ul>
<li>通过 resolveInject 方法处理 获取 $option.inject 参数中数组中 键 对应的 provide 的  键值对参数</li>
<li>若有 inject ，将处理后的参数进行响应式处理 挂到 vm 实例上</li>
</ul>
<p>注意：解析 inject 在 初始化 data&#x2F;props 之前</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\inject.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 $options.inject 的值注入到 vm 上</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initInjections</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取 $options.inject 注入内容</span></span><br><span class="line">  <span class="comment">/* 如：</span></span><br><span class="line"><span class="comment">    // 父组件</span></span><br><span class="line"><span class="comment">    provide: &#123;</span></span><br><span class="line"><span class="comment">      father: &#x27;father params&#x27;</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    // 子组件</span></span><br><span class="line"><span class="comment">    inject: [&#x27;father&#x27;],</span></span><br><span class="line"><span class="comment">    result 结果为： &#123;father: &quot;father params&quot;&#125; */</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">resolveInject</span>(vm.<span class="property">$options</span>.<span class="property">inject</span>, vm)</span><br><span class="line">  <span class="keyword">if</span> (result) &#123;</span><br><span class="line">    <span class="comment">// 关闭依赖收集监听</span></span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="comment">// 将注入的值，在 vm 实例上直接响应式处理；使其可以直接用 vm.father 这种方式使用注入的值</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(result).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">defineReactive</span>(vm, key, result[key], <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`Avoid mutating an injected value directly since the changes will be `</span> +</span><br><span class="line">            <span class="string">`overwritten whenever the provided component re-renders. `</span> +</span><br><span class="line">            <span class="string">`injection being mutated: &quot;<span class="subst">$&#123;key&#125;</span>&quot;`</span>,</span><br><span class="line">            vm</span><br><span class="line">          )</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理后 vm.father = &quot;father params&quot;</span></span><br><span class="line">        <span class="title function_">defineReactive</span>(vm, key, result[key])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 打开依赖收集监听</span></span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-7-initState-vm"><a href="#6-7-initState-vm" class="headerlink" title="6.7 initState(vm)"></a>6.7 <code>initState(vm)</code></h3><ul>
<li>初始化 props, methods, data, computed, watch</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 props, methods, data, computed, watch</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initState</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  vm.<span class="property">_watchers</span> = []</span><br><span class="line">  <span class="keyword">const</span> opts = vm.<span class="property">$options</span></span><br><span class="line">  <span class="comment">// 初始化 options.props 成员</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">props</span>) <span class="title function_">initProps</span>(vm, opts.<span class="property">props</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 options.methods 方法成员</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">methods</span>) <span class="title function_">initMethods</span>(vm, opts.<span class="property">methods</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 options.data ( 响应式处理 )</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">data</span>) &#123;</span><br><span class="line">    <span class="title function_">initData</span>(vm)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">observe</span>(vm.<span class="property">_data</span> = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 options.computed 计算属性</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">computed</span>) <span class="title function_">initComputed</span>(vm, opts.<span class="property">computed</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 options.watch 监听</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">watch</span> &amp;&amp; opts.<span class="property">watch</span> !== nativeWatch) &#123;</span><br><span class="line">    <span class="title function_">initWatch</span>(vm, opts.<span class="property">watch</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-7-1-initProps-vm-opts-props"><a href="#6-7-1-initProps-vm-opts-props" class="headerlink" title="6.7.1 initProps(vm,opts.props)"></a>6.7.1 <code>initProps(vm,opts.props)</code></h4><ul>
<li>遍历 $options.props ，将 key 挂载在 vm._props 下，进行响应式处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 props</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; propsOptions </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initProps</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">propsOptions</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> propsData = vm.<span class="property">$options</span>.<span class="property">propsData</span> || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> props = vm.<span class="property">_props</span> = &#123;&#125;</span><br><span class="line">  <span class="comment">// cache prop keys so that future props updates can iterate using Array</span></span><br><span class="line">  <span class="comment">// instead of dynamic object key enumeration.</span></span><br><span class="line">  <span class="keyword">const</span> keys = vm.<span class="property">$options</span>.<span class="property">_propKeys</span> = []</span><br><span class="line">  <span class="keyword">const</span> isRoot = !vm.<span class="property">$parent</span></span><br><span class="line">  <span class="comment">// root instance props should be converted</span></span><br><span class="line">  <span class="comment">// 不在根下，关闭响应式处理</span></span><br><span class="line">  <span class="keyword">if</span> (!isRoot) &#123;</span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">false</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> propsOptions) &#123;</span><br><span class="line">    keys.<span class="title function_">push</span>(key)</span><br><span class="line">    <span class="keyword">const</span> value = <span class="title function_">validateProp</span>(key, propsOptions, propsData, vm)</span><br><span class="line">    ...</span><br><span class="line">      <span class="comment">// 将 key 挂载在 vm._props 下，进行响应式处理</span></span><br><span class="line">      <span class="title function_">defineReactive</span>(props, key, value)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// static props are already proxied on the component&#x27;s prototype</span></span><br><span class="line">    <span class="comment">// during Vue.extend(). We only need to proxy props defined at</span></span><br><span class="line">    <span class="comment">// instantiation here.</span></span><br><span class="line">    <span class="comment">// 如果 key 不在 vm 实例中，则 将 key 挂载到 vm._props 属性下</span></span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      <span class="title function_">proxy</span>(vm, <span class="string">`_props`</span>, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">toggleObserving</span>(<span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-7-2-initMethods-vm-opts-methods"><a href="#6-7-2-initMethods-vm-opts-methods" class="headerlink" title="6.7.2 initMethods(vm,opts.methods)"></a>6.7.2 <code>initMethods(vm,opts.methods)</code></h4><ul>
<li>遍历 $options.methods ，校验方法，若不是function类型、或与 props 重名、或方法名重名 均报错</li>
<li>若是方法，则 使用 bind 方法，将每个 methods 方法体的 this 指向 vm 实例</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 methods 所有方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; methods </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initMethods</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">methods</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> props = vm.<span class="property">$options</span>.<span class="property">props</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> methods) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 校验 方法不是 function</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> methods[key] !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; has type &quot;<span class="subst">$&#123;<span class="keyword">typeof</span> methods[key]&#125;</span>&quot; in the component definition. `</span> +</span><br><span class="line">          <span class="string">`Did you reference the function correctly?`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 校验 方法 与 props 重名</span></span><br><span class="line">      <span class="keyword">if</span> (props &amp;&amp; <span class="title function_">hasOwn</span>(props, key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; has already been defined as a prop.`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 校验 方法名重复</span></span><br><span class="line">      <span class="keyword">if</span> ((key <span class="keyword">in</span> vm) &amp;&amp; <span class="title function_">isReserved</span>(key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; conflicts with an existing Vue instance method. `</span> +</span><br><span class="line">          <span class="string">`Avoid defining component methods that start with _ or $.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 若  methods[key] 不是方法，则 值为空函数</span></span><br><span class="line">    <span class="comment">// 若 是方法，相当于 methods[key].bind(vm)，即将每个 methods 方法体的 this 指向 vm 实例</span></span><br><span class="line">    vm[key] = <span class="keyword">typeof</span> methods[key] !== <span class="string">&#x27;function&#x27;</span> ? noop : <span class="title function_">bind</span>(methods[key], vm)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="【辅助】bind"><a href="#【辅助】bind" class="headerlink" title="【辅助】bind"></a>【辅助】<code>bind</code></h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\shared\util.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持 bind 时， 即将 fn 内的 this 指向 ctx</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">nativeBind</span> (<span class="attr">fn</span>: <span class="title class_">Function</span>, <span class="attr">ctx</span>: <span class="title class_">Object</span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> fn.<span class="title function_">bind</span>(ctx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> bind = <span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">bind</span></span><br><span class="line">  ? nativeBind</span><br><span class="line">  : polyfillBind</span><br></pre></td></tr></table></figure>

<h4 id="6-7-3-initData-vm"><a href="#6-7-3-initData-vm" class="headerlink" title="6.7.3 initData(vm)"></a>6.7.3 <code>initData(vm)</code></h4><ul>
<li>method、props 重名校验</li>
<li>循环遍历，将 $options.data 的属性挂载到 vm._data；为方便访问，又将其直接挂载到 vm 下</li>
<li>调用 observe 响应式处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initData</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> data = vm.<span class="property">$options</span>.<span class="property">data</span></span><br><span class="line">  <span class="comment">// data 如果是对象格式，则直接赋值；若是函数，则通过getData 获取data 对象</span></span><br><span class="line">  <span class="comment">// 然后将 data 挂载到 vm._data 上</span></span><br><span class="line">  data = vm.<span class="property">_data</span> = <span class="keyword">typeof</span> data === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    ? <span class="title function_">getData</span>(data, vm)</span><br><span class="line">    : data || &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isPlainObject</span>(data)) &#123;</span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">&#x27;data functions should return an object:\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function&#x27;</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// proxy data on instance</span></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(data)</span><br><span class="line">  <span class="keyword">const</span> props = vm.<span class="property">$options</span>.<span class="property">props</span></span><br><span class="line">  <span class="keyword">const</span> methods = vm.<span class="property">$options</span>.<span class="property">methods</span></span><br><span class="line">  <span class="keyword">let</span> i = keys.<span class="property">length</span></span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="comment">// methods 与 $options.data 属性不能重名</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (methods &amp;&amp; <span class="title function_">hasOwn</span>(methods, key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; has already been defined as a data property.`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// props 与 $options.data 属性不能重名</span></span><br><span class="line">    <span class="keyword">if</span> (props &amp;&amp; <span class="title function_">hasOwn</span>(props, key)) &#123;</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`The data property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already declared as a prop. `</span> +</span><br><span class="line">        <span class="string">`Use prop default value instead.`</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title function_">isReserved</span>(key)) &#123;</span><br><span class="line">      <span class="comment">// 若不含保留字符 $ 和 _，循环将 $options.data 的所有属性 key 映射到 vue 实例上</span></span><br><span class="line">      <span class="comment">// 从而访问 data中的属性时，不用 Vue._data.**，直接用 Vue.** </span></span><br><span class="line">      <span class="title function_">proxy</span>(vm, <span class="string">`_data`</span>, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// observe data</span></span><br><span class="line">  <span class="comment">// data 响应式处理</span></span><br><span class="line">  <span class="title function_">observe</span>(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6-7-3-1-getData"><a href="#6-7-3-1-getData" class="headerlink" title="6.7.3.1 getData()"></a>6.7.3.1 <code>getData()</code></h5><ul>
<li>由于此时是 Vue 的初始化，还没有进行模板渲染，所以 <strong>不需要进行依赖收集，在 pushTarget 的时候传入 空</strong></li>
<li>就将全局的 Watcher 设置为 undefined，依赖收集的时候有一个判断是 Dep.target 存在的时候才收集</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getData</span> (<span class="attr">data</span>: <span class="title class_">Function</span>, <span class="attr">vm</span>: <span class="title class_">Component</span>): any &#123;</span><br><span class="line">  <span class="comment">// #7573 disable dep collection when invoking data getters</span></span><br><span class="line">  <span class="comment">// 此时是 Vue 的初始化，还没有进行模板渲染，所以 不需要进行依赖收集</span></span><br><span class="line">  <span class="title function_">pushTarget</span>()</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> data.<span class="title function_">call</span>(vm, vm)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="title function_">handleError</span>(e, vm, <span class="string">`data()`</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="title function_">popTarget</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6-7-3-2-proxy-将-options-data-的所有属性-key-映射到-vue-实例上"><a href="#6-7-3-2-proxy-将-options-data-的所有属性-key-映射到-vue-实例上" class="headerlink" title="6.7.3.2 proxy()  将$options.data 的所有属性 key 映射到 vue 实例上"></a>6.7.3.2 <code>proxy()</code>  将$options.data 的所有属性 key 映射到 vue 实例上</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 Object.defineProperty 数据劫持</span></span><br><span class="line"><span class="comment">// eg：proxy(vm, `_data`, key), 实现将 vm._data.key 可以直接用 vm.key 访问的功能</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">proxy</span> (<span class="attr">target</span>: <span class="title class_">Object</span>, <span class="attr">sourceKey</span>: string, <span class="attr">key</span>: string) &#123;</span><br><span class="line">  sharedPropertyDefinition.<span class="property">get</span> = <span class="keyword">function</span> <span class="title function_">proxyGetter</span> () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>[sourceKey][key]</span><br><span class="line">  &#125;</span><br><span class="line">  sharedPropertyDefinition.<span class="property">set</span> = <span class="keyword">function</span> <span class="title function_">proxySetter</span> (val) &#123;</span><br><span class="line">    <span class="variable language_">this</span>[sourceKey][key] = val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(target, key, sharedPropertyDefinition)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6-7-3-3-observe响应式处理"><a href="#6-7-3-3-observe响应式处理" class="headerlink" title="6.7.3.3  observe响应式处理"></a>6.7.3.3  <code>observe</code>响应式处理</h5><p>详见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/onzg44">05- observer</a></p>
<h4 id="6-7-4-initComputed-vm-opts-computed"><a href="#6-7-4-initComputed-vm-opts-computed" class="headerlink" title="6.7.4 initComputed(vm,opts.computed)"></a>6.7.4 <code>initComputed(vm,opts.computed)</code></h4><p>详见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/onzg44">05- observer</a> 的 6</p>
<h4 id="6-7-5-initWatch-vm-opts-watch"><a href="#6-7-5-initWatch-vm-opts-watch" class="headerlink" title="6.7.5 initWatch(vm,opts.watch)"></a>6.7.5 <code>initWatch(vm,opts.watch)</code></h4><p>详见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/onzg44">05- observer</a> 的 5.1</p>
<h3 id="6-8-initProvide-vm"><a href="#6-8-initProvide-vm" class="headerlink" title="6.8 initProvide(vm)"></a>6.8 <code>initProvide(vm)</code></h3><ul>
<li>初始化 provide 指定我们想要<strong>提供</strong>给后代组件的数据&#x2F;方法</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 provide</span></span><br><span class="line"><span class="comment"> * 获取 $options.provide，若是 function 则直接执行；若不是则返回 provide</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initProvide</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> provide = vm.<span class="property">$options</span>.<span class="property">provide</span></span><br><span class="line">  <span class="keyword">if</span> (provide) &#123;</span><br><span class="line">    vm.<span class="property">_provided</span> = <span class="keyword">typeof</span> provide === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">      ? provide.<span class="title function_">call</span>(vm)</span><br><span class="line">      : provide</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-9-vm-mount-vm-options-el"><a href="#6-9-vm-mount-vm-options-el" class="headerlink" title="6.9 vm.$mount(vm.$options.el)"></a>6.9 <code>vm.$mount(vm.$options.el)</code></h3><p>详细分析见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/ad1pdp">06- 模板渲染</a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6877754661362171912">https://juejin.cn/post/6877754661362171912</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6954923081462710309">https://juejin.cn/post/6954923081462710309</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7070087080965046280">https://juejin.cn/post/7070087080965046280</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-03-12</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约4049个字, 13分钟29秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/101-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E5%85%A5%E5%8F%A3/">源码学习入口</a></h3></div><div class="post-content"><div class="card"><p><h2 id><a href="#" class="headerlink" title></a><img src="/101-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E5%85%A5%E5%8F%A3/1658329999134-ff717063-49d2-447d-8227-3c345506f6e4.png" alt="img"></h2><h2 id="1-入口文件package-json"><a href="#1-入口文件package-json" class="headerlink" title="1. 入口文件package.json"></a>1. 入口文件<code>package.json</code></h2><ul>
<li>根据运行命令，去找 <code>dev</code> 后配置，即找 <code>scripts/config.js</code> 文件的 <code>web-full-dev</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;dev&quot;: &quot;rollup -w -c scripts/config.js --environment TARGET:web-full-dev&quot;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-scripts-config-js"><a href="#2-scripts-config-js" class="headerlink" title="2. scripts/config.js"></a>2. <code>scripts/config.js</code></h2><ul>
<li>初始化配置 config，引入 entry-runtime-with-compiler.js</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">// scripts\config.js</span><br><span class="line">...</span><br><span class="line">const aliases = require(&#x27;./alias&#x27;) // 看 ./alias 文件</span><br><span class="line">const resolve = p =&gt; &#123;</span><br><span class="line">  const base = p.split(&#x27;/&#x27;)[0]</span><br><span class="line">  if (aliases[base]) &#123;</span><br><span class="line">    return path.resolve(aliases[base], p.slice(base.length + 1))</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return path.resolve(__dirname, &#x27;../&#x27;, p)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 配置定义</span><br><span class="line">const builds = &#123;</span><br><span class="line">  ... </span><br><span class="line">  // Runtime+compiler development build (Browser)</span><br><span class="line">  &#x27;web-full-dev&#x27;: &#123;</span><br><span class="line">    entry: resolve(&#x27;web/entry-runtime-with-compiler.js&#x27;), // 看 reslove ，由此找到对应文件真实路径</span><br><span class="line">    dest: resolve(&#x27;dist/vue.js&#x27;),</span><br><span class="line">    format: &#x27;umd&#x27;,</span><br><span class="line">    env: &#x27;development&#x27;,</span><br><span class="line">    alias: &#123; he: &#x27;./entity-decoder&#x27; &#125;,</span><br><span class="line">    banner</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 根据不同的环境，初始化参数 input, plugins, output, __VERSION__ 等</span><br><span class="line"> * @param &#123;*&#125; name 环境名</span><br><span class="line"> * @returns </span><br><span class="line"> */</span><br><span class="line">function genConfig (name) &#123;</span><br><span class="line">  const opts = builds[name] // 找 builds 中 name 配置</span><br><span class="line">  const config = &#123;</span><br><span class="line">     input: opts.entry,</span><br><span class="line">     external: opts.external,</span><br><span class="line">     plugins: [],</span><br><span class="line">     output: &#123;&#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  return config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始执行入口，找 TARGET 对应配置</span><br><span class="line">if (process.env.TARGET) &#123;</span><br><span class="line">  module.exports = genConfig(process.env.TARGET) // 看 genConfig</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  exports.getBuild = genConfig</span><br><span class="line">  exports.getAllBuilds = () =&gt; Object.keys(builds).map(genConfig)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="process-env-TARGET"><a href="#process-env-TARGET" class="headerlink" title="**process****.****env****.****TARGET**:"></a><code>**process****.****env****.****TARGET**</code><strong>:</strong></h3><p>这个 <code>process</code>  是nodejs 的 变量，</p>
<p>在  \node_modules@types\node\globals.d.ts 中：</p>
<p> <code>declare var process: NodeJS.Process;</code></p>
<h3 id="aliases："><a href="#aliases：" class="headerlink" title="aliases："></a><code>aliases</code>：</h3><p>根据上面的找<code>./alias</code> 文件，即：scripts&#x2F;alias.js，由此找到 <code>web/</code> 对应的文件全路径。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// </span><br><span class="line">...</span><br><span class="line">module.exports = &#123;</span><br><span class="line">  vue: resolve(&#x27;src/platforms/web/entry-runtime-with-compiler&#x27;),</span><br><span class="line">  compiler: resolve(&#x27;src/compiler&#x27;),</span><br><span class="line">  core: resolve(&#x27;src/core&#x27;),</span><br><span class="line">  shared: resolve(&#x27;src/shared&#x27;),</span><br><span class="line">  web: resolve(&#x27;src/platforms/web&#x27;),</span><br><span class="line">  weex: resolve(&#x27;src/platforms/weex&#x27;),</span><br><span class="line">  server: resolve(&#x27;src/server&#x27;),</span><br><span class="line">  sfc: resolve(&#x27;src/sfc&#x27;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由此找到 <code> entry: resolve(&#39;web/entry-runtime-with-compiler.js&#39;),</code></p>
<p>拼接后的入口文件路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/platforms/web/entry-runtime-with-compiler.js</span><br></pre></td></tr></table></figure>



<h2 id="3-platforms-web-entry-runtime-with-compiler-js"><a href="#3-platforms-web-entry-runtime-with-compiler-js" class="headerlink" title="3. platforms/web/entry-runtime-with-compiler.js"></a>3. <code>platforms/web/entry-runtime-with-compiler.js</code></h2><ul>
<li>导入  .&#x2F;runtime&#x2F;index，见 4.1；</li>
<li>扩展 Vue.prototype.$mount 方法；</li>
<li>导入  .&#x2F;compiler&#x2F;index 的 compileToFunctions 方法，挂载到 Vue.compile，见 4.2；</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">// 引入 /runtime/index 文件, 初始化 vue</span><br><span class="line">import Vue from &#x27;./runtime/index&#x27;</span><br><span class="line">...</span><br><span class="line">// 引入 /compiler/index 文件，初始化 compile 编译方法</span><br><span class="line">import &#123; compileToFunctions &#125; from &#x27;./compiler/index&#x27;</span><br><span class="line">...</span><br><span class="line">// 扩展 $mount 挂载方法</span><br><span class="line">const mount = Vue.prototype.$mount</span><br><span class="line">Vue.prototype.$mount = function (</span><br><span class="line">  el?: string | Element,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): Component &#123;</span><br><span class="line">    ...</span><br><span class="line">    return mount.call(this, el, hydrating)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">// 定义 compile 方法</span><br><span class="line">Vue.compile = compileToFunctions</span><br><span class="line"></span><br><span class="line">export default Vue</span><br></pre></td></tr></table></figure>



<h2 id="4-1-platforms-web-runtime-index-js"><a href="#4-1-platforms-web-runtime-index-js" class="headerlink" title="4.1 platforms/web/runtime/index.js"></a>4.1 <code>platforms/web/runtime/index.js</code></h2><ul>
<li>导入 <code>core/index</code> ，vue 核心代码</li>
<li>定义 $mount 挂载方法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 初始化 vue 核心代码</span><br><span class="line">import Vue from &#x27;core/index&#x27;</span><br><span class="line">...</span><br><span class="line">// 定义 $mount 挂载方法</span><br><span class="line">Vue.prototype.$mount = function (</span><br><span class="line">  el?: string | Element,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): Component &#123;</span><br><span class="line">  // 初始化挂载组件</span><br><span class="line">  el = el &amp;&amp; inBrowser ? query(el) : undefined</span><br><span class="line">  ...</span><br><span class="line">  return mountComponent(this, el, hydrating)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">export default Vue</span><br></pre></td></tr></table></figure>



<h3 id="4-1-2-core-index-js"><a href="#4-1-2-core-index-js" class="headerlink" title="4.1.2 core/index.js"></a>4.1.2 <code>core/index.js</code></h3><ul>
<li>导入 core&#x2F;instance&#x2F;index.js </li>
<li>初始化 全局 API 方法，initGlobalAPI(Vue)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 初始化 vue 实例</span><br><span class="line">import Vue from &#x27;./instance/index&#x27;</span><br><span class="line">import &#123; initGlobalAPI &#125; from &#x27;./global-api/index&#x27;</span><br><span class="line">...</span><br><span class="line">// 初始化 Vue 全局 API</span><br><span class="line">initGlobalAPI(Vue)</span><br><span class="line">...</span><br><span class="line">export default Vue</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-1-instance-index"><a href="#4-1-2-1-instance-index" class="headerlink" title="4.1.2.1 ./instance/index"></a>4.1.2.1 <code>./instance/index</code></h4><ul>
<li>详见：<a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/knb6de">02- ‘src&#x2F;core&#x2F;instance&#x2F;index.js’</a></li>
</ul>
<h4 id="4-1-2-2-initGlobalAPI-Vue"><a href="#4-1-2-2-initGlobalAPI-Vue" class="headerlink" title="4.1.2.2 initGlobalAPI(Vue)"></a>4.1.2.2 <code>initGlobalAPI(Vue)</code></h4><ul>
<li>详见：<a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/vhrfsg">03 - core&#x2F;global-api&#x2F;index.js</a></li>
</ul>
<h2 id="4-2-platforms-web-compile-index-js"><a href="#4-2-platforms-web-compile-index-js" class="headerlink" title="4.2 platforms/web/compile/index.js"></a>4.2 <code>platforms/web/compile/index.js</code></h2><ul>
<li>通过  createCompiler(baseOptions) 初始化 compile， compileToFunctions  方法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import &#123; baseOptions &#125; from &#x27;./options&#x27;</span><br><span class="line">import &#123; createCompiler &#125; from &#x27;compiler/index&#x27;</span><br><span class="line"></span><br><span class="line">const &#123; compile, compileToFunctions &#125; = createCompiler(baseOptions)</span><br><span class="line"></span><br><span class="line">export &#123; compile, compileToFunctions &#125;</span><br></pre></td></tr></table></figure>

<h2 id="附：-调试方法（基于-v2-6-14）"><a href="#附：-调试方法（基于-v2-6-14）" class="headerlink" title="附： 调试方法（基于 v2.6.14）"></a>附： 调试方法（基于 v2.6.14）</h2><ul>
<li><code>npm install</code></li>
<li>找到 examples 文件夹，打开任意一个，如 markdowm&#x2F;index.html，将引入的文件的vue文件由min修改为</li>
</ul>
<script src="../../dist/vue.js"></script>

<ul>
<li>直接浏览器打开 index.html 文件即可调试，如 file:&#x2F;&#x2F;&#x2F;E:&#x2F;workSpaces&#x2F;vue-2.6.14&#x2F;examples&#x2F;markdown&#x2F;index.html</li>
</ul>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-02-13</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约823个字, 2分钟44秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/03-%E5%86%85%E5%AD%98/">内存</a></h3></div><div class="post-content"><div class="card"><p><h1 id="1-内存模型"><a href="#1-内存模型" class="headerlink" title="1. 内存模型"></a>1. 内存模型</h1><p>内存空间分为 **栈(stack)、堆(heap)、池(一般也会归类为栈中)**。 </p>
<p>其中<strong>栈</strong>存放变量，<strong>堆</strong>存放复杂对象，<strong>池</strong>存放常量。</p>
<h3 id="1-1-栈内存"><a href="#1-1-栈内存" class="headerlink" title="1.1 栈内存"></a>1.1 栈内存</h3><p>栈是一种特殊的列表。</p>
<p>存取：<strong>先进后出</strong></p>
<p>存储基本数据类型： <strong><code>String</code>、<code>Number</code>、<code>boolean</code>、<code>null</code>、<code>undefined</code>、<code>Symbol</code></strong></p>
<p>基本数据类型保存在栈内存中，因为基本数据类型占用空间小、大小固定，通过按值来访问，属于被频繁使用的数据。</p>
<h3 id="1-2-堆内存"><a href="#1-2-堆内存" class="headerlink" title="1.2 堆内存"></a>1.2 堆内存</h3><p>堆是一种经过排序的树形数据结构，每个结点都有一个值。</p>
<p>堆的特点是根结点的值最小（或最大），且根结点的两个子树也是一个堆。 由于堆的这个特性，常用来实现优先队列。</p>
<p>存取：<strong>随意</strong></p>
<p>存储引用数据类型：<code>Object</code>、<code>Array</code>、<code>Function</code>等</p>
<p>引用数据类型存储在堆内存中，因为引用数据类型占据空间大、大小不固定。 如果存储在栈中，将会影响程序运行的性能； <strong>引用数据类型在栈中存储了指针</strong>，该指针指向堆中该实体的起始地址。 当解释器寻找引用值时，会首先检索其在栈中的地址，<strong>取得地址后从堆中获得值</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">123</span>; <span class="comment">// 变量 a 存在栈中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 变量 b 存在栈中，b的值是&#123;age: 18&#125;的引用地址；&#123;age: 18&#125;作为对象存在堆内存</span></span><br><span class="line"><span class="keyword">var</span> b = &#123; <span class="attr">age</span>: <span class="number">18</span> &#125;; </span><br></pre></td></tr></table></figure>

<h4 id="1-2-1-为什么可以改变-const-的值？"><a href="#1-2-1-为什么可以改变-const-的值？" class="headerlink" title="1.2.1 为什么可以改变 const 的值？"></a>1.2.1 为什么可以改变 const 的值？</h4><p>ES6语法中的 const 声明一个只读的常量。一旦声明，常量的值就不能改变。但是下面的代码可以改变 const 的值，这是为什么？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = &#123;&#125;;</span><br><span class="line">foo.<span class="property">prop</span> = <span class="number">123</span>;</span><br><span class="line">foo.<span class="property">prop</span> <span class="comment">// 123; // 可以修改const，不报错</span></span><br><span class="line">foo = &#123;&#125;; <span class="comment">// TypeError: &quot;foo&quot; is read-only</span></span><br></pre></td></tr></table></figure>

<p>因为const foo存的{}的地址，当foo直接改变地址时，就违反了改变的原则；而当{}中增加属性值时，foo的引用地址没改变，所以可以修改。</p>
<h3 id="1-3-简单类型和复杂类型的区别"><a href="#1-3-简单类型和复杂类型的区别" class="headerlink" title="1.3 简单类型和复杂类型的区别"></a>1.3 简单类型和复杂类型的区别</h3><ul>
<li><p>声明变量时不同的内存地址分配：</p>
</li>
<li><ul>
<li>简单类型的值存放在栈中，在栈中存放的是对应的值</li>
<li>引用类型对应的值存储在堆中，在栈中存放的是指向堆内存的地址</li>
</ul>
</li>
<li><p>不同的类型数据导致赋值变量时的不同：</p>
</li>
<li><ul>
<li>简单类型赋值，是生成相同的值，两个对象对应不同的地址</li>
<li>复杂类型赋值，是将保存对象的内存地址赋值给另一个变量。也就是两个变量指向堆内存中同一个对象</li>
</ul>
</li>
</ul>
<h2 id="2-内存的生命周期："><a href="#2-内存的生命周期：" class="headerlink" title="2. 内存的生命周期："></a>2. 内存的生命周期：</h2><p><img src="/03-%E5%86%85%E5%AD%98/1661853741029-c26d1a6a-79ca-4f67-a7a6-30c667a149af-20220901232511827.png" alt="img"></p>
<ol>
<li>分配需要的内存</li>
</ol>
<p>JavaScript 在定义变量或者创建一个变量的时候，就完成了内存分配。</p>
<ol>
<li>使用分配到的内存（读、写操作）</li>
<li>不需要时将其释放、归还</li>
</ol>
<p>“垃圾回收器”，它的主要工作是跟踪内存的分配和使用，以便当分配的内存不再使用时，自动释放它。</p>
<h2 id="3-垃圾回收机制（GC）"><a href="#3-垃圾回收机制（GC）" class="headerlink" title="3. 垃圾回收机制（GC）"></a>3. 垃圾回收机制（GC）</h2><p><strong>Java garbage collection (GC)</strong></p>
<h3 id="3-1-JavaScript-的自动垃圾收集机制"><a href="#3-1-JavaScript-的自动垃圾收集机制" class="headerlink" title="3.1 JavaScript 的自动垃圾收集机制"></a>3.1 JavaScript 的自动垃圾收集机制</h3><p>就是找出那些不再继续使用的值，然后释放其占用的内存。垃圾收集器会每隔固定的时间段就执行一次释放操作。 在JavaScript中，最常用的是通过标记清除的算法来找到哪些对象是不再继续使用的，因此 a &#x3D; null 其实仅仅只是做了一个释放引用的操作，让 a 原本对应的值失去引用，脱离执行环境，这个值会在下一次垃圾收集器执行操作时被找到并释放。而在适当的时候解除引用，是为页面获得更好性能的一个重要方式。</p>
<h4 id="3-1-1-如何判断一个变量已经死了？"><a href="#3-1-1-如何判断一个变量已经死了？" class="headerlink" title="3.1.1 如何判断一个变量已经死了？"></a>3.1.1 如何判断一个变量已经死了？</h4><p>一个对象在已经没有引用时。</p>
<p>全局变量：会到程序执行完毕，才会被回收；</p>
<p>局部变量：函数执行结束后，如果有外部引用，则不能被回收；没有便可以被回收；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a= &#123;<span class="attr">a</span>: <span class="number">123</span>&#125; <span class="comment">//  &#123;a: 123&#125; 有a引用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> b1 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> c =&#123;<span class="attr">a</span>:<span class="number">1</span>&#125;</span><br><span class="line">  <span class="keyword">return</span> b1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="title function_">b</span>();<span class="comment">//如果return b1,则b1会被回收；如果return c，c不会被回收；</span></span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-到底什么时候回收？"><a href="#3-1-2-到底什么时候回收？" class="headerlink" title="3.1.2 到底什么时候回收？"></a>3.1.2 到底什么时候回收？</h4><p>JavaScript 是自动回收机制，以下是可能会触发的情况：</p>
<ul>
<li>执行完一次主线程（或宏任务、微任务），就会回收一次</li>
<li>当内存不够时，一次执行中可能也会触发回收</li>
</ul>
<h4 id><a href="#" class="headerlink" title></a></h4><h3 id="3-2-引用计数算法"><a href="#3-2-引用计数算法" class="headerlink" title="3.2 引用计数算法"></a>3.2 引用计数算法</h3><p> 引用计数算法定义“内存不再使用”的标准很简单，就是看一个对象是否有指向它的引用。如果没有其他对象指向它了，说明该对象已经不再需了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个对象person，有两个指向属性age和name的引用</span></span><br><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">12</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;aaaa&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">person.<span class="property">name</span> = <span class="literal">null</span>; <span class="comment">// 虽然设置为null，但因为person对象还有指向name的引用，因此name不会回收</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p = person; </span><br><span class="line">person = <span class="number">1</span>;         <span class="comment">//原来的person对象被赋值为1，但因为有新引用p指向原person对象，因此它不会被回收</span></span><br><span class="line"></span><br><span class="line">p = <span class="literal">null</span>;           <span class="comment">//原person对象已经没有引用，很快会被回收</span></span><br></pre></td></tr></table></figure>

<h4 id="限制：循环引用会导致内存泄露"><a href="#限制：循环引用会导致内存泄露" class="headerlink" title="限制：循环引用会导致内存泄露"></a>限制：循环引用会导致内存泄露</h4><p>循环引用：两个对象相互引用，尽管它们不再使用，也不会进行回收，导致内存泄露。</p>
<p>该算法有个限制：无法处理循环引用的事例。在下面的例子1中，两个对象被创建，并互相引用，形成了一个循环。它们被调用之后会离开函数作用域，所以它们已经没有用了，可以被回收了。然而，引用计数算法考虑到它们互相都有至少一次引用，所以它们不会被回收。</p>
<ul>
<li>案例1：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> o = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> o2 = &#123;&#125;;</span><br><span class="line">  o.<span class="property">a</span> = o2; <span class="comment">// o 引用 o2</span></span><br><span class="line">  o2.<span class="property">a</span> = o; <span class="comment">// o2 引用 o</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;azerty&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li>案例2：</li>
</ul>
<p>如：创建一个DOM元素并绑定一个点击事件，变量div有事件处理函数的引用，同时事件处理函数也有div的引用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> div;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  div = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;myDivElement&quot;</span>);</span><br><span class="line">  div.<span class="property">circularReference</span> = div;</span><br><span class="line">  div.<span class="property">lotsOfData</span> = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">10000</span>).<span class="title function_">join</span>(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在上面的例子里，myDivElement 这个 DOM 元素里的 circularReference 属性引用了 myDivElement，造成了循环引用。如果该属性没有显示移除或者设为 null，引用计数式垃圾收集器将总是且至少有一个引用，并将一直保持在内存里的 DOM 元素，即使其从 DOM 树中删去了。如果这个 DOM 元素拥有大量的数据 (如上的 lotsOfData 属性)，而这个数据占用的内存将永远不会被释放。</p>
<h3 id="3-3-标记清除算法"><a href="#3-3-标记清除算法" class="headerlink" title="3.3 标记清除算法"></a>3.3 标记清除算法</h3><p>从 2012 年起，所有现代浏览器都使用了标记 - 清除垃圾回收算法。所有对 JavaScript 垃圾回收算法的改进都是基于标记 - 清除算法的改进，并没有改进标记 - 清除算法本身和它对“对象是否不再需要”的简化定义。</p>
<p>这个算法假定设置一个叫做根（root）的对象（在 Javascript 里，根是全局对象）。垃圾回收器将定期从根开始，找所有从根开始引用的对象，然后找这些对象引用的对象……从根开始，垃圾回收器将找到所有可以获得的对象和收集所有不能获得的对象。</p>
<p>简单说，将那些无法由根部触触发到的对象标记为不再使用，稍后进行回收。</p>
<p><strong>此算法避免内存泄露的方法：</strong></p>
<p><strong>明确切断需要回收的对象与根部的联系</strong></p>
<h4 id="限制：那些无法从根对象查询到的对象都将被清除"><a href="#限制：那些无法从根对象查询到的对象都将被清除" class="headerlink" title="限制：那些无法从根对象查询到的对象都将被清除"></a>限制：那些无法从根对象查询到的对象都将被清除</h4><p>尽管这是一个限制，但实践中我们很少会碰到类似的情况，所以开发者不太会去关心垃圾回收机制。</p>
<h3 id="3-4-V8引擎"><a href="#3-4-V8引擎" class="headerlink" title="3.4 V8引擎"></a>3.4 V8引擎</h3><h4 id="3-4-1-堆内存大小"><a href="#3-4-1-堆内存大小" class="headerlink" title="3.4.1 堆内存大小"></a>3.4.1 堆内存大小</h4><p>在V8引擎的堆内存的大小上限在64位系统中为 <strong>1464MB</strong>，在32位系统中则为 <strong>732MB</strong>（在node 环境有 C++ 加持下，会略扩容）</p>
<h4 id="3-4-2-堆内存对象的分代管理"><a href="#3-4-2-堆内存对象的分代管理" class="headerlink" title="3.4.2 堆内存对象的分代管理"></a>3.4.2 堆内存对象的分代管理</h4><p>V8引擎对堆内存中的 JavaScript 对象进行分代管理。</p>
<p><img src="/03-%E5%86%85%E5%AD%98/1662016839861-073ba972-8ecb-40e9-b3eb-8a8fd7e42379-20220901232511902.png" alt="img"></p>
<p>“垃圾变量”：不再使用的变量或没有被引用的对象。</p>
<h5 id="3-4-2-1-新生代："><a href="#3-4-2-1-新生代：" class="headerlink" title="3.4.2.1 新生代："></a>3.4.2.1 新生代：</h5><p>短时间存活的新变量会存在新生代中，新生代的内存量极小。在 64位系统下，约32M。</p>
<p><strong>新生代的回收算法:</strong></p>
<p>新生代空间一分为二，分为 from: 16M、to: 16M(一直空的) 区。</p>
<p><strong>核心：复制 - 清空</strong></p>
<p><strong>过程：</strong></p>
<p>删掉垃圾变量，把from存活的变量复制到to，把from清空，再把to和from的名字对调。</p>
<p><strong>优势：</strong></p>
<p>这样可以提升回收速度，时间复杂度低，牺牲空间换时间。不用像老生代那样整理磁盘。</p>
<h5 id="3-4-2-2-老生代："><a href="#3-4-2-2-老生代：" class="headerlink" title="3.4.2.2 老生代："></a>3.4.2.2 老生代：</h5><p>生存时间比较长的变量，会转存到老生代，老生代占据了几乎所有内存。在 64位系统下，约1.4G。</p>
<p><strong>老生代回收算法：</strong></p>
<ol>
<li><p>标记垃圾变量</p>
</li>
<li><p>清除垃圾变量</p>
</li>
<li><p>整理磁盘（）– </p>
</li>
<li><ol>
<li>为什么要整理磁盘？</li>
</ol>
</li>
</ol>
<p>如果清除的垃圾变量是多个不连续的变量，虽然空间够，但如果要存一个数组，而<strong>数组存储，必须是在连续的内存空间</strong>，多个不连续的空白空间不能存储数组。</p>
<ol>
<li><ol>
<li>如何整理磁盘？</li>
</ol>
</li>
</ol>
<p>把空出来的内存位置移动合并，留最后整个统一的空白块</p>
<h5 id="3-4-2-3-新生代什么时候转换到老生代？"><a href="#3-4-2-3-新生代什么时候转换到老生代？" class="headerlink" title="3.4.2.3  新生代什么时候转换到老生代？"></a>3.4.2.3  <strong>新生代什么时候转换到老生代？</strong></h5><ol>
<li>新生代发现本次复制（from-&gt; to复制）后，会占用超过25%的to空间</li>
<li>这个对象已经在新生代经历过一次回收</li>
</ol>
<p>就会将新生代变量放到老生代。</p>
<h3 id="3-4-3-为什么-JavaScript-要限制内存，设置-1-4G？"><a href="#3-4-3-为什么-JavaScript-要限制内存，设置-1-4G？" class="headerlink" title="3.4.3 为什么 JavaScript 要限制内存，设置 1.4G？"></a>3.4.3 为什么 JavaScript 要限制内存，设置 1.4G？</h3><ol>
<li>JavaScript 是脚本语言，而脚本语言的特性是一次执行的，没必要弄太大；</li>
</ol>
<p>而Java 这类是后端语言，是作为服务的，会一直开着运行，也就会不断增加内存。</p>
<ol>
<li><strong>核心原因：</strong>垃圾回收是阻塞式的（阻塞式是如果要进行垃圾回收，会中断代码执行，而 JavaScript 是单线程的）</li>
</ol>
<p>而进行一次 1.4G 的垃圾回收，大约需要1s。</p>
<p>如果垃圾太大，垃圾回收耗时久，用户直观看页面感知非常明显；但后端如果中断1s相对影响不大。</p>
<h2 id="4-检测内存"><a href="#4-检测内存" class="headerlink" title="4. 检测内存"></a>4. 检测内存</h2><h3 id="4-1-浏览器端"><a href="#4-1-浏览器端" class="headerlink" title="4.1 浏览器端"></a>4.1 浏览器端</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window.performance.memory</span><br></pre></td></tr></table></figure>

<p>在 DevTools 中，使用 Memory 工具。</p>
<h4 id="Shallow-Size："><a href="#Shallow-Size：" class="headerlink" title="Shallow Size："></a>Shallow Size：</h4><p>对象本身占用<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%86%85%E5%AD%98&spm=1001.2101.3001.7020">内存</a>的大小，不包含其引用的对象。</p>
<ul>
<li>常规对象（非数组）的 Shallow size 由其成员变量的数量和类型决定。</li>
<li>数组的shallow size由数组元素的类型及数组长度决定</li>
</ul>
<h4 id="Retained-Size："><a href="#Retained-Size：" class="headerlink" title="Retained Size："></a>Retained Size：</h4><p>对象的Retained Size &#x3D; 对象本身的Shallow Size + 对象能直接或间接访问到的对象的Shallow Size</p>
<h4 id="Heap-Size"><a href="#Heap-Size" class="headerlink" title="Heap Size:"></a>Heap Size:</h4><p>堆的大小，当资源增加，当前堆的空间不够时，系统会增加堆的大小，若超过上限（如64M，阈值视平台而定）则会被杀掉 。</p>
<h4 id="Allocated"><a href="#Allocated" class="headerlink" title="Allocated:"></a>Allocated:</h4><p>堆中已分配的大小，即 App 应用实际占用的内存大小，资源回收后，此项数据会变小。</p>
<h3 id="4-2-Node-端"><a href="#4-2-Node-端" class="headerlink" title="4.2 Node 端"></a>4.2 Node 端</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 已使用的内存</span></span><br><span class="line">process.<span class="title function_">memoryUsage</span>()</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Node端可以手动触发垃圾回收：global.gc （因为其源码是C++）</p>
</li>
<li><p>Node端可以设置内存：</p>
</li>
</ul>
<p>Node 新版是可以自动扩，如下将内存设置到最大：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行 test.js 文件，设置最大的老生代空间为1700M</span></span><br><span class="line">node --max-old-space-size=<span class="number">1700</span> test.<span class="property">js</span> <span class="comment">// 单位是MB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 test.js 文件，设置最大的新生代空间为1024M</span></span><br><span class="line">node --max_semi_space_size=<span class="number">1024</span> test.<span class="property">js</span> <span class="comment">// 单位是KB</span></span><br></pre></td></tr></table></figure>

<h2 id="5-优化内存"><a href="#5-优化内存" class="headerlink" title="5. 优化内存"></a>5. 优化内存</h2><ul>
<li>少定义全局变量；</li>
<li>如果一定要定义全局变量，可以用完后，手动释放掉，如 <code>a=undefined;a=null;</code> (原理：将引用类型赋值为基本类型，去引用)；</li>
<li>注意增长闭包情况；</li>
</ul>
<h3 id="5-1-增长闭包："><a href="#5-1-增长闭包：" class="headerlink" title="5.1 增长闭包："></a>5.1 增长闭包：</h3><p>普通闭包，对象数据量不大，对整个项目一般影响不大，但需注意增长闭包。</p>
<p>如下例子，是会无限增长的闭包：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="title function_">funciotn</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> arr = []</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">item</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(arr.<span class="property">length</span>&gt;<span class="number">0</span>)&#123; <span class="comment">//可通过限制条数，规避对内存的影响</span></span><br><span class="line">      arr.<span class="title function_">push</span>(item)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)&#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-WeakMap"><a href="#6-WeakMap" class="headerlink" title="6. WeakMap"></a>6. WeakMap</h2><p>ES6 推出了两种新的数据结构：<strong>WeakSet</strong> 和 <strong>WeakMap</strong>。它们对于值的引用都是不计入垃圾回收机制的，所以名字里面才会有一个”Weak”，表示这是<strong>弱引用</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> wm = <span class="keyword">new</span> <span class="title class_">WeakMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> element = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;example&#x27;</span>);</span><br><span class="line"></span><br><span class="line">wm.<span class="title function_">set</span>(element, <span class="string">&#x27;some information&#x27;</span>);</span><br><span class="line">wm.<span class="title function_">get</span>(element) <span class="comment">// &quot;some information&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面代码中，先新建一个 Weakmap 实例。然后，将一个 DOM 节点作为键名存入该实例，并将一些附加信息作为键值，一起存放在 WeakMap 里面。这时，WeakMap 里面对element的引用就是弱引用，不会被计入垃圾回收机制。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903615300108302">https://juejin.cn/post/6844903615300108302</a></p>
<p><a target="_blank" rel="noopener" href="https://www.imooc.com/article/13489">https://www.imooc.com/article/13489</a></p>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2017/04/memory-leak.html">http://www.ruanyifeng.com/blog/2017/04/memory-leak.html</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-01-08</span><i class="fa fa-tag"></i><a class="tag" href="/tags/JavaScript/" title="JavaScript">JavaScript </a><span class="leancloud_visitors"></span><span>大约3562个字, 11分钟52秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/06-%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95vs%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95vs%E5%8E%9F%E5%9E%8B%E6%96%B9%E6%B3%95/">静态方法vs实例方法vs原型方法</a></h3></div><div class="post-content"><div class="card"><p><h4 id="例子对比："><a href="#例子对比：" class="headerlink" title="例子对比："></a>例子对比：</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Person</span> = <span class="keyword">function</span>(<span class="params">name</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;初始化构造函数&#x27;</span>)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构造函数内的方法</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">getName</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;调用构造函数内的方法&#x27;</span>)</span><br><span class="line">    <span class="comment">// return name</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态方法</span></span><br><span class="line"><span class="title class_">Person</span>.<span class="property">staticFunc</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;调用静态方法&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 原型方法</span></span><br><span class="line"><span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">protoFunc</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;调用原型方法&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例对象</span></span><br><span class="line"><span class="keyword">let</span> p1 = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;Luna&#x27;</span>) <span class="comment">// 输出： 初始化构造函数</span></span><br><span class="line"></span><br><span class="line">p1.<span class="title function_">getName</span>()  <span class="comment">// 输出：  调用构造函数内的方法</span></span><br><span class="line">p1.<span class="title function_">protoFunc</span>() <span class="comment">// 输出： 调用原型方法</span></span><br><span class="line">p1.<span class="property">staticFunc</span> <span class="comment">// 输出： undefined</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Person</span>.<span class="property">getName</span> <span class="comment">// 输出： undefined </span></span><br><span class="line"><span class="title class_">Person</span>.<span class="property">protoFunc</span> <span class="comment">// 输出： undefined</span></span><br><span class="line"><span class="title class_">Person</span>.<span class="title function_">staticFunc</span>() <span class="comment">// 输出： 调用静态方法</span></span><br></pre></td></tr></table></figure>

<h3 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h3><p><strong>static</strong> 关键字定义了<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E5%92%8C%E5%AD%97%E6%AE%B5">静态方法或字段</a>，或<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes/Static_initialization_blocks">静态初始化块</a>（有关这种用法的更多信息，请参阅链接）。<strong>静态属性不能在类的实例上直接访问</strong>。相反，它们是<strong>在类本身上被访问</strong>的。</p>
<p>静态方法通常是实用函数，如创建或克隆对象的函数，而静态属性则适用于缓存、固定配置或其他不需要跨实例复制的数据。</p>
<p><strong>当你希望一个字段在每个类中只存在一次，而不是在你创建的每个类实例中都存在时，公有静态字段就很有用。</strong>这对缓存、固定配置或其他不需要在实例间复制的数据非常有用。</p>
<h3 id="构造函数："><a href="#构造函数：" class="headerlink" title="构造函数："></a>构造函数：</h3><p>构造函数的特点有两个。</p>
<ul>
<li>函数体内部使用了this关键字，代表了所要生成的对象实例。</li>
<li>生成对象实例的时候，必须使用new命令。</li>
</ul>
<h3 id="实例方法："><a href="#实例方法：" class="headerlink" title="实例方法："></a>实例方法：</h3><p>实例对象调用的构造函数内的方法。</p>
<h3 id="原型方法："><a href="#原型方法：" class="headerlink" title="原型方法："></a>原型方法：</h3><p>希望在已存在的对象、构造函数添加新的属性或方法，就在对象或构造函数的 prototype 属性上增加新属性和方法。</p>
<p><strong>实例之间共享prototype上的属性和方法。</strong></p>
<h4 id="共享而非复制"><a href="#共享而非复制" class="headerlink" title="共享而非复制"></a>共享而非复制</h4><p>通过将方法和属性定义在prototype上，所有的实例都会共享这些属性和方法，而不是在每个实例创建时复制一份。这意味着无论创建多少个实例，它们都使用同一个方法的引用，这有助于减少脚本的内存使用量。</p>
<h4 id="减少内存使用，优化性能"><a href="#减少内存使用，优化性能" class="headerlink" title="减少内存使用，优化性能"></a>减少内存使用，优化性能</h4><p>当实例需要访问构造函数原型上的属性或方法时，它们会通过原型链来进行查找。这种查找机制相比于在每个对象实例中存储自己的副本要高效得多，因为它避免了不必要的内存浪费，从而提高程序运行的性能。</p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><ol>
<li><strong>实例对象</strong>可以调用的方法：<strong>构造函数内的方法、原型方法；</strong></li>
<li><strong>构造函数</strong>可以调用的方法：<strong>静态方法；</strong></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://docs.pingcode.com/ask/168242.html">https://docs.pingcode.com/ask/168242.html</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Working_with_objects">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Working_with_objects</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-11-30</span><i class="fa fa-tag"></i><a class="tag" href="/tags/JavaScript/" title="JavaScript">JavaScript </a><span class="leancloud_visitors"></span><span>大约788个字, 2分钟37秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/301-hexo%E6%90%AD%E5%BB%BA/">hexo搭建</a></h3></div><div class="post-content"><div class="card"><p><h2 id="1-创建-hexo-项目"><a href="#1-创建-hexo-项目" class="headerlink" title="1. 创建 hexo 项目"></a>1. 创建 hexo 项目</h2><h3 id="1-1-安装-Hexo"><a href="#1-1-安装-Hexo" class="headerlink" title="1.1 安装 Hexo"></a>1.1 安装 Hexo</h3><p><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/#%E5%AE%89%E8%A3%85-Hexo">https://hexo.io/zh-cn/docs/#%E5%AE%89%E8%A3%85-Hexo</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 安装 hexo 手脚架</span><br><span class="line">$ npm install -g hexo-cli</span><br></pre></td></tr></table></figure>

<h3 id="1-2-建站（创建-hexo-项目）"><a href="#1-2-建站（创建-hexo-项目）" class="headerlink" title="1.2  建站（创建 hexo 项目）"></a>1.2  建站（创建 hexo 项目）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 创建项目 &lt;folder&gt;</span><br><span class="line">$ hexo init &lt;folder&gt;</span><br><span class="line">  </span><br><span class="line"># 安装项目依赖  </span><br><span class="line">$ cd &lt;folder&gt;</span><br><span class="line">$ npm install</span><br></pre></td></tr></table></figure>



<p>新建完成后，指定文件夹的目录如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">. </span><br><span class="line">├── _config.yml  // hexo 项目主要的配置文件 </span><br><span class="line">├── package.json </span><br><span class="line">├── scaffolds   // 存放新建blog的模板 </span><br><span class="line">├── source   // blog 文件源 </span><br><span class="line">|   ├── _drafts </span><br><span class="line">|   └── _posts // 最常用穿件的blog存放位置 </span><br><span class="line">└── themes  // blog 主题包</span><br></pre></td></tr></table></figure>

<p><img src="/301-hexo%E6%90%AD%E5%BB%BA/1651791606534-8e89bb3d-10d1-42ae-991a-3cb0309c962e-20220820211106224.png" alt="img"></p>
<h3 id="1-3-预览网站"><a href="#1-3-预览网站" class="headerlink" title="1.3 预览网站"></a>1.3 预览网站</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo server</span><br></pre></td></tr></table></figure>

<p><img src="/301-hexo%E6%90%AD%E5%BB%BA/1651791772412-82774cdc-c583-49ed-813e-bd89f252a8c3-20220820211106832.png" alt="img"></p>
<h2 id="目录-默认文件结构"><a href="#目录-默认文件结构" class="headerlink" title="目录(默认文件结构)"></a>目录(默认文件结构)</h2><table>
<thead>
<tr>
<th><strong>参数</strong></th>
<th><strong>描述</strong></th>
<th><strong>默认值</strong></th>
</tr>
</thead>
<tbody><tr>
<td>source_dir</td>
<td>资源文件夹，这个文件夹用来存放内容。</td>
<td>source</td>
</tr>
<tr>
<td>public_dir</td>
<td>公共文件夹，这个文件夹用于存放生成的站点文件。</td>
<td>public</td>
</tr>
<tr>
<td>tag_dir</td>
<td>标签文件夹</td>
<td>tags</td>
</tr>
<tr>
<td>archive_dir</td>
<td>归档文件夹</td>
<td>archives</td>
</tr>
<tr>
<td>category_dir</td>
<td>分类文件夹</td>
<td>categories</td>
</tr>
<tr>
<td>code_dir</td>
<td>Include code 文件夹，source_dir 下的子目录</td>
<td>downloads&#x2F;code</td>
</tr>
<tr>
<td>i18n_dir</td>
<td>国际化（i18n）文件夹</td>
<td>:lang</td>
</tr>
<tr>
<td>skip_render</td>
<td>跳过指定文件的渲染。匹配到的文件将会被不做改动地复制到 public 目录中。您可使用 <a target="_blank" rel="noopener" href="https://github.com/micromatch/micromatch#extended-globbing">glob 表达式</a>来匹配路径。</td>
<td></td>
</tr>
</tbody></table>
<h3 id="1-4-主题修改"><a href="#1-4-主题修改" class="headerlink" title="1.4 主题修改"></a>1.4 主题修改</h3><p>在 <a target="_blank" rel="noopener" href="https://hexo.io/themes/">https://hexo.io/themes/</a> 可以寻找喜欢的主题进行安装。</p>
<p>如：安装 anatole 主题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://gitee.com/Lhcfl/hexo-theme-anatolo.git themes/Anatolo</span><br></pre></td></tr></table></figure>

<p>安装依赖</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-renderer-pug --save</span><br><span class="line">npm install hexo-renderer-stylus --save</span><br></pre></td></tr></table></figure>

<p>安装成功后（在 theme 文件夹下新增一个皮肤包），修改 <code>_config.yml</code>  的配置 ：</p>
<h2 id="2-创建文章"><a href="#2-创建文章" class="headerlink" title="2. 创建文章"></a>2. 创建文章</h2><h3 id="2-1-创建文章"><a href="#2-1-创建文章" class="headerlink" title="2.1 创建文章"></a>2.1 创建文章</h3><p>默认创建 post 类型 <code>.md</code>文章（文件名默认为<code>.md</code>，文件名无需加 后缀）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ hexo <span class="keyword">new</span> [layout] &lt;title&gt;</span><br><span class="line"></span><br><span class="line"># 简便创建，默认layout 为 post</span><br><span class="line">$ hexo <span class="keyword">new</span> &lt;title&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-创建有图片等资源的文件"><a href="#2-2-创建有图片等资源的文件" class="headerlink" title="2.2 创建有图片等资源的文件"></a>2.2 创建有图片等资源的文件</h3><h4 id="2-2-1-修改-post-asset-folder"><a href="#2-2-1-修改-post-asset-folder" class="headerlink" title="2.2.1 修改  post_asset_folder"></a>2.2.1 修改  <code>post_asset_folder</code></h4><p>修改 <code>_config.yml</code>  中 <code>post_asset_folder</code>配置为 <code>true</code>，然后正常创建文章，便会在<code>A.md</code>文章同层多一个<code>A</code>同名文件夹。</p>
<p>图片路径就直接写即可，相当于 <strong>图片和文章在同一层级</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">post_asset_folder</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><img src="/301-hexo%E6%90%AD%E5%BB%BA/1651793328430-c8aeb32c-1354-495c-bbcf-b8732792058e-20220820211106320.jpeg" alt="img"></p>
<h4 id="2-2-2-安装插件-hexo-renderer-marked"><a href="#2-2-2-安装插件-hexo-renderer-marked" class="headerlink" title="2.2.2 安装插件 hexo-renderer-marked"></a>2.2.2 安装插件 <code>hexo-renderer-marked</code></h4><p>用于 Markdown 解析和渲染的插件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-renderer-marked</span><br></pre></td></tr></table></figure>



<p>修改 <code>_config.yml</code> 配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">post_asset_folder: true</span><br><span class="line">marked:</span><br><span class="line">  prependRoot: true</span><br><span class="line">  postAsset: true</span><br></pre></td></tr></table></figure>



<h3 id="2-3-创建按照年份分类的文章-（此方式暂不可行，会导致图片无法显示）"><a href="#2-3-创建按照年份分类的文章-（此方式暂不可行，会导致图片无法显示）" class="headerlink" title="2.3 创建按照年份分类的文章 （此方式暂不可行，会导致图片无法显示）"></a>2.3 创建按照年份分类的文章 （此方式暂不可行，会导致图片无法显示）</h3><h4 id="有解决方案的欢迎指点"><a href="#有解决方案的欢迎指点" class="headerlink" title="有解决方案的欢迎指点~"></a>有解决方案的欢迎指点~</h4><p>如果直接创建文章，则默认在 <code>source/_post</code> 文件夹下排排放，修改如下配置后，则可以按创建年份将文章分类到不同文件夹下。</p>
<p>修改 <code>_config.yml</code>  ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 保持不变</span><br><span class="line"><span class="attr">permalink</span>: :year/:month/:day/:title/</span><br><span class="line"></span><br><span class="line"># 修改 new_post_name</span><br><span class="line"><span class="attr">new_post_name</span>: :year/:title.<span class="property">md</span> </span><br></pre></td></tr></table></figure>

<h3 id><a href="#" class="headerlink" title></a><img src="/301-hexo%E6%90%AD%E5%BB%BA/1651793466575-2ec9fc1c-8456-4f1f-8295-80fafa9fc221-20220820211106393.png" alt="img"></h3><h3 id="2-4-首页显示部分文章"><a href="#2-4-首页显示部分文章" class="headerlink" title="2.4 首页显示部分文章"></a>2.4 首页显示部分文章</h3><p>在需要显示后加此句，截断首页显示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--more--&gt; </span><br></pre></td></tr></table></figure>



<h2 id="3-Github-Action-部署项目"><a href="#3-Github-Action-部署项目" class="headerlink" title="3. Github Action 部署项目"></a>3. Github Action 部署项目</h2><h3 id="3-1-github-新建仓库"><a href="#3-1-github-新建仓库" class="headerlink" title="3.1 github 新建仓库"></a>3.1 github 新建仓库</h3><ul>
<li>在github 上新建仓库，仓库名为 <code>&#123;userName&#125;.github.io</code>， userName就是github的用户名</li>
<li>创建成功后，复制仓库http的地址</li>
</ul>
<h3 id="3-2-部署"><a href="#3-2-部署" class="headerlink" title="3.2 部署"></a>3.2 部署</h3><ul>
<li>安装部署插件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 安装部署插件</span></span><br><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>

<ul>
<li>修改 <code>_config.yml</code>  配置</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy</span>:</span><br><span class="line">  <span class="attr">type</span>: git</span><br><span class="line">  <span class="attr">repo</span>: <span class="attr">https</span>:<span class="comment">//github.com/SummerOrange/SummerOrange.github.io</span></span><br><span class="line">  <span class="attr">branch</span>: master</span><br></pre></td></tr></table></figure>

<ul>
<li>部署命令</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br><span class="line"></span><br><span class="line"># 简写</span><br><span class="line">$ hexo d</span><br></pre></td></tr></table></figure>

<p>部署完成后，使用仓库名<code>https://summerorange.github.io/</code>即可访问blog。</p>
<h3 id="3-3-如果部署后未修改，可以在github的Actions中查看自动build-run-的情况。"><a href="#3-3-如果部署后未修改，可以在github的Actions中查看自动build-run-的情况。" class="headerlink" title="3.3 如果部署后未修改，可以在github的Actions中查看自动build , run 的情况。"></a>3.3 如果部署后未修改，可以在github的Actions中查看自动build , run 的情况。</h3><p><img src="/301-hexo%E6%90%AD%E5%BB%BA/1651854012322-e6c0a9e2-5036-4d65-b9e5-f717d5cd8ca2-20220820211106443.png" alt="img"></p>
<h3 id="3-4-部署报错"><a href="#3-4-部署报错" class="headerlink" title="3.4 部署报错"></a>3.4 部署报错</h3><p>若 <code>hexo d</code>后报类似错：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fatal</span>: unable to access <span class="string">&#x27;https://.../&#x27;</span>: <span class="title class_">Encountered</span> end <span class="keyword">of</span> file</span><br><span class="line"><span class="variable constant_">FATAL</span> &#123;</span><br><span class="line">  <span class="attr">err</span>: <span class="title class_">Error</span>: <span class="title class_">Spawn</span> failed</span><br><span class="line">      at <span class="title class_">ChildProcess</span>.&lt;anonymous&gt; (<span class="regexp">/.../</span>lib/spawn.<span class="property">js</span>:<span class="number">51</span>:<span class="number">21</span>)</span><br><span class="line">      at <span class="title class_">ChildProcess</span>.<span class="property">emit</span> (events.<span class="property">js</span>:<span class="number">376</span>:<span class="number">20</span>)</span><br><span class="line">      at <span class="title class_">Process</span>.<span class="property">ChildProcess</span>.<span class="property">_handle</span>.<span class="property">onexit</span> (internal/child_process.<span class="property">js</span>:<span class="number">277</span>:<span class="number">12</span>) &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="number">128</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>解决方案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 在项目的根目录下操作如下：</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf .deploy_git/</span><br><span class="line"></span><br><span class="line">git config --global core.autocrlf <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br></pre></td></tr></table></figure>

<h2 id="4-导入有图片的-md已有-blog-小技巧"><a href="#4-导入有图片的-md已有-blog-小技巧" class="headerlink" title="4. 导入有图片的.md已有 blog 小技巧"></a>4. 导入有图片的<code>.md</code>已有 blog 小技巧</h2><h3 id="借助-Typora"><a href="#借助-Typora" class="headerlink" title="借助 Typora"></a><strong>借助 Typora</strong></h3><p>如果已经在在线笔记类似工具中存有<code>.md</code>文章，如果有图片，一个个下载图改路径，是个苦力活。</p>
<p>可以借助 Typora，先在“偏好设置”中配置，图像 - 对网络位置的图片应用上述规则，配置如下：</p>
<p><img src="/301-hexo%E6%90%AD%E5%BB%BA/1652026396145-80fff01d-d2bf-442d-b579-feadc44bf230-20220820211106406.png" alt="img"></p>
<p>配置好后，通过hexo新建好空文档，在 Typora 中将文章直接ctrl + v ，然后将根目录下的图片资源移动到文章对应的文件夹下。</p>
<p>PS：因为hexo中，md 中写的图片路径直接就是图片名称，所以此处配置，不能写<code>./$&#123;filename&#125;</code></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-11-08</span><i class="fa fa-tag"></i><a class="tag" href="/tags/综合/" title="综合">综合 </a><span class="leancloud_visitors"></span><span>大约1148个字, 3分钟49秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/401-Promise/">Promise</a></h3></div><div class="post-content"><div class="card"><p><h2 id="1-Promise-对象"><a href="#1-Promise-对象" class="headerlink" title="1. Promise 对象"></a>1. Promise 对象</h2><p>ES6 规定，Promise对象是一个构造函数，用来生成Promise实例。</p>
<ul>
<li>Promise 构造函数接受 <strong>一个函数</strong> 作为参数。</li>
<li>该函数的两个参数分别是resolve和reject，它们是两个函数，由 JavaScript 引擎提供，不用自己部署。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">  <span class="comment">// ... some code</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* 异步操作成功 */</span>)&#123;</span><br><span class="line">    <span class="title function_">resolve</span>(value);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="1-1-Promise-对象实例结构"><a href="#1-1-Promise-对象实例结构" class="headerlink" title="1.1 Promise 对象实例结构"></a>1.1 Promise 对象实例结构</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">()=&gt;</span>&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/401-Promise/1660893766690-7a5ae28b-54c5-40a1-870f-058820822104-20220820215141535.png" alt="img"></p>
<ul>
<li>Promise 的内部属性有 <code>PromiseState``PromiseResult</code></li>
<li>实例 promise 的 <code>__proto__</code>指向 Promise 的原型对象，</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Promise.prototype == promise.__proto__` 为 `true</span><br></pre></td></tr></table></figure>

<ul>
<li>Promise 原型方法有： then、catch、finally</li>
<li>Promise 构造函数方法有：all、allSettled、any、race、resolve、reject。</li>
</ul>
<h3 id="1-2-状态"><a href="#1-2-状态" class="headerlink" title="1.2 状态"></a>1.2 状态</h3><ul>
<li><p>Promise对象代表一个异步操作，有三种状态：</p>
</li>
<li><ul>
<li>pending（进行中）</li>
<li>fulfilled（已成功）</li>
<li>rejected（已失败）</li>
</ul>
</li>
<li><p><strong>只有异步操作的结果，可以决定当前是哪一种状态</strong>，任何其他操作都无法改变这个状态。改变的情况只有：</p>
</li>
<li><ul>
<li>从pending变为fulfilled</li>
<li>从pending变为rejected</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">()=&gt;</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> promise2 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise2&#x27;</span>);</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> promise3 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Promise3&#x27;</span>);</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&#x27;err&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/401-Promise/1660892604893-7c3b163d-dc7a-467c-b84c-706353c537f9-20220820215141659.png" alt="img"></p>
<p><img src="/401-Promise/1660897204141-977c9093-639b-42c1-9d6b-185f3b5688ee-20220820215141707.png" alt="img"></p>
<h3 id="1-3-特点"><a href="#1-3-特点" class="headerlink" title="1.3 特点"></a>1.3 特点</h3><ul>
<li><p>Promise 是微任务。</p>
</li>
<li><p><strong>Promise 新建后就会立即执行。</strong></p>
</li>
<li><p>调用resolve或reject并不会终结 Promise 的参数函数的执行，即 <strong>resolve</strong><strong>(<strong><strong>‘success’</strong></strong>) 后的语句仍执行；</strong>但<code>return **resolve**(&#39;success&#39;) </code>加上 return 语句后，后面的语句就不执行了。</p>
</li>
<li><p>没有 <strong>resolve</strong> 或 reject ，promise.then 并不会执行。</p>
</li>
<li><p><code>console.**log**(&#39;1&#39;, new Promise(...)); </code> 先执行 new Promise 构造函数的代码，再执行 console.log。</p>
</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>无法取消Promise，一旦新建它就会立即执行，无法中途取消。</li>
<li>如果不设置回调函数，Promise内部抛出的错误，不会反应到外部。</li>
<li>当处于pending状态时，无法得知目前进展到哪一个阶段（刚刚开始还是即将完成）。</li>
</ul>
<h3 id="1-4-Promise-嵌套"><a href="#1-4-Promise-嵌套" class="headerlink" title="1.4 Promise 嵌套"></a>1.4 Promise 嵌套</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;p1&#x27;</span>, p1)</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;fail&#x27;</span>)), <span class="number">3000</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p2 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;p2 a&#x27;</span>)</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(p1), <span class="number">1000</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;p2 b&#x27;</span>, p2)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">p2</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(result, <span class="string">&#x27;p2&#x27;</span>, p2, <span class="string">&#x27;p1&#x27;</span>, p1))</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(error, <span class="string">&#x27;p2&#x27;</span>, p2, <span class="string">&#x27;p1&#x27;</span>, p1))</span><br></pre></td></tr></table></figure>

<p><img src="/401-Promise/1660880665692-b28328a0-02da-4fd0-b738-cdc568df15c3-20220820215141694.png" alt="img"></p>
<p>上面代码中，p1和p2都是 Promise 的实例，但是p2的resolve方法将p1作为参数，即一个异步操作的结果是返回另一个异步操作。</p>
<p>注意，这时p1的状态就会传递给p2，也就是说<strong>，<strong><strong>p1</strong></strong>的状态决定了<strong><strong>p2</strong></strong>的状态</strong>。如果p1的状态是pending，那么p2的回调函数就会等待p1的状态改变<strong>；如果<strong><strong>p1</strong></strong>的状态已经是<strong><strong>resolved</strong></strong>或者<strong><strong>rejected</strong></strong>，那么<strong><strong>p2</strong></strong>的回调函数将会立刻执行。</strong></p>
<h2 id="2-原型方法"><a href="#2-原型方法" class="headerlink" title="2. 原型方法"></a>2. 原型方法</h2><h3 id="2-1-Promise-prototype-then-onFulfilled-onRejected"><a href="#2-1-Promise-prototype-then-onFulfilled-onRejected" class="headerlink" title="2.1 Promise.prototype.then(onFulfilled[, onRejected])"></a>2.1 <code>Promise.prototype.then(onFulfilled[, onRejected])</code></h3><p>onFulfilled : resolved状态的回调<strong>函数</strong></p>
<p>onRejected ：rejected状态的回调<strong>函数</strong></p>
<h4 id="链式调用"><a href="#链式调用" class="headerlink" title="链式调用"></a>链式调用</h4><p>then() 返回一个<strong>新的</strong> Promise 实例，这就是 Promise 可以链式调用的原因</p>
<h3 id="2-2-Promise-prototype-catch"><a href="#2-2-Promise-prototype-catch" class="headerlink" title="2.2 Promise.prototype.catch()"></a>2.2 Promise.prototype.catch()</h3><p>是.then(null, rejection)或.then(undefined, rejection)的别名，用于指定发生错误时的回调函数。</p>
<ul>
<li>若 .then(null, rejection) 指定和 .catch() 都存在，则执行先出现的。</li>
<li>如果将 .catch 放在 .then 前，要是then()方法里面报错，就与前面的catch()无关了。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promiseErr = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;test&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line">promiseErr.<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;&#125;, <span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;reject&#x27;</span>,err)</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;catch&#x27;</span>,error);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// reject Error: test</span></span><br><span class="line"></span><br><span class="line">promiseErr.<span class="title function_">catch</span>(<span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;catch&#x27;</span>,error);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;&#125;, <span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;reject&#x27;</span>,err)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// catch Error: test</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-Promise-prototype-finally"><a href="#2-3-Promise-prototype-finally" class="headerlink" title="2.3 Promise.prototype.finally()"></a>2.3 Promise.prototype.finally()</h3><ul>
<li>finally()方法用于指定不管 Promise 对象最后状态如何，都会执行的操作。该方法是 ES2018 引入标准的。</li>
<li>不依赖于 Promise 的执行结果。</li>
<li>写在前面就会先执行（仍是微任务）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promiseFin = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">promiseFin.<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;finally&#x27;</span>)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// finally </span></span><br><span class="line"><span class="comment">// success</span></span><br></pre></td></tr></table></figure>

<h2 id="3-构造函数方法"><a href="#3-构造函数方法" class="headerlink" title="3. 构造函数方法"></a>3. 构造函数方法</h2><h3 id="3-1-Promise-resolve"><a href="#3-1-Promise-resolve" class="headerlink" title="3.1 Promise.resolve()"></a>3.1 <code>Promise.resolve()</code></h3><p>将现有对象转为 Promise 对象，</p>
<p>**Promise.resolve(value)**方法返回一个以给定值解析后的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> 对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise1 = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">promise1.<span class="title function_">then</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">  <span class="comment">// expected output: 123</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Promise-reject"><a href="#3-2-Promise-reject" class="headerlink" title="3.2 Promise.reject()"></a>3.2 <code>Promise.reject()</code></h3><p>将现有对象转为 Promise 对象，</p>
<p><strong>Promise.reject()</strong> 方法返回一个带有拒绝原因的 Promise 对象。</p>
<h3 id="3-3-Promise-all-p1-p2-p3"><a href="#3-3-Promise-all-p1-p2-p3" class="headerlink" title="3.3**Promise.all([ p1, p2, p3, ...])**"></a>3.3<code>**Promise.all([ p1, p2, p3, ...])**</code></h3><p>【<strong>只要有 rejected，状态都变为 rejected</strong>】</p>
<p>Promise.all()方法用于将多个 Promise 实例，包装成一个新的 Promise 实例。<strong>只要有一个 rejected，状态都变为 rejected。</strong></p>
<ul>
<li><strong>只有<strong><strong>p1</strong></strong>、<strong><strong>p2</strong></strong>、<strong><strong>p3</strong></strong>的状态都变成<strong><strong>fulfilled</strong></strong>，<strong><strong>p</strong></strong>的状态才会变成****fulfilled</strong>，此时p1、p2、p3的返回值组成一个数组，传递给p的回调函数。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello p1&#x27;</span>);<span class="title function_">resolve</span>(<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> p2 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello p2&#x27;</span>);<span class="title function_">resolve</span>(<span class="string">&#x27;hellooo&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> p = <span class="title class_">Promise</span>.<span class="title function_">all</span>([p1,p2])</span><br></pre></td></tr></table></figure>

<p><img src="/401-Promise/1660922627729-ba17d6d2-6c89-4665-8d13-d3efb4096c4e-20220820215141624.png" alt="img"></p>
<ul>
<li>只要p1、p2、p3之中有<strong>一个被<strong><strong>rejected</strong></strong>，<strong><strong>p</strong></strong>的状态就变成****rejected</strong>，此时第一个被reject的实例的返回值，会传递给p的回调函数。</li>
</ul>
<p>Promise.all() 是所有请求都成功了，但是只要有一个请求失败，它就会报错，而不管另外的请求是否结束。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello p1&#x27;</span>);<span class="title function_">reject</span>(<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> p2 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello p2&#x27;</span>);<span class="title function_">resolve</span>(<span class="string">&#x27;hellooo&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> p = <span class="title class_">Promise</span>.<span class="title function_">all</span>([p1,p2])</span><br></pre></td></tr></table></figure>

<p><img src="/401-Promise/1660922685690-53c90451-c4db-4748-ae8b-8778185918fe-20220820215141687.png" alt="img"></p>
<h3 id="3-4-Promise-allSettled"><a href="#3-4-Promise-allSettled" class="headerlink" title="3.4 Promise.allSettled()"></a>3.4 <code>Promise.allSettled()</code></h3><p>【用来确定一组异步操作是否都结束了（不管成功或失败）】</p>
<p>同上的例子，用 Promise.all()  返回的状态是 reject；</p>
<p>用  Promise.allSettled()  返回的状态是 fulfilled；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello p1&#x27;</span>);<span class="title function_">reject</span>(<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> p2 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello p2&#x27;</span>);<span class="title function_">resolve</span>(<span class="string">&#x27;hellooo&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> p = <span class="title class_">Promise</span>.<span class="title function_">allSettled</span>([p1,p2])</span><br></pre></td></tr></table></figure>

<p><img src="/401-Promise/1660923528734-33457f9f-aaf7-4c48-96a9-9337b7306b89-20220820215141680.png" alt="img"></p>
<h3 id="3-5-Promise-race"><a href="#3-5-Promise-race" class="headerlink" title="3.5 Promise.race()"></a>3.5 <code>Promise.race()</code></h3><p>【取率先改变的状态】</p>
<p>Promise.race()方法同样是将多个 Promise 实例，包装成一个新的 Promise 实例。</p>
<p>只要p1、p2、p3之中有一个实例<strong>率先改变</strong>状态，p的状态就跟着改变。那个率先改变的 Promise 实例的返回值，就传递给p的回调函数。</p>
<h3 id="3-6-Promise-any"><a href="#3-6-Promise-any" class="headerlink" title="3.6 Promise.any() "></a>3.6 <code>Promise.any() </code></h3><p>【任意一个成功就算成功，全部失败才是失败】</p>
<p>只要参数实例有一个变成fulfilled状态，包装实例就会变成fulfilled状态；如果所有参数实例都变成rejected状态，包装实例就会变成rejected状态。</p>
<p>想要刷題可看这个：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904077537574919">https://juejin.cn/post/6844904077537574919</a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://es6.ruanyifeng.com/#docs/promise">https://es6.ruanyifeng.com/#docs/promise</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-10-20</span><i class="fa fa-tag"></i><a class="tag" href="/tags/ES6/" title="ES6">ES6 </a><span class="leancloud_visitors"></span><span>大约1676个字, 5分钟35秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/302-%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/">正向代理与反向代理</a></h3></div><div class="post-content"><div class="card"><p><p><img src="/302-%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/1658237934758-62135c80-5ead-42bf-aa8b-f86c770e6697.png" alt="img"></p>
<table>
<thead>
<tr>
<th></th>
<th><strong>正向代理</strong></th>
<th><strong>反向代理</strong></th>
</tr>
</thead>
<tbody><tr>
<td>代理目标</td>
<td><strong>“代理服务器”代理了”客户端”，去和”目标服务器”进行交互</strong></td>
<td><strong>“代理服务器”代理了”目标服务器”，去和”客户端”进行交互</strong></td>
</tr>
<tr>
<td>访问目标服务器时</td>
<td>目标服务器是不知道真正的客户端是谁的，甚至不知道访问自己的是一个代理</td>
<td>客户端是不知道真正的目标服务器是谁的，甚至不知道自己访问的是一个代理</td>
</tr>
<tr>
<td></td>
<td>代理服务器 帮助 客户端 请求页面并缓存，再返回给 客户端</td>
<td>代理服务器 将 目标服务器 请求结果缓存到本地，再返回给 客户端</td>
</tr>
<tr>
<td></td>
<td>客户端 使用 代理服务器的 IP 和端口去浏览器访问</td>
<td>服务端 使用 代理服务器的 IP 和端口给 客户端 使用</td>
</tr>
</tbody></table>
<h2 id="正向代理-（forward-proxy）"><a href="#正向代理-（forward-proxy）" class="headerlink" title="正向代理 （forward proxy）"></a>正向代理 （forward proxy）</h2><p>为了从 <code>目标服务器</code> 获取内容，<code>客户端</code> 向 <code>代理服务器</code> 发送一个请求并指定目标，然后 <code>代理服务器</code> 向 <code>目标服务器</code> 转发请求，并将获得的内容返回给 <code>客户端</code>。</p>
<h3 id="常见场景："><a href="#常见场景：" class="headerlink" title="常见场景："></a>常见场景：</h3><ul>
<li>访问 国外技术 网站</li>
<li>早些年，没有使用 node 时的前后端分离，常用 Tomcat, IIS 作为 Web 服务器，这种方式就是 正向代理。</li>
</ul>
<h3 id="正向代理的用途"><a href="#正向代理的用途" class="headerlink" title="正向代理的用途"></a><strong>正向代理的用途</strong></h3><ul>
<li><strong>突破访问限制</strong></li>
</ul>
<p>通过代理服务器，可以突破自身 IP 访问限制，访问国外网站，教育网等。</p>
<ul>
<li><strong>提高访问速度</strong></li>
</ul>
<p>通常代理服务器都设置一个较大的硬盘缓冲区，会将部分请求的响应保存到<strong>缓冲区</strong>中，当其他用户再访问相同的信息时， 则直接由缓冲区中取出信息，传给用户，以提高访问速度。</p>
<ul>
<li><strong>隐藏客户端真实 IP</strong></li>
</ul>
<p>上网者也可以通过这种方法隐藏自己的IP，免受攻击。</p>
<h2 id="2-反向代理（reverse-proxy）"><a href="#2-反向代理（reverse-proxy）" class="headerlink" title="2. 反向代理（reverse proxy）"></a>2. 反向代理（reverse proxy）</h2><p>用 <code>代理服务器</code> 接收 <code>客户端</code> 的连接请求，将请求转发给 <code>目标服务器</code>，然后将 <code>目标服务器</code> 返回的结果，再返回给 <code>客户端</code>。 </p>
<h3 id="常见场景：-1"><a href="#常见场景：-1" class="headerlink" title="常见场景："></a>常见场景：</h3><ul>
<li><p>负载均衡（Nginx）：客户端发送请求到负载均衡服务器上，负载均衡服务器再把请求转发给其中一台服务器来执行，再把执行结果返回给客户端。</p>
</li>
<li><p>前端 Node 服务。</p>
</li>
<li><ul>
<li><strong>为什么 Node.js 要用 反向代理？</strong> （<a target="_blank" rel="noopener" href="https://www.yisu.com/zixun/489265.html%EF%BC%89">https://www.yisu.com/zixun/489265.html）</a></li>
</ul>
</li>
<li><ul>
<li><ul>
<li>Node.js 是高可塑性的。它可以从文件系统架设静态资源服务、对 HTTP 响应执行 gzip 压缩、内建支持  HTTPS，另有很多其它特性。它甚至有能力通过 cluster 模块，运行一个应用的多个实例并分发其自身的请求。然而，基本上让一个反向代理来处理这些操作，而不是靠 Node.js 应用去做。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="反向代理的用途"><a href="#反向代理的用途" class="headerlink" title="反向代理的用途"></a><strong>反向代理的用途</strong></h3><ul>
<li><strong>隐藏服务器真实 IP</strong></li>
</ul>
<p>使用反向代理，可以对客户端隐藏服务器的IP地址。</p>
<ul>
<li><strong>负载均衡</strong></li>
</ul>
<p>反向代理服务器可以做负载均衡，根据所有真实服务器的负载情况，将客户端请求分发到不同的真实服务器上。</p>
<ul>
<li><strong>提高访问速度</strong></li>
</ul>
<p>反向代理服务器可以对于静态内容及短时间内有大量访问请求的动态内容<strong>提供缓存服务</strong>，提高访问速度。</p>
<p>即，二房东同样有房屋信息和钥匙。</p>
<ul>
<li><strong>提供安全保障</strong></li>
</ul>
<p>反向代理服务器可以作为应用层防火墙，为网站提供对基于Web的攻击行为（例如DoS&#x2F;DDoS）的防护，更容易排查恶意软件等。还可以为后端服务器统一提供加密和SSL加速（如SSL终端代理），提供HTTP访问认证等。</p>
<h2 id="3-区别："><a href="#3-区别：" class="headerlink" title="3. 区别："></a>3. 区别：</h2><p>虽然正向代理服务器和反向代理服务器所处的位置都是客户端和真实服务器之间，所做的事情也都是把客户端的请求转发给服务器，再把服务器的响应转发给客户端，但是二者之间还是有一定的差异的。</p>
<p>1、<strong>正向代理其实是客户端的代理</strong>，帮助客户端访问其无法访问的服务器资源。<strong>反向代理则是服务器的代理</strong>，帮助服务器做负载均衡，安全防护等。</p>
<p>2、<strong>正向代理一般是客户端架设的</strong>，比如在自己的机器上安装一个代理软件。而<strong>反向代理一般是服务器架设的</strong>，比如在自己的机器集群中部署一个反向代理服务器。</p>
<p>3、<strong>正向代理中，服务器不知道真正的客户端到底是谁</strong>，以为访问自己的就是真实的客户端。而在<strong>反向代理中，客户端不知道真正的服务器是谁</strong>，以为自己访问的就是真实的服务器。</p>
<p>4、正向代理和反向代理的作用和目的不同。<strong>正向代理主要是用来解决访问限制问题。而反向代理则是提供负载均衡、安全防护等作用。二者均能提高访问速度。</strong></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1418457">https://cloud.tencent.com/developer/article/1418457</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-10-09</span><i class="fa fa-tag"></i><a class="tag" href="/tags/综合/" title="综合">综合 </a><span class="leancloud_visitors"></span><span>大约1440个字, 4分钟48秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/02-%E9%98%B2%E6%8A%96%E8%8A%82%E6%B5%81/">防抖节流</a></h3></div><div class="post-content"><div class="card"><p><h2 id="1-防抖："><a href="#1-防抖：" class="headerlink" title="1. 防抖："></a>1. 防抖：</h2><h3 id="1-1-防抖"><a href="#1-1-防抖" class="headerlink" title="1.1 防抖"></a>1.1 防抖</h3><p>在一定时间n秒内，多次重复触发（重复触发时重新计时），只在最后一次触发后n秒执行一次。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 防抖</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">fn, delay</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> timer</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...args1</span>) &#123;</span><br><span class="line">      <span class="built_in">clearTimeout</span>(timer)</span><br><span class="line">      timer = <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args1)</span><br><span class="line">      &#125;, delay)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="应用场景："><a href="#应用场景：" class="headerlink" title="应用场景："></a>应用场景：</h4><ul>
<li>键盘输入input框监听，搜索内容时在最后发送一次请求</li>
<li>手机号、邮箱验证输入时</li>
<li>窗口大小resize。只需窗口调整完成后，计算窗口大小。防止重复渲染。</li>
</ul>
<h3 id="1-2-防抖（立即执行）"><a href="#1-2-防抖（立即执行）" class="headerlink" title="1.2 防抖（立即执行）"></a>1.2 防抖（立即执行）</h3><p>在一定时间n秒内，多次重复触发（重复触发时重新计时），只在第一次触发后n秒执行一次。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 防抖（立即执行）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">debounce2</span>(<span class="params">fn, delay</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> timer = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// let flag = false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">        <span class="comment">// if (!flag) &#123;  //直接用timer是否为空判断，更简洁</span></span><br><span class="line">        <span class="keyword">if</span> (!timer) &#123;</span><br><span class="line">            fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (timer) <span class="built_in">clearTimeout</span>(timer)</span><br><span class="line">        timer = <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            timer = <span class="literal">null</span></span><br><span class="line">        &#125;, delay)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="应用场景：-1"><a href="#应用场景：-1" class="headerlink" title="应用场景："></a>应用场景：</h4><ul>
<li>表单提交按钮的触发</li>
</ul>
<h2 id="2-节流："><a href="#2-节流：" class="headerlink" title="2. 节流："></a>2. 节流：</h2><p> 在 n  秒内只运行一次，若在 n 秒内重复触发，只有延迟时间到后那一次生效。</p>
<h3 id="2-1-节流（定时器）"><a href="#2-1-节流（定时器）" class="headerlink" title="2.1 节流（定时器）"></a>2.1 节流（定时器）</h3><p>触发 n 秒后，执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 节流（定时器）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">throttled</span>(<span class="params">fn, delay</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> timer = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!timer) &#123;</span><br><span class="line">            timer = <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">                fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">                <span class="built_in">clearTimeout</span>(timer)</span><br><span class="line">                timer = <span class="literal">null</span></span><br><span class="line">            &#125;, delay)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-节流（时间戳）"><a href="#2-2-节流（时间戳）" class="headerlink" title="2.2 节流（时间戳）"></a>2.2 节流（时间戳）</h3><p>停止触发时，若时间间隔不够，则无法执行函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 节流（时间戳）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">throttled2</span>(<span class="params">fn, delay</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">        <span class="keyword">if</span> (now - last &gt;= delay) &#123;</span><br><span class="line">            fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">            last = now</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="应用场景：-2"><a href="#应用场景：-2" class="headerlink" title="应用场景："></a>应用场景：</h4><ul>
<li>提交等接口，防止重复调用多次</li>
<li>监听滚动事件，比如是否滑到底部自动加载更多，用throttle来判断。</li>
</ul>
<h2 id="3-区别"><a href="#3-区别" class="headerlink" title="3. 区别"></a>3. 区别</h2><ul>
<li>防抖是重复触发时，不断清除定时器，重置初始时间，直到n秒内不再触发再执行一次</li>
<li>节流是重复触发时，挂起&#x2F;不调用函数，以此方式阻止重复执行</li>
<li>函数防抖关注一定时间连续触发的事件，只在最后执行一次；而函数节流关注一段时间内只执行一次</li>
</ul>
<h2 id="4-附-完整测试代码"><a href="#4-附-完整测试代码" class="headerlink" title="4. 附 - 完整测试代码"></a>4. 附 - 完整测试代码</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    防抖：    &lt;input id=&quot;debounce&quot; &gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    防抖（立即执行）：    &lt;input id=&quot;debounce2&quot; &gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    节流（定时器）：    &lt;input id=&quot;throttled&quot; &gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    节流（时间戳）：    &lt;input id=&quot;throttled2&quot; &gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    function ajax() &#123;</span><br><span class="line">        let v = arguments[0]</span><br><span class="line">        let label = arguments[1]</span><br><span class="line">        console.log(label + &#x27;：&#x27; + v)</span><br><span class="line">    &#125;</span><br><span class="line">    // 封装节流防抖后的ajax</span><br><span class="line">    function packingAjax(type) &#123;</span><br><span class="line">        switch (type) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                return debounce(ajax, 1000) // 不可写成 ajax(),会立即执行ajax方法，便会失去延迟效果</span><br><span class="line">                break</span><br><span class="line">            case 1:</span><br><span class="line">                // throttled(ajax(v, txt), 1000)</span><br><span class="line">                return throttled(ajax, 3000)</span><br><span class="line">                break</span><br><span class="line">            case 2:</span><br><span class="line">                return debounce2(ajax, 1000)</span><br><span class="line">                break</span><br><span class="line">            case 3:</span><br><span class="line">                return throttled2(ajax, 3000)</span><br><span class="line">                break</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 防抖</span><br><span class="line">    function debounce(fn, delay) &#123;</span><br><span class="line">        let timer</span><br><span class="line">        return function (...args1) &#123;</span><br><span class="line">            clearTimeout(timer)</span><br><span class="line">            timer = setTimeout(()=&gt;&#123;</span><br><span class="line">                fn.apply(this, args1)</span><br><span class="line">            &#125;, delay)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    let d = document.getElementById(&#x27;debounce&#x27;)</span><br><span class="line">    let packing = packingAjax(0)</span><br><span class="line">    // 注意！！！</span><br><span class="line">    // 必须放外层，若放在监听中，则每次都会调用 debounce(ajax, 1000) 一次，便每次都要初始化timer，失去回调意义</span><br><span class="line">    d.addEventListener(&quot;keyup&quot;, function (e) &#123;</span><br><span class="line">        packing(e.target.value, &#x27;防抖&#x27;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 防抖（立即执行）</span><br><span class="line">    function debounce2(fn, delay) &#123;</span><br><span class="line">        let timer = null</span><br><span class="line">        // let flag = false</span><br><span class="line">        return function (...args) &#123;</span><br><span class="line">            // if (!flag) &#123;  //直接用timer是否为空判断，更简洁</span><br><span class="line">            if (!timer) &#123;</span><br><span class="line">                fn.apply(this, args)</span><br><span class="line">            &#125;</span><br><span class="line">            if (timer) clearTimeout(timer)</span><br><span class="line">            timer = setTimeout(()=&gt;&#123;</span><br><span class="line">                timer = null</span><br><span class="line">            &#125;, delay)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    let d2 = document.getElementById(&#x27;debounce2&#x27;)</span><br><span class="line">    let packing2 = packingAjax(2)</span><br><span class="line">    d2.addEventListener(&quot;keyup&quot;, function (e) &#123;</span><br><span class="line">        packing2(e.target.value, &#x27;防抖（立即执行）&#x27;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 节流（定时器）</span><br><span class="line">    function throttled(fn, delay) &#123;</span><br><span class="line">        let timer = null</span><br><span class="line">        return function (...args) &#123;</span><br><span class="line">            if (!timer) &#123;</span><br><span class="line">                timer = setTimeout(()=&gt;&#123;</span><br><span class="line">                    fn.apply(this, args)</span><br><span class="line">                    clearTimeout(timer)</span><br><span class="line">                    timer = null</span><br><span class="line">                &#125;, delay)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    let t = document.getElementById(&#x27;throttled&#x27;)</span><br><span class="line">    let packing1 = packingAjax(1)</span><br><span class="line">    t.addEventListener(&quot;keyup&quot;, function (e) &#123;</span><br><span class="line">        packing1(e.target.value, &#x27;节流（定时器）&#x27;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 节流（时间戳）</span><br><span class="line">    function throttled2(fn, delay) &#123;</span><br><span class="line">        let last = 0</span><br><span class="line">        return function (...args) &#123;</span><br><span class="line">            let now = new Date()</span><br><span class="line">            if (now - last &gt;= delay) &#123;</span><br><span class="line">                fn.apply(this, args)</span><br><span class="line">                last = now</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    let t2 = document.getElementById(&#x27;throttled2&#x27;)</span><br><span class="line">    let packing3 = packingAjax(3)</span><br><span class="line">    t2.addEventListener(&quot;keyup&quot;, function (e) &#123;</span><br><span class="line">        packing3(e.target.value, &#x27;节流（时间戳）&#x27;)</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-09-21</span><i class="fa fa-tag"></i><a class="tag" href="/tags/JavaScript/" title="JavaScript">JavaScript </a><span class="leancloud_visitors"></span><span>大约1065个字, 3分钟33秒读完</span></div></div></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/">上一页</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/page/3/">下一页</a></li></ul></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(无标题)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="想要查找什么..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>