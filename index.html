<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="chengshuomin"><title>学习笔记</title><meta name="description" content="chengshuomin blog"><meta name="keywords" content="Blog,博客,chengshuomin"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon1.svg"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.1.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a class="current" href="/">首页</a></li><li> <a href="/archives">归档</a></li><li> <a href="/tags">标签</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)" style="display:none;"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/logo.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/title.svg" style="width:200px;" alt="favicon"><h3 title=""><a href="/">学习笔记</a></h3><div class="description"><p>chengshuomin blog</p></div></div><ul class="social-links"></ul></div></div><div class="footer"><div class="p"><span> 全站 CC-BY-SA-3.0</span><i class="fa fa-star"></i><span> chengshuomin</span></div><div class="by_farbox"><span>Powered by</span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo</a><span> &</span><span>Anatolo</span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/601-%E5%A0%86/">堆</a></h3></div><div class="post-content"><div class="card"><p><h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number[]</span>&#125; <span class="variable">nums</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; <span class="variable">k</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">number</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">class</span> <span class="title class_">MinHeap</span> &#123;</span><br><span class="line">    <span class="comment">// 用数组存储堆元素</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">heap</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取下标为i的父节点下标</span></span><br><span class="line">    <span class="title function_">getParentIndex</span>(<span class="params">i</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (i - <span class="number">1</span>) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获得下标为i的左节点下标</span></span><br><span class="line">    <span class="title function_">getleftIndex</span>(<span class="params">i</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * i + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获得下标为i的右节点下标</span></span><br><span class="line">    <span class="title function_">getrightIndex</span>(<span class="params">i</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * i + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 交换节点位置</span></span><br><span class="line">    <span class="title function_">swap</span>(<span class="params">i1, i2</span>) &#123;</span><br><span class="line">        [<span class="variable language_">this</span>.<span class="property">heap</span>[i1], <span class="variable language_">this</span>.<span class="property">heap</span>[i2]] = [<span class="variable language_">this</span>.<span class="property">heap</span>[i2], <span class="variable language_">this</span>.<span class="property">heap</span>[i1]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 上移（上浮）- 【递归写法】</span></span><br><span class="line">    <span class="title function_">shiftUp2</span>(<span class="params">index</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (index === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> parentIndex = <span class="variable language_">this</span>.<span class="title function_">getParentIndex</span>(index);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">heap</span>[parentIndex] &gt; <span class="variable language_">this</span>.<span class="property">heap</span>[index]) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">swap</span>(parentIndex, index);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">shiftUp</span>(parentIndex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 下移（下沉）- 【递归写法】</span></span><br><span class="line">    <span class="title function_">shiftDown2</span>(<span class="params">index</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> leftIndex = <span class="variable language_">this</span>.<span class="title function_">getleftIndex</span>(index);</span><br><span class="line">        <span class="keyword">const</span> rightIndex = <span class="variable language_">this</span>.<span class="title function_">getrightIndex</span>(index);</span><br><span class="line">        <span class="keyword">let</span> max = index</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">heap</span>[leftIndex] &lt; <span class="variable language_">this</span>.<span class="property">heap</span>[index]) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">swap</span>(leftIndex, index);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">shiftDown</span>(leftIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">heap</span>[rightIndex] &lt; <span class="variable language_">this</span>.<span class="property">heap</span>[index]) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">swap</span>(rightIndex, index);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">shiftDown</span>(rightIndex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入</span></span><br><span class="line">    <span class="title function_">insert</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="comment">// 堆尾插入新值</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">heap</span>.<span class="title function_">push</span>(value);</span><br><span class="line">        <span class="comment">// 堆自底而上，重新排序</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">shiftUp</span>(<span class="variable language_">this</span>.<span class="property">heap</span>.<span class="property">length</span> - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 删除堆顶</span></span><br><span class="line">    <span class="title function_">shift</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 将最后一个叶子节点（即数组最后一个元素）移到堆顶（即：删除堆顶）</span></span><br><span class="line">        <span class="comment">// pop()方法删除数组最后一个元素并返回该元素的值，将此值赋值给堆顶</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">heap</span>[<span class="number">0</span>] = <span class="variable language_">this</span>.<span class="property">heap</span>.<span class="title function_">pop</span>();</span><br><span class="line">        <span class="comment">// 堆自顶而下，重新排序</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">shiftDown</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取堆顶</span></span><br><span class="line">    <span class="title function_">peek</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">heap</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取堆长度</span></span><br><span class="line">    <span class="title function_">size</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">heap</span>.<span class="property">length</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 打印堆内容</span></span><br><span class="line">    <span class="title function_">print</span>(<span class="params">name = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(name, <span class="variable language_">this</span>.<span class="property">heap</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> findKthLargest = <span class="keyword">function</span>(<span class="params">nums, k</span>) &#123;</span><br><span class="line">    <span class="comment">// 一、建堆</span></span><br><span class="line">    <span class="keyword">const</span> heap = <span class="keyword">new</span> <span class="title class_">MinHeap</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> num <span class="keyword">of</span> nums) &#123;</span><br><span class="line">        <span class="comment">// 二、调整堆内顺序</span></span><br><span class="line">        <span class="comment">// 将数组元素依次插入堆中</span></span><br><span class="line">        heap.<span class="title function_">insert</span>(num);</span><br><span class="line">        <span class="comment">// 三、删除</span></span><br><span class="line">        <span class="comment">// 如果堆大小超过k， 开始裁员， 将堆顶(最小) 的去掉</span></span><br><span class="line">        <span class="keyword">if</span> (heap.<span class="title function_">size</span>() &gt; k) heap.<span class="title function_">shift</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回堆顶，即第k大元素</span></span><br><span class="line">    <span class="keyword">return</span> heap.<span class="title function_">peek</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>





<p>循环嵌套递归，易导致内存溢出。</p>
<h4 id="易错点记录："><a href="#易错点记录：" class="headerlink" title="易错点记录："></a>易错点记录：</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误写法</span></span><br><span class="line"><span class="title function_">shiftDown</span>(<span class="params">index</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> leftIndex = <span class="variable language_">this</span>.<span class="title function_">getleftIndex</span>(index);</span><br><span class="line">        <span class="keyword">const</span> rightIndex = <span class="variable language_">this</span>.<span class="title function_">getrightIndex</span>(index);</span><br><span class="line">        <span class="comment">// 这种写法，在满足一个if后，再看是否满足第二个if，</span></span><br><span class="line">        <span class="comment">// 若两个都满足，则第二个会把第一个本应递归的下标覆盖掉，就会出现两者只递归一次的情况</span></span><br><span class="line">        <span class="keyword">let</span> i = index</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">heap</span>, index, i)</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">heap</span>[leftIndex] &lt; <span class="variable language_">this</span>.<span class="property">heap</span>[index]) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;left&#x27;</span>, leftIndex, index)</span><br><span class="line">            i = leftIndex</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">heap</span>[rightIndex] &lt; <span class="variable language_">this</span>.<span class="property">heap</span>[index]) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;right&#x27;</span>, rightIndex, index)</span><br><span class="line">            i = rightIndex</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;i&#x27;</span>, i, index)</span><br><span class="line">        <span class="keyword">if</span> (i != index) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">swap</span>(i, index);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">shiftDown</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确写法</span></span><br><span class="line"><span class="comment">// 下移（下沉）</span></span><br><span class="line">    <span class="title function_">shiftDown</span>(<span class="params">index</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> leftIndex = <span class="variable language_">this</span>.<span class="title function_">getleftIndex</span>(index);</span><br><span class="line">        <span class="keyword">const</span> rightIndex = <span class="variable language_">this</span>.<span class="title function_">getrightIndex</span>(index);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">heap</span>, index)</span><br><span class="line">        <span class="comment">// 这种写法，在满足一个if后就会递归，满足第二个if，就再次递归</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">heap</span>[leftIndex] &lt; <span class="variable language_">this</span>.<span class="property">heap</span>[index]) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;left&#x27;</span>, leftIndex, index)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">swap</span>(leftIndex, index);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">shiftDown</span>(leftIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">heap</span>[rightIndex] &lt; <span class="variable language_">this</span>.<span class="property">heap</span>[index]) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;right&#x27;</span>, rightIndex, index)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">swap</span>(rightIndex, index);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">shiftDown</span>(rightIndex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误写法</span></span><br><span class="line"><span class="comment">// eg： nums = [3,2,3,1,2,4,5,5,6] </span></span><br><span class="line"><span class="comment">// 排序后为：[2, 1, 3, 3, 2, 4, 5, 5, 6 ]</span></span><br><span class="line">    <span class="title function_">shiftUp</span>(<span class="params">index</span>) &#123;</span><br><span class="line">        <span class="comment">// if (index === 0) return</span></span><br><span class="line">        <span class="keyword">const</span> parentIndex = <span class="variable language_">this</span>.<span class="title function_">getParent</span>(index)</span><br><span class="line">        <span class="comment">// 最小堆堆化</span></span><br><span class="line">        <span class="comment">// 此写法，while循环会漏掉， parentIndex 动态变化的那部分可以循环的内容</span></span><br><span class="line">        <span class="comment">// 因为  parentIndex 已经将 动态变化的 index 的值给固定了</span></span><br><span class="line">        <span class="keyword">while</span> (index &gt; <span class="number">0</span> &amp;&amp;  <span class="variable language_">this</span>.<span class="property">heap</span>[parentIndex] &gt; <span class="variable language_">this</span>.<span class="property">heap</span>[index]) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;...&gt;&#x27;</span>)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">swap</span>(parentIndex, index)</span><br><span class="line">            index = parentIndex <span class="comment">// 往上接着查</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确写法：</span></span><br><span class="line">    <span class="title function_">shiftUp</span>(<span class="params">index</span>) &#123;</span><br><span class="line">        <span class="comment">// 最小堆堆化</span></span><br><span class="line">        <span class="keyword">while</span> (index &gt; <span class="number">0</span> &amp;&amp;  <span class="variable language_">this</span>.<span class="property">heap</span>[<span class="variable language_">this</span>.<span class="title function_">getParent</span>(index)] &gt; <span class="variable language_">this</span>.<span class="property">heap</span>[index]) &#123;</span><br><span class="line">            <span class="keyword">let</span> parentIndex = <span class="variable language_">this</span>.<span class="title function_">getParent</span>(index)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">swap</span>(parentIndex, index)</span><br><span class="line">            index = parentIndex <span class="comment">// 往上接着查</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<p><strong>TODO：</strong></p>
<p><strong>概念文字待更新</strong></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2025-01-10</span><i class="fa fa-tag"></i><a class="tag" href="/tags/算法与数据结构/" title="算法与数据结构">算法与数据结构 </a><span class="leancloud_visitors"></span><span>大约835个字, 2分钟47秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/402-async%E5%87%BD%E6%95%B0/">async函数</a></h3></div><div class="post-content"><div class="card"><p><h3 id="1-是什么？"><a href="#1-是什么？" class="headerlink" title="1. 是什么？"></a>1. 是什么？</h3><p><strong>async function</strong> 声明创建一个绑定到给定名称的新异步函数。函数体内允许使用 await 关键字，这使得我们可以更简洁地编写基于 promise 的异步代码，并且避免了显式地配置 promise 链的需要。</p>
<p>ES2017 标准引入了 async 函数，使得<strong>异步操作</strong>变得更加方便。</p>
<p>async 函数是什么？一句话，它就是 Generator 函数的语法糖。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async 写法</span></span><br><span class="line"><span class="keyword">const</span> asyncReadFile = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> f1 = <span class="keyword">await</span> <span class="title function_">readFile</span>(<span class="string">&#x27;/etc/abc&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> f2 = <span class="keyword">await</span> <span class="title function_">readFile</span>(<span class="string">&#x27;/etc/def&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="1-1-和-Generator-函数-对比"><a href="#1-1-和-Generator-函数-对比" class="headerlink" title="1.1. 和 Generator 函数 对比"></a>1.1. 和 Generator 函数 对比</h4><ul>
<li>async函数就是将 Generator 函数的星号（*）替换成async，将yield替换成await</li>
<li>Generator 函数的执行必须靠执行器，而async函数自带执行器。即 async函数的执行，与普通函数一样。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generator 写法</span></span><br><span class="line"><span class="keyword">const</span> gen = <span class="keyword">function</span>* () &#123;</span><br><span class="line">  <span class="keyword">const</span> f1 = <span class="keyword">yield</span> <span class="title function_">readFile</span>(<span class="string">&#x27;/etc/abc&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> f2 = <span class="keyword">yield</span> <span class="title function_">readFile</span>(<span class="string">&#x27;/etc/def&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-和-Promise-调用-对比"><a href="#1-2-和-Promise-调用-对比" class="headerlink" title="1.2. 和 Promise 调用 对比"></a>1.2. 和 Promise 调用 对比</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise 写法</span></span><br><span class="line"><span class="keyword">const</span> promiseReadFile = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="title function_">readFile</span>(<span class="string">&#x27;/etc/abc&#x27;</span>);</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="literal">true</span>)</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">v</span>=&gt;</span><span class="variable language_">console</span>.<span class="title function_">log</span>(v))</span><br><span class="line">  <span class="keyword">let</span> p2 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="title function_">readFile</span>(<span class="string">&#x27;/etc/def&#x27;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2-基本用法"><a href="#2-基本用法" class="headerlink" title="2. 基本用法"></a>2. 基本用法</h3><h4 id="2-1-async"><a href="#2-1-async" class="headerlink" title="2.1. async"></a>2.1. <code>async</code></h4><ul>
<li><code>async</code>声明的函数<strong>返回的是</strong><code>**Promise**</code><strong>对象</strong>，可<strong>用</strong><code>**then**</code><strong>方法添加回调函数</strong>。</li>
<li><strong>只有</strong><code>async</code><strong>函数内部的异步操作执行完，才会执行</strong><code>**then**</code><strong>方法指定的回调函数。</strong></li>
<li><code>**async**</code>函数内部<code>return</code>语句<strong>返回</strong>的<strong>值</strong>，会成为<code>**then**</code>方法<strong>回调</strong>函数的<strong>参数</strong>，若没有<code>return</code>的值，则参数为<code>undefined</code>。</li>
</ul>
<h4 id="2-2-await"><a href="#2-2-await" class="headerlink" title="2.2. await"></a>2.2. <code>await</code></h4><ul>
<li><p><code>await</code>必须在<code>async</code>声明的函数内使用。</p>
</li>
<li><p><code>**await**</code><strong>命令后面必须是</strong> <code>**Promise**</code> <strong>对象</strong>，然后返回该对象的结果。</p>
</li>
<li><ul>
<li><code>await</code>后面是 <code>Promise</code> 对象本身；</li>
<li><code>await</code>后面是原始类型的值（数值、字符串和布尔值，但这时会自动转成立即 <code>resolved</code> 的 <code>**Promise**</code> 对象）。然后直接返回对应的值。</li>
<li><code>await</code>后面是一个<code>thenable</code>对象（即定义了<code>**then**</code>方法的对象），<code>await</code>会将其视为<code>**Promise**</code>处理。</li>
</ul>
</li>
<li><p>当函数执行的时候，一旦遇到<code>await</code>就会先不往下执行，等 <code>await</code> 后的异步操作完成，再接着执行函数体内后面的语句。</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">timeout</span>(<span class="params">ms</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout...&#x27;</span>, ms)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout promise...&#x27;</span>, resolve)</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span><span class="title function_">resolve</span>(<span class="string">&#x27;t resolve&#x27;</span>), ms);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">asyncPrint</span>(<span class="params">value, ms</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line">  <span class="comment">// await命令后面的 Promise 对象，接收其resolve/reject 的参数</span></span><br><span class="line">  <span class="keyword">let</span> p = <span class="keyword">await</span> <span class="title function_">timeout</span>(ms);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>, p, value, ms);</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// async 函数返回一个Promise对象, eg:asy</span></span><br><span class="line"><span class="keyword">let</span> asy = <span class="title function_">asyncPrint</span>(<span class="string">&#x27;hello world&#x27;</span>, <span class="number">50</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;asy...&#x27;</span>, asy)</span><br><span class="line"></span><br><span class="line"><span class="comment">// then 接收回调结果，参数是 async 内 return 的返回值, eg:v</span></span><br><span class="line"><span class="comment">// 只有async函数内部的异步操作执行完，才会执行then方法指定的回调函数。</span></span><br><span class="line">asy.<span class="title function_">then</span>(<span class="function"><span class="params">v</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;then...&#x27;</span>,v));</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// timeout... 50</span></span><br><span class="line"><span class="comment">// timeout promise... ƒ () &#123; [native code] &#125;</span></span><br><span class="line"><span class="comment">// asy... Promise&#123;&#125;</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 &#x27;t return&#x27; &#x27;hello world&#x27; 50</span></span><br><span class="line"><span class="comment">// then... hello world</span></span><br></pre></td></tr></table></figure>

<h4 id="2-3-错误处理"><a href="#2-3-错误处理" class="headerlink" title="2.3. 错误处理"></a>2.3. 错误处理</h4><p>如果<code>await</code>后面的异步操作出错，那么等同于<code>async</code>函数返回的 <code>Promise</code>对象被<code>reject</code>。</p>
<p><strong>为了防止出错，将</strong><code>**await**</code><strong>操作放在</strong><code>**try...catch**</code><strong>代码块之中。</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> val1 = <span class="keyword">await</span> <span class="title function_">firstStep</span>();</span><br><span class="line">    <span class="keyword">const</span> val2 = <span class="keyword">await</span> <span class="title function_">secondStep</span>(val1);</span><br><span class="line">    <span class="keyword">const</span> val3 = <span class="keyword">await</span> <span class="title function_">thirdStep</span>(val1, val2);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Final: &#x27;</span>, val3);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-易错点"><a href="#3-易错点" class="headerlink" title="3. 易错点"></a>3. 易错点</h3><h4 id="3-1-await命令后面必须放Promise对象-或-原始数据类型值、thenable对象。"><a href="#3-1-await命令后面必须放Promise对象-或-原始数据类型值、thenable对象。" class="headerlink" title="3.1.  await命令后面必须放Promise对象 或 原始数据类型值、thenable对象。"></a>3.1.  <code>await</code>命令后面必须放<code>Promise</code>对象 或 原始数据类型值、<code>thenable</code>对象。</h4><h4 id="3-2-await命令后的Promise对象声明时需要有有完整的从-pending-变为-resolved-x2F-reject-的部分，否则-Promise-会一直处于-pending-状态。"><a href="#3-2-await命令后的Promise对象声明时需要有有完整的从-pending-变为-resolved-x2F-reject-的部分，否则-Promise-会一直处于-pending-状态。" class="headerlink" title="3.2. await命令后的Promise对象声明时需要有有完整的从 pending 变为 resolved&#x2F;reject 的部分，否则 Promise 会一直处于 pending 状态。"></a>3.2. <code>await</code>命令后的<code>Promise</code>对象声明时需要有有完整的从 pending 变为 resolved&#x2F;reject 的部分，否则 Promise 会一直处于 pending 状态。</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">timeoutPending</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout-Pending&#x27;</span>)</span><br><span class="line">  &#125;,<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">timeout</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">     <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout-Success&#x27;</span>)</span><br><span class="line">       <span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">     &#125;, <span class="number">10</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getFoo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 返回 fulfilled 状态</span></span><br><span class="line">  <span class="keyword">let</span> foo2 = <span class="keyword">await</span> <span class="title function_">timeout</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>, foo2);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 返回 pending 状态，不会往下执行</span></span><br><span class="line">  <span class="keyword">let</span> foo1 = <span class="keyword">await</span> <span class="title function_">timeoutPending</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>, foo1);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// timeout-Success</span></span><br><span class="line"><span class="comment">// 2 success</span></span><br><span class="line"><span class="comment">// timeout-Pending</span></span><br></pre></td></tr></table></figure>

<h4 id="3-3-多个请求串行与并行"><a href="#3-3-多个请求串行与并行" class="headerlink" title="3.3. 多个请求串行与并行"></a>3.3. 多个请求串行与并行</h4><h5 id="3-3-1-如下是串行与并行，两种写法的例子"><a href="#3-3-1-如下是串行与并行，两种写法的例子" class="headerlink" title="3.3.1. 如下是串行与并行，两种写法的例子"></a>3.3.1. 如下是串行与并行，两种写法的例子</h5><ul>
<li><strong>写法1：</strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getFoo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span><span class="title function_">res</span>(<span class="string">&#x27;getFoo&#x27;</span>),<span class="number">2000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getBar</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span><span class="title function_">res</span>(<span class="string">&#x27;getBar&#x27;</span>),<span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 串行</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>());</span><br><span class="line">  <span class="keyword">let</span> foo = <span class="keyword">await</span> <span class="title function_">getFoo</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), foo);</span><br><span class="line">  <span class="keyword">let</span> bar = <span class="keyword">await</span> <span class="title function_">getBar</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), bar);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getAll</span>()</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// 1 29</span></span><br><span class="line"><span class="comment">// Promise &#123;&lt;fulfilled&gt;&#125;</span></span><br><span class="line"><span class="comment">// 2 31 getFoo</span></span><br><span class="line"><span class="comment">// 3 32 getBar</span></span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getFoo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span><span class="title function_">res</span>(<span class="string">&#x27;getFoo&#x27;</span>),<span class="number">2000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getBar</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span><span class="title function_">res</span>(<span class="string">&#x27;getBar&#x27;</span>),<span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 并行</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>());</span><br><span class="line">  <span class="keyword">let</span> f = <span class="title function_">getFoo</span>();</span><br><span class="line">  <span class="keyword">let</span> b = <span class="title function_">getBar</span>()</span><br><span class="line">  <span class="keyword">let</span> foo = <span class="keyword">await</span> f;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), foo);</span><br><span class="line">  <span class="keyword">let</span> bar = <span class="keyword">await</span> b;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), bar);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getAll</span>()</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// 1 32</span></span><br><span class="line"><span class="comment">// Promise &#123;&lt;fulfilled&gt;&#125;</span></span><br><span class="line"><span class="comment">// 2 34 getFoo</span></span><br><span class="line"><span class="comment">// 3 34 getBar</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>写法2：</strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 串行</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> getFoo = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span><span class="title function_">res</span>(<span class="string">&#x27;getFoo&#x27;</span>),<span class="number">2000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>());</span><br><span class="line">  <span class="keyword">let</span> foo = <span class="keyword">await</span> getFoo;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), foo);</span><br><span class="line">  <span class="keyword">let</span> getBar = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span><span class="title function_">res</span>(<span class="string">&#x27;getBar&#x27;</span>),<span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">let</span> bar = <span class="keyword">await</span> getBar;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), bar);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getAll</span>()</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// 1 45</span></span><br><span class="line"><span class="comment">// Promise &#123;&lt;fulfilled&gt;&#125;</span></span><br><span class="line"><span class="comment">// 2 47 getFoo</span></span><br><span class="line"><span class="comment">// 3 48 getBar</span></span><br><span class="line"><span class="comment">// 并行</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>());</span><br><span class="line">  <span class="keyword">let</span> getFoo = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span><span class="title function_">res</span>(<span class="string">&#x27;getFoo&#x27;</span>),<span class="number">2000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">let</span> getBar = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span><span class="title function_">res</span>(<span class="string">&#x27;getBar&#x27;</span>),<span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">let</span> foo = <span class="keyword">await</span> getFoo;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), foo);</span><br><span class="line">  <span class="keyword">let</span> bar = <span class="keyword">await</span> getBar;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), bar);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getAll</span>()</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// 1 36</span></span><br><span class="line"><span class="comment">// Promise &#123;&lt;fulfilled&gt;&#125;</span></span><br><span class="line"><span class="comment">// 2 38 getFoo</span></span><br><span class="line"><span class="comment">// 3 38 getBar</span></span><br></pre></td></tr></table></figure>

<h5 id="3-3-2-分析"><a href="#3-3-2-分析" class="headerlink" title="3.3.2. 分析"></a>3.3.2. 分析</h5><ol>
<li>现象</li>
</ol>
<p>多个请求串行，是后一个等前一个执行成功后再去请求；多个请求并行，是所有请求一起去执行。</p>
<p>如上左侧是串行的例子，串行代码总执行时间需要3s，并行代码只需2s。</p>
<ol>
<li>原因分析</li>
</ol>
<p><strong>如上例子串行与并行请求代码的区别，通过调整代码顺序即可实现。</strong>可为什么呢？</p>
<p><strong>其原因是</strong> <code>**Promise**</code><strong>的运行机制，****Promise 新建（即：</strong> <code>**new Promise()**</code><strong>）后就会立即执行。</strong></p>
<p>如写法2：</p>
<ul>
<li><p>串行代码，在创建 <code>getFoo</code> 变量时，就开始执行了<code>new Promise()</code>内的代码了，遇到<code>await</code>后，等待pending状态改变为fulfilled&#x2F;reject 后，继续执行下面的语句，过程同前面；</p>
</li>
<li><p>而并行代码，一开始先创建<code>getFoo</code>、<code>getBar</code> 变量，就意味着将两个<code>new Promise()</code>内的代码的代码都执行了，再遇到<code>await</code>，等到pending状态改变为fulfilled&#x2F;reject 后，继续执行下一个<code>await</code>。</p>
</li>
<li><ul>
<li>如果第一个需要2s，第二个需要1s，则第一个await结果返回后，第二个结果也已经返回，则如例子所示，两个的时间是一样的；</li>
<li>如果如果第一个需要1s，第二个需要2s，则第一个await结果返回后，被第二个<code>await</code>拦住等待状态改变，改变后再继续往下执行。</li>
</ul>
</li>
</ul>
<p>附：串、并行的 Promise 写法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 并行</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>());</span><br><span class="line">  <span class="keyword">let</span> getFoo = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;<span class="title function_">res</span>(<span class="string">&#x27;getFoo&#x27;</span>);<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), getFoo);&#125;,<span class="number">2000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">let</span> getBar = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;<span class="title function_">res</span>(<span class="string">&#x27;getBar&#x27;</span>);<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), getBar)&#125;,<span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 串行</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>());</span><br><span class="line">  <span class="keyword">let</span> getFoo = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;<span class="title function_">res</span>(<span class="string">&#x27;getFoo&#x27;</span>);<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), getFoo);&#125;,<span class="number">2000</span>)</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">v</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">let</span> getBar = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;<span class="title function_">res</span>(<span class="string">&#x27;getBar&#x27;</span>);<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getSeconds</span>(), getBar)&#125;,<span class="number">1000</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-12-29</span><i class="fa fa-tag"></i><a class="tag" href="/tags/ES6/" title="ES6">ES6 </a><span class="leancloud_visitors"></span><span>大约1798个字, 5分钟59秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/305-window.performance/">window.performance</a></h3></div><div class="post-content"><div class="card"><p><img src="/305-window.performance/image (2).png" alt="image (1)" style="zoom:67%;">

<h2 id="2-window-performance-属性"><a href="#2-window-performance-属性" class="headerlink" title="2. window.performance 属性"></a>2. <code>window.performance</code> 属性</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// memory 是非标准属性，只在 Chrome 有</span></span><br><span class="line"><span class="attr">memory</span>: &#123;</span><br><span class="line">    <span class="attr">usedJSHeapSize</span>:  <span class="number">16100000</span>, <span class="comment">// JS 对象（包括V8引擎内部对象）占用的内存，一定小于 totalJSHeapSize</span></span><br><span class="line">    <span class="attr">totalJSHeapSize</span>: <span class="number">35100000</span>, <span class="comment">// 可使用的内存</span></span><br><span class="line">    <span class="attr">jsHeapSizeLimit</span>: <span class="number">793000000</span> <span class="comment">// 内存大小限制</span></span><br><span class="line">&#125;,</span><br><span class="line"> </span><br><span class="line"><span class="comment">//  哲学问题：我从哪里来？</span></span><br><span class="line"><span class="attr">navigation</span>: &#123;</span><br><span class="line">    <span class="attr">redirectCount</span>: <span class="number">0</span>, <span class="comment">// 如果有重定向的话，页面通过几次重定向跳转而来</span></span><br><span class="line">    <span class="attr">type</span>: <span class="number">0</span>           <span class="comment">// 0   即 TYPE_NAVIGATENEXT 正常进入的页面（非刷新、非重定向等）</span></span><br><span class="line">                      <span class="comment">// 1   即 TYPE_RELOAD       通过 window.location.reload() 刷新的页面</span></span><br><span class="line">                      <span class="comment">// 2   即 TYPE_BACK_FORWARD 通过浏览器的前进后退按钮进入的页面（历史记录）</span></span><br><span class="line">                      <span class="comment">// 255 即 TYPE_UNDEFINED    非以上方式进入的页面</span></span><br><span class="line">&#125;,</span><br><span class="line">  </span><br><span class="line"><span class="attr">timing</span>: &#123;</span><br><span class="line">    <span class="comment">// 在同一个浏览器上下文中，前一个网页（与当前页面不一定同域）unload 的时间戳，如果无前一个网页 unload ，则与 fetchStart 值相等</span></span><br><span class="line">    <span class="attr">navigationStart</span>: <span class="number">1441112691935</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 前一个网页（与当前页面同域）unload 的时间戳，如果无前一个网页 unload 或者前一个网页与当前页面不同域，则值为 0</span></span><br><span class="line">    <span class="attr">unloadEventStart</span>: <span class="number">0</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 和 unloadEventStart 相对应，返回前一个网页 unload 事件绑定的回调函数执行完毕的时间戳</span></span><br><span class="line">    <span class="attr">unloadEventEnd</span>: <span class="number">0</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 第一个 HTTP 重定向发生时的时间。有跳转且是同域名内的重定向才算，否则值为 0</span></span><br><span class="line">    <span class="attr">redirectStart</span>: <span class="number">0</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 最后一个 HTTP 重定向完成时的时间。有跳转且是同域名内部的重定向才算，否则值为 0</span></span><br><span class="line">    <span class="attr">redirectEnd</span>: <span class="number">0</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 浏览器准备好使用 HTTP 请求抓取文档的时间，这发生在检查本地缓存之前</span></span><br><span class="line">    <span class="attr">fetchStart</span>: <span class="number">1441112692155</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// DNS 域名查询开始的时间，如果使用了本地缓存（即无 DNS 查询）或持久连接，则与 fetchStart 值相等</span></span><br><span class="line">    <span class="attr">domainLookupStart</span>: <span class="number">1441112692155</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// DNS 域名查询完成的时间，如果使用了本地缓存（即无 DNS 查询）或持久连接，则与 fetchStart 值相等</span></span><br><span class="line">    <span class="attr">domainLookupEnd</span>: <span class="number">1441112692155</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// HTTP（TCP） 开始建立连接的时间，如果是持久连接，则与 fetchStart 值相等</span></span><br><span class="line">    <span class="comment">// 注意如果在传输层发生了错误且重新建立连接，则这里显示的是新建立的连接开始的时间</span></span><br><span class="line">    <span class="attr">connectStart</span>: <span class="number">1441112692155</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// HTTP（TCP） 完成建立连接的时间（完成握手），如果是持久连接，则与 fetchStart 值相等</span></span><br><span class="line">    <span class="comment">// 注意如果在传输层发生了错误且重新建立连接，则这里显示的是新建立的连接完成的时间</span></span><br><span class="line">    <span class="comment">// 注意这里握手结束，包括安全连接建立完成、SOCKS 授权通过</span></span><br><span class="line">    <span class="attr">connectEnd</span>: <span class="number">1441112692155</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// HTTPS 连接开始的时间，如果不是安全连接，则值为 0</span></span><br><span class="line">    <span class="attr">secureConnectionStart</span>: <span class="number">0</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// HTTP 请求读取真实文档开始的时间（完成建立连接），包括从本地读取缓存</span></span><br><span class="line">    <span class="comment">// 连接错误重连时，这里显示的也是新建立连接的时间</span></span><br><span class="line">    <span class="attr">requestStart</span>: <span class="number">1441112692158</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// HTTP 开始接收响应的时间（获取到第一个字节），包括从本地读取缓存</span></span><br><span class="line">    <span class="attr">responseStart</span>: <span class="number">1441112692686</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// HTTP 响应全部接收完成的时间（获取到最后一个字节），包括从本地读取缓存</span></span><br><span class="line">    <span class="attr">responseEnd</span>: <span class="number">1441112692687</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 开始解析渲染 DOM 树的时间，此时 Document.readyState 变为 loading，并将抛出 readystatechange 相关事件</span></span><br><span class="line">    <span class="attr">domLoading</span>: <span class="number">1441112692690</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 完成解析 DOM 树的时间，Document.readyState 变为 interactive，并将抛出 readystatechange 相关事件</span></span><br><span class="line">    <span class="comment">// 注意只是 DOM 树解析完成，这时候并没有开始加载网页内的资源</span></span><br><span class="line">    <span class="attr">domInteractive</span>: <span class="number">1441112693093</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// DOM 解析完成后，网页内资源加载开始的时间</span></span><br><span class="line">    <span class="comment">// 在 DOMContentLoaded 事件抛出前发生</span></span><br><span class="line">    <span class="attr">domContentLoadedEventStart</span>: <span class="number">1441112693093</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// DOM 解析完成后，网页内资源加载完成的时间（如 JS 脚本加载执行完毕）</span></span><br><span class="line">    <span class="attr">domContentLoadedEventEnd</span>: <span class="number">1441112693101</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// DOM 树解析完成，且资源也准备就绪的时间，Document.readyState 变为 complete，并将抛出 readystatechange 相关事件</span></span><br><span class="line">    <span class="attr">domComplete</span>: <span class="number">1441112693214</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// load 事件发送给文档，也即 load 回调函数开始执行的时间</span></span><br><span class="line">    <span class="comment">// 注意如果没有绑定 load 事件，值为 0</span></span><br><span class="line">    <span class="attr">loadEventStart</span>: <span class="number">1441112693214</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// load 事件的回调函数执行完毕的时间</span></span><br><span class="line">    <span class="attr">loadEventEnd</span>: <span class="number">1441112693215</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用-performance-timing-信息简单计算出网页性能数据"><a href="#使用-performance-timing-信息简单计算出网页性能数据" class="headerlink" title="使用 performance.timing 信息简单计算出网页性能数据:"></a>使用 performance.timing 信息简单计算出网页性能数据:</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算加载时间</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPerformanceTiming</span> () &#123;  </span><br><span class="line">    <span class="keyword">var</span> performance = <span class="variable language_">window</span>.<span class="property">performance</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!performance) &#123;</span><br><span class="line">        <span class="comment">// 当前浏览器不支持</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;你的浏览器不支持 performance 接口&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> t = performance.<span class="property">timing</span>;</span><br><span class="line">    <span class="keyword">var</span> times = &#123;&#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【重要】页面加载完成的时间</span></span><br><span class="line">    <span class="comment">//【原因】这几乎代表了用户等待页面可用的时间</span></span><br><span class="line">    times.<span class="property">loadPage</span> = t.<span class="property">loadEventEnd</span> - t.<span class="property">navigationStart</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【重要】解析 DOM 树结构的时间</span></span><br><span class="line">    <span class="comment">//【原因】反省下你的 DOM 树嵌套是不是太多了！</span></span><br><span class="line">    times.<span class="property">domReady</span> = t.<span class="property">domComplete</span> - t.<span class="property">responseEnd</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【重要】重定向的时间</span></span><br><span class="line">    <span class="comment">//【原因】拒绝重定向！比如，http://example.com/ 就不该写成 http://example.com</span></span><br><span class="line">    times.<span class="property">redirect</span> = t.<span class="property">redirectEnd</span> - t.<span class="property">redirectStart</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【重要】DNS 查询时间</span></span><br><span class="line">    <span class="comment">//【原因】DNS 预加载做了么？页面内是不是使用了太多不同的域名导致域名查询的时间太长？</span></span><br><span class="line">    <span class="comment">// 可使用 HTML5 Prefetch 预查询 DNS ，见：[HTML5 prefetch](http://segmentfault.com/a/1190000000633364)            </span></span><br><span class="line">    times.<span class="property">lookupDomain</span> = t.<span class="property">domainLookupEnd</span> - t.<span class="property">domainLookupStart</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【重要】读取页面第一个字节的时间</span></span><br><span class="line">    <span class="comment">//【原因】这可以理解为用户拿到你的资源占用的时间，加异地机房了么，加CDN 处理了么？加带宽了么？加 CPU 运算速度了么？</span></span><br><span class="line">    <span class="comment">// TTFB 即 Time To First Byte 的意思</span></span><br><span class="line">    <span class="comment">// 维基百科：https://en.wikipedia.org/wiki/Time_To_First_Byte</span></span><br><span class="line">    times.<span class="property">ttfb</span> = t.<span class="property">responseStart</span> - t.<span class="property">navigationStart</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【重要】内容加载完成的时间</span></span><br><span class="line">    <span class="comment">//【原因】页面内容经过 gzip 压缩了么，静态资源 css/js 等压缩了么？</span></span><br><span class="line">    times.<span class="property">request</span> = t.<span class="property">responseEnd</span> - t.<span class="property">requestStart</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【重要】执行 onload 回调函数的时间</span></span><br><span class="line">    <span class="comment">//【原因】是否太多不必要的操作都放到 onload 回调函数里执行了，考虑过延迟加载、按需加载的策略么？</span></span><br><span class="line">    times.<span class="property">loadEvent</span> = t.<span class="property">loadEventEnd</span> - t.<span class="property">loadEventStart</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// DNS 缓存时间</span></span><br><span class="line">    times.<span class="property">appcache</span> = t.<span class="property">domainLookupStart</span> - t.<span class="property">fetchStart</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 卸载页面的时间</span></span><br><span class="line">    times.<span class="property">unloadEvent</span> = t.<span class="property">unloadEventEnd</span> - t.<span class="property">unloadEventStart</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// TCP 建立连接完成握手的时间</span></span><br><span class="line">    times.<span class="property">connect</span> = t.<span class="property">connectEnd</span> - t.<span class="property">connectStart</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> times;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用-performance-mark-标记各种时间戳"><a href="#使用-performance-mark-标记各种时间戳" class="headerlink" title="使用 performance.mark() 标记各种时间戳"></a>使用 performance.mark() 标记各种时间戳</h2><h2 id="使用-performance-measure-计算mark标记的时间-duration"><a href="#使用-performance-measure-计算mark标记的时间-duration" class="headerlink" title="使用 performance.measure() 计算mark标记的时间 duration"></a>使用 performance.measure() 计算mark标记的时间 <code>duration</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">randomFunc</span> (n) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (!n) &#123;</span><br><span class="line">        <span class="comment">// 生成一个随机数</span></span><br><span class="line">        n = ~~(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> nameStart = <span class="string">&#x27;markStart&#x27;</span> + n;</span><br><span class="line">    <span class="keyword">var</span> nameEnd   = <span class="string">&#x27;markEnd&#x27;</span> + n;</span><br><span class="line">    <span class="comment">// 函数执行前做个标记</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">mark</span>(nameStart);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="comment">// do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 函数执行后再做个标记</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">mark</span>(nameEnd); <span class="comment">// mark 用法！</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 然后测量这个两个标记间的时间距离，并保存起来</span></span><br><span class="line">    <span class="keyword">var</span> name = <span class="string">&#x27;measureRandomFunc&#x27;</span> + n;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">measure</span>(name, nameStart, nameEnd); <span class="comment">// measur 用法！</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 执行三次看看</span></span><br><span class="line"><span class="title function_">randomFunc</span>();  </span><br><span class="line"><span class="title function_">randomFunc</span>();  </span><br><span class="line"><span class="comment">// 指定一个名字</span></span><br><span class="line"><span class="title function_">randomFunc</span>(<span class="number">888</span>);</span><br></pre></td></tr></table></figure>

<h2 id="使用performance-getEntries-获取所有资源请求的时间数据"><a href="#使用performance-getEntries-获取所有资源请求的时间数据" class="headerlink" title="使用performance.getEntries() 获取所有资源请求的时间数据"></a>使用performance.getEntries() 获取所有资源请求的时间数据</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 看下保存起来的标记 mark</span></span><br><span class="line"><span class="keyword">var</span> marks = <span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">getEntriesByType</span>(<span class="string">&#x27;mark&#x27;</span>);  </span><br><span class="line"><span class="comment">// 看下保存起来的测量 measure</span></span><br><span class="line"><span class="keyword">var</span> measure = <span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">getEntriesByType</span>(<span class="string">&#x27;measure&#x27;</span>);  </span><br></pre></td></tr></table></figure>

<h2 id="清除标记："><a href="#清除标记：" class="headerlink" title="清除标记："></a>清除标记：</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 清除指定标记</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">clearMarks</span>(<span class="string">&#x27;markStart888&#x27;</span>);  </span><br><span class="line"><span class="comment">// 清除所有标记</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">clearMarks</span>();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 清除指定测量</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">clearMeasures</span>(<span class="string">&#x27;measureRandomFunc&#x27;</span>);  </span><br><span class="line"><span class="comment">// 清除所有测量</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">clearMeasures</span>();</span><br></pre></td></tr></table></figure>



<h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/timing">performance.timing</a> ：包含延迟相关的性能信息。</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/navigation">performance.navigation</a> ：表示在当前给定浏览上下文中网页导航的类型以及次数。</p>
<p><a target="_blank" rel="noopener" href="https://docs.webplatform.org/apis/timing/properties/memory">performance.memory</a> ：在Chrome中添加的一个非标准扩展。</p>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/mark">performance.mark()</a>：</p>
<p>通过一个给定的名称，将该名称（作为键）和对应的<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/DOMHighResTimeStamp">DOMHighResTimeStamp</a>（作为值）保存在一个哈希结构里。该键值对表示了从某一时刻（译者注：某一时刻通常是 navigationStart 事件发生时刻）到记录时刻间隔的毫秒数。（译者注：该方法一般用来多次记录时间，用于求得各记录间的时间差）</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/now">performance.now()</a>：</p>
<p>该方法返回一个<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/DOMHighResTimeStamp">DOMHighResTimeStamp</a>对象，该对象表示从某一时刻（译者注：某一时刻通常是 navigationStart 事件发生时刻）到调用该方法时刻的毫秒数。</p>
<p><strong>参考：</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhuyang/p/4789020.html">https://www.cnblogs.com/zhuyang/p/4789020.html</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-12-21</span><i class="fa fa-tag"></i><a class="tag" href="/tags/综合/" title="综合">综合 </a><span class="leancloud_visitors"></span><span>大约2027个字, 6分钟45秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/901-Canvas%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95/">Canvas常用方法</a></h3></div><div class="post-content"><div class="card"><p><h2 id="1-基本思路"><a href="#1-基本思路" class="headerlink" title="1. 基本思路"></a>1. 基本思路</h2><ul>
<li>如果位置有重叠，一般地，后面绘制的图形会覆盖前面的；</li>
</ul>
<h2 id="2-画圆"><a href="#2-画圆" class="headerlink" title="2. 画圆"></a>2. 画圆</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;canvas&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">ctx.<span class="title function_">arc</span>(<span class="number">100</span>, <span class="number">75</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">2</span> * <span class="title class_">Math</span>.<span class="property">PI</span>);</span><br><span class="line">ctx.<span class="title function_">stroke</span>();</span><br></pre></td></tr></table></figure>

<h2 id="3-矩形"><a href="#3-矩形" class="headerlink" title="3. 矩形"></a>3. 矩形</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;canvas&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="title function_">rect</span>(<span class="number">10</span>, <span class="number">20</span>, <span class="number">150</span>, <span class="number">100</span>);</span><br><span class="line">ctx.<span class="title function_">fill</span>();<span class="comment">// 实心矩形</span></span><br></pre></td></tr></table></figure>

<h2 id="4-Math-PI"><a href="#4-Math-PI" class="headerlink" title="4. Math.PI"></a>4. <code>Math.PI</code></h2><p><code>**Math.PI**</code> 表示一个圆的周长与直径的比例，约为 3.14159：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Math.PI = 𝜋 ≈ 3.14159</span><br></pre></td></tr></table></figure>

<h2 id="5-常用方法"><a href="#5-常用方法" class="headerlink" title="5. 常用方法"></a>5. 常用方法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctx.<span class="title function_">fill</span>(); <span class="comment">// 填充形状</span></span><br><span class="line">ctx.<span class="title function_">stroke</span>(); <span class="comment">// 绘制形状轮廓</span></span><br></pre></td></tr></table></figure>

<h2 id="6-绘制带边框的三角形"><a href="#6-绘制带边框的三角形" class="headerlink" title="6. 绘制带边框的三角形"></a>6. 绘制带边框的三角形</h2><p>注意：加边框，需要关闭绘制路径 <code>ctx.closePath()</code></p>
<p><code>**CanvasRenderingContext2D.closePath()**</code> 是 Canvas 2D API 将笔点返回到当前子路径起始点的方法。它尝试从当前点到起始点绘制一条直线。如果图形已经是封闭的或者只有一个点，那么此方法不会做任何操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;canvas&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="title function_">beginPath</span>()</span><br><span class="line">ctx.<span class="title function_">moveTo</span>(<span class="number">100</span>, <span class="number">10</span>)</span><br><span class="line">ctx.<span class="title function_">lineTo</span>(<span class="number">10</span>, <span class="number">100</span>)</span><br><span class="line">ctx.<span class="title function_">lineTo</span>(<span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;pink&#x27;</span></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&#x27;#ff0&#x27;</span></span><br><span class="line">ctx.<span class="title function_">closePath</span>() <span class="comment">// ！若要加边框，则需关闭绘制路径 </span></span><br><span class="line">ctx.<span class="title function_">fill</span>()</span><br><span class="line"><span class="comment">// stroke() 加边框，需和 closePath 配合使用</span></span><br><span class="line">ctx.<span class="title function_">stroke</span>()</span><br></pre></td></tr></table></figure></p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-04-19</span><i class="fa fa-tag"></i><a class="tag" href="/tags/图/" title="图">图 </a><span class="leancloud_visitors"></span><span>大约288个字, 57秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/07-%E5%9D%97%E7%BA%A7%E4%BD%9C%E7%94%A8%E5%9F%9F/">块级作用域</a></h3></div><div class="post-content"><div class="card"><p><h2 id="块级作用域定义："><a href="#块级作用域定义：" class="headerlink" title="块级作用域定义："></a>块级作用域定义：</h2><p>块作用域是指被大括号（“{}”）包裹住的相关联的<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Statement">语句</a>的集合。例如，你可以在 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/if...else">if (condition)</a> 后声明一段块作用域形式的代码，表明当条件判断为真时，解释程序应该运行上述块作用域里的代码，或者当条件判断为假时跳过执行上述块作用域里的代码。</p>
<h3 id="举例："><a href="#举例：" class="headerlink" title="举例："></a>举例：</h3><p><code>var</code> 没有块级作用域，但<code>let``const</code> 有。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c3 = <span class="number">123</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c3)</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> c3 = <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(c3)</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c3)</span><br><span class="line"><span class="comment">// 输出：123  abc  abc</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> c1 = <span class="number">123</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c1)</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> c1 = <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(c1)</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c1)</span><br><span class="line"><span class="comment">// 输出：123  abc  123</span></span><br></pre></td></tr></table></figure>



<h3 id="块级作用域可规避的问题："><a href="#块级作用域可规避的问题：" class="headerlink" title="块级作用域可规避的问题："></a>块级作用域可规避的问题：</h3><ol>
<li>内层变量不会覆盖外层变量</li>
<li>避免计数的循环变量泄露为全局变量，如：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;in=&gt;&#x27;</span>+i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;out=&gt;&#x27;</span>+i);</span><br><span class="line"><span class="comment">// 输出：in=&gt;0	in=&gt;1	out=&gt;2</span></span><br><span class="line"><span class="keyword">let</span> i = <span class="number">1</span></span><br><span class="line"><span class="comment">// Uncaught SyntaxError: Identifier &#x27;i&#x27; has already been declared</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 但包在for 中，let i 声明，并不会报错，如下：</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用let声明计数变量j</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; <span class="number">2</span>; j++)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;in=&gt;&#x27;</span>+j);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;out=&gt;&#x27;</span>+j);</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// in=&gt;0</span></span><br><span class="line"><span class="comment">// in=&gt;1  </span></span><br><span class="line"><span class="comment">// VM367:4 Uncaught ReferenceError: j is not defined at &lt;anonymous&gt;:4:21</span></span><br></pre></td></tr></table></figure>

<p> 在 <code>for</code> 循环中定义的变量 <code>i</code>，通常是想在 <code>for</code> 循环内部的上下文中使用 <code>i</code>，但用 <code>var</code>声明会将 <code>i</code> 会绑定在外部作用域(函数或全局)中。</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-03-17</span><i class="fa fa-tag"></i><a class="tag" href="/tags/JavaScript/" title="JavaScript">JavaScript </a><span class="leancloud_visitors"></span><span>大约388个字, 1分钟17秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/304-%E7%94%A8proxyman%E8%B0%83%E8%AF%95%E8%AE%BE%E5%A4%87(Mac)/">用proxyman调试设备(Mac)</a></h3></div><div class="post-content"><div class="card"><p><ol>
<li>安装 Proxyman</li>
<li>Tools -&gt; proxy settings -&gt;  override macOs proxy 关闭，即停止了本机的抓包</li>
<li>certificate -&gt; install certificate on ios -&gt; physical Devices 安装证书</li>
</ol>
<img src="/304-%E7%94%A8proxyman%E8%B0%83%E8%AF%95%E8%AE%BE%E5%A4%87(Mac)/image (1).png" alt="image (1)" style="zoom:67%;">


<h2 id="遇到的问题："><a href="#遇到的问题：" class="headerlink" title="遇到的问题："></a>遇到的问题：</h2><ol>
<li>第3步，打不开这个网址</li>
</ol>
<p>解决：</p>
<p>重新连 wifi。</p>
<p><a target="_blank" rel="noopener" href="https://docs.proxyman.io/troubleshooting/ios-16-devices-issues#1.-problem">https://docs.proxyman.io/troubleshooting/ios-16-devices-issues#1.-problem</a></p>
<img src="/304-%E7%94%A8proxyman%E8%B0%83%E8%AF%95%E8%AE%BE%E5%A4%87(Mac)/image.png" alt="image" style="zoom:80%;">

<p> 打开 proxy.man&#x2F;ssl 后，弹框点击 allow ，后进入 到 setting ，左侧列表中，会有 安装证书的一行。</p>
<ol start="2">
<li>连接后，仍然打不开内网网址 <code>https://***</code></li>
</ol>
<p>解决：</p>
<p>清 Safari 的缓存，重新进入，安全链接选仍打开。</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-01-10</span><i class="fa fa-tag"></i><a class="tag" href="/tags/综合/" title="综合">综合 </a><span class="leancloud_visitors"></span><span>大约143个字, 28秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/303-%E5%89%8D%E7%AB%AF%E6%97%A0%E6%84%9F%E7%9F%A5%E5%88%B7%E6%96%B0token/">前端无感知刷新token</a></h3></div><div class="post-content"><div class="card"><p><h2 id="需求背景："><a href="#需求背景：" class="headerlink" title="需求背景："></a>需求背景：</h2><ol>
<li>后端的 token 机制，每次发送请求，都会自动延长 token 的过期时间</li>
<li><strong>需求场景：</strong> 网站有很多数据待核对， 用户并未刷新或操作网站，一段时间后，当用户终于核对输入好数据后，点保存按钮，登录过期￣□￣｜｜。</li>
</ol>
<h2 id="解决思路："><a href="#解决思路：" class="headerlink" title="解决思路："></a>解决思路：</h2><p>监听用户的鼠标移动事件，若移动则触发一个轻量后端请求，以延长 token 过期时间，以此达到无感知刷新 token 的效果。</p>
<h2 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h2><p><strong>在主页面中，监听全局页面的鼠标移动事件，通过节流，在一段时间内调用刷新请求。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// 主页面 main.vue</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div</span><br><span class="line">    @mousemove=&quot;mouseMove&quot; &gt;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  const refreshTokenTime = 1000 * 60 * 5 // 暂定5分钟</span><br><span class="line">  export default &#123;</span><br><span class="line">    data () &#123;</span><br><span class="line">      return &#123;</span><br><span class="line">        handleMove: &#x27;&#x27;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    mounted () &#123;</span><br><span class="line">      this.handleMove = this.throttled(this.mouseMoveFn, refreshTokenTime)</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">      mouseMove () &#123;</span><br><span class="line">        this.handleMove()</span><br><span class="line">      &#125;,</span><br><span class="line">      // 激活</span><br><span class="line">      mouseMoveFn () &#123;</span><br><span class="line">        console.log(&#x27;move&#x27;)</span><br><span class="line">        // 刷新 token 的请求</span><br><span class="line">        this.$http(&#123;</span><br><span class="line">          isRefresh: true,</span><br><span class="line">          url: &#x27;/**/info&#x27;,</span><br><span class="line">          method: &#x27;get&#x27;</span><br><span class="line">        &#125;).then(() =&gt; &#123;</span><br><span class="line">          // 如果有需要，可以刷新后，修改本地存储、token等信息</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">      // 除了恶意修改本地时间，用时间戳方式节流</span><br><span class="line">      throttled (fn, delay) &#123;</span><br><span class="line">        let last = 0</span><br><span class="line">        return (...args) =&gt; &#123;</span><br><span class="line">          let now = new Date()</span><br><span class="line">          if (now - last &gt;= delay) &#123;</span><br><span class="line">            fn.apply(this, args)</span><br><span class="line">            last = now</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h4 id="寻找更加优雅的方案，欢迎指点"><a href="#寻找更加优雅的方案，欢迎指点" class="headerlink" title="寻找更加优雅的方案，欢迎指点~"></a>寻找更加优雅的方案，欢迎指点~</h4><h2 id="附：JWT-方式实现思路"><a href="#附：JWT-方式实现思路" class="headerlink" title="附：JWT 方式实现思路"></a>附：JWT 方式实现思路</h2><p>详细可看：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7023253083475935240#heading-9">https://juejin.cn/post/7023253083475935240#heading-9</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/316165120/answer/1490826572">https://www.zhihu.com/question/316165120/answer/1490826572</a></p>
<blockquote>
<p>通过长短token实现：短token用来请求应用数据，长token用于获取新的短token（长短指的是过期时间） </p>
<p>短token过期了，用长token调后端接口获取新的短token。如果长token也过期了，直接跳转到登录页重新登录。</p>
<ul>
<li><strong>Access Token即“访问令牌”，是客户端向资源服务器换取资源的凭证；</strong></li>
<li><strong>Refresh Token即“刷新令牌”，是客户端向认证服务器换取Access Token的凭证。</strong></li>
</ul>
<ol>
<li>用户提供身份信息（一般是用户名密码），利用客户端向认证服务器换取 Refresh Token和Access Token；</li>
<li>客户端携带Access Token访问资源服务器，资源服务器识别Access Token并返回资源；</li>
<li>当Access Token过期或失效，客户端再一次访问资源服务器，<strong>资源服务器返回“无效token”报错</strong>；</li>
<li>客户端通过<strong>Refresh Token向认证服务器换取Access Token</strong>，认证服务器返回<strong>新的</strong>Access Token。</li>
</ol>
</blockquote>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-11-15</span><i class="fa fa-tag"></i><a class="tag" href="/tags/综合/" title="综合">综合 </a><span class="leancloud_visitors"></span><span>大约650个字, 2分钟10秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/107-nextTick/">nextTick</a></h3></div><div class="post-content"><div class="card"><p><h2 id="1-nextTick-与-nextTick"><a href="#1-nextTick-与-nextTick" class="headerlink" title="1. nextTick 与 $nextTick"></a>1. nextTick 与 $nextTick</h2><h3 id="全局-API-Vue-nextTick"><a href="#全局-API-Vue-nextTick" class="headerlink" title="全局 API Vue.nextTick()"></a>全局 API <code>Vue.nextTick()</code></h3><h3 id="Vue-nextTick-callback-context"><a href="#Vue-nextTick-callback-context" class="headerlink" title="[Vue.nextTick( callback, context] )"></a>[Vue.nextTick( <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#Vue-nextTick">callback, context] )</a></h3><p><strong>在下次 DOM 更新循环结束之后执行延迟回调。</strong></p>
<p><strong>在修改数据之后立即使用这个方法，获取更新后的 DOM。</strong></p>
<p>2.1.0 起新增：<strong>如果没有提供回调且在支持 Promise 的环境中，则返回一个 Promise。</strong>请注意 Vue 不自带 Promise 的 polyfill，所以如果你的目标浏览器不原生支持 Promise (IE：你们都看我干嘛)，你得自己提供 polyfill。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改数据</span></span><br><span class="line">vm.<span class="property">msg</span> = <span class="string">&#x27;Hello&#x27;</span></span><br><span class="line"><span class="comment">// DOM 还没有更新</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">nextTick</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// DOM 更新了</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 作为一个 Promise 使用 (2.1.0 起新增，详见接下来的提示)</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">nextTick</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// DOM 更新了</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="实例方法-x2F-实例生命周期-vm-nextTick"><a href="#实例方法-x2F-实例生命周期-vm-nextTick" class="headerlink" title="实例方法&#x2F;实例生命周期 vm.$nextTick()"></a>实例方法&#x2F;实例生命周期 <code>vm.$nextTick()</code></h3><h3 id="vm-nextTick-callback"><a href="#vm-nextTick-callback" class="headerlink" title="[vm.$nextTick( callback] )"></a>[vm.$nextTick( <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#vm-nextTick">callback] )</a></h3><p><strong>将回调延迟到下次 DOM 更新循环之后执行。</strong></p>
<p><strong>在修改数据之后立即使用它，然后等待 DOM 更新。</strong></p>
<p><strong>它跟全局方法</strong> <strong>Vue.nextTick</strong> <strong>一样，不同的是回调的</strong> <strong>this</strong> <strong>自动绑定到调用它的实例上。</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="attr">example</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 修改数据</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">message</span> = <span class="string">&#x27;changed&#x27;</span></span><br><span class="line">      <span class="comment">// DOM 还没有更新</span></span><br><span class="line">      <span class="variable language_">this</span>.$nextTick(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// DOM 现在更新了</span></span><br><span class="line">        <span class="comment">// `this` 绑定到当前实例</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">doSomethingElse</span>()</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="2-源码分析"><a href="#2-源码分析" class="headerlink" title="2. 源码分析"></a>2. 源码分析</h2><h3 id="2-1-初始化"><a href="#2-1-初始化" class="headerlink" title="2.1 初始化"></a>2.1 初始化</h3><p>都是调用的 src&#x2F;core&#x2F;util&#x2F;next-tick.js 的 nextTick 方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; nextTick &#125; <span class="keyword">from</span> <span class="string">&#x27;../util/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/core/global-api/index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initGlobalAPI</span> (<span class="title class_">Vue</span>: <span class="title class_">GlobalAPI</span>) &#123;</span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property">nextTick</span> = nextTick</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/core/instance/render.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$nextTick</span> = <span class="keyword">function</span> (<span class="params">fn: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">nextTick</span>(fn, <span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-调用"><a href="#2-2-调用" class="headerlink" title="2.2 调用"></a>2.2 调用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/scheduler.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">queueWatcher</span> (<span class="attr">watcher</span>: <span class="title class_">Watcher</span>) &#123;</span><br><span class="line">      <span class="title function_">nextTick</span>(flushSchedulerQueue)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-nextTick"><a href="#2-3-nextTick" class="headerlink" title="2.3 nextTick()"></a>2.3 <code>nextTick()</code></h3><ul>
<li>将 回调函数 存到 callbacks 队列</li>
<li>如果有正在执行的，就等待上一个执行结束后，下一次更新执行</li>
<li>事件循环通过微任务或宏任务，再依次执行 callbacks 中的回调函数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/util/next-tick.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局唯一，异步操作队列</span></span><br><span class="line"><span class="keyword">const</span> callbacks = []</span><br><span class="line"><span class="comment">// 标识同一个时间只能执行一次</span></span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">nextTick</span> (cb?: <span class="title class_">Function</span>, ctx?: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> _resolve</span><br><span class="line">  <span class="comment">// 将入参的 回调函数cb 存到 callbacks队列中</span></span><br><span class="line">  callbacks.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 保留 cb 的 this 仍是 ctx</span></span><br><span class="line">        cb.<span class="title function_">call</span>(ctx)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="title function_">handleError</span>(e, ctx, <span class="string">&#x27;nextTick&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_resolve) &#123;</span><br><span class="line">      <span class="title function_">_resolve</span>(ctx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 若没有正在执行的任务</span></span><br><span class="line">  <span class="keyword">if</span> (!pending) &#123;</span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// 将待执行操作加到微/宏任务队列（各个系统方式不同 ，简单理解为 setTimeout（利用 Event Loop））</span></span><br><span class="line">    <span class="title function_">timerFunc</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="comment">// 如果没有提供回调且在支持 Promise 的环境中，则返回一个 Promise</span></span><br><span class="line">  <span class="keyword">if</span> (!cb &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      _resolve = resolve</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-timerFunc"><a href="#2-4-timerFunc" class="headerlink" title="2.4 timerFunc"></a>2.4 <code>timerFunc</code></h3><p>挂起任务的方法，将待执行操作加到微&#x2F;宏任务队列（微任务优先于宏任务）</p>
<p>优先级为： Promise &gt; MutationObserver &gt; setImmediate &gt; setTimeout</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/util/next-tick.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 挂起方法，将待执行操作加到微/宏任务队列（各个系统方式不同 ，使用不同的方式）</span></span><br><span class="line"><span class="comment">// 优先级为： Promise &gt; MutationObserver &gt; setImmediate &gt; setTimeout</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> isUsingMicroTask = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> timerFunc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(<span class="title class_">Promise</span>)) &#123;</span><br><span class="line">  <span class="comment">// 支持 Promise 的，使用 Promise 方式挂起，回调函数放在 then() 中 -- 微任务</span></span><br><span class="line">  <span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    p.<span class="title function_">then</span>(flushCallbacks)</span><br><span class="line">    <span class="keyword">if</span> (isIOS) <span class="built_in">setTimeout</span>(noop)</span><br><span class="line">  &#125;</span><br><span class="line">  isUsingMicroTask = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isIE &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">MutationObserver</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; (</span><br><span class="line">  <span class="title function_">isNative</span>(<span class="title class_">MutationObserver</span>) ||</span><br><span class="line">  <span class="comment">// PhantomJS and iOS 7.x</span></span><br><span class="line">  <span class="title class_">MutationObserver</span>.<span class="title function_">toString</span>() === <span class="string">&#x27;[object MutationObserverConstructor]&#x27;</span></span><br><span class="line">)) &#123;</span><br><span class="line">  <span class="comment">// 不支持 Promise ,但非IE 且支持 MutationObserver 的，使用 MutationObserver  -- 微任务</span></span><br><span class="line">  ...</span><br><span class="line">  isUsingMicroTask = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(setImmediate)) &#123;</span><br><span class="line">  <span class="comment">// 不支持 Promise 和 MutationObserver ，</span></span><br><span class="line">  <span class="comment">// 但支持 setImmediate，用 setImmediate 挂起 -- 宏任务</span></span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setImmediate</span>(flushCallbacks)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 以上都不支持的，使用 setTimeout 挂起 -- 宏任务</span></span><br><span class="line">  <span class="comment">// Fallback to setTimeout.</span></span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(flushCallbacks, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-5-flushCallbacks"><a href="#2-5-flushCallbacks" class="headerlink" title="2.5 flushCallbacks()"></a>2.5 <code>flushCallbacks()</code></h3><ul>
<li>执行回调函数，将标志位置为 false</li>
<li>遍历 callbacks 回调队列，挨个执行</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/util/next-tick.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历 callbacks 队列中的回调函数，挨个执行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushCallbacks</span> () &#123;</span><br><span class="line">  pending = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> copies = callbacks.<span class="title function_">slice</span>(<span class="number">0</span>)</span><br><span class="line">  callbacks.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// 挨个执行</span></span><br><span class="line">    copies[i]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-07-18</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约968个字, 3分钟13秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/">模版渲染</a></h3></div><div class="post-content"><div class="card"><p><h1 id="入口-vm-mount-方法："><a href="#入口-vm-mount-方法：" class="headerlink" title="入口 vm.$mount 方法："></a>入口 <code>vm.$mount</code> 方法：</h1><p>在 <code>vm.$mount(vm.$options.el)</code>中，</p>
<h1 id="1-扩展-mount-方法（platforms-web-entry-runtime-with-compiler）"><a href="#1-扩展-mount-方法（platforms-web-entry-runtime-with-compiler）" class="headerlink" title="1. 扩展 $mount 方法（platforms/web/entry-runtime-with-compiler）"></a>1. 扩展 $mount 方法（<code>platforms/web/entry-runtime-with-compiler</code>）</h1><p><strong>先调用 扩展的 $mount 方法（</strong><code>**src/platforms/web/entry-runtime-with-compiler.js**</code><strong>）, 生成 render。</strong></p>
<ul>
<li><p>id 不能挂载到 body 或 documentElement 页面文档上</p>
</li>
<li><p>若 this.$options 上没有 render 方法</p>
</li>
<li><ul>
<li>取 $options 的 template 或 el 获取元素，生成 html 字符串（此 html 字符串即 下文 parseHTML 方法的入参 html）</li>
<li>调用 compileToFunctions ，获取 render 方法</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/platforms/web/entry-runtime-with-compiler.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mount = <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  <span class="comment">// 获取元素或查询元素 （query 方法分析见下方）</span></span><br><span class="line">  <span class="comment">//  el 是元素选择器</span></span><br><span class="line">  el = el &amp;&amp; <span class="title function_">query</span>(el)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="comment">// vue 不允许将 id 直接挂到 body 或 页面文档</span></span><br><span class="line">  <span class="keyword">if</span> (el === <span class="variable language_">document</span>.<span class="property">body</span> || el === <span class="variable language_">document</span>.<span class="property">documentElement</span>) &#123;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.`</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 此处的 $options 如下图1</span></span><br><span class="line">  <span class="keyword">const</span> options = <span class="variable language_">this</span>.<span class="property">$options</span></span><br><span class="line">  <span class="comment">// resolve template/el and convert to render function</span></span><br><span class="line">  <span class="keyword">if</span> (!options.<span class="property">render</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> template = options.<span class="property">template</span></span><br><span class="line">    <span class="comment">// 若参数中有 template</span></span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> template === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 若有 # ，则可能是id 选择器的标志，用 idToTemplate 转换获取 node 节点</span></span><br><span class="line">        <span class="keyword">if</span> (template.<span class="title function_">charAt</span>(<span class="number">0</span>) === <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">          template = <span class="title function_">idToTemplate</span>(template)</span><br><span class="line">          <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">          <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !template) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">`Template element not found or is empty: <span class="subst">$&#123;options.template&#125;</span>`</span>,</span><br><span class="line">              <span class="variable language_">this</span></span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (template.<span class="property">nodeType</span>) &#123;</span><br><span class="line">        <span class="comment">// 若 template 是node 类型节点，则取其 内部html 节点</span></span><br><span class="line">        template = template.<span class="property">innerHTML</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(<span class="string">&#x27;invalid template option:&#x27;</span> + template, <span class="variable language_">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el) &#123;</span><br><span class="line">      <span class="comment">// 若el 有值，则取 el 本身元素（此处也表明 优先取 template 属性值）</span></span><br><span class="line">      template = <span class="title function_">getOuterHTML</span>(el)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">        <span class="title function_">mark</span>(<span class="string">&#x27;compile&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 1.模板编译，将 template 解析为 ast tree</span></span><br><span class="line"><span class="comment">        * 2.将 ast tree 转换成 render 语法字符串</span></span><br><span class="line"><span class="comment">        * 3.生成 render 方法</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line">      <span class="keyword">const</span> &#123; render, staticRenderFns &#125; = <span class="title function_">compileToFunctions</span>(template, &#123;</span><br><span class="line">        <span class="attr">outputSourceRange</span>: process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">        shouldDecodeNewlines,</span><br><span class="line">        shouldDecodeNewlinesForHref,</span><br><span class="line">        <span class="attr">delimiters</span>: options.<span class="property">delimiters</span>,</span><br><span class="line">        <span class="attr">comments</span>: options.<span class="property">comments</span></span><br><span class="line">      &#125;, <span class="variable language_">this</span>)</span><br><span class="line">      <span class="comment">// 这里的 render 就是生成虚拟 DOM 的方法</span></span><br><span class="line">      options.<span class="property">render</span> = render</span><br><span class="line">      options.<span class="property">staticRenderFns</span> = staticRenderFns</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">        <span class="title function_">mark</span>(<span class="string">&#x27;compile end&#x27;</span>)</span><br><span class="line">        <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;<span class="variable language_">this</span>._name&#125;</span> compile`</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;compile end&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 此处转换后的 $options 如下图2</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">$options</span>)</span><br><span class="line">  <span class="comment">// 由于是扩展方法，则 return 回 $mount 方法，使其继续调用原始方法</span></span><br><span class="line">  <span class="keyword">return</span> mount.<span class="title function_">call</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1656583813165-0d3bf22c-7b9d-4187-8ae8-6fe052976217.png" alt="img"></p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1656583751696-a1a3581c-3204-4245-8f82-433ef3404b5e.png" alt="img"></p>
<h4 id="【辅助】query-el-方法："><a href="#【辅助】query-el-方法：" class="headerlink" title="【辅助】query(el) 方法："></a>【辅助】<code>query(el)</code> 方法：</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Query an element selector if it&#x27;s not an element already.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">query</span> (<span class="attr">el</span>: string | <span class="title class_">Element</span>): <span class="title class_">Element</span> &#123;</span><br><span class="line">  <span class="comment">// el 的格式只有 string 和 Element</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> el === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// string 时，相当于 el 的值是元素的 id ，通过 document.querySelector() 方法获取dom元素 ，并返回</span></span><br><span class="line">    <span class="keyword">const</span> selected = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(el)</span><br><span class="line">    <span class="keyword">if</span> (!selected) &#123;</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;Cannot find element: &#x27;</span> + el</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> selected</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 若是 Element 类型，直接返回 元素</span></span><br><span class="line">    <span class="keyword">return</span> el</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-1-compileToFunctions"><a href="#1-1-compileToFunctions" class="headerlink" title="1.1 compileToFunctions()"></a>1.1 <code>compileToFunctions()</code></h2><ul>
<li>找 compileToFunctions() 的定义在 <code>src\platforms\web\compiler\index.js</code>，由 createCompiler 创建</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\platforms\web\compiler\index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createCompiler &#125; <span class="keyword">from</span> <span class="string">&#x27;compiler/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; compile, compileToFunctions &#125; = <span class="title function_">createCompiler</span>(baseOptions)</span><br><span class="line"><span class="keyword">export</span> &#123; compile, compileToFunctions &#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-createCompiler"><a href="#1-2-createCompiler" class="headerlink" title="1.2 createCompiler"></a>1.2 <code>createCompiler</code></h2><ul>
<li>再找 createCompiler 的定义在 <code>src\compiler\index.js</code>，引出创建方法 <code>createCompilerCreator</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模板编译，将模板代码转化为 AST；</span></span><br><span class="line"><span class="comment"> * 优化 AST，方便后续虚拟 DOM 更新；</span></span><br><span class="line"><span class="comment"> * 生成代码，将 AST 转化为可执行的代码；</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createCompiler = <span class="title function_">createCompilerCreator</span>(<span class="keyword">function</span> <span class="title function_">baseCompile</span> (</span><br><span class="line">  <span class="attr">template</span>: string,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">CompiledResult</span> &#123;</span><br><span class="line">  <span class="comment">// baseCompile 的调用在：</span></span><br><span class="line">  <span class="comment">// src\compiler\create-compiler.js 中的 const compiled = baseCompile(template.trim(), finalOptions)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 解析 template 模板，转换为 ast</span></span><br><span class="line">  <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options)</span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">optimize</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">// 优化 ast，标记静态节点</span></span><br><span class="line">    <span class="title function_">optimize</span>(ast, options)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将 ast 转化为可执行代码</span></span><br><span class="line">  <span class="keyword">const</span> code = <span class="title function_">generate</span>(ast, options)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="1-3-createCompilerCreator"><a href="#1-3-createCompilerCreator" class="headerlink" title="1.3 createCompilerCreator"></a>1.3 <code>createCompilerCreator</code></h2><ul>
<li><p>再找<code>createCompilerCreator</code>创建在 <code>src\compiler\create-compiler.js</code>，由此引出：</p>
</li>
<li><ul>
<li><code>createCompileToFunctionFn(compile)</code> </li>
<li><code>compile()</code> 的定义在 <code>createCompiler</code>方法内的子函数</li>
</ul>
</li>
</ul>
<h3 id="1-3-1-createCompilerCreator-和-compile"><a href="#1-3-1-createCompilerCreator-和-compile" class="headerlink" title="1.3.1 createCompilerCreator 和 compile()"></a>1.3.1 <code>createCompilerCreator</code> 和 <code>compile()</code></h3><ul>
<li><ul>
<li><ul>
<li>在 <code>compile()</code>的实现中，引出 <code>baseCompile(template.trim(), finalOptions)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\create-compiler.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createCompilerCreator</span> (<span class="attr">baseCompile</span>: <span class="title class_">Function</span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">createCompiler</span> (<span class="attr">baseOptions</span>: <span class="title class_">CompilerOptions</span>) &#123;</span><br><span class="line">    <span class="comment">// compile 是在 createCompiler 函数体内定义个一个子函数</span></span><br><span class="line">    <span class="comment">// 应用 eg： src\compiler\to-function.js 中，const compiled = compile(template, options)</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">compile</span> (</span><br><span class="line">      <span class="attr">template</span>: string,</span><br><span class="line">      options?: <span class="title class_">CompilerOptions</span></span><br><span class="line">    ): <span class="title class_">CompiledResult</span> &#123;</span><br><span class="line">         <span class="comment">// 深拷贝参数 baseOptions</span></span><br><span class="line">        <span class="keyword">const</span> finalOptions = <span class="title class_">Object</span>.<span class="title function_">create</span>(baseOptions)</span><br><span class="line">        <span class="comment">// modules, directives, warn 的合并</span></span><br><span class="line">        ... </span><br><span class="line">        <span class="comment">// baseCompile 方法是 src\compiler\index.js 中 创建</span></span><br><span class="line">        <span class="keyword">const</span> compiled = <span class="title function_">baseCompile</span>(template.<span class="title function_">trim</span>(), finalOptions)</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> compiled</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        compile,</span><br><span class="line">        <span class="attr">compileToFunctions</span>: <span class="title function_">createCompileToFunctionFn</span>(compile)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<h4 id="1-3-1-1-baseCompile-template-trim-finalOptions"><a href="#1-3-1-1-baseCompile-template-trim-finalOptions" class="headerlink" title="1.3.1.1 baseCompile(template.trim(), finalOptions)"></a>1.3.1.1 <code>baseCompile(template.trim(), finalOptions)</code></h4><p>此方法的创建在 1.1.2 内。</p>
<p>调用此方法后，由此引出 ：</p>
<ul>
<li><code>const ast = parse(template.trim(), options)</code>，具体分析见下文 【 <em><strong>3. 生成AST</strong></em> 】</li>
<li><code>optimize(ast, options)</code> &#x2F;&#x2F; todo</li>
<li><code>constcode = generate(ast, options)</code> &#x2F;&#x2F; todo</li>
</ul>
<h3 id="1-3-2-createCompileToFunctionFn-compile"><a href="#1-3-2-createCompileToFunctionFn-compile" class="headerlink" title="1.3.2 createCompileToFunctionFn(compile)"></a>1.3.2 <code>createCompileToFunctionFn(compile)</code></h3><ul>
<li><ul>
<li>再找 <code>createCompileToFunctionFn(compile)</code> 创建在 <code>src\compiler\to-function.js</code></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\to-function.js</span></span><br><span class="line"></span><br><span class="line">type <span class="title class_">CompiledFunctionResult</span> = &#123;</span><br><span class="line">  <span class="attr">render</span>: <span class="title class_">Function</span>;</span><br><span class="line">  <span class="attr">staticRenderFns</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Function</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建 编译函数 render, staticRenderFns</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">创建</span>&#125; compile </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span>  <span class="variable">CompiledFunctionResult</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createCompileToFunctionFn</span> (<span class="attr">compile</span>: <span class="title class_">Function</span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="comment">// 创建编译缓存</span></span><br><span class="line">  <span class="keyword">const</span> cache = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">compileToFunctions</span> (</span><br><span class="line">    <span class="attr">template</span>: string,</span><br><span class="line">    options?: <span class="title class_">CompilerOptions</span>,</span><br><span class="line">    vm?: <span class="title class_">Component</span></span><br><span class="line">  ): <span class="title class_">CompiledFunctionResult</span> &#123;</span><br><span class="line">    options = <span class="title function_">extend</span>(&#123;&#125;, options)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// check cache</span></span><br><span class="line">    <span class="comment">// 检查缓存，有缓存直接用</span></span><br><span class="line">    <span class="keyword">const</span> key = options.<span class="property">delimiters</span></span><br><span class="line">      ? <span class="title class_">String</span>(options.<span class="property">delimiters</span>) + template</span><br><span class="line">      : template</span><br><span class="line">    <span class="keyword">if</span> (cache[key]) &#123;</span><br><span class="line">      <span class="keyword">return</span> cache[key]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// compile</span></span><br><span class="line">    <span class="comment">// compile 函数 是在 src\compiler\create-compiler.js 下，createCompilerCreator 中 return 的 createCompiler 的函数体中定义 </span></span><br><span class="line">    <span class="keyword">const</span> compiled = <span class="title function_">compile</span>(template, options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check compilation errors/tips</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// turn code into functions</span></span><br><span class="line">    <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> fnGenErrors = []</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * createFunction 核心 new Function(code)</span></span><br><span class="line"><span class="comment">     * 将 字符串 创建为 函数 </span></span><br><span class="line"><span class="comment">     * */</span> </span><br><span class="line">    <span class="comment">// render 创建好了</span></span><br><span class="line">    res.<span class="property">render</span> = <span class="title function_">createFunction</span>(compiled.<span class="property">render</span>, fnGenErrors)</span><br><span class="line">    res.<span class="property">staticRenderFns</span> = compiled.<span class="property">staticRenderFns</span>.<span class="title function_">map</span>(<span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">createFunction</span>(code, fnGenErrors)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check function generation errors.</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建好的 res 放在缓存</span></span><br><span class="line">    <span class="keyword">return</span> (cache[key] = res)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-原始-mount-方法（-platforms-web-runtime-index-）"><a href="#2-原始-mount-方法（-platforms-web-runtime-index-）" class="headerlink" title="2. 原始 $mount 方法（**platforms/web/runtime/index**）"></a>2. <strong>原始 $mount 方法（</strong><code>**platforms/web/runtime/index**</code><strong>）</strong></h1><p><strong>再调用 原始的 $mount 方法（</strong><code>**src/platforms/web/runtime/index.js**</code><strong>）, 获得元素，返回 mountComponent 方法</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/platforms/web/runtime/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; mountComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;core/instance/lifecycle&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// public mount method</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  <span class="comment">// 初始化挂载组件</span></span><br><span class="line">  el = el &amp;&amp; inBrowser ? <span class="title function_">query</span>(el) : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">mountComponent</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="mountComponent-this-el-hydrating-方法："><a href="#mountComponent-this-el-hydrating-方法：" class="headerlink" title="mountComponent(this, el, hydrating) 方法："></a><code>mountComponent(this, el, hydrating)</code> 方法：</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\lifecycle.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">mountComponent</span> (</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span><br><span class="line">  <span class="attr">el</span>: ?<span class="title class_">Element</span>,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): <span class="title class_">Component</span> &#123;</span><br><span class="line">  vm.<span class="property">$el</span> = el</span><br><span class="line">  <span class="comment">// 若没有获取解析的 render 函数，抛出警告</span></span><br><span class="line">  <span class="comment">// render 是解析模板生成的，</span></span><br><span class="line">  <span class="comment">// 在 /entry-runtime-with-Compiler.js 中 $mounted() , const &#123; render, staticRenderFns &#125; = compileToFunctions(template,&#123;&#125;) 生成的</span></span><br><span class="line">  <span class="keyword">if</span> (!vm.<span class="property">$options</span>.<span class="property">render</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeMount&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> updateComponent</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">    <span class="comment">// 支持performance的开发环境，添加关于 performance 的分析时间线</span></span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> name = vm.<span class="property">_name</span></span><br><span class="line">      <span class="keyword">const</span> id = vm.<span class="property">_uid</span></span><br><span class="line">      <span class="keyword">const</span> startTag = <span class="string">`vue-perf-start:<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">      <span class="keyword">const</span> endTag = <span class="string">`vue-perf-end:<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">      <span class="title function_">mark</span>(startTag)</span><br><span class="line">      <span class="keyword">const</span> vnode = vm.<span class="title function_">_render</span>()</span><br><span class="line">      <span class="title function_">mark</span>(endTag)</span><br><span class="line">      <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;name&#125;</span> render`</span>, startTag, endTag)</span><br><span class="line"></span><br><span class="line">      <span class="title function_">mark</span>(startTag)</span><br><span class="line">      vm.<span class="title function_">_update</span>(vnode, hydrating) <span class="comment">// 核心逻辑 同else的，vm._update(vm._render(), hydrating)</span></span><br><span class="line">      <span class="title function_">mark</span>(endTag)</span><br><span class="line">      <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;name&#125;</span> patch`</span>, startTag, endTag)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 生产环境环境 </span></span><br><span class="line">    <span class="comment">// vm._render 用于生成虚拟 DOM</span></span><br><span class="line">    <span class="comment">// _update 内部调用 patch 方法 将虚拟 DOM 与 真实的 DOM 同步 ( diff )</span></span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we set this to vm._watcher inside the watcher&#x27;s constructor</span></span><br><span class="line">  <span class="comment">// since the watcher&#x27;s initial patch may call $forceUpdate (e.g. inside child</span></span><br><span class="line">  <span class="comment">// component&#x27;s mounted hook), which relies on vm._watcher being already defined</span></span><br><span class="line">  <span class="comment">// 【new Watcher 初始化】监听当前组件状态，当有数据变化时，更新组件</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, updateComponent, noop, &#123;</span><br><span class="line">    before () &#123;</span><br><span class="line">      <span class="keyword">if</span> (vm.<span class="property">_isMounted</span> &amp;&amp; !vm.<span class="property">_isDestroyed</span>) &#123;</span><br><span class="line">        <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeUpdate&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>)</span><br><span class="line">  hydrating = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// manually mounted instance, call mounted on self</span></span><br><span class="line">  <span class="comment">// mounted is called for render-created child components in its inserted hook</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$vnode</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">    vm.<span class="property">_isMounted</span> = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;mounted&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-1-vm-render"><a href="#2-1-vm-render" class="headerlink" title="2.1 vm._render()"></a>2.1 <code>vm._render()</code></h2><p>vm._render <strong>用于生成虚拟 dom</strong>，执行 dom-diff，更新真实 dom</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\render.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initRender</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">    <span class="comment">// bind the createElement fn to this instance</span></span><br><span class="line">  <span class="comment">// so that we get proper render context inside it.</span></span><br><span class="line">  <span class="comment">// args order: tag, data, children, normalizationType, alwaysNormalize</span></span><br><span class="line">  <span class="comment">// internal version is used by render functions compiled from templates</span></span><br><span class="line">  vm.<span class="property">_c</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">false</span>)              <span class="comment">// 系统创建元素的 方法</span></span><br><span class="line">  <span class="comment">// normalization is always applied for the public version, used in</span></span><br><span class="line">  <span class="comment">// user-written render functions.</span></span><br><span class="line">  vm.<span class="property">$createElement</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">true</span>)   <span class="comment">// 用户提供了 render 属性时创建元素的方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_render</span> = <span class="keyword">function</span> (<span class="params"></span>): <span class="title class_">VNode</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> &#123; render, _parentVnode &#125; = vm.<span class="property">$options</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 执行 render 方法中的 createElement 参数就是 vm.$createElement，</span></span><br><span class="line">    <span class="comment">// vm.$createElement 方法是定义在 initRender 方法上</span></span><br><span class="line">    vnode = render.<span class="title function_">call</span>(vm.<span class="property">_renderProxy</span>, vm.<span class="property">$createElement</span>)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// createEmptyVNode 的核心  const node = new VNode()</span></span><br><span class="line">    vnode = <span class="title function_">createEmptyVNode</span>()</span><br><span class="line">    <span class="comment">// set parent</span></span><br><span class="line">    vnode.<span class="property">parent</span> = _parentVnode</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>initRender</code>,</p>
<p>这里 vm._c 和 vm.$createElement 的区别为：</p>
<p>vm._c 是被模板编译成的 render 函数使用；</p>
<p>vm.$createElement 是用户手写 render 方法使用的；</p>
<p>两个方法支持的参数相同，并且内部都调用了 createElement 方法</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657800175284-07e129c1-8412-46ed-a8eb-70fbe5d575b6.png" alt="img"></p>
<h3 id="2-1-1-VNode"><a href="#2-1-1-VNode" class="headerlink" title="2.1.1 VNode"></a>2.1.1 <code>VNode</code></h3><p>虚拟Dom 的类是 <code>VNode</code>，主要属性是：tag, data, children, text, elm, ns, context, key, parent, raw</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="attr">tag</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">data</span>: <span class="title class_">VNodeData</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">children</span>: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;;</span><br><span class="line">  <span class="attr">text</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">elm</span>: <span class="title class_">Node</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">ns</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">context</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// rendered in this component&#x27;s scope</span></span><br><span class="line">  <span class="attr">key</span>: string | number | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">componentOptions</span>: <span class="title class_">VNodeComponentOptions</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">componentInstance</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// component instance</span></span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">VNode</span> | <span class="keyword">void</span>; <span class="comment">// component placeholder node</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// strictly internal</span></span><br><span class="line">  <span class="attr">raw</span>: boolean; <span class="comment">// contains raw HTML? (server only)</span></span><br><span class="line">  <span class="attr">isStatic</span>: boolean; <span class="comment">// hoisted static node</span></span><br><span class="line">  <span class="attr">isRootInsert</span>: boolean; <span class="comment">// necessary for enter transition check</span></span><br><span class="line">  <span class="attr">isComment</span>: boolean; <span class="comment">// empty comment placeholder?</span></span><br><span class="line">  <span class="attr">isCloned</span>: boolean; <span class="comment">// is a cloned node?</span></span><br><span class="line">  <span class="attr">isOnce</span>: boolean; <span class="comment">// is a v-once node?</span></span><br><span class="line">  <span class="attr">asyncFactory</span>: <span class="title class_">Function</span> | <span class="keyword">void</span>; <span class="comment">// async component factory function</span></span><br><span class="line">  <span class="attr">asyncMeta</span>: <span class="title class_">Object</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">isAsyncPlaceholder</span>: boolean;</span><br><span class="line">  <span class="attr">ssrContext</span>: <span class="title class_">Object</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">fnContext</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// real context vm for functional nodes</span></span><br><span class="line">  <span class="attr">fnOptions</span>: ?<span class="title class_">ComponentOptions</span>; <span class="comment">// for SSR caching</span></span><br><span class="line">  <span class="attr">devtoolsMeta</span>: ?<span class="title class_">Object</span>; <span class="comment">// used to store functional render context for devtools</span></span><br><span class="line">  <span class="attr">fnScopeId</span>: ?string; <span class="comment">// functional scope id support</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (</span><br><span class="line">    tag?: string,</span><br><span class="line">    data?: <span class="title class_">VNodeData</span>,</span><br><span class="line">    children?: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;,</span><br><span class="line">    text?: string,</span><br><span class="line">    elm?: <span class="title class_">Node</span>,</span><br><span class="line">    context?: <span class="title class_">Component</span>,</span><br><span class="line">    componentOptions?: <span class="title class_">VNodeComponentOptions</span>,</span><br><span class="line">    asyncFactory?: <span class="title class_">Function</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tag</span> = tag</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = data</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">children</span> = children</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">text</span> = text</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">elm</span> = elm</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ns</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span> = context</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnContext</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnOptions</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnScopeId</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = data &amp;&amp; data.<span class="property">key</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentOptions</span> = componentOptions</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentInstance</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">raw</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStatic</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRootInsert</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isComment</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isCloned</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isOnce</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncFactory</span> = asyncFactory</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncMeta</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isAsyncPlaceholder</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// DEPRECATED: alias for componentInstance for backwards compat.</span></span><br><span class="line">  <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">  get child (): <span class="title class_">Component</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">componentInstance</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-vm-update"><a href="#2-2-vm-update" class="headerlink" title="2.2 vm._update()"></a>2.2 <code>vm._update()</code></h2><p>把 VNode 渲染成真实的 DOM。</p>
<p>被调用：</p>
<ul>
<li>mountComponent ，在初次渲染时</li>
<li>在 update 时</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\lifecycle.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">lifecycleMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_update</span> = <span class="keyword">function</span> (<span class="params">vnode: VNode, hydrating?: boolean</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">// 初次渲染</span></span><br><span class="line">    <span class="comment">// vm.__patch__ 方法：进行 dom diff 比较，然后更新 dom</span></span><br><span class="line">    <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">      <span class="comment">// initial render</span></span><br><span class="line">      vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(vm.<span class="property">$el</span>, vnode, hydrating, <span class="literal">false</span> <span class="comment">/* removeOnly */</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// updates</span></span><br><span class="line">      <span class="comment">// 更新</span></span><br><span class="line">      vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(prevVnode, vnode)</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-1-Vue-prototype-patch"><a href="#2-2-1-Vue-prototype-patch" class="headerlink" title="2.2.1 Vue.**prototype**.**__patch__**"></a>2.2.1 <code>Vue.**prototype**.**__patch__**</code></h3><p><code>__patch__</code>项目中有两种实现，区分于平台：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/platforms/web/runtime/index.js</span></span><br><span class="line"><span class="comment">// install platform patch function</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__patch__</span> = inBrowser ? patch : noop</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/platforms/weex/runtime/index.js</span></span><br><span class="line"><span class="comment">// install platform patch function</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__patch__</span> = patch</span><br></pre></td></tr></table></figure>

<h2 id="2-3-new-Watcher"><a href="#2-3-new-Watcher" class="headerlink" title="2.3 new Watcher"></a>2.3 <code>new Watcher</code></h2><p>关于 Watcher 见 <a target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/onzg44">05- Observer</a></p>
<h1 id="3-生成-AST"><a href="#3-生成-AST" class="headerlink" title="3. 生成 AST"></a>3. 生成 AST</h1><p>如下创建入口，引出 <code>parse</code>方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options)</span><br></pre></td></tr></table></figure>

<p>例： 如下模板 template：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;editor&quot;</span>&gt;</span><br><span class="line">  &lt;!-- 注释 --&gt;</span><br><span class="line">  &lt;试试\&lt;</span><br><span class="line">  &lt;p&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>li的值<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">:value</span>=<span class="string">&quot;input + new Date()&quot;</span> @<span class="attr">input</span>=<span class="string">&quot;update&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-html</span>=<span class="string">&quot;compiledMarkdown&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>生成的 AST 结构如下：</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657793256463-9f07c6aa-a310-4f26-b11a-046ff5be636c.png" alt="img"></p>
<h2 id="3-1-parse"><a href="#3-1-parse" class="headerlink" title="3.1 parse"></a>3.1 <code>parse</code></h2><p>分析源码，由 <code>parse</code> 引出 <code>parseHTML</code> ，</p>
<p>此处 template ：</p>
<p><strong>注意：在转字符串时：</strong></p>
<ul>
<li><strong>会 将类似</strong> <code>**&lt;**</code> <strong>直接转为</strong> <code>**&lt;**</code></li>
<li><strong>会将</strong><code>**&lt;p&gt;**</code> <strong>这样的自动补全为</strong> <code>**&lt;p&gt;&lt;/p&gt;**</code></li>
</ul>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657785219591-105ece0c-a99c-4215-b3e3-785f767b19ad.png" alt="img"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  src\compiler\parser\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert HTML string to AST.</span></span><br><span class="line"><span class="comment"> * 将 html 字符串 转换为 AST</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parse</span> (</span><br><span class="line">  <span class="attr">template</span>: string,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">ASTElement</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">const</span> stack = []</span><br><span class="line">  <span class="keyword">let</span> root</span><br><span class="line">  ...</span><br><span class="line">    <span class="title function_">parseHTML</span>(template, &#123;</span><br><span class="line">    warn,</span><br><span class="line">    <span class="attr">expectHTML</span>: options.<span class="property">expectHTML</span>,</span><br><span class="line">    <span class="attr">isUnaryTag</span>: options.<span class="property">isUnaryTag</span>,</span><br><span class="line">    <span class="attr">canBeLeftOpenTag</span>: options.<span class="property">canBeLeftOpenTag</span>,</span><br><span class="line">    <span class="attr">shouldDecodeNewlines</span>: options.<span class="property">shouldDecodeNewlines</span>,</span><br><span class="line">    <span class="attr">shouldDecodeNewlinesForHref</span>: options.<span class="property">shouldDecodeNewlinesForHref</span>,</span><br><span class="line">    <span class="attr">shouldKeepComment</span>: options.<span class="property">comments</span>,</span><br><span class="line">    <span class="attr">outputSourceRange</span>: options.<span class="property">outputSourceRange</span>,</span><br><span class="line">    start (tag, attrs, unary, start, end) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    end (tag, start, end) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    chars (<span class="attr">text</span>: string, <span class="attr">start</span>: number, <span class="attr">end</span>: number) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line">    comment (<span class="attr">text</span>: string, start, end) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-1-start"><a href="#3-1-1-start" class="headerlink" title="3.1.1 start"></a>3.1.1 <code>start</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">start (tag, attrs, unary, start, end) &#123;</span><br><span class="line">      <span class="comment">// start tag 开头标签回调后执行</span></span><br><span class="line">      <span class="comment">// check namespace.</span></span><br><span class="line">      <span class="comment">// inherit parent ns if there is one</span></span><br><span class="line">      <span class="keyword">const</span> ns = (currentParent &amp;&amp; currentParent.<span class="property">ns</span>) || <span class="title function_">platformGetTagNamespace</span>(tag)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// handle IE svg bug</span></span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (isIE &amp;&amp; ns === <span class="string">&#x27;svg&#x27;</span>) &#123;</span><br><span class="line">        attrs = <span class="title function_">guardIESVGBug</span>(attrs)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建 AST 节点</span></span><br><span class="line">      <span class="keyword">let</span> <span class="attr">element</span>: <span class="title class_">ASTElement</span> = <span class="title function_">createASTElement</span>(tag, attrs, currentParent)</span><br><span class="line">      <span class="keyword">if</span> (ns) &#123;</span><br><span class="line">        element.<span class="property">ns</span> = ns</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="comment">// apply pre-transforms</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; preTransforms.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        element = preTransforms[i](element, options) || element</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!inVPre) &#123;</span><br><span class="line">        <span class="title function_">processPre</span>(element)</span><br><span class="line">        <span class="keyword">if</span> (element.<span class="property">pre</span>) &#123;</span><br><span class="line">          inVPre = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">platformIsPreTag</span>(element.<span class="property">tag</span>)) &#123;</span><br><span class="line">        inPre = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (inVPre) &#123;</span><br><span class="line">        <span class="title function_">processRawAttrs</span>(element)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!element.<span class="property">processed</span>) &#123;</span><br><span class="line">        <span class="comment">// structural directives</span></span><br><span class="line">        <span class="comment">// 处理指令: v-for v-if v-once</span></span><br><span class="line">        <span class="title function_">processFor</span>(element)</span><br><span class="line">        <span class="title function_">processIf</span>(element)</span><br><span class="line">        <span class="title function_">processOnce</span>(element)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">        root = element</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">          <span class="title function_">checkRootConstraints</span>(root)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 闭合标签将 ast element 存入stack</span></span><br><span class="line">      <span class="keyword">if</span> (!unary) &#123;</span><br><span class="line">        currentParent = element</span><br><span class="line">        stack.<span class="title function_">push</span>(element)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 非闭合标签关闭元素</span></span><br><span class="line">        <span class="title function_">closeElement</span>(element)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<h4 id="3-1-1-1-createASTElement-AST-节点-结构"><a href="#3-1-1-1-createASTElement-AST-节点-结构" class="headerlink" title="3.1.1.1 createASTElement AST 节点 结构"></a>3.1.1.1 <code>createASTElement</code> AST 节点 结构</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\parser\index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createASTElement</span> (</span><br><span class="line">  <span class="attr">tag</span>: string,</span><br><span class="line">  <span class="attr">attrs</span>: <span class="title class_">Array</span>&lt;<span class="title class_">ASTAttr</span>&gt;,</span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">ASTElement</span> | <span class="keyword">void</span></span><br><span class="line">): <span class="title class_">ASTElement</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="number">1</span>, <span class="comment">// 节点类型</span></span><br><span class="line">    tag, <span class="comment">// 节点名称</span></span><br><span class="line">    <span class="attr">attrsList</span>: attrs, <span class="comment">// 属性列表</span></span><br><span class="line">    <span class="attr">attrsMap</span>: <span class="title function_">makeAttrsMap</span>(attrs), <span class="comment">// 属性 Map</span></span><br><span class="line">    <span class="attr">rawAttrsMap</span>: &#123;&#125;, <span class="comment">// </span></span><br><span class="line">    parent, <span class="comment">// 父节点</span></span><br><span class="line">    <span class="attr">children</span>: []  <span class="comment">// 子节点</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>【辅助】 <code>makeAttrsMap()</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回转换 attrs 后的map，key 是 attr[i].name, value 是 attrs[i].value</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeAttrsMap</span> (<span class="attr">attrs</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Object</span>&gt;): <span class="title class_">Object</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> map = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = attrs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">      map[attrs[i].<span class="property">name</span>] &amp;&amp; !isIE &amp;&amp; !isEdge</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(<span class="string">&#x27;duplicate attribute: &#x27;</span> + attrs[i].<span class="property">name</span>, attrs[i])</span><br><span class="line">    &#125;</span><br><span class="line">    map[attrs[i].<span class="property">name</span>] = attrs[i].<span class="property">value</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-2-end"><a href="#3-1-2-end" class="headerlink" title="3.1.2 end"></a>3.1.2 <code>end</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">end (tag, start, end) &#123;</span><br><span class="line">      <span class="comment">// end tag 结尾标签回调后执行</span></span><br><span class="line">      <span class="keyword">const</span> element = stack[stack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">      <span class="comment">// pop stack</span></span><br><span class="line">      <span class="comment">// 出栈，重置当前的父节点</span></span><br><span class="line">      stack.<span class="property">length</span> -= <span class="number">1</span></span><br><span class="line">      currentParent = stack[stack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">        element.<span class="property">end</span> = end</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">closeElement</span>(element)</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="3-1-3-chars"><a href="#3-1-3-chars" class="headerlink" title="3.1.3 chars"></a>3.1.3 <code>chars</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">chars (<span class="attr">text</span>: string, <span class="attr">start</span>: number, <span class="attr">end</span>: number) &#123;</span><br><span class="line">     <span class="comment">// 文本 回调后执行</span></span><br><span class="line">     <span class="comment">// 文本节点外如果没有父节点则不处理报错</span></span><br><span class="line">     <span class="keyword">if</span> (!currentParent) &#123;</span><br><span class="line">       <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (text === template) &#123;</span><br><span class="line">           <span class="title function_">warnOnce</span>(</span><br><span class="line">             <span class="string">&#x27;Component template requires a root element, rather than just text.&#x27;</span>,</span><br><span class="line">             &#123; start &#125;</span><br><span class="line">           )</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((text = text.<span class="title function_">trim</span>())) &#123;</span><br><span class="line">           <span class="title function_">warnOnce</span>(</span><br><span class="line">             <span class="string">`text &quot;<span class="subst">$&#123;text&#125;</span>&quot; outside root element will be ignored.`</span>,</span><br><span class="line">             &#123; start &#125;</span><br><span class="line">           )</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// IE textarea placeholder bug</span></span><br><span class="line">     <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">     <span class="keyword">if</span> (isIE &amp;&amp;</span><br><span class="line">       currentParent.<span class="property">tag</span> === <span class="string">&#x27;textarea&#x27;</span> &amp;&amp;</span><br><span class="line">       currentParent.<span class="property">attrsMap</span>.<span class="property">placeholder</span> === text</span><br><span class="line">     ) &#123;</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">const</span> children = currentParent.<span class="property">children</span></span><br><span class="line">     <span class="keyword">if</span> (inPre || text.<span class="title function_">trim</span>()) &#123;</span><br><span class="line">       text = <span class="title function_">isTextTag</span>(currentParent) ? text : <span class="title function_">decodeHTMLCached</span>(text)</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!children.<span class="property">length</span>) &#123;</span><br><span class="line">       <span class="comment">// remove the whitespace-only node right after an opening tag</span></span><br><span class="line">       text = <span class="string">&#x27;&#x27;</span></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (whitespaceOption) &#123;</span><br><span class="line">       <span class="keyword">if</span> (whitespaceOption === <span class="string">&#x27;condense&#x27;</span>) &#123;</span><br><span class="line">         <span class="comment">// in condense mode, remove the whitespace node if it contains</span></span><br><span class="line">         <span class="comment">// line break, otherwise condense to a single space</span></span><br><span class="line">         text = lineBreakRE.<span class="title function_">test</span>(text) ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; &#x27;</span></span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         text = <span class="string">&#x27; &#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       text = preserveWhitespace ? <span class="string">&#x27; &#x27;</span> : <span class="string">&#x27;&#x27;</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (text) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!inPre &amp;&amp; whitespaceOption === <span class="string">&#x27;condense&#x27;</span>) &#123;</span><br><span class="line">         <span class="comment">// condense consecutive whitespaces into single space</span></span><br><span class="line">         text = text.<span class="title function_">replace</span>(whitespaceRE, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">let</span> res</span><br><span class="line">       <span class="keyword">let</span> <span class="attr">child</span>: ?<span class="title class_">ASTNode</span></span><br><span class="line">       <span class="keyword">if</span> (!inVPre &amp;&amp; text !== <span class="string">&#x27; &#x27;</span> &amp;&amp; (res = <span class="title function_">parseText</span>(text, delimiters))) &#123;</span><br><span class="line">         <span class="comment">// 表达式</span></span><br><span class="line">         child = &#123;</span><br><span class="line">           <span class="attr">type</span>: <span class="number">2</span>,</span><br><span class="line">           <span class="attr">expression</span>: res.<span class="property">expression</span>,</span><br><span class="line">           <span class="attr">tokens</span>: res.<span class="property">tokens</span>,</span><br><span class="line">           text</span><br><span class="line">         &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (text !== <span class="string">&#x27; &#x27;</span> || !children.<span class="property">length</span> || children[children.<span class="property">length</span> - <span class="number">1</span>].<span class="property">text</span> !== <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">         <span class="comment">// 静态文本</span></span><br><span class="line">         child = &#123;</span><br><span class="line">           <span class="attr">type</span>: <span class="number">3</span>,</span><br><span class="line">           text</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (child) &#123;</span><br><span class="line">         <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">           child.<span class="property">start</span> = start</span><br><span class="line">           child.<span class="property">end</span> = end</span><br><span class="line">         &#125;</span><br><span class="line">         children.<span class="title function_">push</span>(child)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="3-1-4-comment"><a href="#3-1-4-comment" class="headerlink" title="3.1.4 comment"></a>3.1.4 <code>comment</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">comment (<span class="attr">text</span>: string, start, end) &#123;</span><br><span class="line">      <span class="comment">// 注释代码 回调后执行</span></span><br><span class="line">      <span class="comment">// adding anything as a sibling to the root node is forbidden</span></span><br><span class="line">      <span class="comment">// comments should still be allowed, but ignored</span></span><br><span class="line">      <span class="keyword">if</span> (currentParent) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">child</span>: <span class="title class_">ASTText</span> = &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="number">3</span>,</span><br><span class="line">          text,</span><br><span class="line">          <span class="attr">isComment</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">          child.<span class="property">start</span> = start</span><br><span class="line">          child.<span class="property">end</span> = end</span><br><span class="line">        &#125;</span><br><span class="line">        currentParent.<span class="property">children</span>.<span class="title function_">push</span>(child)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-parseHTML"><a href="#3-2-parseHTML" class="headerlink" title="3.2 parseHTML()"></a>3.2 <code>parseHTML()</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src\compiler\parser\html-parser.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据 options ，对 html字符串 遍历，生成核心参数 match, attrs,</span></span><br><span class="line"><span class="comment"> * 再通过如 options.start(tagName, attrs, unary, match.start, match.end) 回调 parse 中的start, end, chars, comment 方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; html </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; options </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">  <span class="keyword">const</span> stack = [] <span class="comment">// 存 非单标签</span></span><br><span class="line">  <span class="keyword">const</span> expectHTML = options.<span class="property">expectHTML</span></span><br><span class="line">  <span class="keyword">const</span> isUnaryTag = options.<span class="property">isUnaryTag</span> || no</span><br><span class="line">  <span class="keyword">const</span> canBeLeftOpenTag = options.<span class="property">canBeLeftOpenTag</span> || no</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> last, lastTag</span><br><span class="line">  <span class="comment">// 通过 advance 方法递减 html 字符串，直至html为空表示将html全部遍历，结束循环</span></span><br><span class="line">  <span class="keyword">while</span> (html) &#123;</span><br><span class="line">    last = html</span><br><span class="line">    <span class="comment">// Make sure we&#x27;re not in a plaintext content element like script/style</span></span><br><span class="line">    <span class="keyword">if</span> (!lastTag || !<span class="title function_">isPlainTextElement</span>(lastTag)) &#123;</span><br><span class="line">      <span class="keyword">let</span> textEnd = html.<span class="title function_">indexOf</span>(<span class="string">&#x27;&lt;&#x27;</span>)</span><br><span class="line">      <span class="comment">// 以 &lt; 开头</span></span><br><span class="line">      <span class="keyword">if</span> (textEnd === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Comment:</span></span><br><span class="line">        <span class="comment">// 匹配 &lt;!-- 开头  (/^&lt;!\--/ )</span></span><br><span class="line">        <span class="keyword">if</span> (comment.<span class="title function_">test</span>(html)) &#123;</span><br><span class="line">          <span class="keyword">const</span> commentEnd = html.<span class="title function_">indexOf</span>(<span class="string">&#x27;--&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 匹配到注释 &lt;!--  --&gt;</span></span><br><span class="line">          <span class="keyword">if</span> (commentEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (options.<span class="property">shouldKeepComment</span>) &#123;</span><br><span class="line">              <span class="comment">// options.comment 回调</span></span><br><span class="line">              options.<span class="title function_">comment</span>(html.<span class="title function_">substring</span>(<span class="number">4</span>, commentEnd), index, index + commentEnd + <span class="number">3</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 截取 注释结束位+3 后 html 片段 ，相当于 参数html 删掉 已匹配的 注释 字符串</span></span><br><span class="line">            <span class="title function_">advance</span>(commentEnd + <span class="number">3</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// http://en.wikipedia.org/wiki/Conditional_comment#Downlevel-revealed_conditional_comment</span></span><br><span class="line">        <span class="comment">// 匹配 条件注释 ![ 开头   /^&lt;!\[/</span></span><br><span class="line">        <span class="keyword">if</span> (conditionalComment.<span class="title function_">test</span>(html)) &#123;</span><br><span class="line">          <span class="keyword">const</span> conditionalEnd = html.<span class="title function_">indexOf</span>(<span class="string">&#x27;]&gt;&#x27;</span>)</span><br><span class="line">          <span class="comment">// 匹配到条件注释 &lt;![]&gt; , 如 ![if !IE]</span></span><br><span class="line">          <span class="keyword">if</span> (conditionalEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="title function_">advance</span>(conditionalEnd + <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Doctype:</span></span><br><span class="line">        <span class="comment">// 匹配到 &lt;!DOCTYPE &gt; 删掉</span></span><br><span class="line">        <span class="keyword">const</span> doctypeMatch = html.<span class="title function_">match</span>(doctype)</span><br><span class="line">        <span class="keyword">if</span> (doctypeMatch) &#123;</span><br><span class="line">          <span class="title function_">advance</span>(doctypeMatch[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// End tag:</span></span><br><span class="line">        <span class="comment">// 匹配 &lt;/ **&gt; 结束标签</span></span><br><span class="line">        <span class="keyword">const</span> endTagMatch = html.<span class="title function_">match</span>(endTag)</span><br><span class="line">        <span class="keyword">if</span> (endTagMatch) &#123;</span><br><span class="line">          <span class="keyword">const</span> curIndex = index</span><br><span class="line">          <span class="title function_">advance</span>(endTagMatch[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">          <span class="title function_">parseEndTag</span>(endTagMatch[<span class="number">1</span>], curIndex, index)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start tag:</span></span><br><span class="line">        <span class="comment">// 匹配 &lt;**&gt; 开始标签</span></span><br><span class="line">        <span class="keyword">const</span> startTagMatch = <span class="title function_">parseStartTag</span>()</span><br><span class="line">        <span class="keyword">if</span> (startTagMatch) &#123;</span><br><span class="line">          <span class="title function_">handleStartTag</span>(startTagMatch)</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">shouldIgnoreFirstNewline</span>(startTagMatch.<span class="property">tagName</span>, html)) &#123;</span><br><span class="line">            <span class="title function_">advance</span>(<span class="number">1</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> text, rest, next</span><br><span class="line">      <span class="comment">// 参数html 中有 &lt;</span></span><br><span class="line">      <span class="keyword">if</span> (textEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        rest = html.<span class="title function_">slice</span>(textEnd)</span><br><span class="line">        <span class="comment">// 根据这些判断条件知，这个 if 部分的 &lt; 是文本 &lt;</span></span><br><span class="line">        <span class="comment">// 循环 &lt; 后的字符串</span></span><br><span class="line">        <span class="keyword">while</span> (</span><br><span class="line">          !endTag.<span class="title function_">test</span>(rest) &amp;&amp;</span><br><span class="line">          !startTagOpen.<span class="title function_">test</span>(rest) &amp;&amp;</span><br><span class="line">          !comment.<span class="title function_">test</span>(rest) &amp;&amp;</span><br><span class="line">          !conditionalComment.<span class="title function_">test</span>(rest)</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="comment">// &lt; in plain text, be forgiving and treat it as text</span></span><br><span class="line">          next = rest.<span class="title function_">indexOf</span>(<span class="string">&#x27;&lt;&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">if</span> (next &lt; <span class="number">0</span>) <span class="keyword">break</span></span><br><span class="line">          textEnd += next</span><br><span class="line">          rest = html.<span class="title function_">slice</span>(textEnd)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据实践，页面中直接写的&lt;,变成字符串html后，会被转换为 &amp;lt; 并不会进上方的 while 循环</span></span><br><span class="line">        <span class="comment">// text 获取的是普通文本</span></span><br><span class="line">        text = html.<span class="title function_">substring</span>(<span class="number">0</span>, textEnd)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 参数html 中没有 &lt;</span></span><br><span class="line">      <span class="keyword">if</span> (textEnd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        text = html</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (text) &#123;</span><br><span class="line">        <span class="title function_">advance</span>(text.<span class="property">length</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果存在 text 文本，则处理 普通文本 的回调</span></span><br><span class="line">      <span class="comment">// 调用 options.chars 回调</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">chars</span> &amp;&amp; text) &#123;</span><br><span class="line">        options.<span class="title function_">chars</span>(text, index - text.<span class="property">length</span>, index)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 处理结束标签</span></span><br><span class="line">      <span class="keyword">let</span> endTagLength = <span class="number">0</span></span><br><span class="line">      <span class="keyword">const</span> stackedTag = lastTag.<span class="title function_">toLowerCase</span>()</span><br><span class="line">      <span class="keyword">const</span> reStackedTag = reCache[stackedTag] || (reCache[stackedTag] = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&#x27;([\\s\\S]*?)(&lt;/&#x27;</span> + stackedTag + <span class="string">&#x27;[^&gt;]*&gt;)&#x27;</span>, <span class="string">&#x27;i&#x27;</span>))</span><br><span class="line">      <span class="keyword">const</span> rest = html.<span class="title function_">replace</span>(reStackedTag, <span class="keyword">function</span> (<span class="params">all, text, endTag</span>) &#123;</span><br><span class="line">        endTagLength = endTag.<span class="property">length</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">isPlainTextElement</span>(stackedTag) &amp;&amp; stackedTag !== <span class="string">&#x27;noscript&#x27;</span>) &#123;</span><br><span class="line">          text = text</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&lt;!\--([\s\S]*?)--&gt;/g</span>, <span class="string">&#x27;$1&#x27;</span>) <span class="comment">// #7298</span></span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&lt;!\[CDATA\[([\s\S]*?)]]&gt;/g</span>, <span class="string">&#x27;$1&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">shouldIgnoreFirstNewline</span>(stackedTag, text)) &#123;</span><br><span class="line">          text = text.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">chars</span>) &#123;</span><br><span class="line">          options.<span class="title function_">chars</span>(text)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line">      index += html.<span class="property">length</span> - rest.<span class="property">length</span></span><br><span class="line">      html = rest</span><br><span class="line">      <span class="title function_">parseEndTag</span>(stackedTag, index - endTagLength, index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (html === last) &#123;</span><br><span class="line">      options.<span class="property">chars</span> &amp;&amp; options.<span class="title function_">chars</span>(html)</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !stack.<span class="property">length</span> &amp;&amp; options.<span class="property">warn</span>) &#123;</span><br><span class="line">        options.<span class="title function_">warn</span>(<span class="string">`Mal-formatted tag at end of template: &quot;<span class="subst">$&#123;html&#125;</span>&quot;`</span>, &#123; <span class="attr">start</span>: index + html.<span class="property">length</span> &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clean up any remaining tags</span></span><br><span class="line">  <span class="title function_">parseEndTag</span>()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-1-advance"><a href="#3-2-1-advance" class="headerlink" title="3.2.1 advance"></a>3.2.1 <code>advance</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 截取 index + n 后的 html （即删除掉 n 前的字符串）</span></span><br><span class="line"><span class="comment">   * 处理后的标签从html中删除，index 位置相应后移n</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"></span>&#125; <span class="variable">n</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">advance</span> (n) &#123;</span><br><span class="line">    index += n</span><br><span class="line">    html = html.<span class="title function_">substring</span>(n)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-parseStartTag"><a href="#3-2-2-parseStartTag" class="headerlink" title="3.2.2  parseStartTag"></a>3.2.2  <code>parseStartTag</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理 开始标签 ，将 html 转换为 对象match 格式</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">parseStartTag</span> () &#123;</span><br><span class="line">    <span class="keyword">const</span> start = html.<span class="title function_">match</span>(startTagOpen)</span><br><span class="line">    <span class="keyword">if</span> (start) &#123;</span><br><span class="line">      <span class="keyword">const</span> match = &#123;</span><br><span class="line">        <span class="attr">tagName</span>: start[<span class="number">1</span>],</span><br><span class="line">        <span class="attr">attrs</span>: [],</span><br><span class="line">        <span class="attr">start</span>: index</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">advance</span>(start[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">      <span class="keyword">let</span> end, attr</span><br><span class="line">      <span class="comment">// 把 标签内 属性赋值给match</span></span><br><span class="line">      <span class="keyword">while</span> (!(end = html.<span class="title function_">match</span>(startTagClose)) &amp;&amp; (attr = html.<span class="title function_">match</span>(dynamicArgAttribute) || html.<span class="title function_">match</span>(attribute))) &#123;</span><br><span class="line">        attr.<span class="property">start</span> = index</span><br><span class="line">        <span class="title function_">advance</span>(attr[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">        attr.<span class="property">end</span> = index</span><br><span class="line">        match.<span class="property">attrs</span>.<span class="title function_">push</span>(attr)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果有 结束 的标签</span></span><br><span class="line">      <span class="keyword">if</span> (end) &#123;</span><br><span class="line">        match.<span class="property">unarySlash</span> = end[<span class="number">1</span>]</span><br><span class="line">        <span class="comment">// 清掉此句 ，随遍历，随清除</span></span><br><span class="line">        <span class="title function_">advance</span>(end[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">        match.<span class="property">end</span> = index</span><br><span class="line">        <span class="keyword">return</span> match</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例：遍历到 <code>&lt;textarea :value=&quot;input + newDate()&quot; @input=&quot;update&quot;&gt;</code>，<code>parseStartTag()</code> 得到的 match如下图：</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657791625682-d817e676-e28a-4c56-99a1-e8e894bc8180.png" alt="img"></p>
<h3 id="3-2-3-handleStartTag"><a href="#3-2-3-handleStartTag" class="headerlink" title="3.2.3 handleStartTag"></a>3.2.3 <code>handleStartTag</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理 参数match，得到新格式 attrs，</span></span><br><span class="line"><span class="comment">   * 未闭合标签入栈，</span></span><br><span class="line"><span class="comment">   * 回调 start</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; match </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">handleStartTag</span> (match) &#123;</span><br><span class="line">    <span class="keyword">const</span> tagName = match.<span class="property">tagName</span></span><br><span class="line">    <span class="keyword">const</span> unarySlash = match.<span class="property">unarySlash</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (expectHTML) &#123;</span><br><span class="line">      <span class="keyword">if</span> (lastTag === <span class="string">&#x27;p&#x27;</span> &amp;&amp; <span class="title function_">isNonPhrasingTag</span>(tagName)) &#123;</span><br><span class="line">        <span class="title function_">parseEndTag</span>(lastTag)</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">/*       export const canBeLeftOpenTag = makeMap(</span></span><br><span class="line"><span class="comment">        &#x27;colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr,source&#x27;</span></span><br><span class="line"><span class="comment">      ) */</span></span><br><span class="line">      <span class="comment">// 针对可以省略 结果标签 的，自动当作已有结尾标签进行处理</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">canBeLeftOpenTag</span>(tagName) &amp;&amp; lastTag === tagName) &#123;</span><br><span class="line">        <span class="title function_">parseEndTag</span>(tagName)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> unary = <span class="title function_">isUnaryTag</span>(tagName) || !!unarySlash</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历处理 attrs 按照新格式</span></span><br><span class="line">    <span class="keyword">const</span> l = match.<span class="property">attrs</span>.<span class="property">length</span></span><br><span class="line">    <span class="keyword">const</span> attrs = <span class="keyword">new</span> <span class="title class_">Array</span>(l)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> args = match.<span class="property">attrs</span>[i]</span><br><span class="line">      <span class="comment">// 这里的 3、4、5 分别对应三种不同复制属性的方式</span></span><br><span class="line">      <span class="comment">// 3: attr=&quot;xxx&quot; 双引号</span></span><br><span class="line">      <span class="comment">// 4: attr=&#x27;xxx&#x27; 单引号</span></span><br><span class="line">      <span class="comment">// 5: attr=xxx   省略引号</span></span><br><span class="line">      <span class="keyword">const</span> value = args[<span class="number">3</span>] || args[<span class="number">4</span>] || args[<span class="number">5</span>] || <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="keyword">const</span> shouldDecodeNewlines = tagName === <span class="string">&#x27;a&#x27;</span> &amp;&amp; args[<span class="number">1</span>] === <span class="string">&#x27;href&#x27;</span></span><br><span class="line">        ? options.<span class="property">shouldDecodeNewlinesForHref</span></span><br><span class="line">        : options.<span class="property">shouldDecodeNewlines</span></span><br><span class="line">      attrs[i] = &#123;</span><br><span class="line">        <span class="attr">name</span>: args[<span class="number">1</span>],</span><br><span class="line">        <span class="attr">value</span>: <span class="title function_">decodeAttr</span>(value, shouldDecodeNewlines)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">        attrs[i].<span class="property">start</span> = args.<span class="property">start</span> + args[<span class="number">0</span>].<span class="title function_">match</span>(<span class="regexp">/^\s*/</span>).<span class="property">length</span></span><br><span class="line">        attrs[i].<span class="property">end</span> = args.<span class="property">end</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!unary) &#123;</span><br><span class="line">      <span class="comment">// 非单标签，入栈</span></span><br><span class="line">      stack.<span class="title function_">push</span>(&#123; <span class="attr">tag</span>: tagName, <span class="attr">lowerCasedTag</span>: tagName.<span class="title function_">toLowerCase</span>(), <span class="attr">attrs</span>: attrs, <span class="attr">start</span>: match.<span class="property">start</span>, <span class="attr">end</span>: match.<span class="property">end</span> &#125;)</span><br><span class="line">      lastTag = tagName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">start</span>) &#123;</span><br><span class="line">      <span class="comment">// 回调 start</span></span><br><span class="line">      options.<span class="title function_">start</span>(tagName, attrs, unary, match.<span class="property">start</span>, match.<span class="property">end</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例：遍历到 <code>&lt;textarea :value=&quot;input + newDate()&quot; @input=&quot;update&quot;&gt;</code>，<code>handleStartTag()</code> 得到的 <code>attrs</code>如下图：</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657791747470-3a4ab7c5-48a7-4584-abc5-3f1545ce6a2f.png" alt="img"></p>
<h3 id="3-2-4-parseEndTag"><a href="#3-2-4-parseEndTag" class="headerlink" title="3.2.4 parseEndTag"></a>3.2.4 <code>parseEndTag</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理结束标签：</span></span><br><span class="line"><span class="comment">   * 先找未闭合标签的位置pos，回调 end，并在栈中删除已关闭标签</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; tagName </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; start </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; end </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">parseEndTag</span> (tagName, start, end) &#123;</span><br><span class="line">    <span class="keyword">let</span> pos, lowerCasedTagName</span><br><span class="line">    <span class="keyword">if</span> (start == <span class="literal">null</span>) start = index</span><br><span class="line">    <span class="keyword">if</span> (end == <span class="literal">null</span>) end = index</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the closest opened tag of the same type</span></span><br><span class="line">    <span class="keyword">if</span> (tagName) &#123;</span><br><span class="line">      lowerCasedTagName = tagName.<span class="title function_">toLowerCase</span>()</span><br><span class="line">      <span class="comment">// 寻找相同类型的未闭合标签的位置 pos</span></span><br><span class="line">      <span class="keyword">for</span> (pos = stack.<span class="property">length</span> - <span class="number">1</span>; pos &gt;= <span class="number">0</span>; pos--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stack[pos].<span class="property">lowerCasedTag</span> === lowerCasedTagName) &#123;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// If no tag name is provided, clean shop</span></span><br><span class="line">      pos = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Close all the open elements, up the stack</span></span><br><span class="line">      <span class="comment">// 有 pos 位置，如果能和 未闭合stack 栈中匹配（即 stack.length - 1 == pos），则回调 end</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = stack.<span class="property">length</span> - <span class="number">1</span>; i &gt;= pos; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">          (i &gt; pos || !tagName) &amp;&amp;</span><br><span class="line">          options.<span class="property">warn</span></span><br><span class="line">        ) &#123;</span><br><span class="line">          options.<span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`tag &lt;<span class="subst">$&#123;stack[i].tag&#125;</span>&gt; has no matching end tag.`</span>,</span><br><span class="line">            &#123; <span class="attr">start</span>: stack[i].<span class="property">start</span>, <span class="attr">end</span>: stack[i].<span class="property">end</span> &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">end</span>) &#123;</span><br><span class="line">          options.<span class="title function_">end</span>(stack[i].<span class="property">tag</span>, start, end)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Remove the open elements from the stack</span></span><br><span class="line">      <span class="comment">// 并在栈中删除已关闭标签</span></span><br><span class="line">      stack.<span class="property">length</span> = pos</span><br><span class="line">      lastTag = pos &amp;&amp; stack[pos - <span class="number">1</span>].<span class="property">tag</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lowerCasedTagName === <span class="string">&#x27;br&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">start</span>) &#123;</span><br><span class="line">        options.<span class="title function_">start</span>(tagName, [], <span class="literal">true</span>, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lowerCasedTagName === <span class="string">&#x27;p&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">start</span>) &#123;</span><br><span class="line">        options.<span class="title function_">start</span>(tagName, [], <span class="literal">false</span>, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">end</span>) &#123;</span><br><span class="line">        options.<span class="title function_">end</span>(tagName, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-optimize"><a href="#4-optimize" class="headerlink" title="4. optimize()"></a>4. <code>optimize()</code></h1><p>同 3 中模板，</p>
<p>如下创建入口，引出 <code>optimize</code>方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">optimize</span>(ast, options)</span><br></pre></td></tr></table></figure>

<p>得到 ast 结构如下图：</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657792178113-75f71a19-6e80-4005-a2b6-ae44cbe3057e.png" alt="img"></p>
<p>对比上一步的ast，多了一个 static，staticRoot。</p>
<p>具体原因，之后再继续琢磨。</p>
<h1 id="5-generate"><a href="#5-generate" class="headerlink" title="5. generate()"></a>5. <code>generate()</code></h1><p>同 3 中模板，</p>
<p>如下创建入口，引出 <code>generate</code>方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="title function_">generate</span>(ast, options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>得到 code 如下图：</p>
<p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657798847942-c8230cb1-d174-49b3-9dd1-0a76bf3d767a.png" alt="img"></p>
<h2 id="render-创建了！"><a href="#render-创建了！" class="headerlink" title="render 创建了！"></a>render 创建了！</h2><h2 id="render-的结构："><a href="#render-的结构：" class="headerlink" title="render 的结构："></a><code>render</code> 的结构：</h2><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657798935121-e07f3e38-a733-49b2-bf8f-f01a761124e5.png" alt="img"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">`with(this)&#123;</span></span><br><span class="line"><span class="string">    return_c(&#x27;div&#x27;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        attrs: &#123;</span></span><br><span class="line"><span class="string">            &quot;id&quot;: &quot;editor&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    [</span></span><br><span class="line"><span class="string">        _v(&quot;\\n      &lt;试试\\\\&lt;\\n      &quot;),</span></span><br><span class="line"><span class="string">        _c(&#x27;textarea&#x27;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            domProps: &#123;</span></span><br><span class="line"><span class="string">                &quot;value&quot;: input+newDate()</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            on: &#123;</span></span><br><span class="line"><span class="string">                &quot;input&quot;: update</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;),</span></span><br><span class="line"><span class="string">        _v(&quot; &quot;),</span></span><br><span class="line"><span class="string">        _c(&#x27;div&#x27;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            domProps: &#123;</span></span><br><span class="line"><span class="string">                &quot;innerHTML&quot;: _s(compiledMarkdown)</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;)</span></span><br><span class="line"><span class="string">    ])</span></span><br><span class="line"><span class="string">&#125;`</span></span><br></pre></td></tr></table></figure>

<p>这里的 _c 对应的是虚拟 DOM 中的 createElement 方法。</p>
<p>其他的下划线方法在 core&#x2F;instance&#x2F;render-helpers 中都有定义。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7064788398304657415">https://juejin.cn/post/7064788398304657415</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6863241580753616903">https://juejin.cn/post/6863241580753616903</a></p>
<p><strong>着重记下这位大佬推荐的</strong> <a href="https://link.juejin.cn/?target=https://jex.im/regulex/"><strong>正则可视化工具</strong></a> <strong>(๑•̀ㅂ•́)و✧</strong></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-06-28</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约5066个字, 16分钟53秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/105-observer-Dep-Watcher/">observer/Dep/Watcher</a></h3></div><div class="post-content"><div class="card"><p><h1 id="1-Observer"><a href="#1-Observer" class="headerlink" title="1. Observer"></a>1. Observer</h1><p><strong>【前情回顾】</strong></p>
<p><code>observe()</code> 方法路径：<code>src\core\observer\index.js</code><br><img src="/105-observer-Dep-Watcher/1657836607196-542a783f-2ae7-40e0-a62c-d53b407943ab.png" alt="img"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\index.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Vue</span> (options) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_init</span>(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src\core\instance\init.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options?: <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">    <span class="title function_">initState</span>(vm)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initState</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">data</span>) &#123;</span><br><span class="line">    <span class="title function_">initData</span>(vm)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">observe</span>(vm.<span class="property">_data</span> = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initData</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> data = vm.<span class="property">$options</span>.<span class="property">data</span></span><br><span class="line">  <span class="title function_">observe</span>(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-1-observe"><a href="#1-1-observe" class="headerlink" title="1.1 observe()"></a>1.1 <code>observe()</code></h2><p>对 vm.$options.data 进行响应式处理的入口方法。</p>
<p><strong>核心</strong>就是对符合响应式条件的 value 创建 new Observer 实例。</p>
<p><strong>流程：</strong></p>
<ul>
<li>若 value （vm.options.$data）不是对象或是 Vnode 的实例，则不处理直接 return</li>
<li>若 value 包含属性<code>__ob__</code>，且<code>value.__ob__</code>是 Observer 的实例 (<code>__ob__</code>是 Vue 中响应式对象的 标记 )，则返回已存在的响应式对象</li>
<li>若没有包含<code>__ob__</code>,  则调用 <code>new Observer(value)</code>，创建 响应式对象 实例</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\index.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Attempt to create an observer instance for a value,</span></span><br><span class="line"><span class="comment"> * returns the new observer if successfully observed,</span></span><br><span class="line"><span class="comment"> * or the existing observer if the value already has one.</span></span><br><span class="line"><span class="comment"> * 为 vm.$options.data 创建一个 observer 实例</span></span><br><span class="line"><span class="comment"> * 如果是可响应式的，则返回一个新实例；若已经存在则返回已有实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">observe</span> (<span class="attr">value</span>: any, <span class="attr">asRootData</span>: ?boolean): <span class="title class_">Observer</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// 如果不是对象，或者是 VNode，则不进行响应处理</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(value) || value <span class="keyword">instanceof</span> <span class="title class_">VNode</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">ob</span>: <span class="title class_">Observer</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="comment">// 若本身就是响应式对象则直接返回该实例 value.__ob__</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">hasOwn</span>(value, <span class="string">&#x27;__ob__&#x27;</span>) &amp;&amp; value.<span class="property">__ob__</span> <span class="keyword">instanceof</span> <span class="title class_">Observer</span>) &#123;</span><br><span class="line">    ob = value.<span class="property">__ob__</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    shouldObserve &amp;&amp;</span><br><span class="line">    !<span class="title function_">isServerRendering</span>() &amp;&amp;</span><br><span class="line">    (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value) || <span class="title function_">isPlainObject</span>(value)) &amp;&amp;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">isExtensible</span>(value) &amp;&amp;</span><br><span class="line">    !value.<span class="property">_isVue</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 符合 可响应处理的标志 &amp;&amp; 不是SSR &amp; (数组 || 对象) &amp; 对象可扩展 &amp; 不是 Vue 实例本身，则进行响应式处理</span></span><br><span class="line">    ob = <span class="keyword">new</span> <span class="title class_">Observer</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 每个组件只能有一个根元素，若多个则标记，后续判断时有警告</span></span><br><span class="line">  <span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.<span class="property">vmCount</span>++</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-1-1-new-Observer-value"><a href="#1-1-1-new-Observer-value" class="headerlink" title="1.1.1 new Observer(value)"></a>1.1.1 <code>new Observer(value)</code></h2><p>创建响应式实例，</p>
<p><strong>流程：</strong></p>
<ul>
<li>初始化 value，dep，__ob__，vmCount</li>
<li>若 value 是数组，先对数组原型方法进行响应式处理，再遍历递归至对象，再响应式处理</li>
<li>若 value 是对象，则直接 调用 defineReactive() 进行响应式处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">  <span class="attr">value</span>: any;</span><br><span class="line">  <span class="attr">dep</span>: <span class="title class_">Dep</span>;</span><br><span class="line">  <span class="attr">vmCount</span>: number; <span class="comment">// number of vms that have this object as root $data</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (<span class="attr">value</span>: any) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = value <span class="comment">// 相当于 this.value = vm.options.$data</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dep</span> = <span class="keyword">new</span> <span class="title class_">Dep</span>() <span class="comment">// Dep 创建了</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vmCount</span> = <span class="number">0</span> <span class="comment">// 为0，说明是根实例只有一个，符合规范</span></span><br><span class="line">    <span class="title function_">def</span>(value, <span class="string">&#x27;__ob__&#x27;</span>, <span class="variable language_">this</span>) <span class="comment">// 相当于 value.__ob__ = this，循环引用: 对象.__ob__ </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数组的响应式处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">      <span class="comment">// 判断浏览器是否支持 __prop__</span></span><br><span class="line">      <span class="comment">// 对数组 原型方法 进行响应式处理！</span></span><br><span class="line">      <span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">        <span class="comment">// 相当于 value.__proto__ = arrayMethods</span></span><br><span class="line">        <span class="title function_">protoAugment</span>(value, arrayMethods)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">copyAugment</span>(value, arrayMethods, arrayKeys)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 遍历递归数组的元素，对数组每一项进行递归响应式处理</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">observeArray</span>(value)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 遍历对象的属性, 进行响应式处理</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">walk</span>(value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Walk through all properties and convert them into</span></span><br><span class="line"><span class="comment">   * getter/setters. This method should only be called when</span></span><br><span class="line"><span class="comment">   * value type is Object.</span></span><br><span class="line"><span class="comment">   * 遍历对象，循环进行响应式 defineReactive 处理</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  walk (<span class="attr">obj</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="title function_">defineReactive</span>(obj, keys[i]) <span class="comment">// 响应式处理来了</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Observe a list of Array items.</span></span><br><span class="line"><span class="comment">   * 遍历递归数组，调用响应式方法</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  observeArray (<span class="attr">items</span>: <span class="title class_">Array</span>&lt;any&gt;) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = items.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="title function_">observe</span>(items[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="【辅助】def"><a href="#【辅助】def" class="headerlink" title="【辅助】def"></a>【辅助】<code>def</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\util\lang.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define a property.</span></span><br><span class="line"><span class="comment"> * 相当于 obj.key = val</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">def</span> (<span class="attr">obj</span>: <span class="title class_">Object</span>, <span class="attr">key</span>: string, <span class="attr">val</span>: any, enumerable?: boolean) &#123;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">    <span class="attr">value</span>: val,</span><br><span class="line">    <span class="attr">enumerable</span>: !!enumerable,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="【辅助】arrayMethods"><a href="#【辅助】arrayMethods" class="headerlink" title="【辅助】arrayMethods"></a>【辅助】<code>arrayMethods</code></h4><p>arrayProto： Array 基础类型的原型</p>
<p>arrayMethods： arrayMethods 继承 arrayProto ，arrayMethods 的原型就是 arrayProto 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arrayProto = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> arrayMethods = <span class="title class_">Object</span>.<span class="title function_">create</span>(arrayProto)</span><br></pre></td></tr></table></figure>

<p>运行出来是：</p>
<p><img src="/105-observer-Dep-Watcher/1657270159866-e5c77424-fd69-49cb-93f7-e0edf5b76b0a.png" alt="img"></p>
<h4 id="关于-Object-create-："><a href="#关于-Object-create-：" class="headerlink" title="关于 Object.create()："></a>关于 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create">Object.create()</a><strong>：</strong></h4><p><strong>Object.create()</strong> 方法用于创建一个新对象，使用现有的对象来作为新创建对象的原型（prototype）。</p>
<p>试一个简单的例子，</p>
<p><code>var ob = Object.create(arr)</code> <strong>就是将 arr 的值作为 新对象 ob 的原型</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>]</span><br><span class="line"><span class="keyword">var</span> ob = <span class="title class_">Object</span>.<span class="title function_">create</span>(arr)</span><br></pre></td></tr></table></figure>

<p><img src="/105-observer-Dep-Watcher/1657580592186-b6cda673-e8fe-46fe-9419-714b9715f934.png" alt="img"></p>
<p>若 arr 重新赋值， ob 并不会跟着改变，说明此处是深拷贝，不是指向的引用值：</p>
<p><img src="/105-observer-Dep-Watcher/1657580729546-8f1c7819-9d15-4026-8df7-0923e3311b7a.png" alt="img"></p>
<h4 id="【对Array原型方法进行响应式处理】"><a href="#【对Array原型方法进行响应式处理】" class="headerlink" title="【对Array原型方法进行响应式处理】"></a>【对<code>Array</code>原型方法进行响应式处理】</h4><p><code>Array</code>基本类型有pop, push, shift, unshift 等方法，对其进行响应式处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 constructor 构造函数中处理</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断浏览器是否支持 __prop__</span></span><br><span class="line"><span class="comment">// 对数组 原型方法 进行响应式处理！！</span></span><br><span class="line"><span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">  <span class="comment">// 相当于 value.__proto__ = arrayMethods</span></span><br><span class="line">  <span class="title function_">protoAugment</span>(value, arrayMethods)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="title function_">copyAugment</span>(value, arrayMethods, arrayKeys)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用的工具方法实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// helpers</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Augment a target Object or Array by intercepting</span></span><br><span class="line"><span class="comment"> * the prototype chain using __proto__</span></span><br><span class="line"><span class="comment"> * 数组的原型链修改, 从而使得数组变成响应式的 ( pop, push, shift, unshift, ... ) ！</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">protoAugment</span> (target, <span class="attr">src</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="comment">/* eslint-disable no-proto */</span></span><br><span class="line">  target.<span class="property">__proto__</span> = src</span><br><span class="line">  <span class="comment">/* eslint-enable no-proto */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Augment a target Object or Array by defining</span></span><br><span class="line"><span class="comment"> * hidden properties.</span></span><br><span class="line"><span class="comment"> * 如果浏览器不支持就将这些方法直接混入到当前数组中, 属性访问元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* istanbul ignore next */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copyAugment</span> (<span class="attr">target</span>: <span class="title class_">Object</span>, <span class="attr">src</span>: <span class="title class_">Object</span>, <span class="attr">keys</span>: <span class="title class_">Array</span>&lt;string&gt;) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = keys.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="title function_">def</span>(target, key, src[key])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-1-1-defineReactive-响应式的实现"><a href="#1-1-1-1-defineReactive-响应式的实现" class="headerlink" title="1.1.1.1 defineReactive() 响应式的实现"></a>1.1.1.1 <code>defineReactive()</code> 响应式的实现</h3><p>调用处的 walk 方法中，是循环遍历 obj，然后将 obj 和 obj 中每一个 key 作为入参：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">defineReactive</span>(obj, keys[i])</span><br></pre></td></tr></table></figure>

<p><strong>流程</strong>：</p>
<ul>
<li>通過 Object.getOwnPropertyDesccriptor 获取 obj.key 的属性描述</li>
<li>通过 Object.defineProperty 劫持 obj.key 属性，改写 get、set 方法</li>
<li>当模板填充 data 的属性值时，触发 get 方法，调用 dep.depend() ，收集依赖（收集 Watcher）</li>
<li>当 data 的属性值修改时，触发 set 方法，调用 dep.notify() ，派发更新 （通知所有依赖的 Watcher）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define a reactive property on an Object.</span></span><br><span class="line"><span class="comment"> * 为对象定义一个 可响应式 的属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">defineReactive</span> (</span><br><span class="line">  <span class="attr">obj</span>: <span class="title class_">Object</span>,</span><br><span class="line">  <span class="attr">key</span>: string,</span><br><span class="line">  <span class="attr">val</span>: any,</span><br><span class="line">  customSetter?: ?<span class="title class_">Function</span>,</span><br><span class="line">  shallow?: boolean</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// 创建 new Dep</span></span><br><span class="line">  <span class="comment">// Dep见 3 分析</span></span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>()</span><br><span class="line">  <span class="comment">// 获取对象的属性描述 ( &#123; enumerable: true, writable: true, ... &#125; )</span></span><br><span class="line">  <span class="keyword">const</span> property = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(obj, key)</span><br><span class="line">  <span class="keyword">if</span> (property &amp;&amp; property.<span class="property">configurable</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cater for pre-defined getter/setters</span></span><br><span class="line">  <span class="keyword">const</span> getter = property &amp;&amp; property.<span class="property">get</span></span><br><span class="line">  <span class="keyword">const</span> setter = property &amp;&amp; property.<span class="property">set</span></span><br><span class="line">  <span class="comment">// 若 get 方法未定义，则 val 没有值，就手动给 val 赋值</span></span><br><span class="line">  <span class="keyword">if</span> ((!getter || setter) &amp;&amp; <span class="variable language_">arguments</span>.<span class="property">length</span> === <span class="number">2</span>) &#123;</span><br><span class="line">    val = obj[key]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归子，val 是属性值，递归循环看是否还有子对象|数组</span></span><br><span class="line">  <span class="keyword">let</span> childOb = !shallow &amp;&amp; <span class="title function_">observe</span>(val)</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// get 方法收集依赖</span></span><br><span class="line">    <span class="comment">// 读取 某个属性，就触发 get 方法</span></span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span> <span class="title function_">reactiveGetter</span> () &#123;</span><br><span class="line">      <span class="comment">// 如果已经定义 get 方法可以被继承下来, 不会丢失</span></span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.<span class="title function_">call</span>(obj) : val</span><br><span class="line">      <span class="comment">// 如果有 target 标识，则进行依赖收集</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        <span class="comment">// 收集依赖 （页面 template 中用到 data 中某个 key 时，就触发 get 方法，在 dep 收集对应的 Watcher）     </span></span><br><span class="line">        <span class="comment">// 方法内分析见4.2</span></span><br><span class="line">        dep.<span class="title function_">depend</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 收集子属性</span></span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          childOb.<span class="property">dep</span>.<span class="title function_">depend</span>()</span><br><span class="line">          <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">            <span class="title function_">dependArray</span>(value)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// set 通知依赖</span></span><br><span class="line">    <span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">reactiveSetter</span> (newVal) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.<span class="title function_">call</span>(obj) : val</span><br><span class="line">      <span class="comment">/* eslint-disable no-self-compare */</span></span><br><span class="line">      <span class="comment">// 如果数据没有发生变化 就不会进行派发更新</span></span><br><span class="line">      <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* eslint-enable no-self-compare */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; customSetter) &#123;</span><br><span class="line">        <span class="title function_">customSetter</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// #7981: for accessor properties without setter</span></span><br><span class="line">      <span class="keyword">if</span> (getter &amp;&amp; !setter) <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">        <span class="comment">// 保证了如果已经定义的 set 方法可以被继承下来, 不会丢失</span></span><br><span class="line">        setter.<span class="title function_">call</span>(obj, newVal)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 对新值进行响应式化处理</span></span><br><span class="line">      childOb = !shallow &amp;&amp; <span class="title function_">observe</span>(newVal)</span><br><span class="line">      <span class="comment">// 派发更新 </span></span><br><span class="line">      <span class="comment">// 修改数据，通知页面重新渲染</span></span><br><span class="line">      <span class="comment">// 方法内分析见4.3</span></span><br><span class="line">      dep.<span class="title function_">notify</span>() </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="【辅助】Object-getOwnPropertyDescriptor-obj-prop"><a href="#【辅助】Object-getOwnPropertyDescriptor-obj-prop" class="headerlink" title="【辅助】Object.getOwnPropertyDescriptor(obj, prop)"></a>【辅助】<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor">Object.getOwnPropertyDescriptor(obj, prop)</a></h4><p><strong>Object.getOwnPropertyDescriptor()</strong> 方法返回指定对象上一个自有属性对应的属性描述符。（自有属性指的是直接赋予该对象的属性，不需要从原型链上进行查找的属性）</p>
<p><strong>eg:</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> object1 = &#123;</span><br><span class="line">  <span class="attr">property1</span>: <span class="number">42</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> descriptor1 = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(object1, <span class="string">&#x27;property1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(descriptor1);</span><br><span class="line"><span class="comment">// 结果：</span></span><br><span class="line"><span class="comment">// &gt; Object &#123; value: 42, writable: true, enumerable: true, configurable: true &#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="2-Dep"><a href="#2-Dep" class="headerlink" title="2. Dep"></a>2. <code>Dep</code></h1><h2 id="2-1-new-Dep"><a href="#2-1-new-Dep" class="headerlink" title="2.1 new Dep()"></a>2.1 <code>new Dep()</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span><br><span class="line">  <span class="comment">// target 是 当前 Watcher</span></span><br><span class="line">  <span class="keyword">static</span> <span class="attr">target</span>: ?<span class="title class_">Watcher</span>;</span><br><span class="line">  <span class="attr">id</span>: number;</span><br><span class="line">  <span class="comment">// subs 是所有 Watcher 集合，通过 addSub() 添加</span></span><br><span class="line">  <span class="attr">subs</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Watcher</span>&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = uid++</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subs</span> = []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-depend"><a href="#2-2-depend" class="headerlink" title="2.2 depend()"></a>2.2 <code>depend()</code></h2><p>收集依赖，通知 Watcher （通过调用 Watcher.addDep）收集依赖</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 收集依赖，通知 Watcher 收集</span></span><br><span class="line">depend () &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">    <span class="title class_">Dep</span>.<span class="property">target</span>.<span class="title function_">addDep</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-addSub"><a href="#2-3-addSub" class="headerlink" title="2.3 addSub()"></a>2.3 <code>addSub()</code></h2><p>实际 Dep 收集 Watcher 的方法，将Watcher 存到 subs 数组中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 收集 Watcher，通过 dep.depend() ==&gt; Dep.target.addDep() ==&gt; dep.addSub()</span></span><br><span class="line">addSub (<span class="attr">sub</span>: <span class="title class_">Watcher</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">push</span>(sub)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-4-notify"><a href="#2-4-notify" class="headerlink" title="2.4 notify()"></a>2.4 <code>notify()</code></h2><p>遍历通知 dep.subs 绑定的 Watcher ，更新视图</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 每一个属性 都会包含一个 dep 实例</span></span><br><span class="line"><span class="comment"> * 这个 dep 实例会记录下 参与计算或渲染的 watcher</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 发送通知</span></span><br><span class="line">notify () &#123;</span><br><span class="line">  <span class="comment">// stabilize the subscriber list first</span></span><br><span class="line">  <span class="keyword">const</span> subs = <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">slice</span>()</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !config.<span class="property">async</span>) &#123;</span><br><span class="line">    <span class="comment">// subs aren&#x27;t sorted in scheduler if not running async</span></span><br><span class="line">    <span class="comment">// we need to sort them now to make sure they fire in correct</span></span><br><span class="line">    <span class="comment">// order</span></span><br><span class="line">    subs.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">id</span> - b.<span class="property">id</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = subs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="comment">// 调用对应的 Watcher，更新视图</span></span><br><span class="line">    subs[i].<span class="title function_">update</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-5-pushTarget-，popTarget"><a href="#2-5-pushTarget-，popTarget" class="headerlink" title="2.5 pushTarget()，popTarget()"></a>2.5 <code>pushTarget()</code>，<code>popTarget()</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在 watcher 调用 get 方法的时候, 调用 pushTarget(this)，将 Wather 赋值给 Dep.target</span></span><br><span class="line"><span class="comment"> * 在 watcher 的 get 方法结束的时候, 调用 popTarget()，将 Wather 重置为上一个 target</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// The current target watcher being evaluated.</span></span><br><span class="line"><span class="comment">// This is globally unique because only one watcher</span></span><br><span class="line"><span class="comment">// can be evaluated at a time.</span></span><br><span class="line"><span class="comment">// 全局的容器存储渲染 Watcher</span></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property">target</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> targetStack = []</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将当前操作的 watcher 存储到 全局 watcher 中, 参数 target 就是当前 watcher</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">pushTarget</span> (<span class="attr">target</span>: ?<span class="title class_">Watcher</span>) &#123;</span><br><span class="line">  targetStack.<span class="title function_">push</span>(target)</span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = target</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将 当前 watcher 删掉，重置为上一个</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">popTarget</span> () &#123;</span><br><span class="line">  targetStack.<span class="title function_">pop</span>()</span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = targetStack[targetStack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-Watcher"><a href="#3-Watcher" class="headerlink" title="3. Watcher"></a>3. <code>Watcher</code></h1><p><img src="/105-observer-Dep-Watcher/1658238003604-4cf934a7-91d4-477d-bcd9-f3c55dafe7bc.png" alt="img"></p>
<p><strong>【前情】</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initState</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="comment">// 初始化 options.watch 监听</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">watch</span> &amp;&amp; opts.<span class="property">watch</span> !== nativeWatch) &#123;</span><br><span class="line">    <span class="title function_">initWatch</span>(vm, opts.<span class="property">watch</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-1-Wather初始化"><a href="#3-1-Wather初始化" class="headerlink" title="3.1 Wather初始化"></a>3.1 <code>Wather</code>初始化</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">**initWatch(vm, opts.watch)**</span><br></pre></td></tr></table></figure>

<ul>
<li>遍历 $options.watch，值为数组的继续遍历，</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历 $options.watch, 调用 createWatcher 创建</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; watch </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initWatch</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">watch</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="comment">// 遍历 $options.watch</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> watch) &#123;</span><br><span class="line">    <span class="keyword">const</span> handler = watch[key]</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(handler)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; handler.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">createWatcher</span>(vm, key, handler[i])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">createWatcher</span>(vm, key, handler)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-1-createWatcher-vm-key-handler"><a href="#3-1-1-createWatcher-vm-key-handler" class="headerlink" title="3.1.1 createWatcher(vm, key, handler)"></a>3.1.1 <code>createWatcher(vm, key, handler)</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展 $watch </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; vm </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; expOrFn </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; handler </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; options </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createWatcher</span> (</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span><br><span class="line">  <span class="attr">expOrFn</span>: string | <span class="title class_">Function</span>,</span><br><span class="line">  <span class="attr">handler</span>: any,</span><br><span class="line">  options?: <span class="title class_">Object</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// 如果是对象，参数移位</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(handler)) &#123;</span><br><span class="line">    options = handler</span><br><span class="line">    handler = handler.<span class="property">handler</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果是字符串，取 vm[handler] 作为方法</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> handler === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    handler = vm[handler]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm.$watch(expOrFn, handler, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-1-1-vm-watch-expOrFn-handler-options"><a href="#3-1-1-1-vm-watch-expOrFn-handler-options" class="headerlink" title="3.1.1.1 vm.$watch(expOrFn, handler, options)"></a>3.1.1.1 <code>vm.$watch(expOrFn, handler, options)</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$watch</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">    expOrFn: string | <span class="built_in">Function</span>,</span></span><br><span class="line"><span class="params">    cb: any,</span></span><br><span class="line"><span class="params">    options?: <span class="built_in">Object</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="comment">// 如果传入的 handler 是对象，则再扩展解析</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(cb)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">createWatcher</span>(vm, expOrFn, cb, options)</span><br><span class="line">    &#125;</span><br><span class="line">    options = options || &#123;&#125;</span><br><span class="line">    options.<span class="property">user</span> = <span class="literal">true</span></span><br><span class="line">     <span class="comment">// 创建 Watcher 实例 !!!</span></span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, expOrFn, cb, options)</span><br><span class="line">    <span class="comment">// 如果 立即执行标志位为 true，则直接执行 handler（cb）函数</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">immediate</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> info = <span class="string">`callback for immediate watcher &quot;<span class="subst">$&#123;watcher.expression&#125;</span>&quot;`</span></span><br><span class="line">      <span class="title function_">pushTarget</span>()</span><br><span class="line">      <span class="title function_">invokeWithErrorHandling</span>(cb, vm, [watcher.<span class="property">value</span>], vm, info)</span><br><span class="line">      <span class="title function_">popTarget</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回取消监听函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unwatchFn</span> () &#123;</span><br><span class="line">      watcher.<span class="title function_">teardown</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-new-Watcher"><a href="#3-2-new-Watcher" class="headerlink" title="3.2 new Watcher()"></a>3.2 <code>new Watcher()</code></h2><h3 id="3-2-1-construcor"><a href="#3-2-1-construcor" class="headerlink" title="3.2.1 construcor"></a>3.2.1 <code>construcor</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\watcher.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A watcher parses an expression, collects dependencies,</span></span><br><span class="line"><span class="comment"> * and fires callback when the expression value changes.</span></span><br><span class="line"><span class="comment"> * This is used for both the $watch() api and directives.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 在 Vue 中使用了 二次提交的概念</span></span><br><span class="line"><span class="comment">// 每次在数据 渲染 或 计算的时候 就会访问响应式的数据, 就会进行依赖收集</span></span><br><span class="line"><span class="comment">// 将关联的 Watcher 与 dep 相关联,</span></span><br><span class="line"><span class="comment">// 在数据发生变化时, 根据 dep 找到关联的 Watcher, 遍历调用 update</span></span><br><span class="line"><span class="comment">// 执行完成后会清空 Watcher</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Watcher</span> &#123;</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span>;</span><br><span class="line">  <span class="attr">expression</span>: string; <span class="comment">// 关联表达式 或 渲染方法体</span></span><br><span class="line">  <span class="attr">cb</span>: <span class="title class_">Function</span>; <span class="comment">// 在定义 Vue 构造函数时，Vue.prototype.$watch</span></span><br><span class="line">  <span class="attr">id</span>: number;</span><br><span class="line">  <span class="attr">deep</span>: boolean; <span class="comment">// 为 true 时，监听对象内部值的变化</span></span><br><span class="line">  <span class="attr">user</span>: boolean;</span><br><span class="line">  <span class="attr">lazy</span>: boolean;  <span class="comment">// 计算属性标记，为 true 时 Watcher 不立即执行</span></span><br><span class="line">  <span class="attr">sync</span>: boolean;</span><br><span class="line">  <span class="attr">dirty</span>: boolean; <span class="comment">// 计算属性时，为 true 时，需重新计算</span></span><br><span class="line">  <span class="attr">active</span>: boolean;</span><br><span class="line">  <span class="attr">deps</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Dep</span>&gt;;</span><br><span class="line">  <span class="attr">newDeps</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Dep</span>&gt;;</span><br><span class="line">  <span class="attr">depIds</span>: <span class="title class_">SimpleSet</span>;</span><br><span class="line">  <span class="attr">newDepIds</span>: <span class="title class_">SimpleSet</span>;</span><br><span class="line">  <span class="attr">before</span>: ?<span class="title class_">Function</span>; <span class="comment">// Watcher 触发之前, 类似于 生命周期</span></span><br><span class="line">  <span class="attr">getter</span>: <span class="title class_">Function</span>; <span class="comment">// 就是 渲染函数 ( 模板或组件的渲染 ) 或 计算函数 ( watch )</span></span><br><span class="line">  <span class="attr">value</span>: any; </span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (</span><br><span class="line">    <span class="attr">vm</span>: <span class="title class_">Component</span>,</span><br><span class="line">    <span class="attr">expOrFn</span>: string | <span class="title class_">Function</span>,</span><br><span class="line">    <span class="attr">cb</span>: <span class="title class_">Function</span>,</span><br><span class="line">    options?: ?<span class="title class_">Object</span>,</span><br><span class="line">    isRenderWatcher?: boolean</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vm</span> = vm</span><br><span class="line">    <span class="keyword">if</span> (isRenderWatcher) &#123;</span><br><span class="line">      vm.<span class="property">_watcher</span> = <span class="variable language_">this</span></span><br><span class="line">    &#125;</span><br><span class="line">    vm.<span class="property">_watchers</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="comment">// options</span></span><br><span class="line">    <span class="keyword">if</span> (options) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">deep</span> = !!options.<span class="property">deep</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">user</span> = !!options.<span class="property">user</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">lazy</span> = !!options.<span class="property">lazy</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">sync</span> = !!options.<span class="property">sync</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">before</span> = options.<span class="property">before</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">deep</span> = <span class="variable language_">this</span>.<span class="property">user</span> = <span class="variable language_">this</span>.<span class="property">lazy</span> = <span class="variable language_">this</span>.<span class="property">sync</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cb</span> = cb</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = ++uid <span class="comment">// uid for batching</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="variable language_">this</span>.<span class="property">lazy</span> <span class="comment">// for lazy watchers</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">deps</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDeps</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">depIds</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDepIds</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">expression</span> = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span></span><br><span class="line">      ? expOrFn.<span class="title function_">toString</span>()</span><br><span class="line">      : <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">// parse expression for getter</span></span><br><span class="line">    <span class="comment">// expOrFn 如果是函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 在 mountComponent 中，</span></span><br><span class="line">    <span class="comment">// updateComponent = () =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//   vm._update(vm._render(), hydrating)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// new Watcher(vm, updateComponent);</span></span><br><span class="line">    <span class="comment">// 所以，这里的 expOrFn 是： </span></span><br><span class="line">    <span class="comment">/* ƒ () &#123;</span></span><br><span class="line"><span class="comment">      vm._update(vm._render(), hydrating);</span></span><br><span class="line"><span class="comment">    &#125; */</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">getter</span> = expOrFn</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">getter</span> = <span class="title function_">parsePath</span>(expOrFn)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">getter</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">getter</span> = noop</span><br><span class="line">        process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Failed watching path: &quot;<span class="subst">$&#123;expOrFn&#125;</span>&quot; `</span> +</span><br><span class="line">          <span class="string">&#x27;Watcher only accepts simple dot-delimited paths. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;For full control, use a function instead.&#x27;</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 不是计算属性，则 调用 get() 初始化取值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="property">lazy</span></span><br><span class="line">      ? <span class="literal">undefined</span></span><br><span class="line">      : <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-get"><a href="#3-2-2-get" class="headerlink" title="3.2.2 get()"></a>3.2.2 <code>get()</code></h3><ul>
<li><p>先 pushTarget(this) ，将当前 Watcher 赋值给 Dep.target</p>
</li>
<li><p>执行 <strong>this.getter</strong> 的方法</p>
</li>
<li><ul>
<li>若 new Watcher() 的 在初始化 mountComponent 时，getter 是 <code>f() &#123;vm._update(vm._render(), hydrating); &#125;</code></li>
<li>若 在 计算属性时，getter 是 $options.computed 遍历的某一项的自定义函数</li>
</ul>
</li>
<li><p>popTarget() 和 cleanupDeps() 清除 Dep.tartget ，清除依赖收集</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Evaluate the getter, and re-collect dependencies.</span></span><br><span class="line"><span class="comment"> * 计算的getter，重新收集依赖</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">get () &#123;</span><br><span class="line">  <span class="comment">// 将 当前 Watcher 赋值给 Dep.target</span></span><br><span class="line">  <span class="title function_">pushTarget</span>(<span class="variable language_">this</span>)</span><br><span class="line">  <span class="keyword">let</span> value</span><br><span class="line">  <span class="keyword">const</span> vm = <span class="variable language_">this</span>.<span class="property">vm</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 this.getter 是函数，则是</span></span><br><span class="line">   <span class="comment">/*  ƒ () &#123;</span></span><br><span class="line"><span class="comment">      vm._update(vm._render(), hydrating);</span></span><br><span class="line"><span class="comment">    &#125; */</span></span><br><span class="line">    <span class="comment">// this.getter 就是 expOrFn，也就是 vm._render</span></span><br><span class="line">    <span class="comment">// vm._render 用来生成虚拟 dom、执行 dom-diff、更新真实 dom</span></span><br><span class="line">    value = <span class="variable language_">this</span>.<span class="property">getter</span>.<span class="title function_">call</span>(vm, vm)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">user</span>) &#123;</span><br><span class="line">      <span class="title function_">handleError</span>(e, vm, <span class="string">`getter for watcher &quot;<span class="subst">$&#123;<span class="variable language_">this</span>.expression&#125;</span>&quot;`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> e</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// &quot;touch&quot; every property so they are all tracked as</span></span><br><span class="line">    <span class="comment">// dependencies for deep watching</span></span><br><span class="line">    <span class="comment">// 若 要监听对象内部值，则递归</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">deep</span>) &#123;</span><br><span class="line">      <span class="title function_">traverse</span>(value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">popTarget</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">cleanupDeps</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-3-run"><a href="#3-2-3-run" class="headerlink" title="3.2.3 run()"></a>3.2.3 <code>run()</code></h3><ul>
<li>调用 get()，相当于执行  watcher.getter 的函数</li>
<li>执行 watcher.cb 函数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Scheduler job interface.</span></span><br><span class="line"><span class="comment"> * Will be called by the scheduler.</span></span><br><span class="line"><span class="comment"> * 调用 get()，执行 watcher.cb 函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">run () &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">    <span class="comment">// 和初始化一样，直接调用 get(), 更新视图</span></span><br><span class="line">    <span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      value !== <span class="variable language_">this</span>.<span class="property">value</span> ||</span><br><span class="line">      <span class="comment">// Deep watchers and watchers on Object/Arrays should fire even</span></span><br><span class="line">      <span class="comment">// when the value is the same, because the value may</span></span><br><span class="line">      <span class="comment">// have mutated.</span></span><br><span class="line">      <span class="title function_">isObject</span>(value) ||</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">deep</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// set new value</span></span><br><span class="line">      <span class="keyword">const</span> oldValue = <span class="variable language_">this</span>.<span class="property">value</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">value</span> = value</span><br><span class="line">      <span class="comment">// 执行 watcher 的 cb 回调函数</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">user</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果是 user watchers，调用 invokeWithErrorHandling 执行 cb</span></span><br><span class="line">        <span class="keyword">const</span> info = <span class="string">`callback for watcher &quot;<span class="subst">$&#123;<span class="variable language_">this</span>.expression&#125;</span>&quot;`</span></span><br><span class="line">        <span class="title function_">invokeWithErrorHandling</span>(<span class="variable language_">this</span>.<span class="property">cb</span>, <span class="variable language_">this</span>.<span class="property">vm</span>, [value, oldValue], <span class="variable language_">this</span>.<span class="property">vm</span>, info)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cb</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>.<span class="property">vm</span>, value, oldValue)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-4-update"><a href="#3-2-4-update" class="headerlink" title="3.2.4 update()"></a>3.2.4 <code>update()</code></h3><p>更新 Watcher 方法：</p>
<ul>
<li>若是计算属性，则将 dirty 置为 true</li>
<li>若 sync 为 true，直接调用 run()</li>
<li>否则，调用 queueWatcher，开启异步队列（异步队列相关，见 3.3 scheduler ）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Subscriber interface.</span></span><br><span class="line"><span class="comment"> * Will be called when a dependency changes.</span></span><br><span class="line"><span class="comment"> * 订阅者接口，在依赖项改变时被调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">update () &#123;</span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">lazy</span>) &#123;</span><br><span class="line">    <span class="comment">// 若是计算属性，更新后需将缓存标记置为true表示需要更新</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">sync</span>) &#123;</span><br><span class="line">    <span class="comment">// 若为同步，直接 run</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">run</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 否则，放到 观察值队列</span></span><br><span class="line">    <span class="comment">// 开启异步队列，批量更新 Watcher</span></span><br><span class="line">    <span class="title function_">queueWatcher</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-5-addDep-dep"><a href="#3-2-5-addDep-dep" class="headerlink" title="3.2.5 addDep(dep)"></a>3.2.5 <code>addDep(dep)</code></h3><ul>
<li>将 dep 添加到 watcher.newDeps 中</li>
<li>调用 dep.addSub(this)，再将 watcher 添加到 Dep 中</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add a dependency to this directive.</span></span><br><span class="line"><span class="comment"> * Watcher 关联 dep ， 并通知 dep 关联对应的 Watcher</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">addDep (<span class="attr">dep</span>: <span class="title class_">Dep</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = dep.<span class="property">id</span></span><br><span class="line">    <span class="comment">// 当前 dep 不在 新newDepIds 队列，就添加dep 及 id</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">add</span>(id)</span><br><span class="line">      <span class="comment">// 将 dep 关联到 Watcher 中的 newDeps</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDeps</span>.<span class="title function_">push</span>(dep)</span><br><span class="line">      <span class="comment">// 当前 新id 不在 旧depIds 队列，同时将  Watcher 添加到 Dep 队列</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">depIds</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">      <span class="comment">// 将 当前 Watcher 添加到 Dep.subs 中</span></span><br><span class="line">      dep.<span class="title function_">addSub</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-6-cleanupDeps"><a href="#3-2-6-cleanupDeps" class="headerlink" title="3.2.6 cleanupDeps()"></a>3.2.6 <code>cleanupDeps()</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Clean up for dependency collection.</span></span><br><span class="line"><span class="comment"> * 清除依赖收集 ，清除当前watcher对应的 dep.subs 和 watcher.newDeps 中的对应关系</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">cleanupDeps () &#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">deps</span>.<span class="property">length</span></span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> dep = <span class="variable language_">this</span>.<span class="property">deps</span>[i]</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">has</span>(dep.<span class="property">id</span>)) &#123;</span><br><span class="line">      dep.<span class="title function_">removeSub</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> tmp = <span class="variable language_">this</span>.<span class="property">depIds</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">depIds</span> = <span class="variable language_">this</span>.<span class="property">newDepIds</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDepIds</span> = tmp</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">clear</span>()</span><br><span class="line">  tmp = <span class="variable language_">this</span>.<span class="property">deps</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">deps</span> = <span class="variable language_">this</span>.<span class="property">newDeps</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDeps</span> = tmp</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDeps</span>.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-7-evaluate"><a href="#3-2-7-evaluate" class="headerlink" title="3.2.7 evaluate()"></a>3.2.7 <code>evaluate()</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Evaluate the value of the watcher.</span></span><br><span class="line"><span class="comment"> * This only gets called for lazy watchers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算 watcher 的值，仅用于 计算属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">evaluate () &#123;</span><br><span class="line">  <span class="comment">// 调用get() 方法重新计算</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-7-depend"><a href="#3-2-7-depend" class="headerlink" title="3.2.7 depend()"></a>3.2.7 <code>depend()</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Depend on all deps collected by this watcher.</span></span><br><span class="line"><span class="comment"> * 依赖收集；遍历 watcher 中存的 deps，挨个调 Dep.depend()，将watcher 与 dep 相互绑定</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">depend () &#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">deps</span>.<span class="property">length</span></span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">deps</span>[i].<span class="title function_">depend</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-8-teardown"><a href="#3-2-8-teardown" class="headerlink" title="3.2.8 teardown()"></a>3.2.8 <code>teardown()</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Remove self from all dependencies&#x27; subscriber list.</span></span><br><span class="line"><span class="comment">   * teardown 与 depend 相对</span></span><br><span class="line"><span class="comment">   * 将当前 watcher 与 dep 的相互绑定关系移除</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  teardown () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">      <span class="comment">// remove self from vm&#x27;s watcher list</span></span><br><span class="line">      <span class="comment">// this is a somewhat expensive operation so we skip it</span></span><br><span class="line">      <span class="comment">// if the vm is being destroyed.</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">vm</span>.<span class="property">_isBeingDestroyed</span>) &#123;</span><br><span class="line">        <span class="title function_">remove</span>(<span class="variable language_">this</span>.<span class="property">vm</span>.<span class="property">_watchers</span>, <span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">deps</span>.<span class="property">length</span></span><br><span class="line">      <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">deps</span>[i].<span class="title function_">removeSub</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-scheduler"><a href="#3-3-scheduler" class="headerlink" title="3.3 scheduler"></a>3.3 <code>scheduler</code></h2><h3 id="3-3-1-scheduler-相关的全局变量"><a href="#3-3-1-scheduler-相关的全局变量" class="headerlink" title="3.3.1 scheduler 相关的全局变量"></a>3.3.1 scheduler 相关的全局变量</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\observer\scheduler.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">MAX_UPDATE_COUNT</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// watcher 异步队列</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">queue</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Watcher</span>&gt; = []</span><br><span class="line"><span class="keyword">const</span> <span class="attr">activatedChildren</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Component</span>&gt; = []</span><br><span class="line"><span class="keyword">let</span> <span class="attr">has</span>: &#123; [<span class="attr">key</span>: number]: ?<span class="literal">true</span> &#125; = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">circular</span>: &#123; [<span class="attr">key</span>: number]: number &#125; = &#123;&#125;</span><br><span class="line"><span class="comment">// waiting:false 未开启异步队列（是在调用异步回调方法时开启的）</span></span><br><span class="line"><span class="keyword">let</span> waiting = <span class="literal">false</span></span><br><span class="line"><span class="comment">// flushing: false 未开启冲洗队列（冲洗是在异步回调方法执行完成后回调时执行 flushSchedulerQueue 开启的）</span></span><br><span class="line"><span class="keyword">let</span> flushing = <span class="literal">false</span></span><br><span class="line"><span class="keyword">let</span> index = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>waiting 与 flushing 区别：</strong></p>
<ul>
<li><strong>waiting  是为了判断当前是否调用异步队列 nextTick ，防止重复调用</strong></li>
<li><strong>flushing 是为了判断当前是否正在进行冲洗操作（冲洗操作是在异步队列 nextTick 执行后回调的方法）</strong></li>
</ul>
<h3 id="3-3-2-queueWatcher"><a href="#3-3-2-queueWatcher" class="headerlink" title="3.3.2 queueWatcher()"></a>3.3.2 <code>queueWatcher()</code></h3><p>在 Watcher 的 update() 方法中调用。</p>
<ul>
<li><p>先 判断队列中是否 新watcher 的id，若有则不重复添加到队列；若无，进行后面操作</p>
</li>
<li><p>再判断 flushing，</p>
</li>
<li><ul>
<li>若当前没有冲洗操作，则将 wather 直接push 到 queue 队列</li>
<li>若正在进行冲洗操作，则遍历 queue 队列，给当前的watcher 根据 id 找到合适的位置插入</li>
</ul>
</li>
<li><p>判断 waiting，</p>
</li>
<li><ul>
<li>若 当前没有已调用 异步队列 nextTick，则修改标记 waiting 置为 true，将冲洗操作传给异步队列 nextTick(flushSchedulerQueue)</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">queueWatcher</span> (<span class="attr">watcher</span>: <span class="title class_">Watcher</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = watcher.<span class="property">id</span></span><br><span class="line">  <span class="comment">// 若 watcher 的 id 在全局变量 has 中已存在，则忽略</span></span><br><span class="line">  <span class="comment">// 避免重复更新，提升效率</span></span><br><span class="line">  <span class="keyword">if</span> (has[id] == <span class="literal">null</span>) &#123;</span><br><span class="line">    has[id] = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (!flushing) &#123;</span><br><span class="line">      <span class="comment">// 当前没有冲洗操作，将 watcher 插入到队列</span></span><br><span class="line">      queue.<span class="title function_">push</span>(watcher)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// if already flushing, splice the watcher based on its id</span></span><br><span class="line">      <span class="comment">// if already past its id, it will be run next immediately.</span></span><br><span class="line">      <span class="comment">// 冲洗操作时，将新的watcher 遍历按 id 顺序插入到正确的位置</span></span><br><span class="line">      <span class="comment">// 遍历队列，从队尾开始开始，按照 id 的大小（队列是从小到大的顺序）将 Watcher 插入到队列</span></span><br><span class="line">      <span class="comment">// 如果没有遍历到，即当前 id 比队列中的id 都大，没有执行过 i--，相当于插入到队尾</span></span><br><span class="line">      <span class="comment">// index 代表队列中当前正在执行的 Watcher 的位置，初始为 0</span></span><br><span class="line">      <span class="keyword">let</span> i = queue.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">      <span class="keyword">while</span> (i &gt; index &amp;&amp; queue[i].<span class="property">id</span> &gt; watcher.<span class="property">id</span>) &#123;</span><br><span class="line">        i--</span><br><span class="line">      &#125;</span><br><span class="line">      queue.<span class="title function_">splice</span>(i + <span class="number">1</span>, <span class="number">0</span>, watcher)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// queue the flush</span></span><br><span class="line">    <span class="comment">// 正在调用异步队列标记，表示调用队列执行之前不允许重复调用</span></span><br><span class="line">    <span class="keyword">if</span> (!waiting) &#123;</span><br><span class="line">      waiting = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 开发环境若配置同步 则立即执行</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !config.<span class="property">async</span>) &#123;</span><br><span class="line">        <span class="title function_">flushSchedulerQueue</span>()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将待执行的调度任务加入异步队列</span></span><br><span class="line">      <span class="title function_">nextTick</span>(flushSchedulerQueue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-3-flushSchedulerQueue"><a href="#3-3-3-flushSchedulerQueue" class="headerlink" title="3.3.3 flushSchedulerQueue()"></a>3.3.3 <code>flushSchedulerQueue()</code></h3><p><strong>传给异步队列 nextTick 的回调方法，在异步队列执行后回调时执行此方法</strong></p>
<ul>
<li>给 watcher 队列用 id 排序</li>
<li>遍历 watcher 队列，调用 watcher.run() ；更新 active，update 状态</li>
<li>重置状态标记</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Flush both queues and run the watchers.</span></span><br><span class="line"><span class="comment"> * 传给异步队列 nextTick 的回调方法，在异步队列执行后回调时执行此方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushSchedulerQueue</span> () &#123;</span><br><span class="line">  currentFlushTimestamp = <span class="title function_">getNow</span>()</span><br><span class="line">  <span class="comment">// 开始冲洗，此方法是在执行异步队列执行后的回调方法</span></span><br><span class="line">  flushing = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">let</span> watcher, id</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 给队列用 id 由小到大排序</span></span><br><span class="line">  queue.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">id</span> - b.<span class="property">id</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// do not cache length because more watchers might be pushed</span></span><br><span class="line">  <span class="comment">// as we run existing watchers</span></span><br><span class="line">  <span class="comment">// 执行 watcher.run()；更新 active，update 状态</span></span><br><span class="line">  <span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; queue.<span class="property">length</span>; index++) &#123;</span><br><span class="line">    watcher = queue[index]</span><br><span class="line">    ...</span><br><span class="line">    watcher.<span class="title function_">run</span>()</span><br><span class="line">     ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="title function_">resetSchedulerState</span>()</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-4-resetSchedulerState"><a href="#3-3-4-resetSchedulerState" class="headerlink" title="3.3.4 resetSchedulerState()"></a>3.3.4 <code>resetSchedulerState()</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reset the scheduler&#x27;s state.</span></span><br><span class="line"><span class="comment"> * 重置任务调度所有状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resetSchedulerState</span> () &#123;</span><br><span class="line">  index = queue.<span class="property">length</span> = activatedChildren.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">  has = &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    circular = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  waiting = flushing = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-computed-计算属性"><a href="#4-computed-计算属性" class="headerlink" title="4. computed 计算属性"></a>4. <code>computed</code> 计算属性</h1><p><img src="/105-observer-Dep-Watcher/1658334142764-691315cf-a639-4dc2-adea-cb6be819dd06.png" alt="img"></p>
<h3 id="initComputed-vm-opts-computed"><a href="#initComputed-vm-opts-computed" class="headerlink" title="initComputed(vm,opts.computed)"></a><code>initComputed(vm,opts.computed)</code></h3><ul>
<li>创建 计算属性内部的 watcher， vm._computedWatchers</li>
<li>为 计算属性 响应式处理</li>
</ul>
<p><strong>【lazy】</strong>计算属性标记：为true ，则为 计算属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算属性的标记 lazy: true</span></span><br><span class="line"><span class="keyword">const</span> computedWatcherOptions = &#123; <span class="attr">lazy</span>: <span class="literal">true</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initComputed</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">computed</span>: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="comment">// 创建 存储计算属性 的 watcher：_computedWatchers</span></span><br><span class="line">  <span class="keyword">const</span> watchers = vm.<span class="property">_computedWatchers</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// computed properties are just getters during SSR</span></span><br><span class="line">  <span class="keyword">const</span> isSSR = <span class="title function_">isServerRendering</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> computed) &#123;</span><br><span class="line">    <span class="comment">// 获取用户自定义的 computed</span></span><br><span class="line">    <span class="keyword">const</span> userDef = computed[key]</span><br><span class="line">    <span class="comment">// 兼容 computed 后直接写 方法  or 对象中写 get() 的方式</span></span><br><span class="line">    <span class="keyword">const</span> getter = <span class="keyword">typeof</span> userDef === <span class="string">&#x27;function&#x27;</span> ? userDef : userDef.<span class="property">get</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; getter == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`Getter is missing for computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot;.`</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在服务端SSR时，不创建计算属性对应 watcher</span></span><br><span class="line">    <span class="keyword">if</span> (!isSSR) &#123;</span><br><span class="line">      <span class="comment">// create internal watcher for the computed property.</span></span><br><span class="line">      <span class="comment">// 为 计算属性 创建内部 watcher</span></span><br><span class="line">      watchers[key] = <span class="keyword">new</span> <span class="title class_">Watcher</span>(</span><br><span class="line">        vm,</span><br><span class="line">        getter || noop,</span><br><span class="line">        noop,</span><br><span class="line">        computedWatcherOptions</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// component-defined computed properties are already defined on the</span></span><br><span class="line">    <span class="comment">// component prototype. We only need to define computed properties defined</span></span><br><span class="line">    <span class="comment">// at instantiation here.</span></span><br><span class="line">    <span class="comment">// 如果计算属性 key 不在vue实例中，就创建响应式的 vm[key] ，其值为 userDef</span></span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      <span class="title function_">defineComputed</span>(vm, key, userDef)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 各种重名报错</span></span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> vm.<span class="property">$data</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">`The computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already defined in data.`</span>, vm)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">props</span> &amp;&amp; key <span class="keyword">in</span> vm.<span class="property">$options</span>.<span class="property">props</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">`The computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already defined as a prop.`</span>, vm)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">methods</span> &amp;&amp; key <span class="keyword">in</span> vm.<span class="property">$options</span>.<span class="property">methods</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">`The computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already defined as a method.`</span>, vm)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="为什么-SSR-不用创建-computed？"><a href="#为什么-SSR-不用创建-computed？" class="headerlink" title="为什么 SSR 不用创建 computed？"></a>为什么 SSR 不用创建 computed？</h4><p>由于watcher实现vue的响应式，而如果是服务器环境下，数据和模板从后端获取即可而不需要在前端收集依赖，不需要缓存机制，因此在服务器并不需要这一点</p>
<h2 id="4-1-defineComputed-vm-key-userDef"><a href="#4-1-defineComputed-vm-key-userDef" class="headerlink" title="4.1 defineComputed(vm, key, userDef)"></a>4.1 <code>defineComputed(vm, key, userDef)</code></h2><ul>
<li>非 SSR 使用缓存，及 computed 的值是否是函数，设置get，set方法，进行响应式处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\state.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应式基础配置</span></span><br><span class="line"><span class="keyword">const</span> sharedPropertyDefinition = &#123;</span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">get</span>: noop,</span><br><span class="line">  <span class="attr">set</span>: noop</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * computed 进行响应式处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; target </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; key </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; userDef </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">defineComputed</span> (</span><br><span class="line">  <span class="attr">target</span>: any,</span><br><span class="line">  <span class="attr">key</span>: string,</span><br><span class="line">  <span class="attr">userDef</span>: <span class="title class_">Object</span> | <span class="title class_">Function</span></span><br><span class="line">) &#123;</span><br><span class="line">   <span class="comment">// 缓存标记，非 SSR 的进行缓存</span></span><br><span class="line">  <span class="keyword">const</span> shouldCache = !<span class="title function_">isServerRendering</span>()</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> userDef === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// userDef 若为函数，若有缓存用 createComputedGetter 转换，若无则用 createGetterInvoker 转换，获取 get</span></span><br><span class="line">    sharedPropertyDefinition.<span class="property">get</span> = shouldCache</span><br><span class="line">      ? <span class="title function_">createComputedGetter</span>(key)</span><br><span class="line">      : <span class="title function_">createGetterInvoker</span>(userDef)</span><br><span class="line">    sharedPropertyDefinition.<span class="property">set</span> = noop</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// userDef 若不是函数，则 取 userDef.get 的值</span></span><br><span class="line">    <span class="comment">// 若userDef.get为空则赋值 空函数</span></span><br><span class="line">    <span class="comment">// 若不为空，同上 if</span></span><br><span class="line">    sharedPropertyDefinition.<span class="property">get</span> = userDef.<span class="property">get</span></span><br><span class="line">      ? shouldCache &amp;&amp; userDef.<span class="property">cache</span> !== <span class="literal">false</span></span><br><span class="line">        ? <span class="title function_">createComputedGetter</span>(key)</span><br><span class="line">        : <span class="title function_">createGetterInvoker</span>(userDef.<span class="property">get</span>)</span><br><span class="line">      : noop</span><br><span class="line">    sharedPropertyDefinition.<span class="property">set</span> = userDef.<span class="property">set</span> || noop</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// computed 属性的 get，set 配置后，响应式 绑定 到 target[key]</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(target, key, sharedPropertyDefinition)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-1-createComputedGetter-key"><a href="#4-1-1-createComputedGetter-key" class="headerlink" title="4.1.1 createComputedGetter(key)"></a>4.1.1 <code>createComputedGetter(key)</code></h3><ul>
<li>获取计算属性的watcher，_computedWatchers</li>
<li>若 watcher.dirty 为true，则调用 evaluate() 进行计算获取值；若为false，继续使用watcher.value 的缓存值</li>
<li>若 Dep.target 存在，则进行依赖收集</li>
</ul>
<p><strong>【dirty】</strong>：缓存标记；true：需要重新计算；false：使用缓存</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回计算属性的结果值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createComputedGetter</span> (key) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">computedGetter</span> () &#123;</span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="variable language_">this</span>.<span class="property">_computedWatchers</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">_computedWatchers</span>[key]</span><br><span class="line">    <span class="keyword">if</span> (watcher) &#123;</span><br><span class="line">      <span class="comment">// dirty：缓存标记；true：需要重新计算；false：使用缓存</span></span><br><span class="line">      <span class="keyword">if</span> (watcher.<span class="property">dirty</span>) &#123;</span><br><span class="line">        watcher.evaluate()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 依赖收集</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        watcher.<span class="title function_">depend</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> watcher.<span class="property">value</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-1-1-1-watcher-evaluate"><a href="#4-1-1-1-watcher-evaluate" class="headerlink" title="4.1.1.1  watcher.evaluate()"></a>4.1.1.1 <code> watcher.evaluate()</code></h4><ul>
<li>调用 watcher.get() 方法计算，并将 dirty 置为 false</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Evaluate the value of the watcher.</span></span><br><span class="line"><span class="comment"> * This only gets called for lazy watchers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算 watcher 的值，仅用于 计算属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">evaluate () &#123;</span><br><span class="line">  <span class="comment">// 调用get() 方法重新计算</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-2-createGetterInvoker-userDef"><a href="#4-1-2-createGetterInvoker-userDef" class="headerlink" title="4.1.2 createGetterInvoker(userDef)"></a>4.1.2 <code>createGetterInvoker(userDef)</code></h3><ul>
<li>SSR 下，直接返回 计算属性函数，不进行缓存处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回 直接执行 fn 的函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createGetterInvoker</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">computedGetter</span> () &#123;</span><br><span class="line">    <span class="keyword">return</span> fn.<span class="title function_">call</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-响应式原理"><a href="#5-响应式原理" class="headerlink" title="5. 响应式原理"></a>5. 响应式原理</h2><p>这位<a target="_blank" rel="noopener" href="https://juejin.cn/post/6857669921166491662">大神孟思行</a>已经整理的非常好，直接拿来用好了</p>
<ol>
<li><strong>从 new Vue 开始，首先通过 get、set 监听 Data 中的数据变化，同时创建 Dep 用来搜集使用该 Data 的 Watcher。</strong></li>
<li><strong>编译模板，创建 Watcher，并将 Dep.target 标识为当前 Watcher。</strong></li>
<li><strong>编译模板时，如果使用到了 Data 中的数据，就会触发 Data 的 get 方法，然后调用 Dep.addSub 将 Watcher 搜集起来。</strong></li>
<li><strong>数据更新时，会触发 Data 的 set 方法，然后调用 Dep.notify 通知所有使用到该 Data 的 Watcher 去更新 DOM。</strong></li>
</ol>
<p><img src="/105-observer-Dep-Watcher/1657613113860-71683bd4-1f5b-4bc9-a715-6dc168f790ea.png" alt="img"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903858850758670">https://juejin.cn/post/6844903858850758670</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6857669921166491662">https://juejin.cn/post/6857669921166491662</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-06-02</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue源码/" title="Vue源码">Vue源码 </a><span class="leancloud_visitors"></span><span>大约5998个字, 19分钟59秒读完</span></div></div></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/page/2/">下一页</a></li></ul></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(无标题)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="想要查找什么..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>