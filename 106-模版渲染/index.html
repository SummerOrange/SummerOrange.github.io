<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="Hexo Theme Keep"><meta name="author" content="ChengShuomin"><title>6. 模版渲染 | 学习笔记</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/favicon.webp"><link rel="stylesheet" href="/font/css/fontawesome.min.css"><link rel="stylesheet" href="/font/css/brands.min.css"><script class="keep-theme-configurations">const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-cn"}
    KEEP.theme_config = {"base_info":{"primary_color":"#d5c4f2","title":"学习笔记","author":"ChengShuomin","avatar":"/images/avatar.webp","logo":"/images/logo.svg","favicon":"/images/favicon.webp"},"language":"zh-CN","menu":{"home":"/","archives":"/archives"},"first_screen":{"enable":true,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"♚ 今天不走，明天要跑 ♚ || 走过的路，每一步都算数","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":true,"percent":true,"hide_header":true},"home":{"announcement":null,"category":false,"tag":false},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD","copyright_info":true,"share":true,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"toc":{"enable":false,"number":false,"expand_all":false,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":false,"preload":false},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.39"},"waline":{"server_url":null,"reaction":false,"version":"3.3.2"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2021,"word_count":false,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"}
    KEEP.language_code_block = {"copy":"Copy code","copied":"Copied","fold":"Fold code block","folded":"Folded"}
    KEEP.language_copy_copyright = {"copy":"Copy copyright info","copied":"Copied","title":"Original post title","author":"Original post author","link":"Original post link"}</script><meta name="generator" content="Hexo 6.1.0"></head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span></div><main class="page-container border-box"><div class="page-main-content border-box"><div class="page-main-content-top"><header class="header-wrapper"><div class="border-box header-content"><div class="left flex-start border-box"><a class="logo-image border-box" href="/"><img src="/images/logo.svg"> </a><a class="site-name border-box" href="/">学习笔记</a></div><div class="right border-box"><div class="pc border-box"><ul class="menu-list border-box"><li class="menu-item flex-start border-box"><a class="menu-text-color border-box" href="/">Home</a></li><li class="menu-item flex-start border-box"><a class="menu-text-color border-box" href="/archives">Archives</a></li></ul></div><div class="mobile border-box flex-start"><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list border-box"><li class="drawer-menu-item border-box not-sub-menu"><label class="drawer-menu-label border-box"><a class="drawer-menu-text-color left-side flex-start border-box" href="/">HOME</a></label></li><li class="drawer-menu-item border-box not-sub-menu"><label class="drawer-menu-label border-box"><a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">ARCHIVES</a></label></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle border-box"><div class="main-content border-box"><div class="fade-in-down-animation"><div class="post-page-container border-box"><div class="post-content-container border-box"><div class="post-content-bottom border-box"><div class="post-title">6. 模版渲染</div><div class="post-header border-box"><div class="avatar-box border-box"><img src="/images/avatar.webp"></div><div class="info-box"><div class="author border-box"><span class="name">ChengShuomin</span> <span class="author-badge">Lv3</span></div><div class="meta-info border-box"><div class="post-meta-info-container border-box post"><div class="post-meta-info border-box"><span class="meta-info-item post-create-date"><i class="icon fa-solid fa-calendar-plus"></i>&nbsp; <span class="datetime">2022-06-28</span> </span><span class="post-tag meta-info-item border-box"><ul class="post-tag-ul"><li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Vue%E6%BA%90%E7%A0%81/">Vue源码</a></li></ul></span></div></div></div></div></div><div class="post-content keep-markdown-body"><h1 id="入口-vm-mount-方法："><a href="#入口-vm-mount-方法：" class="headerlink" title="入口 vm.$mount 方法："></a>入口 <code>vm.$mount</code> 方法：</h1><p>在 <code>vm.$mount(vm.$options.el)</code>中，</p><h1 id="1-扩展-mount-方法（platforms-web-entry-runtime-with-compiler）"><a href="#1-扩展-mount-方法（platforms-web-entry-runtime-with-compiler）" class="headerlink" title="1. 扩展 $mount 方法（platforms/web/entry-runtime-with-compiler）"></a>1. 扩展 $mount 方法（<code>platforms/web/entry-runtime-with-compiler</code>）</h1><p><strong>先调用 扩展的 $mount 方法（</strong><code>src/platforms/web/entry-runtime-with-compiler.js</code><strong>）, 生成 render。</strong></p><ul><li><p>id 不能挂载到 body 或 documentElement 页面文档上</p></li><li><p>若 this.$options 上没有 render 方法</p></li><li><ul><li>取 $options 的 template 或 el 获取元素，生成 html 字符串（此 html 字符串即 下文 parseHTML 方法的入参 html）</li><li>调用 compileToFunctions ，获取 render 方法</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/platforms/web/entry-runtime-with-compiler.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mount = <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  <span class="comment">// 获取元素或查询元素 （query 方法分析见下方）</span></span><br><span class="line">  <span class="comment">//  el 是元素选择器</span></span><br><span class="line">  el = el &amp;&amp; <span class="title function_">query</span>(el)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="comment">// vue 不允许将 id 直接挂到 body 或 页面文档</span></span><br><span class="line">  <span class="keyword">if</span> (el === <span class="variable language_">document</span>.<span class="property">body</span> || el === <span class="variable language_">document</span>.<span class="property">documentElement</span>) &#123;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.`</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 此处的 $options 如下图1</span></span><br><span class="line">  <span class="keyword">const</span> options = <span class="variable language_">this</span>.<span class="property">$options</span></span><br><span class="line">  <span class="comment">// resolve template/el and convert to render function</span></span><br><span class="line">  <span class="keyword">if</span> (!options.<span class="property">render</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> template = options.<span class="property">template</span></span><br><span class="line">    <span class="comment">// 若参数中有 template</span></span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> template === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 若有 # ，则可能是id 选择器的标志，用 idToTemplate 转换获取 node 节点</span></span><br><span class="line">        <span class="keyword">if</span> (template.<span class="title function_">charAt</span>(<span class="number">0</span>) === <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">          template = <span class="title function_">idToTemplate</span>(template)</span><br><span class="line">          <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">          <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !template) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">`Template element not found or is empty: <span class="subst">$&#123;options.template&#125;</span>`</span>,</span><br><span class="line">              <span class="variable language_">this</span></span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (template.<span class="property">nodeType</span>) &#123;</span><br><span class="line">        <span class="comment">// 若 template 是node 类型节点，则取其 内部html 节点</span></span><br><span class="line">        template = template.<span class="property">innerHTML</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(<span class="string">&#x27;invalid template option:&#x27;</span> + template, <span class="variable language_">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el) &#123;</span><br><span class="line">      <span class="comment">// 若el 有值，则取 el 本身元素（此处也表明 优先取 template 属性值）</span></span><br><span class="line">      template = <span class="title function_">getOuterHTML</span>(el)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">        <span class="title function_">mark</span>(<span class="string">&#x27;compile&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 1.模板编译，将 template 解析为 ast tree</span></span><br><span class="line"><span class="comment">        * 2.将 ast tree 转换成 render 语法字符串</span></span><br><span class="line"><span class="comment">        * 3.生成 render 方法</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line">      <span class="keyword">const</span> &#123; render, staticRenderFns &#125; = <span class="title function_">compileToFunctions</span>(template, &#123;</span><br><span class="line">        <span class="attr">outputSourceRange</span>: process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">        shouldDecodeNewlines,</span><br><span class="line">        shouldDecodeNewlinesForHref,</span><br><span class="line">        <span class="attr">delimiters</span>: options.<span class="property">delimiters</span>,</span><br><span class="line">        <span class="attr">comments</span>: options.<span class="property">comments</span></span><br><span class="line">      &#125;, <span class="variable language_">this</span>)</span><br><span class="line">      <span class="comment">// 这里的 render 就是生成虚拟 DOM 的方法</span></span><br><span class="line">      options.<span class="property">render</span> = render</span><br><span class="line">      options.<span class="property">staticRenderFns</span> = staticRenderFns</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">        <span class="title function_">mark</span>(<span class="string">&#x27;compile end&#x27;</span>)</span><br><span class="line">        <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;<span class="variable language_">this</span>._name&#125;</span> compile`</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;compile end&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 此处转换后的 $options 如下图2</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">$options</span>)</span><br><span class="line">  <span class="comment">// 由于是扩展方法，则 return 回 $mount 方法，使其继续调用原始方法</span></span><br><span class="line">  <span class="keyword">return</span> mount.<span class="title function_">call</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1656583813165-0d3bf22c-7b9d-4187-8ae8-6fe052976217.png" alt="img"></p><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1656583751696-a1a3581c-3204-4245-8f82-433ef3404b5e.png" alt="img"></p><h4 id="【辅助】query-el-方法："><a href="#【辅助】query-el-方法：" class="headerlink" title="【辅助】query(el) 方法："></a>【辅助】<code>query(el)</code> 方法：</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Query an element selector if it&#x27;s not an element already.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">query</span> (<span class="attr">el</span>: string | <span class="title class_">Element</span>): <span class="title class_">Element</span> &#123;</span><br><span class="line">  <span class="comment">// el 的格式只有 string 和 Element</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> el === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// string 时，相当于 el 的值是元素的 id ，通过 document.querySelector() 方法获取dom元素 ，并返回</span></span><br><span class="line">    <span class="keyword">const</span> selected = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(el)</span><br><span class="line">    <span class="keyword">if</span> (!selected) &#123;</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;Cannot find element: &#x27;</span> + el</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> selected</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 若是 Element 类型，直接返回 元素</span></span><br><span class="line">    <span class="keyword">return</span> el</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-1-compileToFunctions"><a href="#1-1-compileToFunctions" class="headerlink" title="1.1 compileToFunctions()"></a>1.1 <code>compileToFunctions()</code></h2><ul><li>找 compileToFunctions() 的定义在 <code>src\platforms\web\compiler\index.js</code>，由 createCompiler 创建</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\platforms\web\compiler\index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createCompiler &#125; <span class="keyword">from</span> <span class="string">&#x27;compiler/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; compile, compileToFunctions &#125; = <span class="title function_">createCompiler</span>(baseOptions)</span><br><span class="line"><span class="keyword">export</span> &#123; compile, compileToFunctions &#125;</span><br></pre></td></tr></table></figure><h2 id="1-2-createCompiler"><a href="#1-2-createCompiler" class="headerlink" title="1.2 createCompiler"></a>1.2 <code>createCompiler</code></h2><ul><li>再找 createCompiler 的定义在 <code>src\compiler\index.js</code>，引出创建方法 <code>createCompilerCreator</code></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模板编译，将模板代码转化为 AST；</span></span><br><span class="line"><span class="comment"> * 优化 AST，方便后续虚拟 DOM 更新；</span></span><br><span class="line"><span class="comment"> * 生成代码，将 AST 转化为可执行的代码；</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createCompiler = <span class="title function_">createCompilerCreator</span>(<span class="keyword">function</span> <span class="title function_">baseCompile</span> (</span><br><span class="line">  <span class="attr">template</span>: string,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">CompiledResult</span> &#123;</span><br><span class="line">  <span class="comment">// baseCompile 的调用在：</span></span><br><span class="line">  <span class="comment">// src\compiler\create-compiler.js 中的 const compiled = baseCompile(template.trim(), finalOptions)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 解析 template 模板，转换为 ast</span></span><br><span class="line">  <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options)</span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">optimize</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">// 优化 ast，标记静态节点</span></span><br><span class="line">    <span class="title function_">optimize</span>(ast, options)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将 ast 转化为可执行代码</span></span><br><span class="line">  <span class="keyword">const</span> code = <span class="title function_">generate</span>(ast, options)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="1-3-createCompilerCreator"><a href="#1-3-createCompilerCreator" class="headerlink" title="1.3 createCompilerCreator"></a>1.3 <code>createCompilerCreator</code></h2><ul><li><p>再找<code>createCompilerCreator</code>创建在 <code>src\compiler\create-compiler.js</code>，由此引出：</p><ul><li><code>createCompileToFunctionFn(compile)</code></li><li><code>compile()</code> 的定义在 <code>createCompiler</code>方法内的子函数</li></ul></li></ul><h3 id="1-3-1-createCompilerCreator-和-compile"><a href="#1-3-1-createCompilerCreator-和-compile" class="headerlink" title="1.3.1 createCompilerCreator 和 compile()"></a>1.3.1 <code>createCompilerCreator</code> 和 <code>compile()</code></h3><ul><li>在 <code>compile()</code>的实现中，引出 <code>baseCompile(template.trim(), finalOptions)</code></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\create-compiler.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createCompilerCreator</span> (<span class="attr">baseCompile</span>: <span class="title class_">Function</span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">createCompiler</span> (<span class="attr">baseOptions</span>: <span class="title class_">CompilerOptions</span>) &#123;</span><br><span class="line">    <span class="comment">// compile 是在 createCompiler 函数体内定义个一个子函数</span></span><br><span class="line">    <span class="comment">// 应用 eg： src\compiler\to-function.js 中，const compiled = compile(template, options)</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">compile</span> (</span><br><span class="line">      <span class="attr">template</span>: string,</span><br><span class="line">      options?: <span class="title class_">CompilerOptions</span></span><br><span class="line">    ): <span class="title class_">CompiledResult</span> &#123;</span><br><span class="line">         <span class="comment">// 深拷贝参数 baseOptions</span></span><br><span class="line">        <span class="keyword">const</span> finalOptions = <span class="title class_">Object</span>.<span class="title function_">create</span>(baseOptions)</span><br><span class="line">        <span class="comment">// modules, directives, warn 的合并</span></span><br><span class="line">        ... </span><br><span class="line">        <span class="comment">// baseCompile 方法是 src\compiler\index.js 中 创建</span></span><br><span class="line">        <span class="keyword">const</span> compiled = <span class="title function_">baseCompile</span>(template.<span class="title function_">trim</span>(), finalOptions)</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> compiled</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        compile,</span><br><span class="line">        <span class="attr">compileToFunctions</span>: <span class="title function_">createCompileToFunctionFn</span>(compile)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">        </span><br></pre></td></tr></table></figure><h4 id="1-3-1-1-baseCompile-template-trim-finalOptions"><a href="#1-3-1-1-baseCompile-template-trim-finalOptions" class="headerlink" title="1.3.1.1 baseCompile(template.trim(), finalOptions)"></a>1.3.1.1 <code>baseCompile(template.trim(), finalOptions)</code></h4><p>此方法的创建在 1.1.2 内。</p><p>调用此方法后，由此引出 ：</p><ul><li><code>const ast = parse(template.trim(), options)</code>，具体分析见下文 【 <em><strong>3. 生成AST</strong></em> 】</li><li><code>optimize(ast, options)</code> &#x2F;&#x2F; todo</li><li><code>constcode = generate(ast, options)</code> &#x2F;&#x2F; todo</li></ul><h3 id="1-3-2-createCompileToFunctionFn-compile"><a href="#1-3-2-createCompileToFunctionFn-compile" class="headerlink" title="1.3.2 createCompileToFunctionFn(compile)"></a>1.3.2 <code>createCompileToFunctionFn(compile)</code></h3><ul><li>再找 <code>createCompileToFunctionFn(compile)</code> 创建在 <code>src\compiler\to-function.js</code></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\to-function.js</span></span><br><span class="line"></span><br><span class="line">type <span class="title class_">CompiledFunctionResult</span> = &#123;</span><br><span class="line">  <span class="attr">render</span>: <span class="title class_">Function</span>;</span><br><span class="line">  <span class="attr">staticRenderFns</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Function</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建 编译函数 render, staticRenderFns</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">创建</span>&#125; compile </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span>  <span class="variable">CompiledFunctionResult</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createCompileToFunctionFn</span> (<span class="attr">compile</span>: <span class="title class_">Function</span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="comment">// 创建编译缓存</span></span><br><span class="line">  <span class="keyword">const</span> cache = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">compileToFunctions</span> (</span><br><span class="line">    <span class="attr">template</span>: string,</span><br><span class="line">    options?: <span class="title class_">CompilerOptions</span>,</span><br><span class="line">    vm?: <span class="title class_">Component</span></span><br><span class="line">  ): <span class="title class_">CompiledFunctionResult</span> &#123;</span><br><span class="line">    options = <span class="title function_">extend</span>(&#123;&#125;, options)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// check cache</span></span><br><span class="line">    <span class="comment">// 检查缓存，有缓存直接用</span></span><br><span class="line">    <span class="keyword">const</span> key = options.<span class="property">delimiters</span></span><br><span class="line">      ? <span class="title class_">String</span>(options.<span class="property">delimiters</span>) + template</span><br><span class="line">      : template</span><br><span class="line">    <span class="keyword">if</span> (cache[key]) &#123;</span><br><span class="line">      <span class="keyword">return</span> cache[key]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// compile</span></span><br><span class="line">    <span class="comment">// compile 函数 是在 src\compiler\create-compiler.js 下，createCompilerCreator 中 return 的 createCompiler 的函数体中定义 </span></span><br><span class="line">    <span class="keyword">const</span> compiled = <span class="title function_">compile</span>(template, options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check compilation errors/tips</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// turn code into functions</span></span><br><span class="line">    <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> fnGenErrors = []</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * createFunction 核心 new Function(code)</span></span><br><span class="line"><span class="comment">     * 将 字符串 创建为 函数 </span></span><br><span class="line"><span class="comment">     * */</span> </span><br><span class="line">    <span class="comment">// render 创建好了</span></span><br><span class="line">    res.<span class="property">render</span> = <span class="title function_">createFunction</span>(compiled.<span class="property">render</span>, fnGenErrors)</span><br><span class="line">    res.<span class="property">staticRenderFns</span> = compiled.<span class="property">staticRenderFns</span>.<span class="title function_">map</span>(<span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">createFunction</span>(code, fnGenErrors)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check function generation errors.</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建好的 res 放在缓存</span></span><br><span class="line">    <span class="keyword">return</span> (cache[key] = res)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="2-原始-mount-方法（platforms-web-runtime-index）"><a href="#2-原始-mount-方法（platforms-web-runtime-index）" class="headerlink" title="2. 原始 $mount 方法（platforms/web/runtime/index）"></a>2. 原始 $mount 方法（<code>platforms/web/runtime/index</code>）</h1><p><strong>再调用 原始的 $mount 方法（<code>src/platforms/web/runtime/index.js</code>）, 获得元素，返回 mountComponent 方法</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/platforms/web/runtime/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; mountComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;core/instance/lifecycle&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// public mount method</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  <span class="comment">// 初始化挂载组件</span></span><br><span class="line">  el = el &amp;&amp; inBrowser ? <span class="title function_">query</span>(el) : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">mountComponent</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="mountComponent-this-el-hydrating-方法："><a href="#mountComponent-this-el-hydrating-方法：" class="headerlink" title="mountComponent(this, el, hydrating) 方法："></a><code>mountComponent(this, el, hydrating)</code> 方法：</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\lifecycle.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">mountComponent</span> (</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span><br><span class="line">  <span class="attr">el</span>: ?<span class="title class_">Element</span>,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): <span class="title class_">Component</span> &#123;</span><br><span class="line">  vm.<span class="property">$el</span> = el</span><br><span class="line">  <span class="comment">// 若没有获取解析的 render 函数，抛出警告</span></span><br><span class="line">  <span class="comment">// render 是解析模板生成的，</span></span><br><span class="line">  <span class="comment">// 在 /entry-runtime-with-Compiler.js 中 $mounted() , const &#123; render, staticRenderFns &#125; = compileToFunctions(template,&#123;&#125;) 生成的</span></span><br><span class="line">  <span class="keyword">if</span> (!vm.<span class="property">$options</span>.<span class="property">render</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeMount&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> updateComponent</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">    <span class="comment">// 支持performance的开发环境，添加关于 performance 的分析时间线</span></span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> name = vm.<span class="property">_name</span></span><br><span class="line">      <span class="keyword">const</span> id = vm.<span class="property">_uid</span></span><br><span class="line">      <span class="keyword">const</span> startTag = <span class="string">`vue-perf-start:<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">      <span class="keyword">const</span> endTag = <span class="string">`vue-perf-end:<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">      <span class="title function_">mark</span>(startTag)</span><br><span class="line">      <span class="keyword">const</span> vnode = vm.<span class="title function_">_render</span>()</span><br><span class="line">      <span class="title function_">mark</span>(endTag)</span><br><span class="line">      <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;name&#125;</span> render`</span>, startTag, endTag)</span><br><span class="line"></span><br><span class="line">      <span class="title function_">mark</span>(startTag)</span><br><span class="line">      vm.<span class="title function_">_update</span>(vnode, hydrating) <span class="comment">// 核心逻辑 同else的，vm._update(vm._render(), hydrating)</span></span><br><span class="line">      <span class="title function_">mark</span>(endTag)</span><br><span class="line">      <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;name&#125;</span> patch`</span>, startTag, endTag)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 生产环境环境 </span></span><br><span class="line">    <span class="comment">// vm._render 用于生成虚拟 DOM</span></span><br><span class="line">    <span class="comment">// _update 内部调用 patch 方法 将虚拟 DOM 与 真实的 DOM 同步 ( diff )</span></span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we set this to vm._watcher inside the watcher&#x27;s constructor</span></span><br><span class="line">  <span class="comment">// since the watcher&#x27;s initial patch may call $forceUpdate (e.g. inside child</span></span><br><span class="line">  <span class="comment">// component&#x27;s mounted hook), which relies on vm._watcher being already defined</span></span><br><span class="line">  <span class="comment">// 【new Watcher 初始化】监听当前组件状态，当有数据变化时，更新组件</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, updateComponent, noop, &#123;</span><br><span class="line">    before () &#123;</span><br><span class="line">      <span class="keyword">if</span> (vm.<span class="property">_isMounted</span> &amp;&amp; !vm.<span class="property">_isDestroyed</span>) &#123;</span><br><span class="line">        <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeUpdate&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>)</span><br><span class="line">  hydrating = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// manually mounted instance, call mounted on self</span></span><br><span class="line">  <span class="comment">// mounted is called for render-created child components in its inserted hook</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$vnode</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">    vm.<span class="property">_isMounted</span> = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;mounted&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-1-vm-render"><a href="#2-1-vm-render" class="headerlink" title="2.1 vm._render()"></a>2.1 <code>vm._render()</code></h2><p>vm._render <strong>用于生成虚拟 dom</strong>，执行 dom-diff，更新真实 dom</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\render.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initRender</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">    <span class="comment">// bind the createElement fn to this instance</span></span><br><span class="line">  <span class="comment">// so that we get proper render context inside it.</span></span><br><span class="line">  <span class="comment">// args order: tag, data, children, normalizationType, alwaysNormalize</span></span><br><span class="line">  <span class="comment">// internal version is used by render functions compiled from templates</span></span><br><span class="line">  vm.<span class="property">_c</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">false</span>)              <span class="comment">// 系统创建元素的 方法</span></span><br><span class="line">  <span class="comment">// normalization is always applied for the public version, used in</span></span><br><span class="line">  <span class="comment">// user-written render functions.</span></span><br><span class="line">  vm.<span class="property">$createElement</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">true</span>)   <span class="comment">// 用户提供了 render 属性时创建元素的方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_render</span> = <span class="keyword">function</span> (<span class="params"></span>): <span class="title class_">VNode</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> &#123; render, _parentVnode &#125; = vm.<span class="property">$options</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 执行 render 方法中的 createElement 参数就是 vm.$createElement，</span></span><br><span class="line">    <span class="comment">// vm.$createElement 方法是定义在 initRender 方法上</span></span><br><span class="line">    vnode = render.<span class="title function_">call</span>(vm.<span class="property">_renderProxy</span>, vm.<span class="property">$createElement</span>)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// createEmptyVNode 的核心  const node = new VNode()</span></span><br><span class="line">    vnode = <span class="title function_">createEmptyVNode</span>()</span><br><span class="line">    <span class="comment">// set parent</span></span><br><span class="line">    vnode.<span class="property">parent</span> = _parentVnode</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>initRender</code>,</p><p>这里 vm._c 和 vm.$createElement 的区别为：</p><p>vm._c 是被模板编译成的 render 函数使用；</p><p>vm.$createElement 是用户手写 render 方法使用的；</p><p>两个方法支持的参数相同，并且内部都调用了 createElement 方法</p><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657800175284-07e129c1-8412-46ed-a8eb-70fbe5d575b6.png" alt="img"></p><h3 id="2-1-1-VNode"><a href="#2-1-1-VNode" class="headerlink" title="2.1.1 VNode"></a>2.1.1 <code>VNode</code></h3><p>虚拟Dom 的类是 <code>VNode</code>，主要属性是：tag, data, children, text, elm, ns, context, key, parent, raw</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="attr">tag</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">data</span>: <span class="title class_">VNodeData</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">children</span>: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;;</span><br><span class="line">  <span class="attr">text</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">elm</span>: <span class="title class_">Node</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">ns</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">context</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// rendered in this component&#x27;s scope</span></span><br><span class="line">  <span class="attr">key</span>: string | number | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">componentOptions</span>: <span class="title class_">VNodeComponentOptions</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">componentInstance</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// component instance</span></span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">VNode</span> | <span class="keyword">void</span>; <span class="comment">// component placeholder node</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// strictly internal</span></span><br><span class="line">  <span class="attr">raw</span>: boolean; <span class="comment">// contains raw HTML? (server only)</span></span><br><span class="line">  <span class="attr">isStatic</span>: boolean; <span class="comment">// hoisted static node</span></span><br><span class="line">  <span class="attr">isRootInsert</span>: boolean; <span class="comment">// necessary for enter transition check</span></span><br><span class="line">  <span class="attr">isComment</span>: boolean; <span class="comment">// empty comment placeholder?</span></span><br><span class="line">  <span class="attr">isCloned</span>: boolean; <span class="comment">// is a cloned node?</span></span><br><span class="line">  <span class="attr">isOnce</span>: boolean; <span class="comment">// is a v-once node?</span></span><br><span class="line">  <span class="attr">asyncFactory</span>: <span class="title class_">Function</span> | <span class="keyword">void</span>; <span class="comment">// async component factory function</span></span><br><span class="line">  <span class="attr">asyncMeta</span>: <span class="title class_">Object</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">isAsyncPlaceholder</span>: boolean;</span><br><span class="line">  <span class="attr">ssrContext</span>: <span class="title class_">Object</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">fnContext</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// real context vm for functional nodes</span></span><br><span class="line">  <span class="attr">fnOptions</span>: ?<span class="title class_">ComponentOptions</span>; <span class="comment">// for SSR caching</span></span><br><span class="line">  <span class="attr">devtoolsMeta</span>: ?<span class="title class_">Object</span>; <span class="comment">// used to store functional render context for devtools</span></span><br><span class="line">  <span class="attr">fnScopeId</span>: ?string; <span class="comment">// functional scope id support</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (</span><br><span class="line">    tag?: string,</span><br><span class="line">    data?: <span class="title class_">VNodeData</span>,</span><br><span class="line">    children?: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;,</span><br><span class="line">    text?: string,</span><br><span class="line">    elm?: <span class="title class_">Node</span>,</span><br><span class="line">    context?: <span class="title class_">Component</span>,</span><br><span class="line">    componentOptions?: <span class="title class_">VNodeComponentOptions</span>,</span><br><span class="line">    asyncFactory?: <span class="title class_">Function</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tag</span> = tag</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = data</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">children</span> = children</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">text</span> = text</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">elm</span> = elm</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ns</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span> = context</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnContext</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnOptions</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnScopeId</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = data &amp;&amp; data.<span class="property">key</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentOptions</span> = componentOptions</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentInstance</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">raw</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStatic</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRootInsert</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isComment</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isCloned</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isOnce</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncFactory</span> = asyncFactory</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncMeta</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isAsyncPlaceholder</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// DEPRECATED: alias for componentInstance for backwards compat.</span></span><br><span class="line">  <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">  get child (): <span class="title class_">Component</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">componentInstance</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2-vm-update"><a href="#2-2-vm-update" class="headerlink" title="2.2 vm._update()"></a>2.2 <code>vm._update()</code></h2><p>把 VNode 渲染成真实的 DOM。</p><p>被调用：</p><ul><li>mountComponent ，在初次渲染时</li><li>在 update 时</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\core\instance\lifecycle.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">lifecycleMixin</span> (<span class="title class_">Vue</span>: <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt;) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_update</span> = <span class="keyword">function</span> (<span class="params">vnode: VNode, hydrating?: boolean</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">// 初次渲染</span></span><br><span class="line">    <span class="comment">// vm.__patch__ 方法：进行 dom diff 比较，然后更新 dom</span></span><br><span class="line">    <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">      <span class="comment">// initial render</span></span><br><span class="line">      vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(vm.<span class="property">$el</span>, vnode, hydrating, <span class="literal">false</span> <span class="comment">/* removeOnly */</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// updates</span></span><br><span class="line">      <span class="comment">// 更新</span></span><br><span class="line">      vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(prevVnode, vnode)</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-1-Vue-prototype-patch"><a href="#2-2-1-Vue-prototype-patch" class="headerlink" title="2.2.1 Vue.prototype.__patch__"></a>2.2.1 <code>Vue.prototype.__patch__</code></h3><p><code>__patch__</code>项目中有两种实现，区分于平台：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/platforms/web/runtime/index.js</span></span><br><span class="line"><span class="comment">// install platform patch function</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__patch__</span> = inBrowser ? patch : noop</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/platforms/weex/runtime/index.js</span></span><br><span class="line"><span class="comment">// install platform patch function</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__patch__</span> = patch</span><br></pre></td></tr></table></figure><h2 id="2-3-new-Watcher"><a href="#2-3-new-Watcher" class="headerlink" title="2.3 new Watcher"></a>2.3 <code>new Watcher</code></h2><p>关于 Watcher 见 <a class="link" target="_blank" rel="noopener" href="https://www.yuque.com/orange-yubdy/ki9i6o/onzg44">05- Observer<i class="fas fa-external-link-alt"></i></a></p><h1 id="3-生成-AST"><a href="#3-生成-AST" class="headerlink" title="3. 生成 AST"></a>3. 生成 AST</h1><p>如下创建入口，引出 <code>parse</code>方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options)</span><br></pre></td></tr></table></figure><p>例： 如下模板 template：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;editor&quot;</span>&gt;</span><br><span class="line">  &lt;!-- 注释 --&gt;</span><br><span class="line">  &lt;试试\&lt;</span><br><span class="line">  &lt;p&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>li的值<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">:value</span>=<span class="string">&quot;input + new Date()&quot;</span> @<span class="attr">input</span>=<span class="string">&quot;update&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-html</span>=<span class="string">&quot;compiledMarkdown&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>生成的 AST 结构如下：</p><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657793256463-9f07c6aa-a310-4f26-b11a-046ff5be636c.png" alt="img"></p><h2 id="3-1-parse"><a href="#3-1-parse" class="headerlink" title="3.1 parse"></a>3.1 <code>parse</code></h2><p>分析源码，由 <code>parse</code> 引出 <code>parseHTML</code> ，</p><p>此处 template ：</p><p><strong>注意：在转字符串时：</strong></p><ul><li>**会 将类似 <code>&lt;</code> 直接转为 <code>&amp;lt;</code></li><li>会将<code>&lt;p&gt;</code> 这样的自动补全为<code>&lt;p&gt;&lt;/p&gt;</code></li></ul><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657785219591-105ece0c-a99c-4215-b3e3-785f767b19ad.png" alt="img"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  src\compiler\parser\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert HTML string to AST.</span></span><br><span class="line"><span class="comment"> * 将 html 字符串 转换为 AST</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parse</span> (</span><br><span class="line">  <span class="attr">template</span>: string,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">ASTElement</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">const</span> stack = []</span><br><span class="line">  <span class="keyword">let</span> root</span><br><span class="line">  ...</span><br><span class="line">    <span class="title function_">parseHTML</span>(template, &#123;</span><br><span class="line">    warn,</span><br><span class="line">    <span class="attr">expectHTML</span>: options.<span class="property">expectHTML</span>,</span><br><span class="line">    <span class="attr">isUnaryTag</span>: options.<span class="property">isUnaryTag</span>,</span><br><span class="line">    <span class="attr">canBeLeftOpenTag</span>: options.<span class="property">canBeLeftOpenTag</span>,</span><br><span class="line">    <span class="attr">shouldDecodeNewlines</span>: options.<span class="property">shouldDecodeNewlines</span>,</span><br><span class="line">    <span class="attr">shouldDecodeNewlinesForHref</span>: options.<span class="property">shouldDecodeNewlinesForHref</span>,</span><br><span class="line">    <span class="attr">shouldKeepComment</span>: options.<span class="property">comments</span>,</span><br><span class="line">    <span class="attr">outputSourceRange</span>: options.<span class="property">outputSourceRange</span>,</span><br><span class="line">    start (tag, attrs, unary, start, end) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    end (tag, start, end) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    chars (<span class="attr">text</span>: string, <span class="attr">start</span>: number, <span class="attr">end</span>: number) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line">    comment (<span class="attr">text</span>: string, start, end) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-1-1-start"><a href="#3-1-1-start" class="headerlink" title="3.1.1 start"></a>3.1.1 <code>start</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">start (tag, attrs, unary, start, end) &#123;</span><br><span class="line">      <span class="comment">// start tag 开头标签回调后执行</span></span><br><span class="line">      <span class="comment">// check namespace.</span></span><br><span class="line">      <span class="comment">// inherit parent ns if there is one</span></span><br><span class="line">      <span class="keyword">const</span> ns = (currentParent &amp;&amp; currentParent.<span class="property">ns</span>) || <span class="title function_">platformGetTagNamespace</span>(tag)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// handle IE svg bug</span></span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (isIE &amp;&amp; ns === <span class="string">&#x27;svg&#x27;</span>) &#123;</span><br><span class="line">        attrs = <span class="title function_">guardIESVGBug</span>(attrs)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建 AST 节点</span></span><br><span class="line">      <span class="keyword">let</span> <span class="attr">element</span>: <span class="title class_">ASTElement</span> = <span class="title function_">createASTElement</span>(tag, attrs, currentParent)</span><br><span class="line">      <span class="keyword">if</span> (ns) &#123;</span><br><span class="line">        element.<span class="property">ns</span> = ns</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="comment">// apply pre-transforms</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; preTransforms.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        element = preTransforms[i](element, options) || element</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!inVPre) &#123;</span><br><span class="line">        <span class="title function_">processPre</span>(element)</span><br><span class="line">        <span class="keyword">if</span> (element.<span class="property">pre</span>) &#123;</span><br><span class="line">          inVPre = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">platformIsPreTag</span>(element.<span class="property">tag</span>)) &#123;</span><br><span class="line">        inPre = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (inVPre) &#123;</span><br><span class="line">        <span class="title function_">processRawAttrs</span>(element)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!element.<span class="property">processed</span>) &#123;</span><br><span class="line">        <span class="comment">// structural directives</span></span><br><span class="line">        <span class="comment">// 处理指令: v-for v-if v-once</span></span><br><span class="line">        <span class="title function_">processFor</span>(element)</span><br><span class="line">        <span class="title function_">processIf</span>(element)</span><br><span class="line">        <span class="title function_">processOnce</span>(element)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">        root = element</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">          <span class="title function_">checkRootConstraints</span>(root)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 闭合标签将 ast element 存入stack</span></span><br><span class="line">      <span class="keyword">if</span> (!unary) &#123;</span><br><span class="line">        currentParent = element</span><br><span class="line">        stack.<span class="title function_">push</span>(element)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 非闭合标签关闭元素</span></span><br><span class="line">        <span class="title function_">closeElement</span>(element)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure><h4 id="3-1-1-1-createASTElement-AST-节点-结构"><a href="#3-1-1-1-createASTElement-AST-节点-结构" class="headerlink" title="3.1.1.1 createASTElement AST 节点 结构"></a>3.1.1.1 <code>createASTElement</code> AST 节点 结构</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\parser\index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createASTElement</span> (</span><br><span class="line">  <span class="attr">tag</span>: string,</span><br><span class="line">  <span class="attr">attrs</span>: <span class="title class_">Array</span>&lt;<span class="title class_">ASTAttr</span>&gt;,</span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">ASTElement</span> | <span class="keyword">void</span></span><br><span class="line">): <span class="title class_">ASTElement</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="number">1</span>, <span class="comment">// 节点类型</span></span><br><span class="line">    tag, <span class="comment">// 节点名称</span></span><br><span class="line">    <span class="attr">attrsList</span>: attrs, <span class="comment">// 属性列表</span></span><br><span class="line">    <span class="attr">attrsMap</span>: <span class="title function_">makeAttrsMap</span>(attrs), <span class="comment">// 属性 Map</span></span><br><span class="line">    <span class="attr">rawAttrsMap</span>: &#123;&#125;, <span class="comment">// </span></span><br><span class="line">    parent, <span class="comment">// 父节点</span></span><br><span class="line">    <span class="attr">children</span>: []  <span class="comment">// 子节点</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>【辅助】 <code>makeAttrsMap()</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回转换 attrs 后的map，key 是 attr[i].name, value 是 attrs[i].value</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeAttrsMap</span> (<span class="attr">attrs</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Object</span>&gt;): <span class="title class_">Object</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> map = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = attrs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">      map[attrs[i].<span class="property">name</span>] &amp;&amp; !isIE &amp;&amp; !isEdge</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(<span class="string">&#x27;duplicate attribute: &#x27;</span> + attrs[i].<span class="property">name</span>, attrs[i])</span><br><span class="line">    &#125;</span><br><span class="line">    map[attrs[i].<span class="property">name</span>] = attrs[i].<span class="property">value</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-1-2-end"><a href="#3-1-2-end" class="headerlink" title="3.1.2 end"></a>3.1.2 <code>end</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">end (tag, start, end) &#123;</span><br><span class="line">      <span class="comment">// end tag 结尾标签回调后执行</span></span><br><span class="line">      <span class="keyword">const</span> element = stack[stack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">      <span class="comment">// pop stack</span></span><br><span class="line">      <span class="comment">// 出栈，重置当前的父节点</span></span><br><span class="line">      stack.<span class="property">length</span> -= <span class="number">1</span></span><br><span class="line">      currentParent = stack[stack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">        element.<span class="property">end</span> = end</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">closeElement</span>(element)</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure><h3 id="3-1-3-chars"><a href="#3-1-3-chars" class="headerlink" title="3.1.3 chars"></a>3.1.3 <code>chars</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">chars (<span class="attr">text</span>: string, <span class="attr">start</span>: number, <span class="attr">end</span>: number) &#123;</span><br><span class="line">     <span class="comment">// 文本 回调后执行</span></span><br><span class="line">     <span class="comment">// 文本节点外如果没有父节点则不处理报错</span></span><br><span class="line">     <span class="keyword">if</span> (!currentParent) &#123;</span><br><span class="line">       <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (text === template) &#123;</span><br><span class="line">           <span class="title function_">warnOnce</span>(</span><br><span class="line">             <span class="string">&#x27;Component template requires a root element, rather than just text.&#x27;</span>,</span><br><span class="line">             &#123; start &#125;</span><br><span class="line">           )</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((text = text.<span class="title function_">trim</span>())) &#123;</span><br><span class="line">           <span class="title function_">warnOnce</span>(</span><br><span class="line">             <span class="string">`text &quot;<span class="subst">$&#123;text&#125;</span>&quot; outside root element will be ignored.`</span>,</span><br><span class="line">             &#123; start &#125;</span><br><span class="line">           )</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// IE textarea placeholder bug</span></span><br><span class="line">     <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">     <span class="keyword">if</span> (isIE &amp;&amp;</span><br><span class="line">       currentParent.<span class="property">tag</span> === <span class="string">&#x27;textarea&#x27;</span> &amp;&amp;</span><br><span class="line">       currentParent.<span class="property">attrsMap</span>.<span class="property">placeholder</span> === text</span><br><span class="line">     ) &#123;</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">const</span> children = currentParent.<span class="property">children</span></span><br><span class="line">     <span class="keyword">if</span> (inPre || text.<span class="title function_">trim</span>()) &#123;</span><br><span class="line">       text = <span class="title function_">isTextTag</span>(currentParent) ? text : <span class="title function_">decodeHTMLCached</span>(text)</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!children.<span class="property">length</span>) &#123;</span><br><span class="line">       <span class="comment">// remove the whitespace-only node right after an opening tag</span></span><br><span class="line">       text = <span class="string">&#x27;&#x27;</span></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (whitespaceOption) &#123;</span><br><span class="line">       <span class="keyword">if</span> (whitespaceOption === <span class="string">&#x27;condense&#x27;</span>) &#123;</span><br><span class="line">         <span class="comment">// in condense mode, remove the whitespace node if it contains</span></span><br><span class="line">         <span class="comment">// line break, otherwise condense to a single space</span></span><br><span class="line">         text = lineBreakRE.<span class="title function_">test</span>(text) ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; &#x27;</span></span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         text = <span class="string">&#x27; &#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       text = preserveWhitespace ? <span class="string">&#x27; &#x27;</span> : <span class="string">&#x27;&#x27;</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (text) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!inPre &amp;&amp; whitespaceOption === <span class="string">&#x27;condense&#x27;</span>) &#123;</span><br><span class="line">         <span class="comment">// condense consecutive whitespaces into single space</span></span><br><span class="line">         text = text.<span class="title function_">replace</span>(whitespaceRE, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">let</span> res</span><br><span class="line">       <span class="keyword">let</span> <span class="attr">child</span>: ?<span class="title class_">ASTNode</span></span><br><span class="line">       <span class="keyword">if</span> (!inVPre &amp;&amp; text !== <span class="string">&#x27; &#x27;</span> &amp;&amp; (res = <span class="title function_">parseText</span>(text, delimiters))) &#123;</span><br><span class="line">         <span class="comment">// 表达式</span></span><br><span class="line">         child = &#123;</span><br><span class="line">           <span class="attr">type</span>: <span class="number">2</span>,</span><br><span class="line">           <span class="attr">expression</span>: res.<span class="property">expression</span>,</span><br><span class="line">           <span class="attr">tokens</span>: res.<span class="property">tokens</span>,</span><br><span class="line">           text</span><br><span class="line">         &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (text !== <span class="string">&#x27; &#x27;</span> || !children.<span class="property">length</span> || children[children.<span class="property">length</span> - <span class="number">1</span>].<span class="property">text</span> !== <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">         <span class="comment">// 静态文本</span></span><br><span class="line">         child = &#123;</span><br><span class="line">           <span class="attr">type</span>: <span class="number">3</span>,</span><br><span class="line">           text</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (child) &#123;</span><br><span class="line">         <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">           child.<span class="property">start</span> = start</span><br><span class="line">           child.<span class="property">end</span> = end</span><br><span class="line">         &#125;</span><br><span class="line">         children.<span class="title function_">push</span>(child)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure><h3 id="3-1-4-comment"><a href="#3-1-4-comment" class="headerlink" title="3.1.4 comment"></a>3.1.4 <code>comment</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">comment (<span class="attr">text</span>: string, start, end) &#123;</span><br><span class="line">      <span class="comment">// 注释代码 回调后执行</span></span><br><span class="line">      <span class="comment">// adding anything as a sibling to the root node is forbidden</span></span><br><span class="line">      <span class="comment">// comments should still be allowed, but ignored</span></span><br><span class="line">      <span class="keyword">if</span> (currentParent) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">child</span>: <span class="title class_">ASTText</span> = &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="number">3</span>,</span><br><span class="line">          text,</span><br><span class="line">          <span class="attr">isComment</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">          child.<span class="property">start</span> = start</span><br><span class="line">          child.<span class="property">end</span> = end</span><br><span class="line">        &#125;</span><br><span class="line">        currentParent.<span class="property">children</span>.<span class="title function_">push</span>(child)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="3-2-parseHTML"><a href="#3-2-parseHTML" class="headerlink" title="3.2 parseHTML()"></a>3.2 <code>parseHTML()</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src\compiler\parser\html-parser.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据 options ，对 html字符串 遍历，生成核心参数 match, attrs,</span></span><br><span class="line"><span class="comment"> * 再通过如 options.start(tagName, attrs, unary, match.start, match.end) 回调 parse 中的start, end, chars, comment 方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; html </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; options </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">  <span class="keyword">const</span> stack = [] <span class="comment">// 存 非单标签</span></span><br><span class="line">  <span class="keyword">const</span> expectHTML = options.<span class="property">expectHTML</span></span><br><span class="line">  <span class="keyword">const</span> isUnaryTag = options.<span class="property">isUnaryTag</span> || no</span><br><span class="line">  <span class="keyword">const</span> canBeLeftOpenTag = options.<span class="property">canBeLeftOpenTag</span> || no</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> last, lastTag</span><br><span class="line">  <span class="comment">// 通过 advance 方法递减 html 字符串，直至html为空表示将html全部遍历，结束循环</span></span><br><span class="line">  <span class="keyword">while</span> (html) &#123;</span><br><span class="line">    last = html</span><br><span class="line">    <span class="comment">// Make sure we&#x27;re not in a plaintext content element like script/style</span></span><br><span class="line">    <span class="keyword">if</span> (!lastTag || !<span class="title function_">isPlainTextElement</span>(lastTag)) &#123;</span><br><span class="line">      <span class="keyword">let</span> textEnd = html.<span class="title function_">indexOf</span>(<span class="string">&#x27;&lt;&#x27;</span>)</span><br><span class="line">      <span class="comment">// 以 &lt; 开头</span></span><br><span class="line">      <span class="keyword">if</span> (textEnd === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Comment:</span></span><br><span class="line">        <span class="comment">// 匹配 &lt;!-- 开头  (/^&lt;!\--/ )</span></span><br><span class="line">        <span class="keyword">if</span> (comment.<span class="title function_">test</span>(html)) &#123;</span><br><span class="line">          <span class="keyword">const</span> commentEnd = html.<span class="title function_">indexOf</span>(<span class="string">&#x27;--&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 匹配到注释 &lt;!--  --&gt;</span></span><br><span class="line">          <span class="keyword">if</span> (commentEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (options.<span class="property">shouldKeepComment</span>) &#123;</span><br><span class="line">              <span class="comment">// options.comment 回调</span></span><br><span class="line">              options.<span class="title function_">comment</span>(html.<span class="title function_">substring</span>(<span class="number">4</span>, commentEnd), index, index + commentEnd + <span class="number">3</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 截取 注释结束位+3 后 html 片段 ，相当于 参数html 删掉 已匹配的 注释 字符串</span></span><br><span class="line">            <span class="title function_">advance</span>(commentEnd + <span class="number">3</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// http://en.wikipedia.org/wiki/Conditional_comment#Downlevel-revealed_conditional_comment</span></span><br><span class="line">        <span class="comment">// 匹配 条件注释 ![ 开头   /^&lt;!\[/</span></span><br><span class="line">        <span class="keyword">if</span> (conditionalComment.<span class="title function_">test</span>(html)) &#123;</span><br><span class="line">          <span class="keyword">const</span> conditionalEnd = html.<span class="title function_">indexOf</span>(<span class="string">&#x27;]&gt;&#x27;</span>)</span><br><span class="line">          <span class="comment">// 匹配到条件注释 &lt;![]&gt; , 如 ![if !IE]</span></span><br><span class="line">          <span class="keyword">if</span> (conditionalEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="title function_">advance</span>(conditionalEnd + <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Doctype:</span></span><br><span class="line">        <span class="comment">// 匹配到 &lt;!DOCTYPE &gt; 删掉</span></span><br><span class="line">        <span class="keyword">const</span> doctypeMatch = html.<span class="title function_">match</span>(doctype)</span><br><span class="line">        <span class="keyword">if</span> (doctypeMatch) &#123;</span><br><span class="line">          <span class="title function_">advance</span>(doctypeMatch[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// End tag:</span></span><br><span class="line">        <span class="comment">// 匹配 &lt;/ **&gt; 结束标签</span></span><br><span class="line">        <span class="keyword">const</span> endTagMatch = html.<span class="title function_">match</span>(endTag)</span><br><span class="line">        <span class="keyword">if</span> (endTagMatch) &#123;</span><br><span class="line">          <span class="keyword">const</span> curIndex = index</span><br><span class="line">          <span class="title function_">advance</span>(endTagMatch[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">          <span class="title function_">parseEndTag</span>(endTagMatch[<span class="number">1</span>], curIndex, index)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start tag:</span></span><br><span class="line">        <span class="comment">// 匹配 &lt;**&gt; 开始标签</span></span><br><span class="line">        <span class="keyword">const</span> startTagMatch = <span class="title function_">parseStartTag</span>()</span><br><span class="line">        <span class="keyword">if</span> (startTagMatch) &#123;</span><br><span class="line">          <span class="title function_">handleStartTag</span>(startTagMatch)</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">shouldIgnoreFirstNewline</span>(startTagMatch.<span class="property">tagName</span>, html)) &#123;</span><br><span class="line">            <span class="title function_">advance</span>(<span class="number">1</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> text, rest, next</span><br><span class="line">      <span class="comment">// 参数html 中有 &lt;</span></span><br><span class="line">      <span class="keyword">if</span> (textEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        rest = html.<span class="title function_">slice</span>(textEnd)</span><br><span class="line">        <span class="comment">// 根据这些判断条件知，这个 if 部分的 &lt; 是文本 &lt;</span></span><br><span class="line">        <span class="comment">// 循环 &lt; 后的字符串</span></span><br><span class="line">        <span class="keyword">while</span> (</span><br><span class="line">          !endTag.<span class="title function_">test</span>(rest) &amp;&amp;</span><br><span class="line">          !startTagOpen.<span class="title function_">test</span>(rest) &amp;&amp;</span><br><span class="line">          !comment.<span class="title function_">test</span>(rest) &amp;&amp;</span><br><span class="line">          !conditionalComment.<span class="title function_">test</span>(rest)</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="comment">// &lt; in plain text, be forgiving and treat it as text</span></span><br><span class="line">          next = rest.<span class="title function_">indexOf</span>(<span class="string">&#x27;&lt;&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">if</span> (next &lt; <span class="number">0</span>) <span class="keyword">break</span></span><br><span class="line">          textEnd += next</span><br><span class="line">          rest = html.<span class="title function_">slice</span>(textEnd)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据实践，页面中直接写的&lt;,变成字符串html后，会被转换为 &amp;lt; 并不会进上方的 while 循环</span></span><br><span class="line">        <span class="comment">// text 获取的是普通文本</span></span><br><span class="line">        text = html.<span class="title function_">substring</span>(<span class="number">0</span>, textEnd)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 参数html 中没有 &lt;</span></span><br><span class="line">      <span class="keyword">if</span> (textEnd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        text = html</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (text) &#123;</span><br><span class="line">        <span class="title function_">advance</span>(text.<span class="property">length</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果存在 text 文本，则处理 普通文本 的回调</span></span><br><span class="line">      <span class="comment">// 调用 options.chars 回调</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">chars</span> &amp;&amp; text) &#123;</span><br><span class="line">        options.<span class="title function_">chars</span>(text, index - text.<span class="property">length</span>, index)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 处理结束标签</span></span><br><span class="line">      <span class="keyword">let</span> endTagLength = <span class="number">0</span></span><br><span class="line">      <span class="keyword">const</span> stackedTag = lastTag.<span class="title function_">toLowerCase</span>()</span><br><span class="line">      <span class="keyword">const</span> reStackedTag = reCache[stackedTag] || (reCache[stackedTag] = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&#x27;([\\s\\S]*?)(&lt;/&#x27;</span> + stackedTag + <span class="string">&#x27;[^&gt;]*&gt;)&#x27;</span>, <span class="string">&#x27;i&#x27;</span>))</span><br><span class="line">      <span class="keyword">const</span> rest = html.<span class="title function_">replace</span>(reStackedTag, <span class="keyword">function</span> (<span class="params">all, text, endTag</span>) &#123;</span><br><span class="line">        endTagLength = endTag.<span class="property">length</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">isPlainTextElement</span>(stackedTag) &amp;&amp; stackedTag !== <span class="string">&#x27;noscript&#x27;</span>) &#123;</span><br><span class="line">          text = text</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&lt;!\--([\s\S]*?)--&gt;/g</span>, <span class="string">&#x27;$1&#x27;</span>) <span class="comment">// #7298</span></span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&lt;!\[CDATA\[([\s\S]*?)]]&gt;/g</span>, <span class="string">&#x27;$1&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">shouldIgnoreFirstNewline</span>(stackedTag, text)) &#123;</span><br><span class="line">          text = text.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">chars</span>) &#123;</span><br><span class="line">          options.<span class="title function_">chars</span>(text)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line">      index += html.<span class="property">length</span> - rest.<span class="property">length</span></span><br><span class="line">      html = rest</span><br><span class="line">      <span class="title function_">parseEndTag</span>(stackedTag, index - endTagLength, index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (html === last) &#123;</span><br><span class="line">      options.<span class="property">chars</span> &amp;&amp; options.<span class="title function_">chars</span>(html)</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !stack.<span class="property">length</span> &amp;&amp; options.<span class="property">warn</span>) &#123;</span><br><span class="line">        options.<span class="title function_">warn</span>(<span class="string">`Mal-formatted tag at end of template: &quot;<span class="subst">$&#123;html&#125;</span>&quot;`</span>, &#123; <span class="attr">start</span>: index + html.<span class="property">length</span> &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clean up any remaining tags</span></span><br><span class="line">  <span class="title function_">parseEndTag</span>()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-1-advance"><a href="#3-2-1-advance" class="headerlink" title="3.2.1 advance"></a>3.2.1 <code>advance</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 截取 index + n 后的 html （即删除掉 n 前的字符串）</span></span><br><span class="line"><span class="comment">   * 处理后的标签从html中删除，index 位置相应后移n</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"></span>&#125; <span class="variable">n</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">advance</span> (n) &#123;</span><br><span class="line">    index += n</span><br><span class="line">    html = html.<span class="title function_">substring</span>(n)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h3 id="3-2-2-parseStartTag"><a href="#3-2-2-parseStartTag" class="headerlink" title="3.2.2  parseStartTag"></a>3.2.2 <code>parseStartTag</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理 开始标签 ，将 html 转换为 对象match 格式</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">parseStartTag</span> () &#123;</span><br><span class="line">    <span class="keyword">const</span> start = html.<span class="title function_">match</span>(startTagOpen)</span><br><span class="line">    <span class="keyword">if</span> (start) &#123;</span><br><span class="line">      <span class="keyword">const</span> match = &#123;</span><br><span class="line">        <span class="attr">tagName</span>: start[<span class="number">1</span>],</span><br><span class="line">        <span class="attr">attrs</span>: [],</span><br><span class="line">        <span class="attr">start</span>: index</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">advance</span>(start[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">      <span class="keyword">let</span> end, attr</span><br><span class="line">      <span class="comment">// 把 标签内 属性赋值给match</span></span><br><span class="line">      <span class="keyword">while</span> (!(end = html.<span class="title function_">match</span>(startTagClose)) &amp;&amp; (attr = html.<span class="title function_">match</span>(dynamicArgAttribute) || html.<span class="title function_">match</span>(attribute))) &#123;</span><br><span class="line">        attr.<span class="property">start</span> = index</span><br><span class="line">        <span class="title function_">advance</span>(attr[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">        attr.<span class="property">end</span> = index</span><br><span class="line">        match.<span class="property">attrs</span>.<span class="title function_">push</span>(attr)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果有 结束 的标签</span></span><br><span class="line">      <span class="keyword">if</span> (end) &#123;</span><br><span class="line">        match.<span class="property">unarySlash</span> = end[<span class="number">1</span>]</span><br><span class="line">        <span class="comment">// 清掉此句 ，随遍历，随清除</span></span><br><span class="line">        <span class="title function_">advance</span>(end[<span class="number">0</span>].<span class="property">length</span>)</span><br><span class="line">        match.<span class="property">end</span> = index</span><br><span class="line">        <span class="keyword">return</span> match</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>例：遍历到 <code>&lt;textarea :value=&quot;input + newDate()&quot; @input=&quot;update&quot;&gt;</code>，<code>parseStartTag()</code> 得到的 match如下图：</p><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657791625682-d817e676-e28a-4c56-99a1-e8e894bc8180.png" alt="img"></p><h3 id="3-2-3-handleStartTag"><a href="#3-2-3-handleStartTag" class="headerlink" title="3.2.3 handleStartTag"></a>3.2.3 <code>handleStartTag</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理 参数match，得到新格式 attrs，</span></span><br><span class="line"><span class="comment">   * 未闭合标签入栈，</span></span><br><span class="line"><span class="comment">   * 回调 start</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; match </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">handleStartTag</span> (match) &#123;</span><br><span class="line">    <span class="keyword">const</span> tagName = match.<span class="property">tagName</span></span><br><span class="line">    <span class="keyword">const</span> unarySlash = match.<span class="property">unarySlash</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (expectHTML) &#123;</span><br><span class="line">      <span class="keyword">if</span> (lastTag === <span class="string">&#x27;p&#x27;</span> &amp;&amp; <span class="title function_">isNonPhrasingTag</span>(tagName)) &#123;</span><br><span class="line">        <span class="title function_">parseEndTag</span>(lastTag)</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">/*       export const canBeLeftOpenTag = makeMap(</span></span><br><span class="line"><span class="comment">        &#x27;colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr,source&#x27;</span></span><br><span class="line"><span class="comment">      ) */</span></span><br><span class="line">      <span class="comment">// 针对可以省略 结果标签 的，自动当作已有结尾标签进行处理</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">canBeLeftOpenTag</span>(tagName) &amp;&amp; lastTag === tagName) &#123;</span><br><span class="line">        <span class="title function_">parseEndTag</span>(tagName)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> unary = <span class="title function_">isUnaryTag</span>(tagName) || !!unarySlash</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历处理 attrs 按照新格式</span></span><br><span class="line">    <span class="keyword">const</span> l = match.<span class="property">attrs</span>.<span class="property">length</span></span><br><span class="line">    <span class="keyword">const</span> attrs = <span class="keyword">new</span> <span class="title class_">Array</span>(l)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> args = match.<span class="property">attrs</span>[i]</span><br><span class="line">      <span class="comment">// 这里的 3、4、5 分别对应三种不同复制属性的方式</span></span><br><span class="line">      <span class="comment">// 3: attr=&quot;xxx&quot; 双引号</span></span><br><span class="line">      <span class="comment">// 4: attr=&#x27;xxx&#x27; 单引号</span></span><br><span class="line">      <span class="comment">// 5: attr=xxx   省略引号</span></span><br><span class="line">      <span class="keyword">const</span> value = args[<span class="number">3</span>] || args[<span class="number">4</span>] || args[<span class="number">5</span>] || <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="keyword">const</span> shouldDecodeNewlines = tagName === <span class="string">&#x27;a&#x27;</span> &amp;&amp; args[<span class="number">1</span>] === <span class="string">&#x27;href&#x27;</span></span><br><span class="line">        ? options.<span class="property">shouldDecodeNewlinesForHref</span></span><br><span class="line">        : options.<span class="property">shouldDecodeNewlines</span></span><br><span class="line">      attrs[i] = &#123;</span><br><span class="line">        <span class="attr">name</span>: args[<span class="number">1</span>],</span><br><span class="line">        <span class="attr">value</span>: <span class="title function_">decodeAttr</span>(value, shouldDecodeNewlines)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; options.<span class="property">outputSourceRange</span>) &#123;</span><br><span class="line">        attrs[i].<span class="property">start</span> = args.<span class="property">start</span> + args[<span class="number">0</span>].<span class="title function_">match</span>(<span class="regexp">/^\s*/</span>).<span class="property">length</span></span><br><span class="line">        attrs[i].<span class="property">end</span> = args.<span class="property">end</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!unary) &#123;</span><br><span class="line">      <span class="comment">// 非单标签，入栈</span></span><br><span class="line">      stack.<span class="title function_">push</span>(&#123; <span class="attr">tag</span>: tagName, <span class="attr">lowerCasedTag</span>: tagName.<span class="title function_">toLowerCase</span>(), <span class="attr">attrs</span>: attrs, <span class="attr">start</span>: match.<span class="property">start</span>, <span class="attr">end</span>: match.<span class="property">end</span> &#125;)</span><br><span class="line">      lastTag = tagName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">start</span>) &#123;</span><br><span class="line">      <span class="comment">// 回调 start</span></span><br><span class="line">      options.<span class="title function_">start</span>(tagName, attrs, unary, match.<span class="property">start</span>, match.<span class="property">end</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>例：遍历到 <code>&lt;textarea :value=&quot;input + newDate()&quot; @input=&quot;update&quot;&gt;</code>，<code>handleStartTag()</code> 得到的 <code>attrs</code>如下图：</p><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657791747470-3a4ab7c5-48a7-4584-abc5-3f1545ce6a2f.png" alt="img"></p><h3 id="3-2-4-parseEndTag"><a href="#3-2-4-parseEndTag" class="headerlink" title="3.2.4 parseEndTag"></a>3.2.4 <code>parseEndTag</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理结束标签：</span></span><br><span class="line"><span class="comment">   * 先找未闭合标签的位置pos，回调 end，并在栈中删除已关闭标签</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; tagName </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; start </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; end </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">parseEndTag</span> (tagName, start, end) &#123;</span><br><span class="line">    <span class="keyword">let</span> pos, lowerCasedTagName</span><br><span class="line">    <span class="keyword">if</span> (start == <span class="literal">null</span>) start = index</span><br><span class="line">    <span class="keyword">if</span> (end == <span class="literal">null</span>) end = index</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the closest opened tag of the same type</span></span><br><span class="line">    <span class="keyword">if</span> (tagName) &#123;</span><br><span class="line">      lowerCasedTagName = tagName.<span class="title function_">toLowerCase</span>()</span><br><span class="line">      <span class="comment">// 寻找相同类型的未闭合标签的位置 pos</span></span><br><span class="line">      <span class="keyword">for</span> (pos = stack.<span class="property">length</span> - <span class="number">1</span>; pos &gt;= <span class="number">0</span>; pos--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stack[pos].<span class="property">lowerCasedTag</span> === lowerCasedTagName) &#123;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// If no tag name is provided, clean shop</span></span><br><span class="line">      pos = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Close all the open elements, up the stack</span></span><br><span class="line">      <span class="comment">// 有 pos 位置，如果能和 未闭合stack 栈中匹配（即 stack.length - 1 == pos），则回调 end</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = stack.<span class="property">length</span> - <span class="number">1</span>; i &gt;= pos; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">          (i &gt; pos || !tagName) &amp;&amp;</span><br><span class="line">          options.<span class="property">warn</span></span><br><span class="line">        ) &#123;</span><br><span class="line">          options.<span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`tag &lt;<span class="subst">$&#123;stack[i].tag&#125;</span>&gt; has no matching end tag.`</span>,</span><br><span class="line">            &#123; <span class="attr">start</span>: stack[i].<span class="property">start</span>, <span class="attr">end</span>: stack[i].<span class="property">end</span> &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">end</span>) &#123;</span><br><span class="line">          options.<span class="title function_">end</span>(stack[i].<span class="property">tag</span>, start, end)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Remove the open elements from the stack</span></span><br><span class="line">      <span class="comment">// 并在栈中删除已关闭标签</span></span><br><span class="line">      stack.<span class="property">length</span> = pos</span><br><span class="line">      lastTag = pos &amp;&amp; stack[pos - <span class="number">1</span>].<span class="property">tag</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lowerCasedTagName === <span class="string">&#x27;br&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">start</span>) &#123;</span><br><span class="line">        options.<span class="title function_">start</span>(tagName, [], <span class="literal">true</span>, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lowerCasedTagName === <span class="string">&#x27;p&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">start</span>) &#123;</span><br><span class="line">        options.<span class="title function_">start</span>(tagName, [], <span class="literal">false</span>, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">end</span>) &#123;</span><br><span class="line">        options.<span class="title function_">end</span>(tagName, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="4-optimize"><a href="#4-optimize" class="headerlink" title="4. optimize()"></a>4. <code>optimize()</code></h1><p>同 3 中模板，</p><p>如下创建入口，引出 <code>optimize</code>方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">optimize</span>(ast, options)</span><br></pre></td></tr></table></figure><p>得到 ast 结构如下图：</p><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657792178113-75f71a19-6e80-4005-a2b6-ae44cbe3057e.png" alt="img"></p><p>对比上一步的ast，多了一个 static，staticRoot。</p><p>具体原因，之后再继续琢磨。</p><h1 id="5-generate"><a href="#5-generate" class="headerlink" title="5. generate()"></a>5. <code>generate()</code></h1><p>同 3 中模板，</p><p>如下创建入口，引出 <code>generate</code>方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\compiler\index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="title function_">generate</span>(ast, options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>得到 code 如下图：</p><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657798847942-c8230cb1-d174-49b3-9dd1-0a76bf3d767a.png" alt="img"></p><h2 id="render-创建了！"><a href="#render-创建了！" class="headerlink" title="render 创建了！"></a>render 创建了！</h2><h2 id="render-的结构："><a href="#render-的结构：" class="headerlink" title="render 的结构："></a><code>render</code> 的结构：</h2><p><img src="/106-%E6%A8%A1%E7%89%88%E6%B8%B2%E6%9F%93/1657798935121-e07f3e38-a733-49b2-bf8f-f01a761124e5.png" alt="img"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">`with(this)&#123;</span></span><br><span class="line"><span class="string">    return_c(&#x27;div&#x27;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        attrs: &#123;</span></span><br><span class="line"><span class="string">            &quot;id&quot;: &quot;editor&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    [</span></span><br><span class="line"><span class="string">        _v(&quot;\\n      &lt;试试\\\\&lt;\\n      &quot;),</span></span><br><span class="line"><span class="string">        _c(&#x27;textarea&#x27;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            domProps: &#123;</span></span><br><span class="line"><span class="string">                &quot;value&quot;: input+newDate()</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            on: &#123;</span></span><br><span class="line"><span class="string">                &quot;input&quot;: update</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;),</span></span><br><span class="line"><span class="string">        _v(&quot; &quot;),</span></span><br><span class="line"><span class="string">        _c(&#x27;div&#x27;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            domProps: &#123;</span></span><br><span class="line"><span class="string">                &quot;innerHTML&quot;: _s(compiledMarkdown)</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;)</span></span><br><span class="line"><span class="string">    ])</span></span><br><span class="line"><span class="string">&#125;`</span></span><br></pre></td></tr></table></figure><p>这里的 _c 对应的是虚拟 DOM 中的 createElement 方法。</p><p>其他的下划线方法在 core&#x2F;instance&#x2F;render-helpers 中都有定义。</p><p>参考：</p><p><a class="link" target="_blank" rel="noopener" href="https://juejin.cn/post/7064788398304657415">https://juejin.cn/post/7064788398304657415<i class="fas fa-external-link-alt"></i></a></p><p><a class="link" target="_blank" rel="noopener" href="https://juejin.cn/post/6863241580753616903">https://juejin.cn/post/6863241580753616903<i class="fas fa-external-link-alt"></i></a></p><p><strong>着重记下这位大佬推荐的</strong> <a href="https://link.juejin.cn/?target=https://jex.im/regulex/"><strong>正则可视化工具</strong></a> <strong>(๑•̀ㅂ•́)و✧</strong></p></div><div class="post-copyright-info-container border-box"><div class="copyright-info-content border-box"><div class="copyright-info-top border-box"><div class="copyright-post-title border-box text-ellipsis">6. 模版渲染</div><div class="copyright-post-link border-box text-ellipsis">106-模版渲染/</div></div><div class="copyright-info-bottom border-box"><div class="copyright-post-author bottom-item"><div class="type">Author</div><div class="content">ChengShuomin</div></div><div class="post-time bottom-item"><div class="type">Published</div><div class="content">2022-06-28</div></div><div class="post-license bottom-item"><div class="type">License</div><div class="content tooltip" data-tooltip-content="CC BY-NC-SA 4.0"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank"><i class="fa-brands fa-creative-commons"></i> <i class="fa-brands fa-creative-commons-by"></i> <i class="fa-brands fa-creative-commons-nc"></i> <i class="fa-brands fa-creative-commons-sa"></i></a></div></div></div><i class="copyright-bg fa-solid fa-copyright"></i></div><div class="copy-copyright-info flex-center tooltip" data-tooltip-content="Copy copyright info" data-tooltip-offset-y="-2px"><i class="fa-solid fa-copy"></i></div></div><div class="post-bottom-tags-and-share border-box"><div><ul class="post-tags-box border-box"><li class="tag-item border-box"><i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/Vue%E6%BA%90%E7%A0%81/">Vue源码</a></li></ul></div><div><div class="post-share-container border-box"><ul class="share-list-wrap border-box"><li class="qq share-item border-box flex-center tooltip" data-tooltip-content="Share to QQ"><i class="fa-brands fa-qq"></i></li><li class="wechat share-item border-box flex-center tooltip tooltip-img" data-tooltip-content="Share to WeChat" data-tooltip-img-tip="Scan by WeChat" data-tooltip-img-style="background-color: #fff; top: -10px; padding: 0.6rem 0.6rem 0.1rem 0.6rem;"><i class="fa-brands fa-weixin"></i></li><li class="weibo share-item border-box flex-center tooltip" data-tooltip-content="Share to WeiBo"><i class="fa-brands fa-weibo"></i></li></ul></div></div></div><div class="post-nav border-box"><div class="prev-post"><a class="prev" rel="prev" href="/107-nextTick/" title="7. nextTick"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item text-ellipsis">7. nextTick</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="next-post"><a class="next" rel="next" href="/105-observer-Dep-Watcher/" title="5. observer/Dep/Watcher"><span class="title flex-center"><span class="post-nav-title-item text-ellipsis">5. observer/Dep/Watcher</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div></div></div></div></div></div></div><div class="page-main-content-bottom border-box"><footer class="footer border-box"><div class="copyright-info info-item">&copy;&nbsp;<span>2021</span>&nbsp;-&nbsp;2025 &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">ChengShuomin</a></div><div class="theme-info info-item">Powered by&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;&&nbsp;Theme&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a></div></footer></div></div><div class="post-tools right-toc"><div class="post-tools-container border-box"><ul class="post-tools-list border-box"><li class="tools-item flex-center full-screen"><i class="fa-solid fa-expand"></i></li></ul></div></div><div class="side-tools"><div class="side-tools-container border-box"><ul class="side-tools-list side-tools-show-handle border-box"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-toggle-theme-mode flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list border-box"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center show-arrow"><i class="arrow fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div></main><script src="/js/utils.js"></script><script src="/js/header-shrink.js"></script><script src="/js/back2top.js"></script><script src="/js/toggle-theme.js"></script><script src="/js/code-block.js"></script><script src="/js/main.js"></script><script src="/js/libs/anime.min.js"></script><div><script src="/js/post/post-helper.js"></script><script src="/js/post/copyright-info.js"></script><script src="/js/post/share.js"></script></div></body></html>